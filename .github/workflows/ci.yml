# ============================================================================
# CI Workflow - Build, Test, Lint
# ============================================================================
# MODULE_CONTRACT: MC-ci-github-actions
# Triggers on every push and pull request to ensure code quality.
#
# Jobs:
#   - build: Compile and verify the project
#   - test: Run unit, integration, architecture, and contract tests
#   - lint: Check code style and formatting
#
# Links:
#   - DevelopmentPlan.xml#DP-INFRA-ci-cd
#   - Technology.xml#TECH-CICD-001
# ============================================================================

name: CI

on:
  push:
    branches:
      - main
      - develop
      - 'feature/**'
      - 'release/**'
      - 'hotfix/**'
    paths:
      - 'backend/**'
      - '.github/workflows/ci.yml'
  pull_request:
    branches:
      - main
      - develop
    paths:
      - 'backend/**'
      - '.github/workflows/ci.yml'

env:
  JAVA_VERSION: '25'
  JAVA_DISTRIBUTION: 'temurin'
  MAVEN_OPTS: '-Xmx2g -XX:+UseG1GC'

jobs:
  # ─────────────────────────────────────────────────────────────────────────────
  # Build Job
  # ─────────────────────────────────────────────────────────────────────────────
  build:
    name: Build
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: backend/windows-store-server

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for versioning

      - name: Set up JDK ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          distribution: ${{ env.JAVA_DISTRIBUTION }}
          java-version: ${{ env.JAVA_VERSION }}
          cache: 'maven'

      - name: Cache Maven dependencies
        uses: actions/cache@v4
        with:
          path: ~/.m2/repository
          key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            ${{ runner.os }}-maven-

      - name: Compile project
        run: mvn -B -DskipTests compile

      - name: Verify project (skip tests)
        run: mvn -B -DskipTests verify

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-artifacts
          path: |
            backend/windows-store-server/**/target/*.jar
            !backend/windows-store-server/**/target/*-sources.jar
          retention-days: 1

  # ─────────────────────────────────────────────────────────────────────────────
  # Test Job
  # ─────────────────────────────────────────────────────────────────────────────
  test:
    name: Test
    runs-on: ubuntu-latest
    needs: build
    defaults:
      run:
        working-directory: backend/windows-store-server

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          distribution: ${{ env.JAVA_DISTRIBUTION }}
          java-version: ${{ env.JAVA_VERSION }}
          cache: 'maven'

      - name: Cache Maven dependencies
        uses: actions/cache@v4
        with:
          path: ~/.m2/repository
          key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            ${{ runner.os }}-maven-

      - name: Run unit tests
        run: mvn -B -DfailIfNoTests=false test

      - name: Run integration tests
        run: mvn -B -DskipTests -DfailIfNoTests=false failsafe:integration-test failsafe:verify

      - name: Run ArchUnit tests
        run: mvn -B -Dtest=*ArchUnit* -DfailIfNoTests=false test

      - name: Run contract tests
        run: mvn -B -Dtest=*Contract* -DfailIfNoTests=false test

      - name: Generate test report
        if: always()
        run: mvn -B surefire-report:report-only

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results
          path: |
            backend/windows-store-server/**/target/surefire-reports/
            backend/windows-store-server/**/target/failsafe-reports/
          retention-days: 7

  # ─────────────────────────────────────────────────────────────────────────────
  # Lint Job
  # ─────────────────────────────────────────────────────────────────────────────
  lint:
    name: Lint
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: backend/windows-store-server

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          distribution: ${{ env.JAVA_DISTRIBUTION }}
          java-version: ${{ env.JAVA_VERSION }}
          cache: 'maven'

      - name: Check code formatting (Checkstyle)
        run: mvn -B checkstyle:check || echo "Checkstyle not configured - skipping"
        continue-on-error: true

      - name: Check for common bugs (SpotBugs)
        run: mvn -B spotbugs:check || echo "SpotBugs not configured - skipping"
        continue-on-error: true

      - name: Validate POM files
        run: mvn -B validate

      - name: Check dependency convergence
        run: mvn -B dependency:analyze-only || true
        continue-on-error: true

  # ─────────────────────────────────────────────────────────────────────────────
  # Coverage Job
  # ─────────────────────────────────────────────────────────────────────────────
  coverage:
    name: Coverage Report
    runs-on: ubuntu-latest
    needs: test
    defaults:
      run:
        working-directory: backend/windows-store-server

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          distribution: ${{ env.JAVA_DISTRIBUTION }}
          java-version: ${{ env.JAVA_VERSION }}
          cache: 'maven'

      - name: Generate coverage report (JaCoCo)
        run: mvn -B jacoco:report || echo "JaCoCo not configured - skipping"
        continue-on-error: true

      - name: Upload coverage report
        uses: actions/upload-artifact@v4
        if: success()
        with:
          name: coverage-report
          path: backend/windows-store-server/**/target/site/jacoco/
          retention-days: 7
