# OpenMemory - Windows&Doors E-Commerce (kanokna-store)

## Overview
- Windows and doors e-commerce with configurable products, price preview, and lead-time promises for B2C/B2B buyers.
- Backend: Java 25 + Spring Boot Maven multi-module (config-server, gateway, shared-kernel, api-contracts, services/*); OLTP DB is PostgreSQL per service, with Redis/Elasticsearch/Kafka in the standard stack.
- Frontend: Angular 21 client with SSR entrypoint (src/server.ts) and multiple UI component libraries (Material, Taiga, Spartan).
- Observability and security guardrails: OAuth2/OIDC JWT roles BUYER/ADMIN/INSTALLER, OTEL tracing, Micrometer metrics, JSON logs with correlation IDs.
- Architecture docs: `backend/windows-store-server/docs/grace/RequirementsAnalysis.xml` v1.6.0, `backend/windows-store-server/docs/grace/Technology.xml` v1.5.1, `backend/windows-store-server/docs/grace/DevelopmentPlan.xml` v1.5.0 (flows include Flow-Config-Pricing, Flow-B2C-CPQ, Flow-Checkout-Payment, Flow-Order-Lifecycle, Flow-ProductSearch, Flow-Document-Issue, Flow-B2B-Finance, Flow-Event-Driven).
- ES/Testcontainers alignment: Technology.xml updated to Elasticsearch 8.17.1 + Testcontainers 1.20.x per AWO-20260126-01; search-service contracts updated to reference 8.17.1; Handoff-20260126-01-W0-ES-VERSION-BLUEPRINT-UPDATE approved in approvals.log.

## User Defined Namespaces
- [Leave blank - user populates]

## Architecture
- Backend modules (blueprint): config-server, gateway, shared-kernel, catalog-configuration-service, pricing-service, cart-service, order-service, account-service, media-service, notification-service, reporting-service, search-service; existing code still includes product-service scaffold.
- Patterns: hexagonal intent, Bean Validation on entities, JPA auditing hooks, enums for currency and product options, embeddables for shared specs.
- Data and integration: PostgreSQL per service; Redis/Elasticsearch/Kafka used; REST `/api/v1` endpoints; gRPC for sync inter-service calls; Kafka domain events for async propagation.
- Testing baseline: Testcontainers version pinned to 1.20.4 via parent dependency management to avoid mixed module versions.
- Elasticsearch baseline: docker-compose/testcontainers use 8.17.1; search-service client should stay on the same major.
- Windows + Testcontainers: set Java system property `api.version=1.44` for Surefire/Failsafe to make docker-java work reliably with Docker Desktop npipe.
- Search-service tests: ES 8+ disallows deleting an alias by name; cleanup resolves alias -> concrete indices before delete.
- Search-service autocomplete: completion suggester mapping requires contexts; when no family filter is provided, pass an empty-category prefix context to avoid `Missing mandatory contexts` errors.
- Build and testing: Maven with Spring Boot BOM; JUnit 5 + Testcontainers; ArchUnit/mutation testing planned per Technology guardrails.
- gRPC config uses Spring gRPC 1.0.1 properties under `spring.grpc.*`; config-repo gRPC blocks are currently misindented and need migration to `spring.grpc.client.channels.*` for inter-service calls, with `spring.grpc.client.inprocess.exclusive=false` to allow network channels.
- Config server clients use `spring.config.import=optional:configserver:http://localhost:8888` and require `spring-cloud-starter-config` in service POMs (gateway already includes it).
- Config server now sources configs from the external `kanokna-config` repo (native dev via file path; stage/prod via git), and the in-repo `config-repo` was removed.
- kanokna-config repo now includes README, .gitignore, and application-{dev,stage,prod}.yml placeholders; config files stay at repo root for Spring Cloud Config lookup.
- kanokna-config now has per-service `*-stage.yml` and `*-prod.yml` templates plus populated application-stage/prod overrides for shared stage/prod settings.
- stage/prod config files in kanokna-config are now filled with local Docker values (localhost endpoints, dev credentials, local gRPC addresses) for immediate use.
- gRPC implementation standard is Spring gRPC only; legacy `grpc-spring-boot-starter` (net.devh) is not used.
- Service-level docs added for catalog-configuration-service (docs/RequirementsAnalysis.xml, docs/Technology.xml, docs/DevelopmentPlan.xml) defining service scope, interfaces, flows (Flow-Validation, Flow-Publish, Flow-Bom), and contracts/anchors for validation and BOM resolution.
- Service-level docs added for product-service (docs/RequirementsAnalysis.xml, docs/Technology.xml, docs/DevelopmentPlan.xml) covering product master data use cases (create/update/publish, list/get), tech stack, hexagonal plan, flows (Flow-Read, Flow-Publish), domain invariants, and block anchors (PROD-PRICE-*, PROD-PUB-*).
- Shared-kernel docs added (docs/RequirementsAnalysis.xml, docs/Technology.xml, docs/DevelopmentPlan.xml) describing framework-free value objects/events, invariants, ArchUnit guardrails, and function anchors (MNY-VALIDATE/NORMALIZE, DIM-RANGE, ID-PARSE).
- Pricing-service initialized with module entry in parent POM, service docs (docs/RequirementsAnalysis.xml, docs/Technology.xml, docs/DevelopmentPlan.xml), and bootstrap class with MODULE_CONTRACT; package root now com.kanokna.pricing; flows and anchors defined (PRICE-BASE/OPTIONS/DISCOUNT/TAX).
- Cart-service initialized with parent POM entry, docs (docs/RequirementsAnalysis.xml, docs/Technology.xml, docs/DevelopmentPlan.xml), and bootstrap class with MODULE_CONTRACT; flows and anchors defined for cart add/update/abandon (CART-ADD-IDEMP/VALIDATE, CART-TOTAL-RECALC, CART-SHIP-VALIDATE).
- Order-service initialized with parent POM entry, docs (docs/RequirementsAnalysis.xml, docs/Technology.xml, docs/DevelopmentPlan.xml), and bootstrap class with MODULE_CONTRACT; flows and anchors for checkout/payments/lifecycle (ORDER-VALIDATE/PERSIST/EVENT, PAY-CALLBACK-IDEMP/STATE/NOTIFY).
- services/account-service: domain models (UserProfile, SavedAddress, SavedConfiguration) with events and error codes; AccountApplicationService now acts as facade delegating to ProfileService, AddressService, and SavedConfigurationService with GRACE anchors and canonical logs; adapters include REST controllers, gRPC service and mappers, Keycloak current-user provider, JPA persistence adapters and mappers, and Spring config; Flyway V1 accounts schema; tests cover unit, WebMvc, DataJpa (Testcontainers), integration, and ArchUnit.
- Media-service initialized with parent POM entry, docs (docs/RequirementsAnalysis.xml, docs/Technology.xml, docs/DevelopmentPlan.xml), and bootstrap class with MODULE_CONTRACT; flows and anchors for upload/resolve (MEDIA-UPLOAD-VALIDATE/REGISTER, MEDIA-RESOLVE-FETCH/SIGN).
- Reporting-service initialized with parent POM entry, docs (docs/RequirementsAnalysis.xml, docs/Technology.xml, docs/DevelopmentPlan.xml), and bootstrap class with MODULE_CONTRACT; flows and anchors for ingestion/query/export (REPORT-INGEST-IDEMP/APPLY/CACHE, REPORT-QUERY-CACHE/DB).
- Notification-service initialized with parent POM entry, docs (docs/RequirementsAnalysis.xml, docs/Technology.xml, docs/DevelopmentPlan.xml), and bootstrap class with MODULE_CONTRACT; flows and anchors for event-driven sends (NOTIFY-RENDER, NOTIFY-SEND).
- Search-service initialized with parent POM entry, docs (docs/RequirementsAnalysis.xml, docs/Technology.xml, docs/DevelopmentPlan.xml), and bootstrap class with MODULE_CONTRACT; flows and anchors for search/autocomplete and ingestion (SEARCH-QUERY-CACHE/INDEX, SEARCH-AUTO-CACHE/INDEX).
- Search-service adapters include gRPC service/mapper, admin reindex REST controller, and security config enforcing ADMIN for /api/admin/**.
- Search-service adds Kafka catalog event ingestion (published/updated/unpublished) with DLT handling and health indicators for Elasticsearch/Redis.
- Search-service tests include unit/slice/integration/contract coverage with TestContainersConfig for Elasticsearch/Kafka/Redis and shared SearchTestFixture helpers.
- Installation-service initialized with parent POM entry, docs (docs/RequirementsAnalysis.xml, docs/Technology.xml, docs/DevelopmentPlan.xml), and bootstrap class with MODULE_CONTRACT; flows and anchors for slot booking/status (INSTALL-BOOK-IDEMP/CONFLICT/PERSIST, INSTALL-STATUS-VALIDATE/PERSIST).
- Root RA/Technology/DevelopmentPlan v2.0 now include installation scheduling use cases (UC-INSTALL-SLOT-SEARCH/BOOK/UPDATE), Flow-Installation, Technology entry SVC-installation-service, and mod.installation.domain contracts aligning root docs with installation-service behavior.
- order-service domain layer added: MODULE_MAP and pure domain models (Order aggregate with items/totals/shipping/installation, Payment value/aggregate, enums OrderStatus/PaymentStatus/PaymentMethod, Totals, OrderItem, ShippingInfo, InstallationInfo), DecisionTrace collector, domain events (OrderCreatedEvent, PaymentAppliedEvent), and OrderDomainService with FUNCTION_CONTRACTs and anchors ORDER-VALIDATE/ORDER-EVENT/PAY-STATE/PAY-NOTIFY enforcing currency/status rules and idempotent payment application. Application layer added: ports (CheckoutPort, PaymentPort, InstallationPort, OrderQueryPort, OrderRepository, PaymentRepository, PaymentGatewayPort, NotificationPublisher, OutboxPublisher, CartPort, PricingPort), DTOs (PlaceOrderCommand, OrderCreatedResponse, CartSnapshot, InitiatePaymentCommand, PaymentCallbackCommand, PaymentResult, ScheduleInstallationCommand, PaymentGatewaySession), and OrderApplicationService with MODULE_CONTRACT/anchors orchestrating checkout, payment initiation/callback, installation scheduling over domain services.
- order-service expanded: added JPA persistence adapters/entities (OrderJpaEntity with items/totals/shipping/install JSON, paidTotal; PaymentJpaEntity) with Flyway migration V1__orders.sql; Order/Payment mappers and JPA adapters replace in-memory repositories; Redis idempotency store (primary) with fallback in-memory; Kafka outbox publishers for order/payment and notifications; PaymentGateway stub adapter; enriched GET order response DTO. Added REST controllers for checkout and payment callbacks, OrderQueryService, OpenAPI/AsyncAPI specs, ArchUnit tests, contract existence tests, WebMvc controller smoke tests. Application wiring updated to inject idempotency and real adapters.

## User Defined Namespaces
- [Leave blank - user populates]

## Components
- shared/shared-kernel: Module contract added for shared primitives (Id, Email, Address, Money, LocalizedString, Dimensions, DomainEvent); function contracts for Money factories/arithmetics, LocalizedString.resolve, Id.of/random; Email and Address value objects with validation/canonicalization; CanonicalLogFormatter utility formats GRACE log lines without emitting logs; LogSanitizer utility added for OWASP Encoder-based log sanitization with TC-LOG-SANITIZE-001..004 tests.
- api-contracts: Module scaffolded with gRPC/protobuf build (protobuf-maven-plugin + gRPC stubs) and Wave 0 proto skeletons under api-contracts/src/main/proto/com/kanokna/{service}/grpc for catalog/pricing/cart/order/account/installation/media/notification/search/reporting; docs mirror under docs/api-contracts/protobuf with the same structure.
- services/catalog-configuration-service: Spring Boot shell with module contract; domain layer implemented with ProductTemplate aggregate (attribute groups/options, TemplateStatus, DimensionPolicy), CatalogVersion aggregate, compatibility ruleset, and BOM templates; domain services ConfigurationValidationService (CFG-VAL-RANGE/COMPAT/RESULT anchors) and BomResolutionService (BOM-RES-SELECT/MAP/EVENT anchors) emit ConfigurationValidatedEvent and BomResolvedEvent for adapters/outbox; application layer with QueryPort and ConfigurationApplicationService orchestrating validateConfiguration/resolveBom over ProductTemplateRepository, BomTemplateRepository, OutboxPublisher using APP-VAL-* and APP-BOM-* anchors and returning DTO responses; adapters layer added: REST controller (POST /api/v1/catalog/configurations/validate|resolve-bom) mapping to commands with HTTP logs, adapter DTOs, in-memory adapters for repositories/outbox/search/media, Spring config wiring domain/application beans, and gRPC server/mapper plus gRPC exception interceptor for CatalogConfigurationService.
- services/catalog-configuration-service: CatalogDomainErrors factory added for ERR-CAT-* codes; domain model/event validations throw DomainException instead of IllegalArgumentException; unit tests cover factory methods.
- services/pricing-service: Domain layer implemented with PriceBook aggregate (region/currency, base prices, option premiums, status/version), Campaign aggregate (status, percent discount, schedule), TaxRule, OptionPremiumKey, QuoteRequest/Quote/QuoteCalculationResult value objects, QuoteCalculatedEvent; domain service PriceCalculationService with FUNCTION_CONTRACT and block anchors PRICE-BASE/OPTIONS/DISCOUNT/TAX emitting DecisionTrace entries and QuoteCalculatedEvent, enforcing active price book and currency alignment. Application layer added with QuotePort, QuoteConfigurationCommand/QuoteResponse DTOs, and PriceApplicationService (anchors APP-QUOTE-LOAD/CACHE/DOMAIN/OUTBOX) orchestrating price book/campaign/tax loading, cache lookup, domain call, and outbox publish; out-port interfaces for repositories, cache, FX, outbox. Adapters layer added: REST controller (POST /api/v1/pricing/quote|quote/cart) mapping DTOs to commands and returning Money/DecisionTrace DTOs; in-memory adapters for price books, campaigns, tax rules, quote cache, outbox, FX; Spring config wiring domain/application. Contracts added: docs/pricing-openapi.yaml (quote endpoints) and docs/pricing-asyncapi.yaml (pricing.updated event). ArchUnit hexagonal guardrails in HexagonalArchitectureTest.
- services/pricing-service: PricingDomainErrors factory added for ERR-PRICE-* codes; domain model validations throw DomainException instead of IllegalArgumentException; unit tests cover factory methods.
- services/pricing-service: Domain layer implemented with PriceBook aggregate (region/currency, base prices, option premiums, status/version), Campaign aggregate (status, percent discount, schedule), TaxRule, OptionPremiumKey, QuoteRequest/Quote/QuoteCalculationResult value objects, QuoteCalculatedEvent; domain service PriceCalculationService with FUNCTION_CONTRACT and block anchors PRICE-BASE/OPTIONS/DISCOUNT/TAX emitting DecisionTrace entries and QuoteCalculatedEvent, enforcing active price book and currency alignment. Application layer added with QuotePort, QuoteConfigurationCommand/QuoteResponse DTOs, and PriceApplicationService (anchors APP-QUOTE-LOAD/CACHE/DOMAIN/OUTBOX) orchestrating price book/campaign/tax loading, cache lookup, domain call, and outbox publish; admin layer via PriceAdminPort and AdminController for price books/campaigns/tax rules. Adapters layer: REST controller for quote + admin endpoints; JPA persistence adapters/entities for price books/campaigns/tax rules with Flyway migration; Redis quote cache adapter (primary) with in-memory fallback; Kafka outbox publisher; FX passthrough adapter; Spring config wiring domain/application/outbound adapters. Contracts: docs/pricing-openapi.yaml (quote) and docs/pricing-asyncapi.yaml (pricing.updated). Testing: ArchUnit hexagonal guardrails; integration tests for gRPC, Redis cache, and JPA repository (Testcontainers); contract existence tests for OpenAPI/AsyncAPI.
- product-service domain: AbstractProductCard base entity with price/discount invariant and audit timestamps; Door and Window entities embed ConstructionSpecs; ConstructionSpecs aggregates Profile, Glass, Lamination; enums for currency, door type, glass type, opening direction; validation messages in resources.
- docs blueprint: GRACE contracts planned for catalog validation (CFG-VAL-RANGE/COMPAT/RESULT), pricing calculation (PRICE-BASE/OPTIONS/DISCOUNT/TAX), and order application (ORDER-VALIDATE/PERSIST/EVENT, PAY-CALLBACK-IDEMP/STATE/NOTIFY) anchored in DevelopmentPlan v2.0.
- gateway and config-server: Spring Boot starters present as scaffolding.
- gateway module implemented: GatewayApplication + configs (GatewayConfig routes, SecurityConfig, RateLimitConfig, CircuitBreakerConfig, CorsConfig), filters (CorrelationIdFilter, RequestLoggingFilter, AuthenticationLoggingFilter), fallback handler, logback JSON logging, application.yml/profile configs, and tests covering TC-GW/TC-SEC/TC-CORR/TC-ROUTE/TC-RATE; routes target lb:// services and rate limiting uses Redis with in-memory fallback.
- frontend/windows-store-client: Angular 21 app with SSR setup and extensive UI component libraries.
- services/cart-service: Application service (CartApplicationService) implemented with GRACE function contracts for cart CRUD, promo, merge, refresh, and snapshot flows; canonical logs + Kafka event publishing; added CartProperties and CartServiceConfig for cart settings and domain service beans; tests now include CartServiceTestFixture-driven domain/application coverage with TC-FUNC IDs, JPA slice tests, gRPC mapper/service integration tests, Spring Boot Testcontainers integration (Postgres/Redis/Kafka), and ArchUnit hexagonal checks. CartProperties now includes defaults.defaultCurrency and behavior.allowedProductFamilies, used in CartApplicationService for default currency and family validation. Removed unused MapStruct CartEntityMapper/CartIdMapper/MoneyMapper to unblock cart-service compilation.

## Patterns
- Security: OAuth2/OIDC JWT with BUYER/ADMIN/INSTALLER roles; method-level authorization expected.
- Observability: JSON logs with correlation IDs (traceId/spanId), OTEL tracing, Micrometer metrics with SLOs (quote <=200ms, checkout <=350ms).
- Config: cart/account/search configuration properties use record-based @ConfigurationProperties with nested records, null-safe defaults, and `kanokna.{service}` prefixes; search-service adds autocomplete/facets/defaults sections with default language/currency.
- CI: GitHub Actions baseline workflow (ci.yml) runs Maven build/test stages and CodeQL per TECH-ci-pipeline.
- CD: `.github/workflows/deploy-stage.yml` expects `KUBECONFIG_STAGE` secret to be base64-encoded kubeconfig; both deploy/verify jobs use environment `staging` so they can read Environment secrets and export `KUBECONFIG=$HOME/.kube/config`.
- Tests: config-server config endpoint tests are skipped under Spring Boot 4 placeholder (TECH-ASSUM-001) via JUnit Assumptions; re-enable when Spring Cloud Config is Boot 4 compatible.
- Tests: cart-service Testcontainers tests are gated with @EnabledIf + DockerAvailability; ArchUnit tests skip on Java 25 due to unsupported class file version.
- Tests/build: pricing-service gRPC tests can throw NoClassDefFoundError for proto classes if the local api-contracts jar is stale; rebuild api-contracts (or run service tests with -am) to refresh generated gRPC classes.
- Tests/build: api-contracts is a contracts-only library; Spring Cloud Contract verifier/plugin runs in producer services (not in api-contracts) to avoid MockMvc/test-context coupling in the library module.
- Tests/build: on Windows, `mvn clean verify -pl services/search-service -am` can fail early if `api-contracts/target` protobuf generated sources are locked; rerun after clearing locks or deleting `api-contracts/target` before the build.
- Search-service autocomplete: Elasticsearch completion suggester requires a mandatory `family` context; unfiltered autocomplete uses an empty-prefix context query to match all families.
- API: REST versioned at /api/v1 for catalog/pricing/cart/checkout; GraphQL schema for configurator queries; Kafka events for order/payment/installation lifecycle.
- Data rules: Monetary amounts BigDecimal with ISO currency; discountPrice must be null or <= actualPrice; dimensions for windows/doors enforced (width/height 50-500cm, 10mm step from requirements); lead times >0 for MTO; idempotency for payment callbacks.
- Notes: product-service still lacks service/controller layers; new blueprint extends to dedicated microservices and GRACE semantic anchors for future code generation.
