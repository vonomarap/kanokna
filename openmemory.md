# OpenMemory - Windows&Doors E-Commerce (kanokna-store)

## Overview
- Windows and doors e-commerce with configurable products, price preview, and lead-time promises for B2C/B2B buyers.
- Backend: Java 25 Spring Boot multi-module (config-server, gateway, shared-kernel, product-service) targeting MySQL with optional Redis/Elasticsearch/Kafka per technology guardrails.
- Frontend: Angular 21 client with SSR entrypoint (src/server.ts) and multiple UI component libraries (Material, Taiga, Spartan).
- Observability and security guardrails: OAuth2/OIDC JWT roles BUYER/ADMIN/INSTALLER, OTEL tracing, Micrometer metrics, JSON logs with correlation IDs.
- Architecture docs updated (RequirementsAnalysis v2.0, Technology v2.0, DevelopmentPlan v2.0) covering all services and flows (Flow-Config-Pricing, Flow-Cart-Checkout, Flow-Payment, Flow-Order-Lifecycle, Flow-Notifications, Flow-Reporting, Flow-Search-Experience).

## Architecture
- Backend modules (blueprint): config-server, gateway, shared-kernel, catalog-configuration-service, pricing-service, cart-service, order-service, account-service, media-service, notification-service, reporting-service, search-service; existing code still includes product-service scaffold.
- Patterns: hexagonal intent, Bean Validation on entities, JPA auditing hooks, enums for currency and product options, embeddables for shared specs.
- Data and integration: MySQL primary; Redis/Elasticsearch/Kafka planned; REST /api/v1 endpoints and GraphQL configurator schema; Kafka events order.created, payment.captured, installation.scheduled.
- Build and testing: Maven with Spring Boot BOM; JUnit 5 + Testcontainers; ArchUnit/mutation testing planned per Technology guardrails.
- Service-level docs added for catalog-configuration-service (docs/RequirementsAnalysis.xml, docs/Technology.xml, docs/DevelopmentPlan.xml) defining service scope, interfaces, flows (Flow-Validation, Flow-Publish, Flow-Bom), and contracts/anchors for validation and BOM resolution.
- Service-level docs added for product-service (docs/RequirementsAnalysis.xml, docs/Technology.xml, docs/DevelopmentPlan.xml) covering product master data use cases (create/update/publish, list/get), tech stack, hexagonal plan, flows (Flow-Read, Flow-Publish), domain invariants, and block anchors (PROD-PRICE-*, PROD-PUB-*).
- Shared-kernel docs added (docs/RequirementsAnalysis.xml, docs/Technology.xml, docs/DevelopmentPlan.xml) describing framework-free value objects/events, invariants, ArchUnit guardrails, and function anchors (MNY-VALIDATE/NORMALIZE, DIM-RANGE, ID-PARSE).
- Pricing-service initialized with module entry in parent POM, service docs (docs/RequirementsAnalysis.xml, docs/Technology.xml, docs/DevelopmentPlan.xml), and bootstrap class with MODULE_CONTRACT; flows and anchors defined (PRICE-BASE/OPTIONS/DISCOUNT/TAX).
- Cart-service initialized with parent POM entry, docs (docs/RequirementsAnalysis.xml, docs/Technology.xml, docs/DevelopmentPlan.xml), and bootstrap class with MODULE_CONTRACT; flows and anchors defined for cart add/update/abandon (CART-ADD-IDEMP/VALIDATE, CART-TOTAL-RECALC, CART-SHIP-VALIDATE).
- Order-service initialized with parent POM entry, docs (docs/RequirementsAnalysis.xml, docs/Technology.xml, docs/DevelopmentPlan.xml), and bootstrap class with MODULE_CONTRACT; flows and anchors for checkout/payments/lifecycle (ORDER-VALIDATE/PERSIST/EVENT, PAY-CALLBACK-IDEMP/STATE/NOTIFY).
- Account-service initialized with parent POM entry, docs (docs/RequirementsAnalysis.xml, docs/Technology.xml, docs/DevelopmentPlan.xml), and bootstrap class with MODULE_CONTRACT; flows and anchors for profile/address management (ACC-PROFILE-VALIDATE/APPLY, ACC-ADDR-VALIDATE/DEFAULT).
- Media-service initialized with parent POM entry, docs (docs/RequirementsAnalysis.xml, docs/Technology.xml, docs/DevelopmentPlan.xml), and bootstrap class with MODULE_CONTRACT; flows and anchors for upload/resolve (MEDIA-UPLOAD-VALIDATE/REGISTER, MEDIA-RESOLVE-FETCH/SIGN).
- Reporting-service initialized with parent POM entry, docs (docs/RequirementsAnalysis.xml, docs/Technology.xml, docs/DevelopmentPlan.xml), and bootstrap class with MODULE_CONTRACT; flows and anchors for ingestion/query/export (REPORT-INGEST-IDEMP/APPLY/CACHE, REPORT-QUERY-CACHE/DB).
- Notification-service initialized with parent POM entry, docs (docs/RequirementsAnalysis.xml, docs/Technology.xml, docs/DevelopmentPlan.xml), and bootstrap class with MODULE_CONTRACT; flows and anchors for event-driven sends (NOTIFY-RENDER, NOTIFY-SEND).
- Search-service initialized with parent POM entry, docs (docs/RequirementsAnalysis.xml, docs/Technology.xml, docs/DevelopmentPlan.xml), and bootstrap class with MODULE_CONTRACT; flows and anchors for search/autocomplete and ingestion (SEARCH-QUERY-CACHE/INDEX, SEARCH-AUTO-CACHE/INDEX).
- Installation-service initialized with parent POM entry, docs (docs/RequirementsAnalysis.xml, docs/Technology.xml, docs/DevelopmentPlan.xml), and bootstrap class with MODULE_CONTRACT; flows and anchors for slot booking/status (INSTALL-BOOK-IDEMP/CONFLICT/PERSIST, INSTALL-STATUS-VALIDATE/PERSIST).
- Root RA/Technology/DevelopmentPlan v2.0 now include installation scheduling use cases (UC-INSTALL-SLOT-SEARCH/BOOK/UPDATE), Flow-Installation, Technology entry SVC-installation-service, and mod.installation.domain contracts aligning root docs with installation-service behavior.
- order-service domain layer added: MODULE_MAP and pure domain models (Order aggregate with items/totals/shipping/installation, Payment value/aggregate, enums OrderStatus/PaymentStatus/PaymentMethod, Totals, OrderItem, ShippingInfo, InstallationInfo), DecisionTrace collector, domain events (OrderCreatedEvent, PaymentAppliedEvent), and OrderDomainService with FUNCTION_CONTRACTs and anchors ORDER-VALIDATE/ORDER-EVENT/PAY-STATE/PAY-NOTIFY enforcing currency/status rules and idempotent payment application. Application layer added: ports (CheckoutPort, PaymentPort, InstallationPort, OrderQueryPort, OrderRepository, PaymentRepository, PaymentGatewayPort, NotificationPublisher, OutboxPublisher, CartPort, PricingPort), DTOs (PlaceOrderCommand, OrderCreatedResponse, CartSnapshot, InitiatePaymentCommand, PaymentCallbackCommand, PaymentResult, ScheduleInstallationCommand, PaymentGatewaySession), and OrderApplicationService with MODULE_CONTRACT/anchors orchestrating checkout, payment initiation/callback, installation scheduling over domain services.
- order-service expanded: added JPA persistence adapters/entities (OrderJpaEntity with items/totals/shipping/install JSON, paidTotal; PaymentJpaEntity) with Flyway migration V1__orders.sql; Order/Payment mappers and JPA adapters replace in-memory repositories; Redis idempotency store (primary) with fallback in-memory; Kafka outbox publishers for order/payment and notifications; PaymentGateway stub adapter; enriched GET order response DTO. Added REST controllers for checkout and payment callbacks, OrderQueryService, OpenAPI/AsyncAPI specs, ArchUnit tests, contract existence tests, WebMvc controller smoke tests. Application wiring updated to inject idempotency and real adapters.

## User Defined Namespaces
- [Leave blank - user populates]

## Components
- shared/shared-kernel: Module contract added for shared primitives (Id, Email, Address, Money, LocalizedString, Dimensions, DomainEvent); function contracts for Money factories/arithmetics, LocalizedString.resolve, Id.of/random; Email and Address value objects with validation/canonicalization.
- services/catalog-configuration-service: Spring Boot shell with module contract; domain layer implemented with ProductTemplate aggregate (attribute groups/options, TemplateStatus, DimensionPolicy), CatalogVersion aggregate, compatibility ruleset, and BOM templates; domain services ConfigurationValidationService (CFG-VAL-RANGE/COMPAT/RESULT anchors) and BomResolutionService (BOM-RES-SELECT/MAP/EVENT anchors) emit ConfigurationValidatedEvent and BomResolvedEvent for adapters/outbox; application layer with QueryPort and ConfigurationApplicationService orchestrating validateConfiguration/resolveBom over ProductTemplateRepository, BomTemplateRepository, OutboxPublisher using APP-VAL-* and APP-BOM-* anchors and returning DTO responses; adapters layer added: REST controller (POST /api/v1/catalog/configurations/validate|resolve-bom) mapping to commands with HTTP logs, adapter DTOs, in-memory adapters for repositories/outbox/search/media, and Spring config wiring domain/application beans.
- services/pricing-service: Domain layer implemented with PriceBook aggregate (region/currency, base prices, option premiums, status/version), Campaign aggregate (status, percent discount, schedule), TaxRule, OptionPremiumKey, QuoteRequest/Quote/QuoteCalculationResult value objects, QuoteCalculatedEvent; domain service PriceCalculationService with FUNCTION_CONTRACT and block anchors PRICE-BASE/OPTIONS/DISCOUNT/TAX emitting DecisionTrace entries and QuoteCalculatedEvent, enforcing active price book and currency alignment. Application layer added with QuotePort, QuoteConfigurationCommand/QuoteResponse DTOs, and PriceApplicationService (anchors APP-QUOTE-LOAD/CACHE/DOMAIN/OUTBOX) orchestrating price book/campaign/tax loading, cache lookup, domain call, and outbox publish; out-port interfaces for repositories, cache, FX, outbox. Adapters layer added: REST controller (POST /api/v1/pricing/quote|quote/cart) mapping DTOs to commands and returning Money/DecisionTrace DTOs; in-memory adapters for price books, campaigns, tax rules, quote cache, outbox, FX; Spring config wiring domain/application. Contracts added: docs/pricing-openapi.yaml (quote endpoints) and docs/pricing-asyncapi.yaml (pricing.updated event). ArchUnit hexagonal guardrails in HexagonalArchitectureTest.
- services/pricing-service: Domain layer implemented with PriceBook aggregate (region/currency, base prices, option premiums, status/version), Campaign aggregate (status, percent discount, schedule), TaxRule, OptionPremiumKey, QuoteRequest/Quote/QuoteCalculationResult value objects, QuoteCalculatedEvent; domain service PriceCalculationService with FUNCTION_CONTRACT and block anchors PRICE-BASE/OPTIONS/DISCOUNT/TAX emitting DecisionTrace entries and QuoteCalculatedEvent, enforcing active price book and currency alignment. Application layer added with QuotePort, QuoteConfigurationCommand/QuoteResponse DTOs, and PriceApplicationService (anchors APP-QUOTE-LOAD/CACHE/DOMAIN/OUTBOX) orchestrating price book/campaign/tax loading, cache lookup, domain call, and outbox publish; admin layer via PriceAdminPort and AdminController for price books/campaigns/tax rules. Adapters layer: REST controller for quote + admin endpoints; JPA persistence adapters/entities for price books/campaigns/tax rules with Flyway migration; Redis quote cache adapter (primary) with in-memory fallback; Kafka outbox publisher; FX passthrough adapter; Spring config wiring domain/application/outbound adapters. Contracts: docs/pricing-openapi.yaml (quote) and docs/pricing-asyncapi.yaml (pricing.updated). Testing: ArchUnit hexagonal guardrails; contract existence tests for OpenAPI/AsyncAPI.
- product-service domain: AbstractProductCard base entity with price/discount invariant and audit timestamps; Door and Window entities embed ConstructionSpecs; ConstructionSpecs aggregates Profile, Glass, Lamination; enums for currency, door type, glass type, opening direction; validation messages in resources.
- docs blueprint: GRACE contracts planned for catalog validation (CFG-VAL-RANGE/COMPAT/RESULT), pricing calculation (PRICE-BASE/OPTIONS/DISCOUNT/TAX), and order application (ORDER-VALIDATE/PERSIST/EVENT, PAY-CALLBACK-IDEMP/STATE/NOTIFY) anchored in DevelopmentPlan v2.0.
- gateway and config-server: Spring Boot starters present as scaffolding.
- gateway updated: JWT issuer/JWK defaults set (Keycloak realm), security enabled by default with fail-fast if unset; readiness probes include Redis indicator; local profile disables rate limiter/security dependency on Redis. Correlation filter propagates X-Correlation-Id request/response headers; routes default to lb:// service URIs; WebFlux integration tests use WireMock plus Redis testcontainer (requires parent POM packaging resolution to run).
- frontend/windows-store-client: Angular 21 app with SSR setup and extensive UI component libraries.

## Patterns
- Security: OAuth2/OIDC JWT with BUYER/ADMIN/INSTALLER roles; method-level authorization expected.
- Observability: JSON logs with correlation IDs (traceId/spanId), OTEL tracing, Micrometer metrics with SLOs (quote <=200ms, checkout <=350ms).
- API: REST versioned at /api/v1 for catalog/pricing/cart/checkout; GraphQL schema for configurator queries; Kafka events for order/payment/installation lifecycle.
- Data rules: Monetary amounts BigDecimal with ISO currency; discountPrice must be null or <= actualPrice; dimensions for windows/doors enforced (width/height 50-500cm, 10mm step from requirements); lead times >0 for MTO; idempotency for payment callbacks.
- Notes: product-service still lacks service/controller layers; new blueprint extends to dedicated microservices and GRACE semantic anchors for future code generation.
