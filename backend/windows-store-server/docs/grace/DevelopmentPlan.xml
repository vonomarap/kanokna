<?xml version="1.0" encoding="UTF-8"?>
<!--
  GRACE Canonical Artifact: DevelopmentPlan.xml
  Purpose: Blueprint for implementation - services, flows, contracts, testing, deployment
  Version: 1.4.0
  Last Updated: 2026-01-02T00:00:00+00:00
  Changes:
    - v1.4.0: Added new services (workflow-service, field-ops-service, document-service, billing-service, support-service)
              Added development phases (0-4) with milestones and acceptance gates
              Added new flows (B2C-CPQ, Measurement-Visit, B2B-Project, Installation)
              Added integration contracts (CRM, CAD, ERP, Logistics, Payments)
              Updated order state machine with PAID and extended fulfillment states
              Added StatusModel anchor and audit trail block anchors
    - v1.3.0: Expanded pricing-service contracts (FC-pricing-*) and block anchors
    - v1.2.0: Added admin operation contracts
-->
<DevelopmentPlan version="1.4.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">

  <!-- ===============================================================================
       DEVELOPMENT PHASES
       =============================================================================== -->
  <Phases id="DevelopmentPhases">
    <Description>
      Phased delivery plan with acceptance gates. MUST/SHOULD/LATER priorities from
      RequirementsAnalysis.xml drive phase scope.
    </Description>

    <Phase id="PHASE-0" name="Foundation">
      <Description>Infrastructure, shared modules, and core plumbing</Description>
      <Priority>MUST</Priority>
      <Deliverables>
        <Deliverable id="PHASE-0-D1">shared-kernel module with domain primitives</Deliverable>
        <Deliverable id="PHASE-0-D2">api-contracts module with Protobuf schemas</Deliverable>
        <Deliverable id="PHASE-0-D3">config-server with profiles (dev/stage/prod)</Deliverable>
        <Deliverable id="PHASE-0-D4">gateway with JWT validation, routing, CORS</Deliverable>
        <Deliverable id="PHASE-0-D5">Docker Compose for local dev environment</Deliverable>
        <Deliverable id="PHASE-0-D6">CI/CD pipeline (GitHub Actions)</Deliverable>
      </Deliverables>
      <AcceptanceGates>
        <Gate id="PHASE-0-G1">All modules build successfully</Gate>
        <Gate id="PHASE-0-G2">Gateway routes to placeholder services</Gate>
        <Gate id="PHASE-0-G3">Config-server serves configuration</Gate>
        <Gate id="PHASE-0-G4">Docker Compose starts all infrastructure</Gate>
        <Gate id="PHASE-0-G5">CI pipeline runs tests and builds</Gate>
      </AcceptanceGates>
      <Links>
        <Link ref="DP-SVC-shared-kernel"/>
        <Link ref="DP-SVC-api-contracts"/>
        <Link ref="DP-SVC-gateway"/>
        <Link ref="DP-SVC-config-server"/>
      </Links>
    </Phase>

    <Phase id="PHASE-1" name="CPQ Core">
      <Description>B2C CPQ: Configure + Instant Pricing + Save Draft</Description>
      <Priority>MUST</Priority>
      <DependsOn>
        <PhaseRef ref="PHASE-0"/>
      </DependsOn>
      <Deliverables>
        <Deliverable id="PHASE-1-D1">catalog-configuration-service with product templates and validation rules</Deliverable>
        <Deliverable id="PHASE-1-D2">pricing-service with price books, campaigns, and quote calculation</Deliverable>
        <Deliverable id="PHASE-1-D3">account-service with user profiles and saved configurations</Deliverable>
        <Deliverable id="PHASE-1-D4">search-service with Elasticsearch indexing</Deliverable>
        <Deliverable id="PHASE-1-D5">gRPC contracts for catalog-pricing integration</Deliverable>
        <Deliverable id="PHASE-1-D6">Real-time configuration validation and pricing</Deliverable>
      </Deliverables>
      <AcceptanceGates>
        <Gate id="PHASE-1-G1">UC-B2C-CPQ-01 acceptance criteria met (AC-CPQ-01, AC-CPQ-02, AC-CPQ-03)</Gate>
        <Gate id="PHASE-1-G2">Configuration changes trigger price recalculation within 300ms</Gate>
        <Gate id="PHASE-1-G3">Drafts saved and resumed from authenticated account</Gate>
        <Gate id="PHASE-1-G4">Search returns products within 200ms P95</Gate>
        <Gate id="PHASE-1-G5">80% test coverage on domain layer</Gate>
      </AcceptanceGates>
      <Links>
        <Link ref="RequirementsAnalysis.xml#UC-B2C-CPQ-01"/>
        <Link ref="DP-SVC-catalog-configuration-service"/>
        <Link ref="DP-SVC-pricing-service"/>
      </Links>
    </Phase>

    <Phase id="PHASE-2" name="Measurement and Workflow">
      <Description>Measurement scheduling, workflow/CRM, and field operations</Description>
      <Priority>MUST</Priority>
      <DependsOn>
        <PhaseRef ref="PHASE-1"/>
      </DependsOn>
      <Deliverables>
        <Deliverable id="PHASE-2-D1">workflow-service with lead/deal pipeline and task management</Deliverable>
        <Deliverable id="PHASE-2-D2">field-ops-service with measurement task lifecycle</Deliverable>
        <Deliverable id="PHASE-2-D3">Measurement request scheduling from frontend</Deliverable>
        <Deliverable id="PHASE-2-D4">Mobile-friendly field task APIs</Deliverable>
        <Deliverable id="PHASE-2-D5">Measurement results trigger repricing</Deliverable>
        <Deliverable id="PHASE-2-D6">notification-service baseline (email/SMS for confirmations)</Deliverable>
        <Deliverable id="PHASE-2-D7">Status audit trail infrastructure</Deliverable>
      </Deliverables>
      <AcceptanceGates>
        <Gate id="PHASE-2-G1">UC-B2C-MEASURE-01 acceptance criteria met</Gate>
        <Gate id="PHASE-2-G2">UC-FIELD-MEASURE-01 acceptance criteria met</Gate>
        <Gate id="PHASE-2-G3">UC-STAFF-CRM-01 basic pipeline visible</Gate>
        <Gate id="PHASE-2-G4">Audit trail captures all status changes</Gate>
        <Gate id="PHASE-2-G5">Notifications sent for measurement confirmations</Gate>
      </AcceptanceGates>
      <Links>
        <Link ref="RequirementsAnalysis.xml#UC-B2C-MEASURE-01"/>
        <Link ref="RequirementsAnalysis.xml#UC-FIELD-MEASURE-01"/>
        <Link ref="RequirementsAnalysis.xml#UC-STAFF-CRM-01"/>
        <Link ref="DP-SVC-workflow-service"/>
        <Link ref="DP-SVC-field-ops-service"/>
      </Links>
    </Phase>

    <Phase id="PHASE-3" name="Ordering and Payments">
      <Description>B2C ordering with contract acceptance, payment, and order locking</Description>
      <Priority>MUST</Priority>
      <DependsOn>
        <PhaseRef ref="PHASE-2"/>
      </DependsOn>
      <Deliverables>
        <Deliverable id="PHASE-3-D1">cart-service with cart management and checkout preparation</Deliverable>
        <Deliverable id="PHASE-3-D2">order-service with full state machine including PAID status lock</Deliverable>
        <Deliverable id="PHASE-3-D3">Payment gateway integration with webhook handling</Deliverable>
        <Deliverable id="PHASE-3-D4">Contract acceptance recording</Deliverable>
        <Deliverable id="PHASE-3-D5">Order tracking with status timeline</Deliverable>
        <Deliverable id="PHASE-3-D6">document-service with proposal/invoice/contract generation</Deliverable>
        <Deliverable id="PHASE-3-D7">Notifications for payment and order status changes</Deliverable>
      </Deliverables>
      <AcceptanceGates>
        <Gate id="PHASE-3-G1">UC-B2C-ORDER-01 acceptance criteria met</Gate>
        <Gate id="PHASE-3-G2">UC-B2C-TRACK-01 acceptance criteria met</Gate>
        <Gate id="PHASE-3-G3">Post-payment orders are immutable (locked)</Gate>
        <Gate id="PHASE-3-G4">Payment webhooks update order status correctly</Gate>
        <Gate id="PHASE-3-G5">Documents generated from templates</Gate>
      </AcceptanceGates>
      <Links>
        <Link ref="RequirementsAnalysis.xml#UC-B2C-ORDER-01"/>
        <Link ref="RequirementsAnalysis.xml#UC-B2C-TRACK-01"/>
        <Link ref="DP-SVC-order-service"/>
        <Link ref="DP-SVC-cart-service"/>
        <Link ref="DP-SVC-document-service"/>
      </Links>
    </Phase>

    <Phase id="PHASE-4" name="Fulfillment and After-Sales">
      <Description>Installation, delivery tracking, B2B features, and after-sales support</Description>
      <Priority>MUST (installation, support) / SHOULD (delivery tracking, B2B finance)</Priority>
      <DependsOn>
        <PhaseRef ref="PHASE-3"/>
      </DependsOn>
      <Deliverables>
        <Deliverable id="PHASE-4-D1">Installation task lifecycle in field-ops-service</Deliverable>
        <Deliverable id="PHASE-4-D2">support-service for service/warranty requests</Deliverable>
        <Deliverable id="PHASE-4-D3">billing-service for B2B invoices and settlements (SHOULD)</Deliverable>
        <Deliverable id="PHASE-4-D4">Delivery tracking integration (SHOULD)</Deliverable>
        <Deliverable id="PHASE-4-D5">B2B project orders and partner pricing (MUST)</Deliverable>
        <Deliverable id="PHASE-4-D6">reporting-service with conversion funnel dashboards</Deliverable>
      </Deliverables>
      <AcceptanceGates>
        <Gate id="PHASE-4-G1">UC-FIELD-INSTALL-01 acceptance criteria met</Gate>
        <Gate id="PHASE-4-G2">UC-SUPPORT-CREATE-01 acceptance criteria met</Gate>
        <Gate id="PHASE-4-G3">UC-B2B-CPQ-01 basic flow working</Gate>
        <Gate id="PHASE-4-G4">Conversion funnel report available</Gate>
        <Gate id="PHASE-4-G5">UC-DELIVERY-TRACK-01 (SHOULD) if logistics integration available</Gate>
      </AcceptanceGates>
      <Links>
        <Link ref="RequirementsAnalysis.xml#UC-FIELD-INSTALL-01"/>
        <Link ref="RequirementsAnalysis.xml#UC-SUPPORT-CREATE-01"/>
        <Link ref="RequirementsAnalysis.xml#UC-B2B-CPQ-01"/>
        <Link ref="DP-SVC-field-ops-service"/>
        <Link ref="DP-SVC-support-service"/>
        <Link ref="DP-SVC-billing-service"/>
      </Links>
    </Phase>
  </Phases>

  <!-- ===============================================================================
       SERVICES & MODULES
       =============================================================================== -->
  <Services>
    <!-- ===========================================================================
         SHARED LIBRARIES
         =========================================================================== -->
    <Service id="DP-SVC-shared-kernel" type="library">
      <Name>shared-kernel</Name>
      <ArtifactId>shared-kernel</ArtifactId>
      <Description>
        Cross-service domain primitives: value objects, enums, domain event interface.
        Framework-free, pure Java.
      </Description>
      <BoundedContext>shared-kernel</BoundedContext>
      <Responsibilities>
        <Item>Money value object with currency-aware arithmetic</Item>
        <Item>DimensionsCm for product dimensions (50-400cm range)</Item>
        <Item>DomainEvent interface for event contracts</Item>
        <Item>LocalizedString for i18n content</Item>
        <Item>Address, Email, Id value objects</Item>
        <Item>Common enums (Language, etc.)</Item>
        <Item>StatusChangeRecord for audit trail</Item>
      </Responsibilities>
      <Dependencies>
        <Dependency type="compile">None (pure Java)</Dependency>
      </Dependencies>
      <Constraints>
        <Item>No Spring, JPA, Jackson, or framework dependencies</Item>
        <Item>Immutable value objects only</Item>
        <Item>No DTOs or API models</Item>
      </Constraints>
      <PackageLayout>
        <Package>com.kanokna.shared.core</Package>
        <Package>com.kanokna.shared.money</Package>
        <Package>com.kanokna.shared.measure</Package>
        <Package>com.kanokna.shared.event</Package>
        <Package>com.kanokna.shared.i18n</Package>
        <Package>com.kanokna.shared.audit</Package>
      </PackageLayout>
      <Links>
        <Link ref="RequirementsAnalysis.xml#NFR-MAINT-MODULARITY"/>
        <Link ref="Technology.xml#TECH-java"/>
      </Links>
    </Service>

    <Service id="DP-SVC-api-contracts" type="library">
      <Name>api-contracts</Name>
      <ArtifactId>api-contracts</ArtifactId>
      <Description>
        Contract-first specifications: OpenAPI for external REST APIs, Protobuf for
        gRPC inter-service communication and Kafka events.
      </Description>
      <BoundedContext>contracts</BoundedContext>
      <Responsibilities>
        <Item>OpenAPI 3.1 specs for external/public REST endpoints</Item>
        <Item>Protobuf service definitions for gRPC inter-service calls</Item>
        <Item>Protobuf message schemas for Kafka domain events</Item>
        <Item>AsyncAPI specs for Kafka topics (optional)</Item>
        <Item>Generated gRPC stubs and message classes</Item>
        <Item>Generated code confined to adapters (enforced via ArchUnit)</Item>
      </Responsibilities>
      <Dependencies>
        <Dependency type="compile">io.grpc:grpc-protobuf</Dependency>
        <Dependency type="compile">io.grpc:grpc-stub</Dependency>
        <Dependency type="compile">com.google.protobuf:protobuf-java</Dependency>
        <Dependency type="build">protobuf-maven-plugin</Dependency>
        <Dependency type="build">openapi-generator-maven-plugin</Dependency>
      </Dependencies>
      <Constraints>
        <Item>No Spring Boot runtime dependencies</Item>
        <Item>No JPA/Hibernate</Item>
        <Item>Domain layer MUST NOT depend on generated types</Item>
        <Item>gRPC stubs used only in adapters.out.grpc and adapters.in.grpc packages</Item>
      </Constraints>
      <ContractLocation>
        <OpenAPI>docs/api-contracts/openapi/</OpenAPI>
        <Protobuf>api-contracts/src/main/proto/</Protobuf>
      </ContractLocation>
      <GrpcServices>
        <Service name="CatalogConfigurationService">Configuration validation and product queries</Service>
        <Service name="PricingService">Quote calculation</Service>
        <Service name="CartService">Cart operations</Service>
        <Service name="AccountService">User profile queries</Service>
        <Service name="MediaService">Media metadata queries</Service>
        <Service name="WorkflowService">Lead/deal/task operations</Service>
        <Service name="FieldOpsService">Field task operations</Service>
        <Service name="DocumentService">Document generation</Service>
      </GrpcServices>
      <Links>
        <Link ref="Technology.xml#TECH-protobuf"/>
        <Link ref="Technology.xml#TECH-grpc"/>
        <Link ref="DevelopmentPlan.xml#ContractEvolutionPolicy"/>
      </Links>
    </Service>

    <!-- ===========================================================================
         INFRASTRUCTURE SERVICES
         =========================================================================== -->
    <Service id="DP-SVC-config-server" type="infrastructure">
      <Name>config-server</Name>
      <ArtifactId>config-server</ArtifactId>
      <Description>
        Centralized configuration management using Spring Cloud Config Server.
        Serves configuration to all services based on profile (dev/stage/prod).
      </Description>
      <BoundedContext>infrastructure</BoundedContext>
      <Responsibilities>
        <Item>Serve externalized configuration from Git or file system</Item>
        <Item>Support encryption of sensitive values</Item>
        <Item>Enable runtime config refresh</Item>
      </Responsibilities>
      <Dependencies>
        <Dependency type="compile">spring-cloud-config-server</Dependency>
      </Dependencies>
      <Port>8888</Port>
      <Links>
        <Link ref="Technology.xml#TECH-spring-cloud"/>
      </Links>
    </Service>

    <Service id="DP-SVC-gateway" type="infrastructure">
      <Name>gateway</Name>
      <ArtifactId>gateway</ArtifactId>
      <Description>
        API Gateway using Spring Cloud Gateway. Routes requests to backend services,
        handles authentication, rate limiting, and correlation ID injection.
      </Description>
      <BoundedContext>infrastructure</BoundedContext>
      <Responsibilities>
        <Item>Route requests to backend services based on path prefixes</Item>
        <Item>Validate JWT tokens (first line of defense)</Item>
        <Item>Inject correlation ID header for distributed tracing</Item>
        <Item>Apply rate limiting per client</Item>
        <Item>CORS handling</Item>
      </Responsibilities>
      <Dependencies>
        <Dependency type="compile">spring-cloud-starter-gateway</Dependency>
        <Dependency type="compile">spring-boot-starter-oauth2-resource-server</Dependency>
        <Dependency type="compile">spring-cloud-starter-circuitbreaker-reactor-resilience4j</Dependency>
      </Dependencies>
      <Port>8080</Port>
      <Routes>
        <Route path="/api/catalog/**" target="catalog-configuration-service"/>
        <Route path="/api/pricing/**" target="pricing-service"/>
        <Route path="/api/cart/**" target="cart-service"/>
        <Route path="/api/orders/**" target="order-service"/>
        <Route path="/api/accounts/**" target="account-service"/>
        <Route path="/api/media/**" target="media-service"/>
        <Route path="/api/search/**" target="search-service"/>
        <Route path="/api/workflow/**" target="workflow-service"/>
        <Route path="/api/field/**" target="field-ops-service"/>
        <Route path="/api/documents/**" target="document-service"/>
        <Route path="/api/billing/**" target="billing-service"/>
        <Route path="/api/support/**" target="support-service"/>
        <Route path="/api/reports/**" target="reporting-service"/>
      </Routes>
      <Links>
        <Link ref="Technology.xml#TECH-spring-cloud"/>
        <Link ref="RequirementsAnalysis.xml#NFR-SEC-AUTHENTICATION"/>
      </Links>
    </Service>

    <!-- ===========================================================================
         DOMAIN SERVICES - EXISTING
         =========================================================================== -->
    <Service id="DP-SVC-catalog-configuration-service" type="service">
      <Name>catalog-configuration-service</Name>
      <ArtifactId>catalog-configuration-service</ArtifactId>
      <Description>
        Manages product catalog (windows, doors), configuration options, and validation rules.
        Validates customer configurations against business rules.
      </Description>
      <BoundedContext>catalog-configuration</BoundedContext>
      <Responsibilities>
        <Item>CRUD for product templates (window types, door types)</Item>
        <Item>Define option groups (materials, glazing, colors, accessories)</Item>
        <Item>Define configuration rules (compatibility, constraints, dependencies)</Item>
        <Item>Validate configurations against rules</Item>
        <Item>Resolve BOM (bill of materials) for configurations</Item>
        <Item>Publish ProductTemplatePublishedEvent for search indexing</Item>
      </Responsibilities>
      <Dependencies>
        <ServiceRef ref="DP-SVC-shared-kernel" type="compile"/>
        <ServiceRef ref="DP-SVC-api-contracts" type="compile"/>
        <ServiceRef ref="DP-SVC-pricing-service" type="grpc">For price quotes during configuration</ServiceRef>
        <ServiceRef ref="DP-SVC-search-service" type="async">Publish events for indexing</ServiceRef>
        <ServiceRef ref="DP-SVC-media-service" type="grpc">Resolve media metadata</ServiceRef>
      </Dependencies>
      <Database>
        <Engine ref="Technology.xml#TECH-postgresql"/>
        <Schema>catalog_configuration</Schema>
      </Database>
      <Ports>
        <Port type="http">8081</Port>
        <Port type="grpc">9081</Port>
      </Ports>
      <PackageLayout>
        <Package>com.kanokna.catalog_configuration_service.domain.model</Package>
        <Package>com.kanokna.catalog_configuration_service.domain.service</Package>
        <Package>com.kanokna.catalog_configuration_service.domain.event</Package>
        <Package>com.kanokna.catalog_configuration_service.domain.exception</Package>
        <Package>com.kanokna.catalog_configuration_service.application.port.in</Package>
        <Package>com.kanokna.catalog_configuration_service.application.port.out</Package>
        <Package>com.kanokna.catalog_configuration_service.application.service</Package>
        <Package>com.kanokna.catalog_configuration_service.application.dto</Package>
        <Package>com.kanokna.catalog_configuration_service.adapters.in.web</Package>
        <Package>com.kanokna.catalog_configuration_service.adapters.in.grpc</Package>
        <Package>com.kanokna.catalog_configuration_service.adapters.out.persistence</Package>
        <Package>com.kanokna.catalog_configuration_service.adapters.out.grpc</Package>
        <Package>com.kanokna.catalog_configuration_service.adapters.out.kafka</Package>
        <Package>com.kanokna.catalog_configuration_service.adapters.config</Package>
      </PackageLayout>
      <Aggregates>
        <Aggregate name="ProductTemplate">Root for product definitions</Aggregate>
        <Aggregate name="ConfigurationRuleSet">Root for configuration rules</Aggregate>
        <Aggregate name="BomTemplate">Bill of materials template</Aggregate>
        <Aggregate name="CatalogVersion">Versioned catalog snapshot</Aggregate>
      </Aggregates>
      <DomainEvents>
        <Event name="ProductTemplatePublishedEvent">Triggers search indexing</Event>
        <Event name="CatalogVersionPublishedEvent">Triggers cache invalidation</Event>
        <Event name="ConfigurationValidatedEvent">Audit trail for validations</Event>
      </DomainEvents>
      <Links>
        <Link ref="RequirementsAnalysis.xml#UC-B2C-CPQ-01"/>
        <Link ref="RequirementsAnalysis.xml#UC-CATALOG-BROWSE"/>
      </Links>
    </Service>

    <Service id="DP-SVC-pricing-service" type="service">
      <Name>pricing-service</Name>
      <ArtifactId>pricing-service</ArtifactId>
      <Description>
        Calculates prices for product configurations including base price, option premiums,
        campaigns, discounts, partner tiers, and taxes. Supports multiple currencies.
      </Description>
      <BoundedContext>pricing</BoundedContext>
      <Responsibilities>
        <Item>Manage price books (base prices per product, per-m2 rates)</Item>
        <Item>Define option premiums (absolute or percentage)</Item>
        <Item>Manage campaigns and promotional discounts</Item>
        <Item>Support partner pricing tiers for B2B</Item>
        <Item>Configure tax rules per region</Item>
        <Item>Calculate quotes with decision trace for auditability</Item>
        <Item>Support installment schedule display (if configured)</Item>
      </Responsibilities>
      <Dependencies>
        <ServiceRef ref="DP-SVC-shared-kernel" type="compile"/>
        <ServiceRef ref="DP-SVC-api-contracts" type="compile"/>
      </Dependencies>
      <Database>
        <Engine ref="Technology.xml#TECH-postgresql"/>
        <Schema>pricing</Schema>
      </Database>
      <Cache ref="Technology.xml#TECH-redis">
        <Usage>Quote caching with 5-minute TTL</Usage>
      </Cache>
      <Ports>
        <Port type="http">8082</Port>
        <Port type="grpc">9082</Port>
      </Ports>
      <PackageLayout>
        <Package>com.kanokna.pricing_service.domain.model</Package>
        <Package>com.kanokna.pricing_service.domain.service</Package>
        <Package>com.kanokna.pricing_service.domain.event</Package>
        <Package>com.kanokna.pricing_service.domain.exception</Package>
        <Package>com.kanokna.pricing_service.application.port.in</Package>
        <Package>com.kanokna.pricing_service.application.port.out</Package>
        <Package>com.kanokna.pricing_service.application.service</Package>
        <Package>com.kanokna.pricing_service.application.dto</Package>
        <Package>com.kanokna.pricing_service.adapters.in.web</Package>
        <Package>com.kanokna.pricing_service.adapters.in.grpc</Package>
        <Package>com.kanokna.pricing_service.adapters.out.persistence</Package>
        <Package>com.kanokna.pricing_service.adapters.out.redis</Package>
        <Package>com.kanokna.pricing_service.adapters.config</Package>
      </PackageLayout>
      <Aggregates>
        <Aggregate name="PriceBook">Versioned price definitions</Aggregate>
        <Aggregate name="Campaign">Promotional campaigns</Aggregate>
        <Aggregate name="TaxRule">Regional tax configurations</Aggregate>
        <Aggregate name="Quote">Calculated price quote (transient)</Aggregate>
        <Aggregate name="PartnerPriceTier">B2B partner-specific pricing</Aggregate>
      </Aggregates>
      <DomainEvents>
        <Event name="QuoteCalculatedEvent">Audit trail for pricing decisions</Event>
        <Event name="PriceBookPublishedEvent">Cache invalidation</Event>
      </DomainEvents>
      <Links>
        <Link ref="RequirementsAnalysis.xml#UC-B2C-CPQ-01"/>
        <Link ref="RequirementsAnalysis.xml#UC-B2B-CPQ-01"/>
        <Link ref="RequirementsAnalysis.xml#UC-CPQ-PROMO-01"/>
      </Links>
    </Service>

    <Service id="DP-SVC-cart-service" type="service">
      <Name>cart-service</Name>
      <ArtifactId>cart-service</ArtifactId>
      <Description>
        Manages shopping carts for customers. Stores configured items with price snapshots,
        handles promo codes, and prepares cart for checkout.
      </Description>
      <BoundedContext>cart</BoundedContext>
      <Responsibilities>
        <Item>Create and manage carts (anonymous and authenticated)</Item>
        <Item>Add/update/remove configured items</Item>
        <Item>Validate configurations remain valid on cart operations</Item>
        <Item>Apply promo codes and recalculate totals</Item>
        <Item>Prepare cart snapshot for order creation</Item>
        <Item>Merge anonymous cart into authenticated cart on login</Item>
      </Responsibilities>
      <Dependencies>
        <ServiceRef ref="DP-SVC-shared-kernel" type="compile"/>
        <ServiceRef ref="DP-SVC-api-contracts" type="compile"/>
        <ServiceRef ref="DP-SVC-catalog-configuration-service" type="grpc"/>
        <ServiceRef ref="DP-SVC-pricing-service" type="grpc"/>
      </Dependencies>
      <Database>
        <Engine ref="Technology.xml#TECH-postgresql"/>
        <Schema>cart</Schema>
      </Database>
      <Ports>
        <Port type="http">8083</Port>
        <Port type="grpc">9083</Port>
      </Ports>
      <Links>
        <Link ref="RequirementsAnalysis.xml#UC-B2C-ORDER-01"/>
      </Links>
    </Service>

    <Service id="DP-SVC-order-service" type="service">
      <Name>order-service</Name>
      <ArtifactId>order-service</ArtifactId>
      <Description>
        Creates orders from carts, manages order lifecycle with extended state machine,
        handles payment integration, contract acceptance, and coordinates fulfillment.
      </Description>
      <BoundedContext>order</BoundedContext>
      <Responsibilities>
        <Item>Create orders from cart snapshots</Item>
        <Item>Manage extended order state machine with PAID status lock</Item>
        <Item>Record contract acceptance</Item>
        <Item>Integrate with payment gateway for authorization and capture</Item>
        <Item>Handle payment callbacks/webhooks</Item>
        <Item>Coordinate with field-ops-service for installation scheduling</Item>
        <Item>Publish order lifecycle events</Item>
        <Item>Maintain status audit trail</Item>
      </Responsibilities>
      <Dependencies>
        <ServiceRef ref="DP-SVC-shared-kernel" type="compile"/>
        <ServiceRef ref="DP-SVC-api-contracts" type="compile"/>
        <ServiceRef ref="DP-SVC-cart-service" type="grpc"/>
        <ServiceRef ref="DP-SVC-field-ops-service" type="async"/>
        <ServiceRef ref="DP-SVC-notification-service" type="async"/>
        <ExternalRef ref="INT-PAYMENTS">Payment gateway</ExternalRef>
      </Dependencies>
      <Database>
        <Engine ref="Technology.xml#TECH-postgresql"/>
        <Schema>orders</Schema>
      </Database>
      <Ports>
        <Port type="http">8084</Port>
        <Port type="grpc">9084</Port>
      </Ports>
      <PackageLayout>
        <Package>com.kanokna.order_service.domain.model</Package>
        <Package>com.kanokna.order_service.domain.service</Package>
        <Package>com.kanokna.order_service.domain.event</Package>
        <Package>com.kanokna.order_service.domain.exception</Package>
        <Package>com.kanokna.order_service.application.port.in</Package>
        <Package>com.kanokna.order_service.application.port.out</Package>
        <Package>com.kanokna.order_service.application.service</Package>
        <Package>com.kanokna.order_service.application.dto</Package>
        <Package>com.kanokna.order_service.adapters.in.web</Package>
        <Package>com.kanokna.order_service.adapters.in.listener</Package>
        <Package>com.kanokna.order_service.adapters.out.persistence</Package>
        <Package>com.kanokna.order_service.adapters.out.gateway</Package>
        <Package>com.kanokna.order_service.adapters.out.kafka</Package>
        <Package>com.kanokna.order_service.adapters.config</Package>
      </PackageLayout>
      <Aggregates>
        <Aggregate name="Order">Order aggregate with items, status, and contract acceptance</Aggregate>
        <Aggregate name="Payment">Payment authorization and capture</Aggregate>
        <Aggregate name="StatusAuditLog">Immutable audit records for status changes</Aggregate>
      </Aggregates>
      <DomainEvents>
        <Event name="OrderCreatedEvent">Triggers notification, workflow update</Event>
        <Event name="OrderPaidEvent">Order locked, ready for fulfillment</Event>
        <Event name="OrderInProductionEvent">Manufacturing started</Event>
        <Event name="OrderReadyToShipEvent">Production complete</Event>
        <Event name="OrderInTransitEvent">Out for delivery</Event>
        <Event name="OrderDeliveredEvent">Products delivered</Event>
        <Event name="OrderInstalledEvent">Installation complete</Event>
        <Event name="OrderCancelledEvent">Order cancelled</Event>
        <Event name="PaymentStatusChangedEvent">Payment status update</Event>
      </DomainEvents>
      <StateMachine id="OrderStateMachine">
        <Description>Extended order state machine with PAID lock and fulfillment stages</Description>
        <State name="CREATED" initial="true">Order placed, pending payment</State>
        <State name="PENDING_PAYMENT">Awaiting payment completion</State>
        <State name="PAID">Payment confirmed, order locked (immutable)</State>
        <State name="IN_PRODUCTION">Manufacturing started</State>
        <State name="READY_FOR_SHIPMENT">Production complete, ready to ship</State>
        <State name="IN_TRANSIT">Out for delivery</State>
        <State name="DELIVERED">Products delivered</State>
        <State name="INSTALLATION_SCHEDULED">Installation appointment set</State>
        <State name="INSTALLED" terminal="true">Installation complete</State>
        <State name="CANCELLED" terminal="true">Order cancelled</State>
        <Transition from="CREATED" to="PENDING_PAYMENT" event="PAYMENT_INITIATED"/>
        <Transition from="PENDING_PAYMENT" to="PAID" event="PAYMENT_CAPTURED">Locks order</Transition>
        <Transition from="PENDING_PAYMENT" to="CANCELLED" event="PAYMENT_FAILED"/>
        <Transition from="PAID" to="IN_PRODUCTION" event="PRODUCTION_STARTED"/>
        <Transition from="IN_PRODUCTION" to="READY_FOR_SHIPMENT" event="PRODUCTION_COMPLETE"/>
        <Transition from="READY_FOR_SHIPMENT" to="IN_TRANSIT" event="SHIPPED"/>
        <Transition from="IN_TRANSIT" to="DELIVERED" event="DELIVERED"/>
        <Transition from="DELIVERED" to="INSTALLATION_SCHEDULED" event="INSTALLATION_SCHEDULED"/>
        <Transition from="INSTALLATION_SCHEDULED" to="INSTALLED" event="INSTALLATION_COMPLETE"/>
        <Transition from="DELIVERED" to="INSTALLED" event="SELF_INSTALL_CONFIRMED"/>
        <Transition from="CREATED,PENDING_PAYMENT" to="CANCELLED" event="CANCELLED"/>
        <Constraint>After PAID status, order is immutable (no changes to items/prices)</Constraint>
      </StateMachine>
      <Links>
        <Link ref="RequirementsAnalysis.xml#UC-B2C-ORDER-01"/>
        <Link ref="RequirementsAnalysis.xml#UC-B2C-TRACK-01"/>
        <Link ref="RequirementsAnalysis.xml#StatusModel"/>
      </Links>
    </Service>

    <Service id="DP-SVC-account-service" type="service">
      <Name>account-service</Name>
      <ArtifactId>account-service</ArtifactId>
      <Description>
        Manages user profiles, addresses, preferences, saved configurations, and B2B organizations.
        Integrates with Keycloak for identity management.
      </Description>
      <BoundedContext>account</BoundedContext>
      <Responsibilities>
        <Item>Store user profiles (synced from Keycloak on first login)</Item>
        <Item>Manage delivery addresses</Item>
        <Item>Store user preferences (language, currency, notifications)</Item>
        <Item>Manage saved configurations for later</Item>
        <Item>B2B: organization profiles, sub-users, partner tier assignment</Item>
        <Item>Role domain assignment (B2C, B2B, Staff, Field)</Item>
      </Responsibilities>
      <Dependencies>
        <ServiceRef ref="DP-SVC-shared-kernel" type="compile"/>
        <ExternalRef ref="RequirementsAnalysis.xml#ACT-IDENTITY-PROVIDER">Keycloak</ExternalRef>
      </Dependencies>
      <Database>
        <Engine ref="Technology.xml#TECH-postgresql"/>
        <Schema>accounts</Schema>
      </Database>
      <Port>8085</Port>
      <Aggregates>
        <Aggregate name="UserProfile">User profile aggregate</Aggregate>
        <Aggregate name="SavedConfiguration">Saved product configurations (drafts)</Aggregate>
        <Aggregate name="PartnerOrganization">B2B organization profile</Aggregate>
      </Aggregates>
      <Links>
        <Link ref="RequirementsAnalysis.xml#UC-B2C-CPQ-01"/>
        <Link ref="RequirementsAnalysis.xml#UC-RBAC-01"/>
      </Links>
    </Service>

    <Service id="DP-SVC-media-service" type="service">
      <Name>media-service</Name>
      <ArtifactId>media-service</ArtifactId>
      <Description>
        Manages media assets: product images, renders, manuals, and operational documents.
        Stores metadata in database, actual files in S3-compatible storage.
      </Description>
      <BoundedContext>media</BoundedContext>
      <Responsibilities>
        <Item>Upload and store media assets</Item>
        <Item>Generate image variants (thumbnail, web, original)</Item>
        <Item>Serve media via presigned URLs or direct proxy</Item>
        <Item>Manage asset metadata (tags, descriptions, associations)</Item>
        <Item>Garbage collect orphaned assets</Item>
      </Responsibilities>
      <Dependencies>
        <ServiceRef ref="DP-SVC-shared-kernel" type="compile"/>
        <ExternalRef ref="Technology.xml#TECH-s3-compatible">Object storage</ExternalRef>
      </Dependencies>
      <Database>
        <Engine ref="Technology.xml#TECH-postgresql"/>
        <Schema>media</Schema>
      </Database>
      <Port>8087</Port>
      <Aggregates>
        <Aggregate name="MediaAsset">Asset metadata and variants</Aggregate>
      </Aggregates>
      <Links>
        <Link ref="RequirementsAnalysis.xml#UC-CATALOG-BROWSE"/>
      </Links>
    </Service>

    <Service id="DP-SVC-notification-service" type="service">
      <Name>notification-service</Name>
      <ArtifactId>notification-service</ArtifactId>
      <Description>
        Sends transactional notifications (email, SMS, push) based on domain events.
        Manages templates, localization, and delivery tracking.
      </Description>
      <BoundedContext>notification</BoundedContext>
      <Responsibilities>
        <Item>Subscribe to domain events from Kafka</Item>
        <Item>Manage notification templates with localization</Item>
        <Item>Render templates with event data</Item>
        <Item>Send via external providers (SendGrid, Twilio)</Item>
        <Item>Track delivery status</Item>
        <Item>Handle abandoned cart reminders (scheduled)</Item>
      </Responsibilities>
      <Dependencies>
        <ServiceRef ref="DP-SVC-shared-kernel" type="compile"/>
        <ExternalRef ref="RequirementsAnalysis.xml#ACT-NOTIFICATION-PROVIDER">Email/SMS providers</ExternalRef>
      </Dependencies>
      <Database>
        <Engine ref="Technology.xml#TECH-postgresql"/>
        <Schema>notifications</Schema>
      </Database>
      <Port>8088</Port>
      <NotificationEvents>
        <Event trigger="MeasurementRequestCreated">Confirmation to customer</Event>
        <Event trigger="MeasurementTaskAssigned">Notification to technician</Event>
        <Event trigger="OrderPaid">Order confirmation to customer</Event>
        <Event trigger="OrderInTransit">Shipping notification</Event>
        <Event trigger="OrderDelivered">Delivery confirmation</Event>
        <Event trigger="InstallationScheduled">Appointment confirmation</Event>
        <Event trigger="InstallationCompleted">Completion notification</Event>
        <Event trigger="ServiceRequestCreated">Support ticket confirmation</Event>
      </NotificationEvents>
      <Links>
        <Link ref="RequirementsAnalysis.xml#UC-B2C-TRACK-01"/>
      </Links>
    </Service>

    <Service id="DP-SVC-search-service" type="service">
      <Name>search-service</Name>
      <ArtifactId>search-service</ArtifactId>
      <Description>
        Provides full-text and faceted search over product catalog using Elasticsearch.
      </Description>
      <BoundedContext>search</BoundedContext>
      <Dependencies>
        <ServiceRef ref="DP-SVC-shared-kernel" type="compile"/>
        <ServiceRef ref="DP-SVC-catalog-configuration-service" type="async"/>
        <ExternalRef ref="Technology.xml#TECH-elasticsearch">Search engine</ExternalRef>
      </Dependencies>
      <Port>8089</Port>
      <Links>
        <Link ref="RequirementsAnalysis.xml#UC-CATALOG-BROWSE"/>
        <Link ref="RequirementsAnalysis.xml#NFR-PERF-SEARCH-LATENCY"/>
      </Links>
    </Service>

    <Service id="DP-SVC-reporting-service" type="service">
      <Name>reporting-service</Name>
      <ArtifactId>reporting-service</ArtifactId>
      <Description>
        Aggregates data for dashboards and reports including conversion funnel.
      </Description>
      <BoundedContext>reporting</BoundedContext>
      <Responsibilities>
        <Item>Consume domain events and build read models</Item>
        <Item>Provide sales, conversion, and product performance reports</Item>
        <Item>Support date range and dimension filters</Item>
        <Item>Export reports in CSV/Excel formats</Item>
      </Responsibilities>
      <Dependencies>
        <ServiceRef ref="DP-SVC-shared-kernel" type="compile"/>
        <ServiceRef ref="DP-SVC-order-service" type="async"/>
        <ServiceRef ref="DP-SVC-workflow-service" type="async"/>
      </Dependencies>
      <Database>
        <Engine ref="Technology.xml#TECH-postgresql"/>
        <Schema>reporting</Schema>
      </Database>
      <Port>8090</Port>
      <Reports>
        <Report name="ConversionFunnel">Lead -> Measurement -> Contract -> Paid -> Delivered -> Installed</Report>
        <Report name="SalesByChannel">B2C vs B2B revenue breakdown</Report>
        <Report name="ProductPerformance">Configuration popularity, average order value</Report>
        <Report name="OperationalMetrics">Lead time, installation SLA compliance</Report>
      </Reports>
      <Links>
        <Link ref="RequirementsAnalysis.xml#ACT-ADMIN"/>
      </Links>
    </Service>

    <!-- ===========================================================================
         NEW DOMAIN SERVICES
         =========================================================================== -->
    <Service id="DP-SVC-workflow-service" type="service">
      <Name>workflow-service</Name>
      <ArtifactId>workflow-service</ArtifactId>
      <Description>
        CRM-lite workflow for leads/deals/projects, tasks, reminders, and pipeline stages.
        Owns omnichannel lead capture and deal progression.
      </Description>
      <BoundedContext>sales-workflow</BoundedContext>
      <Responsibilities>
        <Item>Capture leads from website, telephony, messengers, offline</Item>
        <Item>Manage deal pipeline stages (New -> Consultation -> Measurement -> Quote -> Contract -> Converted)</Item>
        <Item>Create and track tasks/reminders for managers</Item>
        <Item>Create measurement/installation requests (delegates to field-ops-service)</Item>
        <Item>Provide Kanban/pipeline dashboard queries</Item>
        <Item>Sync with external CRM if configured</Item>
      </Responsibilities>
      <Dependencies>
        <ServiceRef ref="DP-SVC-shared-kernel" type="compile"/>
        <ServiceRef ref="DP-SVC-api-contracts" type="compile"/>
        <ServiceRef ref="DP-SVC-catalog-configuration-service" type="grpc"/>
        <ServiceRef ref="DP-SVC-pricing-service" type="grpc"/>
        <ServiceRef ref="DP-SVC-field-ops-service" type="grpc"/>
        <ServiceRef ref="DP-SVC-document-service" type="grpc"/>
        <ServiceRef ref="DP-SVC-notification-service" type="async"/>
        <ServiceRef ref="DP-SVC-reporting-service" type="async"/>
        <ExternalRef ref="INT-CRM-ERP">External CRM sync</ExternalRef>
      </Dependencies>
      <Database>
        <Engine ref="Technology.xml#TECH-postgresql"/>
        <Schema>workflow</Schema>
      </Database>
      <Ports>
        <Port type="http">8091</Port>
        <Port type="grpc">9091</Port>
      </Ports>
      <Aggregates>
        <Aggregate name="Lead">Initial customer inquiry</Aggregate>
        <Aggregate name="Deal">Qualified lead progressing through pipeline</Aggregate>
        <Aggregate name="Task">Manager task/reminder</Aggregate>
        <Aggregate name="PipelineStage">Configurable pipeline stages</Aggregate>
      </Aggregates>
      <DomainEvents>
        <Event name="LeadCreatedEvent">New lead intake</Event>
        <Event name="DealStageChangedEvent">Pipeline progression</Event>
        <Event name="TaskCreatedEvent">Task assigned</Event>
        <Event name="MeasurementRequestedEvent">Measurement visit requested</Event>
      </DomainEvents>
      <Links>
        <Link ref="RequirementsAnalysis.xml#UC-B2C-MEASURE-01"/>
        <Link ref="RequirementsAnalysis.xml#UC-STAFF-CRM-01"/>
        <Link ref="Flow-Measurement-Visit"/>
      </Links>
    </Service>

    <Service id="DP-SVC-field-ops-service" type="service">
      <Name>field-ops-service</Name>
      <ArtifactId>field-ops-service</ArtifactId>
      <Description>
        Field operations tasks: measurement visits, installation jobs, logistics/warehouse milestones.
        Provides mobile-friendly APIs for field staff.
      </Description>
      <BoundedContext>field-operations</BoundedContext>
      <Responsibilities>
        <Item>Create/assign/track measurement tasks</Item>
        <Item>Create/assign/track installation tasks</Item>
        <Item>Capture measurement results (dimensions, photos, notes)</Item>
        <Item>Capture installation completion (checklist, acceptance certificate, photos)</Item>
        <Item>Capture logistics milestones (ready-to-ship, in-transit, delivered)</Item>
        <Item>Provide "My Tasks" API for field staff mobile app</Item>
        <Item>Emit events to update deals and orders</Item>
      </Responsibilities>
      <Dependencies>
        <ServiceRef ref="DP-SVC-shared-kernel" type="compile"/>
        <ServiceRef ref="DP-SVC-api-contracts" type="compile"/>
        <ServiceRef ref="DP-SVC-order-service" type="grpc"/>
        <ServiceRef ref="DP-SVC-media-service" type="grpc"/>
        <ServiceRef ref="DP-SVC-notification-service" type="async"/>
        <ExternalRef ref="INT-LOGISTICS">Logistics integration</ExternalRef>
      </Dependencies>
      <Database>
        <Engine ref="Technology.xml#TECH-postgresql"/>
        <Schema>field_ops</Schema>
      </Database>
      <Ports>
        <Port type="http">8092</Port>
        <Port type="grpc">9092</Port>
      </Ports>
      <Aggregates>
        <Aggregate name="MeasurementTask">On-site measurement visit</Aggregate>
        <Aggregate name="InstallationTask">Installation job with checklist</Aggregate>
        <Aggregate name="LogisticsTask">Delivery/warehouse tasks</Aggregate>
      </Aggregates>
      <DomainEvents>
        <Event name="MeasurementTaskAssignedEvent">Task assigned to technician</Event>
        <Event name="MeasurementCompletedEvent">Measurements submitted</Event>
        <Event name="InstallationTaskAssignedEvent">Job assigned to installer</Event>
        <Event name="InstallationCompletedEvent">Installation done with acceptance</Event>
        <Event name="DeliveryStatusUpdatedEvent">Logistics milestone update</Event>
      </DomainEvents>
      <Links>
        <Link ref="RequirementsAnalysis.xml#UC-FIELD-MEASURE-01"/>
        <Link ref="RequirementsAnalysis.xml#UC-FIELD-INSTALL-01"/>
        <Link ref="Flow-Measurement-Visit"/>
      </Links>
    </Service>

    <Service id="DP-SVC-document-service" type="service">
      <Name>document-service</Name>
      <ArtifactId>document-service</ArtifactId>
      <Description>
        Document generation and versioning: proposals, invoices, contracts, acceptance certificates.
        Template-driven with placeholder bindings from order/deal/config data.
      </Description>
      <BoundedContext>documents</BoundedContext>
      <Responsibilities>
        <Item>Manage document templates (proposal, invoice, contract, acceptance)</Item>
        <Item>Generate documents from templates with data binding</Item>
        <Item>Version document history</Item>
        <Item>Store document binaries via media-service</Item>
        <Item>Support e-contract acceptance (checkbox or e-sign integration)</Item>
      </Responsibilities>
      <Dependencies>
        <ServiceRef ref="DP-SVC-shared-kernel" type="compile"/>
        <ServiceRef ref="DP-SVC-api-contracts" type="compile"/>
        <ServiceRef ref="DP-SVC-media-service" type="grpc"/>
        <ServiceRef ref="DP-SVC-order-service" type="grpc"/>
        <ServiceRef ref="DP-SVC-billing-service" type="grpc"/>
      </Dependencies>
      <Database>
        <Engine ref="Technology.xml#TECH-postgresql"/>
        <Schema>documents</Schema>
      </Database>
      <Ports>
        <Port type="http">8093</Port>
        <Port type="grpc">9093</Port>
      </Ports>
      <Aggregates>
        <Aggregate name="DocumentTemplate">Template with placeholders</Aggregate>
        <Aggregate name="GeneratedDocument">Document instance with version history</Aggregate>
      </Aggregates>
      <Links>
        <Link ref="RequirementsAnalysis.xml#UC-STAFF-CRM-01"/>
        <Link ref="RequirementsAnalysis.xml#UC-B2B-CPQ-01"/>
      </Links>
    </Service>

    <Service id="DP-SVC-billing-service" type="service">
      <Name>billing-service</Name>
      <ArtifactId>billing-service</ArtifactId>
      <Description>
        B2B billing: invoices, payment schedules, partner balances, settlements.
        Integrates with payment gateways for status updates.
      </Description>
      <BoundedContext>billing-finance</BoundedContext>
      <Responsibilities>
        <Item>Issue invoices for B2B orders</Item>
        <Item>Manage payment schedules (deposit, balance due)</Item>
        <Item>Track partner balances and credit indicators</Item>
        <Item>Generate settlement reports</Item>
        <Item>Receive payment status updates from gateways</Item>
      </Responsibilities>
      <Dependencies>
        <ServiceRef ref="DP-SVC-shared-kernel" type="compile"/>
        <ServiceRef ref="DP-SVC-api-contracts" type="compile"/>
        <ServiceRef ref="DP-SVC-notification-service" type="async"/>
        <ServiceRef ref="DP-SVC-reporting-service" type="async"/>
        <ExternalRef ref="INT-PAYMENTS">Payment gateway</ExternalRef>
      </Dependencies>
      <Database>
        <Engine ref="Technology.xml#TECH-postgresql"/>
        <Schema>billing</Schema>
      </Database>
      <Ports>
        <Port type="http">8094</Port>
        <Port type="grpc">9094</Port>
      </Ports>
      <Aggregates>
        <Aggregate name="Invoice">B2B invoice</Aggregate>
        <Aggregate name="PaymentSchedule">Deposit and balance schedule</Aggregate>
        <Aggregate name="PartnerBalance">Partner financial status</Aggregate>
      </Aggregates>
      <DomainEvents>
        <Event name="InvoiceIssuedEvent">Invoice created</Event>
        <Event name="PaymentReceivedEvent">Payment status update</Event>
      </DomainEvents>
      <Links>
        <Link ref="RequirementsAnalysis.xml#UC-B2B-CPQ-01"/>
      </Links>
    </Service>

    <Service id="DP-SVC-support-service" type="service">
      <Name>support-service</Name>
      <ArtifactId>support-service</ArtifactId>
      <Description>
        After-sales support: service requests, warranty claims, issue tracking.
        Links requests to orders and tracks SLA/status.
      </Description>
      <BoundedContext>after-sales-support</BoundedContext>
      <Responsibilities>
        <Item>Create service requests linked to orders</Item>
        <Item>Track request status and SLA</Item>
        <Item>Store communication history</Item>
        <Item>Optionally integrate with external service desk</Item>
      </Responsibilities>
      <Dependencies>
        <ServiceRef ref="DP-SVC-shared-kernel" type="compile"/>
        <ServiceRef ref="DP-SVC-api-contracts" type="compile"/>
        <ServiceRef ref="DP-SVC-order-service" type="grpc"/>
        <ServiceRef ref="DP-SVC-media-service" type="grpc"/>
        <ServiceRef ref="DP-SVC-notification-service" type="async"/>
      </Dependencies>
      <Database>
        <Engine ref="Technology.xml#TECH-postgresql"/>
        <Schema>support</Schema>
      </Database>
      <Ports>
        <Port type="http">8095</Port>
        <Port type="grpc">9095</Port>
      </Ports>
      <Aggregates>
        <Aggregate name="ServiceRequest">Service/warranty request</Aggregate>
        <Aggregate name="Communication">Message thread on request</Aggregate>
      </Aggregates>
      <DomainEvents>
        <Event name="ServiceRequestCreatedEvent">Request submitted</Event>
        <Event name="ServiceRequestResolvedEvent">Issue resolved</Event>
      </DomainEvents>
      <Links>
        <Link ref="RequirementsAnalysis.xml#UC-SUPPORT-CREATE-01"/>
      </Links>
    </Service>
  </Services>

  <!-- ===============================================================================
       FLOWS
       =============================================================================== -->
  <Flows>
    <Flow id="Flow-B2C-CPQ">
      <Name>B2C CPQ: Configure + Instant Price + Save Draft</Name>
      <Description>Customer configures product, receives instant pricing, and saves draft</Description>
      <Sequence>
        <Step order="1" from="frontend" to="gateway">Load product template</Step>
        <Step order="2" from="gateway" to="catalog-configuration-service">Get product template with options</Step>
        <Step order="3" from="frontend" to="gateway">Submit configuration for validation</Step>
        <Step order="4" from="gateway" to="catalog-configuration-service">Validate configuration</Step>
        <Step order="5" from="catalog-configuration-service" to="pricing-service">Calculate price quote</Step>
        <Step order="6" from="pricing-service" to="catalog-configuration-service">Return Quote with promos</Step>
        <Step order="7" from="catalog-configuration-service" to="frontend">Return validated config with price</Step>
        <Step order="8" from="frontend" to="account-service">Save draft configuration (if authenticated)</Step>
      </Sequence>
      <PerformanceRequirement>Price recalculation within 300ms of user input</PerformanceRequirement>
      <Links>
        <Link ref="RequirementsAnalysis.xml#UC-B2C-CPQ-01"/>
        <Link ref="RequirementsAnalysis.xml#NFR-PERF-CPQ-RECALC"/>
      </Links>
    </Flow>

    <Flow id="Flow-Measurement-Visit">
      <Name>Measurement Request and Visit Flow</Name>
      <Description>Customer requests measurement; task created; technician completes; repricing triggered</Description>
      <Sequence>
        <Step order="1" from="frontend" to="workflow-service">Request measurement with address + slot</Step>
        <Step order="2" from="workflow-service" to="field-ops-service">Create measurement task</Step>
        <Step order="3" from="field-ops-service" to="notification-service">Notify technician + customer</Step>
        <Step order="4" from="field-app" to="field-ops-service">Technician submits measurements/photos</Step>
        <Step order="5" from="field-ops-service" to="workflow-service">Emit MEASUREMENT_COMPLETED event</Step>
        <Step order="6" from="workflow-service" to="pricing-service">Recalculate with measured dimensions</Step>
        <Step order="7" from="workflow-service" to="notification-service">Notify customer of updated quote</Step>
      </Sequence>
      <Links>
        <Link ref="RequirementsAnalysis.xml#UC-B2C-MEASURE-01"/>
        <Link ref="RequirementsAnalysis.xml#UC-FIELD-MEASURE-01"/>
      </Links>
    </Flow>

    <Flow id="Flow-Checkout-Payment">
      <Name>Checkout, Contract Acceptance, and Payment</Name>
      <Description>Customer checks out, accepts contract, pays, and order is locked</Description>
      <Sequence>
        <Step order="1" from="frontend" to="cart-service">Get cart for checkout</Step>
        <Step order="2" from="cart-service" to="pricing-service">Verify current prices</Step>
        <Step order="3" from="frontend" to="order-service">Create order from cart</Step>
        <Step order="4" from="order-service" to="database">Persist order with CREATED status</Step>
        <Step order="5" from="frontend" to="order-service">Accept contract terms</Step>
        <Step order="6" from="order-service" to="database">Record contract acceptance</Step>
        <Step order="7" from="order-service" to="payment-gateway">Initiate payment</Step>
        <Step order="8" from="payment-gateway" to="frontend">Redirect to payment form</Step>
        <Step order="9" from="payment-gateway" to="order-service">Webhook: payment captured</Step>
        <Step order="10" from="order-service" to="database">Update to PAID status (lock order)</Step>
        <Step order="11" from="order-service" to="kafka">Publish OrderPaidEvent</Step>
        <Step order="12" from="notification-service" to="customer">Send order confirmation</Step>
      </Sequence>
      <AlternateFlows>
        <Flow trigger="Payment fails">
          <Step>order-service receives failure webhook</Step>
          <Step>Order remains in PENDING_PAYMENT or moves to CANCELLED</Step>
          <Step>Customer notified of failure</Step>
        </Flow>
      </AlternateFlows>
      <Links>
        <Link ref="RequirementsAnalysis.xml#UC-B2C-ORDER-01"/>
      </Links>
    </Flow>

    <Flow id="Flow-Order-Fulfillment">
      <Name>Order Fulfillment through Installation</Name>
      <Description>Order progresses from PAID through production, delivery, and installation</Description>
      <Sequence>
        <Step order="1" from="order-service" to="kafka">Order in PAID status</Step>
        <Step order="2" from="external/ERP" to="order-service">Production started</Step>
        <Step order="3" from="order-service" to="database">Update to IN_PRODUCTION</Step>
        <Step order="4" from="external/ERP" to="order-service">Production complete</Step>
        <Step order="5" from="order-service" to="database">Update to READY_FOR_SHIPMENT</Step>
        <Step order="6" from="field-ops-service" to="order-service">Shipment dispatched</Step>
        <Step order="7" from="order-service" to="database">Update to IN_TRANSIT</Step>
        <Step order="8" from="field-ops-service" to="order-service">Delivery confirmed</Step>
        <Step order="9" from="order-service" to="database">Update to DELIVERED</Step>
        <Step order="10" from="workflow-service" to="field-ops-service">Schedule installation</Step>
        <Step order="11" from="field-ops-service" to="order-service">Installation task created</Step>
        <Step order="12" from="order-service" to="database">Update to INSTALLATION_SCHEDULED</Step>
        <Step order="13" from="field-app" to="field-ops-service">Installation completed</Step>
        <Step order="14" from="field-ops-service" to="order-service">Emit InstallationCompletedEvent</Step>
        <Step order="15" from="order-service" to="database">Update to INSTALLED</Step>
      </Sequence>
      <AuditRequirement>Each status transition creates immutable audit record</AuditRequirement>
      <Links>
        <Link ref="RequirementsAnalysis.xml#UC-B2C-TRACK-01"/>
        <Link ref="RequirementsAnalysis.xml#UC-FIELD-INSTALL-01"/>
        <Link ref="RequirementsAnalysis.xml#StatusModel"/>
      </Links>
    </Flow>

    <Flow id="Flow-B2B-Project-Order">
      <Name>B2B Project Order with Partner Pricing</Name>
      <Description>Dealer creates project order with batch items, partner pricing, and documents</Description>
      <Sequence>
        <Step order="1" from="frontend" to="order-service">Create order from cart</Step>
        <Step order="2" from="order-service" to="cart-service">Get cart snapshot</Step>
        <Step order="3" from="order-service" to="database">Create Order with CREATED status</Step>
        <Step order="4" from="order-service" to="payment-gateway">Initiate payment session</Step>
        <Step order="5" from="payment-gateway" to="frontend">Redirect to payment form</Step>
        <Step order="6" from="frontend" to="payment-gateway">Customer submits payment</Step>
        <Step order="7" from="payment-gateway" to="order-service">Webhook: payment authorized</Step>
        <Step order="8" from="order-service" to="payment-gateway">Capture payment</Step>
        <Step order="9" from="order-service" to="database">Update Order to CONFIRMED</Step>
        <Step order="10" from="order-service" to="kafka">Publish OrderCreatedEvent</Step>
        <Step order="11" from="notification-service" to="customer">Send order confirmation email</Step>
      </Sequence>
      <AlternateFlows>
        <Flow trigger="Payment fails">
          <Step order="7a">payment-gateway returns failure</Step>
          <Step order="7b">order-service marks order as CANCELLED</Step>
          <Step order="7c">frontend displays payment error</Step>
        </Flow>
      </AlternateFlows>
      <Links>
        <Link ref="RequirementsAnalysis.xml#UC-ORDER-PLACE"/>
      </Links>
    </Flow>

    <Flow id="Flow-Order-Lifecycle">
      <Name>Order Lifecycle Flow</Name>
      <Description>Order progresses through states from creation to completion</Description>
      <Sequence>
        <Step order="1" from="order-service" to="kafka">OrderCreatedEvent</Step>
        <Step order="2" from="installation-service" to="order-service">Schedule installation if requested</Step>
        <Step order="3" from="order-service" to="kafka">Order moves to PROCESSING</Step>
        <Step order="4" from="logistics-system" to="order-service">Order shipped (external trigger)</Step>
        <Step order="5" from="order-service" to="kafka">OrderShippedEvent</Step>
        <Step order="6" from="notification-service" to="customer">Send shipping notification</Step>
        <Step order="7" from="logistics-system" to="order-service">Order delivered (external trigger)</Step>
        <Step order="8" from="order-service" to="kafka">OrderDeliveredEvent</Step>
        <Step order="9" from="installation-service" to="order-service">Installation completed</Step>
        <Step order="10" from="order-service" to="kafka">OrderCompletedEvent</Step>
      </Sequence>
      <Links>
        <Link ref="RequirementsAnalysis.xml#UC-ORDER-TRACK"/>
        <Link ref="DP-SVC-order-service"/>
      </Links>
    </Flow>

    <Flow id="Flow-Event-Driven">
      <Name>Asynchronous Event-Driven Communication</Name>
      <Description>Services communicate asynchronously via Kafka domain events</Description>
      <Producers>
        <Producer service="catalog-configuration-service" events="ProductTemplatePublishedEvent, CatalogVersionPublishedEvent"/>
        <Producer service="pricing-service" events="QuoteCalculatedEvent, PriceBookPublishedEvent"/>
        <Producer service="order-service" events="OrderCreatedEvent, OrderPaidEvent, OrderInProductionEvent, OrderDeliveredEvent, OrderInstalledEvent, OrderCancelledEvent"/>
        <Producer service="workflow-service" events="LeadCreatedEvent, DealStageChangedEvent, MeasurementRequestedEvent"/>
        <Producer service="field-ops-service" events="MeasurementCompletedEvent, InstallationCompletedEvent, DeliveryStatusUpdatedEvent"/>
        <Producer service="billing-service" events="InvoiceIssuedEvent, PaymentReceivedEvent"/>
        <Producer service="support-service" events="ServiceRequestCreatedEvent, ServiceRequestResolvedEvent"/>
      </Producers>
      <Consumers>
        <Consumer service="search-service" events="ProductTemplatePublishedEvent"/>
        <Consumer service="notification-service" events="OrderPaidEvent, MeasurementCompletedEvent, InstallationCompletedEvent, ServiceRequestCreatedEvent"/>
        <Consumer service="reporting-service" events="OrderPaidEvent, OrderInstalledEvent, LeadCreatedEvent, DealStageChangedEvent"/>
        <Consumer service="order-service" events="InstallationCompletedEvent, DeliveryStatusUpdatedEvent, PaymentReceivedEvent"/>
        <Consumer service="workflow-service" events="MeasurementCompletedEvent, OrderPaidEvent"/>
      </Consumers>
      <Links>
        <Link ref="Technology.xml#TECH-kafka"/>
      </Links>
    </Flow>
  </Flows>

  <!-- ===============================================================================
       INTEGRATION CONTRACTS
       =============================================================================== -->
  <Integrations>
    <Integration id="INT-CRM-ERP">
      <Name>CRM/ERP Integration</Name>
      <Type>bidirectional</Type>
      <Description>Sync leads, deals, tasks, and order statuses with external CRM/ERP</Description>
      <OutboundEvents>
        <Event name="LeadCreatedEvent">Sent when new lead captured</Event>
        <Event name="DealStageChangedEvent">Sent when pipeline stage changes</Event>
        <Event name="TaskCreatedEvent">Sent when task created</Event>
        <Event name="OrderStatusChangedEvent">Sent when order status changes</Event>
      </OutboundEvents>
      <InboundEvents>
        <Event name="OrderProductionStatusUpdate">Received from ERP for production milestones</Event>
      </InboundEvents>
      <SourceOfTruth>
        <Field name="Lead/Deal stages">Our system (primary)</Field>
        <Field name="Production status">TBD - see DEC-OPEN-STATUS-SOT</Field>
      </SourceOfTruth>
      <ImplementingService ref="DP-SVC-workflow-service"/>
      <Links>
        <Link ref="RequirementsAnalysis.xml#INT-REQ-CRM"/>
      </Links>
    </Integration>

    <Integration id="INT-CAD">
      <Name>CAD/CPQ Integration</Name>
      <Type>sync-request</Type>
      <Description>Feasibility validation, drawing generation, visualization</Description>
      <Operations>
        <Operation name="validateFeasibility">
          <Input>Configuration spec (dimensions, materials, options)</Input>
          <Output>Feasibility result (pass/fail with reasons)</Output>
          <SLA>TBD - see DEC-OPEN-CAD-FORMAT</SLA>
        </Operation>
        <Operation name="generateDrawing">
          <Input>Configuration spec</Input>
          <Output>Drawing files (PDF, DXF)</Output>
        </Operation>
        <Operation name="getVisualization">
          <Input>Configuration spec</Input>
          <Output>Image/3D model URL</Output>
        </Operation>
      </Operations>
      <ImplementingService ref="DP-SVC-catalog-configuration-service"/>
      <Links>
        <Link ref="RequirementsAnalysis.xml#INT-REQ-CAD"/>
      </Links>
    </Integration>

    <Integration id="INT-ERP">
      <Name>ERP/Manufacturing Integration</Name>
      <Type>bidirectional</Type>
      <Description>Order sync and production status updates</Description>
      <OutboundEvents>
        <Event name="OrderPaidEvent">Order ready for production</Event>
      </OutboundEvents>
      <InboundEvents>
        <Event name="ProductionStarted">Manufacturing began</Event>
        <Event name="ProductionComplete">Ready for shipment</Event>
      </InboundEvents>
      <SourceOfTruth>
        <Field name="Production stages">ERP (likely) - see DEC-OPEN-STATUS-SOT</Field>
      </SourceOfTruth>
      <ImplementingService ref="DP-SVC-order-service"/>
      <Links>
        <Link ref="RequirementsAnalysis.xml#INT-REQ-ERP"/>
      </Links>
    </Integration>

    <Integration id="INT-LOGISTICS">
      <Name>Logistics/Delivery Integration</Name>
      <Type>bidirectional</Type>
      <Description>Route planning, tracking, proof of delivery</Description>
      <OutboundEvents>
        <Event name="DeliveryRequested">Delivery address and items</Event>
      </OutboundEvents>
      <InboundEvents>
        <Event name="ShipmentDispatched">In transit</Event>
        <Event name="DeliveryCompleted">Delivered with proof</Event>
        <Event name="DeliveryException">Failed delivery attempt</Event>
      </InboundEvents>
      <ImplementingService ref="DP-SVC-field-ops-service"/>
      <Links>
        <Link ref="RequirementsAnalysis.xml#INT-REQ-LOGISTICS"/>
        <Link ref="RequirementsAnalysis.xml#UC-DELIVERY-TRACK-01"/>
      </Links>
    </Integration>

    <Integration id="INT-PAYMENTS">
      <Name>Payment Gateway Integration</Name>
      <Type>sync-request + webhook</Type>
      <Description>Payment initiation and webhook status updates</Description>
      <Operations>
        <Operation name="initiatePayment">
          <Input>Amount, currency, order reference, return URLs</Input>
          <Output>Payment session URL or token</Output>
        </Operation>
        <Operation name="capturePayment">
          <Input>Payment ID</Input>
          <Output>Capture result</Output>
        </Operation>
        <Operation name="refundPayment">
          <Input>Payment ID, amount</Input>
          <Output>Refund result</Output>
        </Operation>
      </Operations>
      <Webhooks>
        <Webhook event="payment.succeeded">Payment captured successfully</Webhook>
        <Webhook event="payment.failed">Payment failed</Webhook>
        <Webhook event="refund.succeeded">Refund processed</Webhook>
      </Webhooks>
      <Security>
        <Item>Webhook signature verification required</Item>
        <Item>No card data stored (PCI on provider)</Item>
        <Item>Payment tokens used for references</Item>
      </Security>
      <ImplementingService ref="DP-SVC-order-service"/>
      <ImplementingService ref="DP-SVC-billing-service"/>
      <Links>
        <Link ref="RequirementsAnalysis.xml#INT-REQ-PAYMENTS"/>
        <Link ref="RequirementsAnalysis.xml#NFR-SEC-PAYMENT"/>
      </Links>
    </Integration>
  </Integrations>

  <!-- ===============================================================================
       CONTRACT EVOLUTION POLICY
       =============================================================================== -->
  <ContractEvolutionPolicy id="ContractEvolutionPolicy">
    <REST>
      <Versioning>URL path versioning (/api/v1/, /api/v2/)</Versioning>
      <Deprecation>6-month deprecation window with Sunset header</Deprecation>
      <CompatibilityRules>
        <Rule>Adding optional fields is backward compatible</Rule>
        <Rule>Removing required fields requires new version</Rule>
        <Rule>Changing field types requires new version</Rule>
      </CompatibilityRules>
    </REST>
    <Events>
      <SchemaFormat>Protobuf</SchemaFormat>
      <Registry>Confluent Schema Registry or equivalent</Registry>
      <CompatibilityMode>BACKWARD</CompatibilityMode>
      <CompatibilityRules>
        <Rule>Add optional fields only; never remove or rename</Rule>
        <Rule>Use reserved field numbers for deprecated fields</Rule>
        <Rule>Event type name includes version if breaking change required (e.g., OrderCreatedEventV2)</Rule>
      </CompatibilityRules>
    </Events>
    <ContractTesting>
      <Tools>
        <Tool>OpenAPI contract validation (spectral)</Tool>
        <Tool>Protobuf compatibility checks (buf)</Tool>
        <Tool>Spring Cloud Contract or Pact (optional for consumer-driven contracts)</Tool>
      </Tools>
      <Policy>Contract tests run in CI before merge</Policy>
    </ContractTesting>
    <Links>
      <Link ref="Technology.xml#TECH-protobuf"/>
      <Link ref="Technology.xml#TECH-contract-testing"/>
    </Links>
  </ContractEvolutionPolicy>

  <!-- ===============================================================================
       TESTING STRATEGY
       =============================================================================== -->
  <TestingStrategy id="TestingStrategy">
    <TestingPyramid>
      <Layer name="Unit" percentage="70">
        <Description>Domain logic, services, validators</Description>
        <Tools>JUnit 5, Mockito, AssertJ</Tools>
        <Coverage>80% minimum for domain and application layers</Coverage>
      </Layer>
      <Layer name="Slice" percentage="15">
        <Description>Layer-specific tests (web, persistence)</Description>
        <Tools>@WebMvcTest, @DataJpaTest, @JsonTest</Tools>
        <Scope>Controller request/response, repository queries</Scope>
      </Layer>
      <Layer name="Integration" percentage="10">
        <Description>Full stack with real dependencies</Description>
        <Tools>Testcontainers (PostgreSQL, Kafka, Redis, Elasticsearch)</Tools>
        <Scope>End-to-end service flows, event publishing/consuming</Scope>
      </Layer>
      <Layer name="Contract" percentage="5">
        <Description>API and event contract validation</Description>
        <Tools>OpenAPI validators, Schema Registry compatibility checks</Tools>
        <Scope>Producer/consumer contract alignment</Scope>
      </Layer>
    </TestingPyramid>
    <AdditionalTesting>
    <ArchitectureTests>
      <Tool>ArchUnit</Tool>
      <Rules>
        <Rule>Domain layer has no Spring/JPA dependencies</Rule>
        <Rule>Application layer has no adapter dependencies</Rule>
        <Rule>Adapters implement port interfaces</Rule>
          <Rule>No cyclic dependencies between packages</Rule>
      </Rules>
    </ArchitectureTests>
      <MutationTesting enabled="optional">
        <Tool>Pitest</Tool>
        <Scope>Critical domain logic (pricing, configuration validation)</Scope>
      </MutationTesting>
      <PerformanceTesting>
        <Tool>Gatling or k6</Tool>
        <Scope>Load testing for P95 latency validation</Scope>
      </PerformanceTesting>
    </AdditionalTesting>
    <Links>
      <Link ref="RequirementsAnalysis.xml#NFR-MAINT-TESTABILITY"/>
      <Link ref="Technology.xml#TECH-testcontainers"/>
      <Link ref="Technology.xml#TECH-archunit"/>
    </Links>
  </TestingStrategy>

  <!-- ===============================================================================
       DEPLOYMENT STRATEGY
       =============================================================================== -->
  <Deployment id="Deployment-Overview">
    <Environments>
      <Environment name="dev">
        <Description>Local development with Docker Compose</Description>
        <Infrastructure>
          <Item>PostgreSQL, Redis, Kafka, Elasticsearch via Docker Compose</Item>
          <Item>Keycloak for local OIDC</Item>
          <Item>MinIO for S3-compatible storage</Item>
        </Infrastructure>
        <Profile>spring.profiles.active=dev</Profile>
      </Environment>
      <Environment name="stage">
        <Description>Pre-production environment mirroring prod</Description>
        <Infrastructure>
          <Item>Kubernetes cluster (same config as prod)</Item>
          <Item>Managed PostgreSQL, Redis, Kafka</Item>
          <Item>Feature flags enabled for testing</Item>
        </Infrastructure>
        <Profile>spring.profiles.active=stage</Profile>
      </Environment>
      <Environment name="prod">
        <Description>Production environment</Description>
        <Infrastructure>
          <Item>Kubernetes cluster with HPA</Item>
          <Item>Managed PostgreSQL (RDS or Cloud SQL)</Item>
          <Item>Managed Kafka (MSK or Confluent)</Item>
          <Item>Managed Redis (ElastiCache)</Item>
          <Item>Managed Elasticsearch (OpenSearch Service)</Item>
          <Item>S3 for object storage with CloudFront CDN</Item>
        </Infrastructure>
        <Profile>spring.profiles.active=prod</Profile>
      </Environment>
    </Environments>
    <RolloutStrategy>
      <Default>Rolling update with readiness probes</Default>
      <HighRisk>Blue-green for payment or order services</HighRisk>
      <DatabaseMigrations>
        <Strategy>Expand-Migrate-Contract</Strategy>
        <Steps>
          <Step order="1">Deploy code that works with old AND new schema</Step>
          <Step order="2">Run Flyway migrations</Step>
          <Step order="3">Deploy code that only uses new schema</Step>
          <Step order="4">Clean up old columns/tables (later release)</Step>
        </Steps>
      </DatabaseMigrations>
    </RolloutStrategy>
    <Observability>
      <HealthChecks>
        <Liveness>/actuator/health/liveness</Liveness>
        <Readiness>/actuator/health/readiness</Readiness>
      </HealthChecks>
      <Dashboards>
        <Dashboard>Service health overview</Dashboard>
        <Dashboard>Request latency and error rates</Dashboard>
        <Dashboard>Business metrics (orders, conversions)</Dashboard>
        <Dashboard>Kafka lag monitoring</Dashboard>
      </Dashboards>
      <Alerting>
        <Alert trigger="P95 latency > 1s" severity="warning"/>
        <Alert trigger="Error rate > 1%" severity="warning"/>
        <Alert trigger="Error rate > 5%" severity="critical"/>
        <Alert trigger="Service unavailable" severity="critical"/>
      </Alerting>
    </Observability>
    <Links>
      <Link ref="Technology.xml#TECH-kubernetes"/>
      <Link ref="Technology.xml#TECH-ci-pipeline"/>
    </Links>
  </Deployment>

  <!-- ===============================================================================
       SEMANTIC CONTRACTS REGISTRY
       =============================================================================== -->
  <Contracts>
    <ContractRegistry>
      <Description>
        Central registry of MODULE_CONTRACT and FUNCTION_CONTRACT IDs.
        Actual contracts are embedded in source code; this section provides an index.
      </Description>

      <!-- catalog-configuration-service -->
      <ModuleContract id="MC-catalog-configuration-service-domain-ConfigurationValidation">
        <Service>catalog-configuration-service</Service>
        <Layer>domain.service</Layer>
        <Description>Configuration validation domain service</Description>
        <Links>
          <Link ref="RequirementsAnalysis.xml#UC-CATALOG-CONFIGURE-ITEM"/>
        </Links>
      </ModuleContract>

      <FunctionContract id="FC-catalog-configuration-service-UC-CATALOG-CONFIGURE-ITEM-validateConfiguration">
        <Service>catalog-configuration-service</Service>
        <UseCase>UC-CATALOG-CONFIGURE-ITEM</UseCase>
        <Method>validateConfiguration</Method>
        <Criticality>HIGH</Criticality>
        <Links>
          <Link ref="MC-catalog-configuration-service-domain-ConfigurationValidation"/>
        </Links>
      </FunctionContract>

      <FunctionContract id="FC-catalog-configuration-service-UC-CATALOG-CONFIGURE-ITEM-resolveBom">
        <Service>catalog-configuration-service</Service>
        <UseCase>UC-CATALOG-CONFIGURE-ITEM</UseCase>
        <Method>resolveBom</Method>
        <Criticality>MEDIUM</Criticality>
      </FunctionContract>

      <!-- pricing-service -->
      <ModuleContract id="MC-pricing-service-domain-PriceCalculation">
        <Service>pricing-service</Service>
        <Layer>domain.service</Layer>
        <Description>Price calculation domain service</Description>
        <Criticality>HIGH</Criticality>
        <Links>
          <Link ref="RequirementsAnalysis.xml#UC-PRICING-QUOTE"/>
          <Link ref="Technology.xml#DEC-ARCH-RULE-ENGINE-STRATEGY"/>
        </Links>
      </ModuleContract>

      <FunctionContract id="FC-pricing-service-UC-PRICING-QUOTE-calculateQuote">
        <Service>pricing-service</Service>
        <UseCase>UC-PRICING-QUOTE</UseCase>
        <Method>calculateQuote</Method>
        <Criticality>HIGH</Criticality>
        <Links>
          <Link ref="MC-pricing-service-domain-PriceCalculation"/>
        </Links>
      </FunctionContract>

      <FunctionContract id="FC-pricing-service-UC-PRICING-QUOTE-validatePromoCode">
        <Service>pricing-service</Service>
        <UseCase>UC-PRICING-QUOTE</UseCase>
        <Method>validatePromoCode</Method>
        <Criticality>MEDIUM</Criticality>
        <Links>
          <Link ref="RequirementsAnalysis.xml#UC-PRICING-QUOTE"/>
        </Links>
      </FunctionContract>

      <FunctionContract id="FC-pricing-service-UC-PRICING-ADMIN-MANAGE-createPriceBook">
        <Service>pricing-service</Service>
        <UseCase>UC-PRICING-ADMIN-MANAGE</UseCase>
        <Method>createPriceBook</Method>
        <Criticality>HIGH</Criticality>
        <Links>
          <Link ref="RequirementsAnalysis.xml#UC-PRICING-ADMIN-MANAGE"/>
          <Link ref="Technology.xml#DEC-ARCH-ENTITY-VERSIONING"/>
        </Links>
      </FunctionContract>

      <FunctionContract id="FC-pricing-service-UC-PRICING-ADMIN-MANAGE-publishPriceBook">
        <Service>pricing-service</Service>
        <UseCase>UC-PRICING-ADMIN-MANAGE</UseCase>
        <Method>publishPriceBook</Method>
        <Criticality>HIGH</Criticality>
        <Links>
          <Link ref="RequirementsAnalysis.xml#UC-PRICING-ADMIN-MANAGE"/>
          <Link ref="Technology.xml#DEC-ARCH-ENTITY-VERSIONING"/>
        </Links>
      </FunctionContract>

      <!-- order-service -->
      <ModuleContract id="MC-order-service-domain-OrderAggregate">
        <Service>order-service</Service>
        <Layer>domain.model</Layer>
        <Description>Order aggregate root with state machine</Description>
        <Links>
          <Link ref="RequirementsAnalysis.xml#UC-ORDER-PLACE"/>
        </Links>
      </ModuleContract>

      <ModuleContract id="MC-order-service-application-OrderPlacement">
        <Service>order-service</Service>
        <Layer>application.service</Layer>
        <Description>Order placement use case service</Description>
        <Links>
          <Link ref="RequirementsAnalysis.xml#UC-ORDER-PLACE"/>
          <Link ref="Flow-Checkout-Payment"/>
        </Links>
      </ModuleContract>

      <FunctionContract id="FC-order-service-UC-ORDER-PLACE-placeOrder">
        <Service>order-service</Service>
        <UseCase>UC-ORDER-PLACE</UseCase>
        <Method>placeOrder</Method>
        <Criticality>HIGH</Criticality>
        <Links>
          <Link ref="MC-order-service-application-OrderPlacement"/>
        </Links>
      </FunctionContract>

      <FunctionContract id="FC-order-service-UC-ORDER-PLACE-initiatePayment">
        <Service>order-service</Service>
        <UseCase>UC-ORDER-PLACE</UseCase>
        <Method>initiatePayment</Method>
        <Criticality>HIGH</Criticality>
      </FunctionContract>

      <FunctionContract id="FC-order-service-UC-ORDER-PLACE-handlePaymentCallback">
        <Service>order-service</Service>
        <UseCase>UC-ORDER-PLACE</UseCase>
        <Method>handlePaymentCallback</Method>
        <Criticality>HIGH</Criticality>
      </FunctionContract>

      <!-- catalog-configuration-service admin operations -->
      <FunctionContract id="FC-catalog-configuration-service-UC-CATALOG-ADMIN-MANAGE-createProductTemplate">
        <Service>catalog-configuration-service</Service>
        <UseCase>UC-CATALOG-ADMIN-MANAGE</UseCase>
        <Method>createProductTemplate</Method>
        <Criticality>HIGH</Criticality>
        <Links>
          <Link ref="MC-catalog-configuration-service-domain-ConfigurationValidation"/>
          <Link ref="RequirementsAnalysis.xml#UC-CATALOG-ADMIN-MANAGE"/>
        </Links>
      </FunctionContract>

      <FunctionContract id="FC-catalog-configuration-service-UC-CATALOG-ADMIN-MANAGE-updateProductTemplate">
        <Service>catalog-configuration-service</Service>
        <UseCase>UC-CATALOG-ADMIN-MANAGE</UseCase>
        <Method>updateProductTemplate</Method>
        <Criticality>HIGH</Criticality>
        <Links>
          <Link ref="RequirementsAnalysis.xml#UC-CATALOG-ADMIN-MANAGE"/>
        </Links>
      </FunctionContract>

      <FunctionContract id="FC-catalog-configuration-service-UC-CATALOG-ADMIN-MANAGE-publishCatalogVersion">
        <Service>catalog-configuration-service</Service>
        <UseCase>UC-CATALOG-ADMIN-MANAGE</UseCase>
        <Method>publishCatalogVersion</Method>
        <Criticality>HIGH</Criticality>
        <Links>
          <Link ref="RequirementsAnalysis.xml#UC-CATALOG-ADMIN-MANAGE"/>
          <Link ref="Technology.xml#DEC-ARCH-ENTITY-VERSIONING"/>
        </Links>
      </FunctionContract>
    </ContractRegistry>

    <BlockAnchorRegistry>
      <Description>
        Index of BLOCK_ANCHOR IDs for critical code segments.
        Used for log correlation and RAG navigation.
      </Description>

      <!-- Configuration validation anchors -->
      <BlockAnchor id="BA-CFG-VAL-01" service="catalog-configuration-service" purpose="Check dimension constraints"/>
      <BlockAnchor id="BA-CFG-VAL-02" service="catalog-configuration-service" purpose="Check material/glazing compatibility"/>
      <BlockAnchor id="BA-CFG-VAL-03" service="catalog-configuration-service" purpose="Check option dependencies"/>
      <BlockAnchor id="BA-CFG-VAL-99" service="catalog-configuration-service" purpose="Final validation result"/>

      <!-- Pricing calculation anchors -->
      <BlockAnchor id="BA-PRC-CALC-01" service="pricing-service" purpose="Load price book for product"/>
      <BlockAnchor id="BA-PRC-CALC-02" service="pricing-service" purpose="Calculate base price from dimensions"/>
      <BlockAnchor id="BA-PRC-CALC-03" service="pricing-service" purpose="Apply option premiums"/>
      <BlockAnchor id="BA-PRC-CALC-04" service="pricing-service" purpose="Apply campaign discounts"/>
      <BlockAnchor id="BA-PRC-CALC-05" service="pricing-service" purpose="Apply promo code discount"/>
      <BlockAnchor id="BA-PRC-CALC-06" service="pricing-service" purpose="Calculate subtotal"/>
      <BlockAnchor id="BA-PRC-CALC-07" service="pricing-service" purpose="Calculate tax"/>
      <BlockAnchor id="BA-PRC-CALC-08" service="pricing-service" purpose="Apply rounding"/>
      <BlockAnchor id="BA-PRC-CALC-99" service="pricing-service" purpose="Final quote result"/>

      <!-- Promo code validation anchors -->
      <BlockAnchor id="BA-PROMO-VAL-01" service="pricing-service" purpose="Load promo code"/>
      <BlockAnchor id="BA-PROMO-VAL-02" service="pricing-service" purpose="Check expiry"/>
      <BlockAnchor id="BA-PROMO-VAL-03" service="pricing-service" purpose="Check usage limits"/>
      <BlockAnchor id="BA-PROMO-VAL-04" service="pricing-service" purpose="Calculate discount amount"/>

      <!-- Price book admin anchors -->
      <BlockAnchor id="BA-PB-CREATE-01" service="pricing-service" purpose="Validate admin authorization for create"/>
      <BlockAnchor id="BA-PB-CREATE-02" service="pricing-service" purpose="Validate price book data"/>
      <BlockAnchor id="BA-PB-CREATE-03" service="pricing-service" purpose="Build PriceBook aggregate"/>
      <BlockAnchor id="BA-PB-CREATE-04" service="pricing-service" purpose="Persist and return ID"/>

      <BlockAnchor id="BA-PB-PUBLISH-01" service="pricing-service" purpose="Validate admin authorization for publish"/>
      <BlockAnchor id="BA-PB-PUBLISH-02" service="pricing-service" purpose="Load price book"/>
      <BlockAnchor id="BA-PB-PUBLISH-03" service="pricing-service" purpose="Create version snapshot"/>
      <BlockAnchor id="BA-PB-PUBLISH-04" service="pricing-service" purpose="Archive previous active"/>
      <BlockAnchor id="BA-PB-PUBLISH-05" service="pricing-service" purpose="Invalidate cache"/>
      <BlockAnchor id="BA-PB-PUBLISH-06" service="pricing-service" purpose="Emit event"/>

      <!-- Order placement anchors -->
      <BlockAnchor id="BA-ORD-PLACE-01" service="order-service" purpose="Validate cart snapshot"/>
      <BlockAnchor id="BA-ORD-PLACE-02" service="order-service" purpose="Check idempotency key"/>
      <BlockAnchor id="BA-ORD-PLACE-03" service="order-service" purpose="Create order aggregate"/>
      <BlockAnchor id="BA-ORD-PLACE-04" service="order-service" purpose="Persist order to database"/>
      <BlockAnchor id="BA-ORD-PLACE-05" service="order-service" purpose="Initiate payment with gateway"/>
      <BlockAnchor id="BA-ORD-PLACE-99" service="order-service" purpose="Order placement result"/>

      <!-- Payment callback anchors -->
      <BlockAnchor id="BA-PAY-CB-01" service="order-service" purpose="Verify webhook signature"/>
      <BlockAnchor id="BA-PAY-CB-02" service="order-service" purpose="Load order by payment reference"/>
      <BlockAnchor id="BA-PAY-CB-03" service="order-service" purpose="Apply payment status transition"/>
      <BlockAnchor id="BA-PAY-CB-04" service="order-service" purpose="Publish OrderConfirmedEvent"/>

      <!-- Catalog admin operation anchors -->
      <BlockAnchor id="BA-CAT-CREATE-01" service="catalog-configuration-service" purpose="Validate admin authorization for create"/>
      <BlockAnchor id="BA-CAT-CREATE-02" service="catalog-configuration-service" purpose="Validate uniqueness constraints"/>
      <BlockAnchor id="BA-CAT-CREATE-03" service="catalog-configuration-service" purpose="Build ProductTemplate aggregate"/>
      <BlockAnchor id="BA-CAT-CREATE-04" service="catalog-configuration-service" purpose="Persist and return ID"/>

      <BlockAnchor id="BA-CAT-UPDATE-01" service="catalog-configuration-service" purpose="Validate admin authorization for update"/>
      <BlockAnchor id="BA-CAT-UPDATE-02" service="catalog-configuration-service" purpose="Load existing template"/>
      <BlockAnchor id="BA-CAT-UPDATE-03" service="catalog-configuration-service" purpose="Apply updates or clone"/>
      <BlockAnchor id="BA-CAT-UPDATE-04" service="catalog-configuration-service" purpose="Persist changes"/>

      <BlockAnchor id="BA-CAT-PUBLISH-01" service="catalog-configuration-service" purpose="Validate admin authorization for publish"/>
      <BlockAnchor id="BA-CAT-PUBLISH-02" service="catalog-configuration-service" purpose="Load DRAFT templates"/>
      <BlockAnchor id="BA-CAT-PUBLISH-03" service="catalog-configuration-service" purpose="Validate all templates"/>
      <BlockAnchor id="BA-CAT-PUBLISH-04" service="catalog-configuration-service" purpose="Create CatalogVersion snapshot"/>
      <BlockAnchor id="BA-CAT-PUBLISH-05" service="catalog-configuration-service" purpose="Transition statuses"/>
      <BlockAnchor id="BA-CAT-PUBLISH-06" service="catalog-configuration-service" purpose="Emit domain events"/>
    </BlockAnchorRegistry>
  </Contracts>

  <!-- ===============================================================================
       OPEN DECISIONS (Tracked from RA)
       =============================================================================== -->
  <OpenDecisions>
    <Decision id="DEC-DP-STATUS-SOT" status="OPEN" blocking="true">
      <Topic>Status source of truth for production/logistics</Topic>
      <Question>Is ERP/logistics the SoT for production/delivery statuses, or do we maintain parallel?</Question>
      <Impact>Affects integration contract design and status reconciliation logic</Impact>
      <Links>
        <Link ref="RequirementsAnalysis.xml#DEC-OPEN-STATUS-SOT"/>
      </Links>
    </Decision>

    <Decision id="DEC-DP-CAD-FORMAT" status="OPEN" blocking="false">
      <Topic>CAD integration API format</Topic>
      <Question>REST API, file exchange, or proprietary protocol?</Question>
      <Impact>Affects catalog-configuration-service adapter implementation</Impact>
      <Links>
        <Link ref="RequirementsAnalysis.xml#DEC-OPEN-CAD-FORMAT"/>
      </Links>
    </Decision>
  </OpenDecisions>

  <!-- ===============================================================================
       ASSUMPTIONS
       =============================================================================== -->
  <Assumptions>
    <Assumption id="DP-ASSUM-001">
      Port numbers are defaults for local development; production uses Kubernetes service discovery.
    </Assumption>
    <Assumption id="DP-ASSUM-002" status="SUPERSEDED">
      SUPERSEDED by DEC-INTER-SERVICE-COMM: gRPC is REQUIRED for inter-service sync communication.
    </Assumption>
    <Assumption id="DP-ASSUM-003">
      New services (workflow, field-ops, document, billing, support) follow same hexagonal architecture as existing services.
    </Assumption>
    <Assumption id="DP-ASSUM-004">
      Phase deliverables may be adjusted based on integration availability (e.g., CAD, logistics).
    </Assumption>
  </Assumptions>

</DevelopmentPlan>