<?xml version="1.0" encoding="UTF-8"?>
<!--
  GRACE Canonical Artifact: DevelopmentPlan.xml
  Purpose: Blueprint for implementation - services, flows, contracts, testing, deployment
  Version: 1.5.0
  Last Updated: 2026-01-21T18:20:50+00:00
  Changes:
    - v1.5.0: Added flows for document issuance and B2B billing visibility
              (Flow-Document-Issue, Flow-B2B-Finance) and restored Flow-Config-Pricing
              for compatibility with existing contracts and logs.
    - v1.4.0: Added new services (workflow-service, field-ops-service, document-service,
billing-service, support-service)
              Added development phases (0-4) with milestones and acceptance gates
              Added new flows (B2C-CPQ, Measurement-Visit, B2B-Project, Installation)
              Added integration contracts (CRM, CAD, ERP, Logistics, Payments)
              Updated order state machine with PAID and extended fulfillment states
              Added StatusModel anchor and audit trail block anchors
    - v1.3.0: Expanded pricing-service contracts (FC-pricing-*) and block anchors
    - v1.2.0: Added admin operation contracts
-->
<DevelopmentPlan version="1.5.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">

  <!-- ===============================================================================
       DEVELOPMENT PHASES
       =============================================================================== -->
  <Phases id="DevelopmentPhases">
    <Description>
      Phased delivery plan with acceptance gates. MUST/SHOULD/LATER priorities from
      RequirementsAnalysis.xml drive phase scope.
    </Description>

    <Phase id="PHASE-0" name="Foundation">
      <Description>Infrastructure, shared modules, and core plumbing</Description>
      <Priority>MUST</Priority>
      <Deliverables>
        <Deliverable id="PHASE-0-D1">shared-kernel module with domain primitives</Deliverable>
        <Deliverable id="PHASE-0-D2">api-contracts module with Protobuf schemas</Deliverable>
        <Deliverable id="PHASE-0-D3">config-server with profiles (dev/stage/prod)</Deliverable>
        <Deliverable id="PHASE-0-D4">gateway with JWT validation, routing, CORS</Deliverable>
        <Deliverable id="PHASE-0-D5">Docker Compose for local dev environment</Deliverable>
        <Deliverable id="PHASE-0-D6">CI/CD pipeline (GitHub Actions)</Deliverable>
      </Deliverables>
      <AcceptanceGates>
        <Gate id="PHASE-0-G1">All modules build successfully</Gate>
        <Gate id="PHASE-0-G2">Gateway routes to placeholder services</Gate>
        <Gate id="PHASE-0-G3">Config-server serves configuration</Gate>
        <Gate id="PHASE-0-G4">Docker Compose starts all infrastructure</Gate>
        <Gate id="PHASE-0-G5">CI pipeline runs tests and builds</Gate>
      </AcceptanceGates>
      <Links>
        <Link ref="DP-SVC-shared-kernel" />
        <Link ref="DP-SVC-api-contracts" />
        <Link ref="DP-SVC-gateway" />
        <Link ref="DP-SVC-config-server" />
      </Links>
    </Phase>

    <Phase id="PHASE-1" name="CPQ Core">
      <Description>B2C CPQ: Configure + Instant Pricing + Save Draft</Description>
      <Priority>MUST</Priority>
      <DependsOn>
        <PhaseRef ref="PHASE-0" />
      </DependsOn>
      <Deliverables>
        <Deliverable id="PHASE-1-D1">catalog-configuration-service with product templates and
          validation rules</Deliverable>
        <Deliverable id="PHASE-1-D2">pricing-service with price books, campaigns, and quote
          calculation</Deliverable>
        <Deliverable id="PHASE-1-D3">account-service with user profiles and saved configurations</Deliverable>
        <Deliverable id="PHASE-1-D4">search-service with Elasticsearch indexing</Deliverable>
        <Deliverable id="PHASE-1-D5">gRPC contracts for catalog-pricing integration</Deliverable>
        <Deliverable id="PHASE-1-D6">Real-time configuration validation and pricing</Deliverable>
      </Deliverables>
      <AcceptanceGates>
        <Gate id="PHASE-1-G1">UC-B2C-CPQ-01 acceptance criteria met (AC-CPQ-01, AC-CPQ-02,
          AC-CPQ-03)</Gate>
        <Gate id="PHASE-1-G2">Configuration changes trigger price recalculation within 300ms</Gate>
        <Gate id="PHASE-1-G3">Drafts saved and resumed from authenticated account</Gate>
        <Gate id="PHASE-1-G4">Search returns products within 200ms P95</Gate>
        <Gate id="PHASE-1-G5">80% test coverage on domain layer</Gate>
      </AcceptanceGates>
      <Links>
        <Link ref="RequirementsAnalysis.xml#UC-B2C-CPQ-01" />
        <Link ref="DP-SVC-catalog-configuration-service" />
        <Link ref="DP-SVC-pricing-service" />
      </Links>
    </Phase>

    <Phase id="PHASE-2" name="Measurement and Workflow">
      <Description>Measurement scheduling, workflow/CRM, and field operations</Description>
      <Priority>MUST</Priority>
      <DependsOn>
        <PhaseRef ref="PHASE-1" />
      </DependsOn>
      <Deliverables>
        <Deliverable id="PHASE-2-D1">workflow-service with lead/deal pipeline and task management</Deliverable>
        <Deliverable id="PHASE-2-D2">field-ops-service with measurement task lifecycle</Deliverable>
        <Deliverable id="PHASE-2-D3">Measurement request scheduling from frontend</Deliverable>
        <Deliverable id="PHASE-2-D4">Mobile-friendly field task APIs</Deliverable>
        <Deliverable id="PHASE-2-D5">Measurement results trigger repricing</Deliverable>
        <Deliverable id="PHASE-2-D6">notification-service baseline (email/SMS for confirmations)</Deliverable>
        <Deliverable id="PHASE-2-D7">Status audit trail infrastructure</Deliverable>
      </Deliverables>
      <AcceptanceGates>
        <Gate id="PHASE-2-G1">UC-B2C-MEASURE-01 acceptance criteria met</Gate>
        <Gate id="PHASE-2-G2">UC-FIELD-MEASURE-01 acceptance criteria met</Gate>
        <Gate id="PHASE-2-G3">UC-STAFF-CRM-01 basic pipeline visible</Gate>
        <Gate id="PHASE-2-G4">Audit trail captures all status changes</Gate>
        <Gate id="PHASE-2-G5">Notifications sent for measurement confirmations</Gate>
      </AcceptanceGates>
      <Links>
        <Link ref="RequirementsAnalysis.xml#UC-B2C-MEASURE-01" />
        <Link ref="RequirementsAnalysis.xml#UC-FIELD-MEASURE-01" />
        <Link ref="RequirementsAnalysis.xml#UC-STAFF-CRM-01" />
        <Link ref="DP-SVC-workflow-service" />
        <Link ref="DP-SVC-field-ops-service" />
      </Links>
    </Phase>

    <Phase id="PHASE-3" name="Ordering and Payments">
      <Description>B2C ordering with contract acceptance, payment, and order locking</Description>
      <Priority>MUST</Priority>
      <DependsOn>
        <PhaseRef ref="PHASE-2" />
      </DependsOn>
      <Deliverables>
        <Deliverable id="PHASE-3-D1">cart-service with cart management and checkout preparation</Deliverable>
        <Deliverable id="PHASE-3-D2">order-service with full state machine including PAID status
          lock</Deliverable>
        <Deliverable id="PHASE-3-D3">Payment gateway integration with webhook handling</Deliverable>
        <Deliverable id="PHASE-3-D4">Contract acceptance recording</Deliverable>
        <Deliverable id="PHASE-3-D5">Order tracking with status timeline</Deliverable>
        <Deliverable id="PHASE-3-D6">document-service with proposal/invoice/contract generation</Deliverable>
        <Deliverable id="PHASE-3-D7">Notifications for payment and order status changes</Deliverable>
      </Deliverables>
      <AcceptanceGates>
        <Gate id="PHASE-3-G1">UC-B2C-ORDER-01 acceptance criteria met</Gate>
        <Gate id="PHASE-3-G2">UC-B2C-TRACK-01 acceptance criteria met</Gate>
        <Gate id="PHASE-3-G3">Post-payment orders are immutable (locked)</Gate>
        <Gate id="PHASE-3-G4">Payment webhooks update order status correctly</Gate>
        <Gate id="PHASE-3-G5">Documents generated from templates</Gate>
      </AcceptanceGates>
      <Links>
        <Link ref="RequirementsAnalysis.xml#UC-B2C-ORDER-01" />
        <Link ref="RequirementsAnalysis.xml#UC-B2C-TRACK-01" />
        <Link ref="DP-SVC-order-service" />
        <Link ref="DP-SVC-cart-service" />
        <Link ref="DP-SVC-document-service" />
      </Links>
    </Phase>

    <Phase id="PHASE-4" name="Fulfillment and After-Sales">
      <Description>Installation, delivery tracking, B2B features, and after-sales support</Description>
      <Priority>MUST (installation, support) / SHOULD (delivery tracking, B2B finance)</Priority>
      <DependsOn>
        <PhaseRef ref="PHASE-3" />
      </DependsOn>
      <Deliverables>
        <Deliverable id="PHASE-4-D1">Installation task lifecycle in field-ops-service</Deliverable>
        <Deliverable id="PHASE-4-D2">support-service for service/warranty requests</Deliverable>
        <Deliverable id="PHASE-4-D3">billing-service for B2B invoices and settlements (SHOULD)</Deliverable>
        <Deliverable id="PHASE-4-D4">Delivery tracking integration (SHOULD)</Deliverable>
        <Deliverable id="PHASE-4-D5">B2B project orders and partner pricing (MUST)</Deliverable>
        <Deliverable id="PHASE-4-D6">reporting-service with conversion funnel dashboards</Deliverable>
      </Deliverables>
      <AcceptanceGates>
        <Gate id="PHASE-4-G1">UC-FIELD-INSTALL-01 acceptance criteria met</Gate>
        <Gate id="PHASE-4-G2">UC-SUPPORT-CREATE-01 acceptance criteria met</Gate>
        <Gate id="PHASE-4-G3">UC-B2B-CPQ-01 basic flow working</Gate>
        <Gate id="PHASE-4-G4">Conversion funnel report available</Gate>
        <Gate id="PHASE-4-G5">UC-DELIVERY-TRACK-01 (SHOULD) if logistics integration available</Gate>
      </AcceptanceGates>
      <Links>
        <Link ref="RequirementsAnalysis.xml#UC-FIELD-INSTALL-01" />
        <Link ref="RequirementsAnalysis.xml#UC-SUPPORT-CREATE-01" />
        <Link ref="RequirementsAnalysis.xml#UC-B2B-CPQ-01" />
        <Link ref="DP-SVC-field-ops-service" />
        <Link ref="DP-SVC-support-service" />
        <Link ref="DP-SVC-billing-service" />
      </Links>
    </Phase>
  </Phases>

  <!-- ===============================================================================
       SERVICES & MODULES
       =============================================================================== -->
  <Services>
    <!-- ===========================================================================
         SHARED LIBRARIES
         =========================================================================== -->
    <Service id="DP-SVC-shared-kernel" type="library">
      <Name>shared-kernel</Name>
      <ArtifactId>shared-kernel</ArtifactId>
      <Description>
        Cross-service domain primitives: value objects, enums, domain event interface.
        Framework-free, pure Java.
      </Description>
      <BoundedContext>shared-kernel</BoundedContext>
      <Responsibilities>
        <Item>Money value object with currency-aware arithmetic</Item>
        <Item>DimensionsCm for product dimensions (50-400cm range)</Item>
        <Item>DomainEvent interface for event contracts</Item>
        <Item>LocalizedString for i18n content</Item>
        <Item>Address, Email, Id value objects</Item>
        <Item>Common enums (Language, etc.)</Item>
        <Item>StatusChangeRecord for audit trail</Item>
      </Responsibilities>
      <Dependencies>
        <Dependency type="compile">None (pure Java)</Dependency>
      </Dependencies>
      <Constraints>
        <Item>No Spring, JPA, Jackson, or framework dependencies</Item>
        <Item>Immutable value objects only</Item>
        <Item>No DTOs or API models</Item>
      </Constraints>
      <PackageLayout>
        <Package>com.kanokna.shared.core</Package>
        <Package>com.kanokna.shared.money</Package>
        <Package>com.kanokna.shared.measure</Package>
        <Package>com.kanokna.shared.event</Package>
        <Package>com.kanokna.shared.i18n</Package>
        <Package>com.kanokna.shared.audit</Package>
      </PackageLayout>
      <Links>
        <Link ref="RequirementsAnalysis.xml#NFR-MAINT-MODULARITY" />
        <Link ref="Technology.xml#TECH-java" />
      </Links>
    </Service>

    <Service id="DP-SVC-api-contracts" type="library">
      <Name>api-contracts</Name>
      <ArtifactId>api-contracts</ArtifactId>
      <Description>
        Contract-first specifications: OpenAPI for external REST APIs, Protobuf for
        gRPC inter-service communication and Kafka events.
      </Description>
      <BoundedContext>contracts</BoundedContext>
      <Responsibilities>
        <Item>OpenAPI 3.1 specs for external/public REST endpoints</Item>
        <Item>Protobuf service definitions for gRPC inter-service calls</Item>
        <Item>Protobuf message schemas for Kafka domain events</Item>
        <Item>AsyncAPI specs for Kafka topics (optional)</Item>
        <Item>Generated gRPC stubs and message classes</Item>
        <Item>Generated code confined to adapters (enforced via ArchUnit)</Item>
      </Responsibilities>
      <Dependencies>
        <Dependency type="compile">io.grpc:grpc-protobuf</Dependency>
        <Dependency type="compile">io.grpc:grpc-stub</Dependency>
        <Dependency type="compile">com.google.protobuf:protobuf-java</Dependency>
        <Dependency type="build">protobuf-maven-plugin</Dependency>
        <Dependency type="build">openapi-generator-maven-plugin</Dependency>
      </Dependencies>
      <Constraints>
        <Item>No Spring Boot runtime dependencies</Item>
        <Item>No JPA/Hibernate</Item>
        <Item>Domain layer MUST NOT depend on generated types</Item>
        <Item>gRPC stubs used only in adapters.out.grpc and adapters.in.grpc packages</Item>
      </Constraints>
      <ContractLocation>
        <OpenAPI>docs/api-contracts/openapi/</OpenAPI>
        <Protobuf>api-contracts/src/main/proto/</Protobuf>
      </ContractLocation>
      <GrpcServices>
        <Service name="CatalogConfigurationService">Configuration validation and product queries</Service>
        <Service name="PricingService">Quote calculation</Service>
        <Service name="CartService">Cart operations</Service>
        <Service name="AccountService">User profile queries</Service>
        <Service name="MediaService">Media metadata queries</Service>
        <Service name="WorkflowService">Lead/deal/task operations</Service>
        <Service name="FieldOpsService">Field task operations</Service>
        <Service name="DocumentService">Document generation</Service>
      </GrpcServices>
      <Links>
        <Link ref="Technology.xml#TECH-protobuf" />
        <Link ref="Technology.xml#TECH-grpc" />
        <Link ref="DevelopmentPlan.xml#ContractEvolutionPolicy" />
      </Links>
    </Service>

    <!-- ===========================================================================
         TESTING INFRASTRUCTURE (AWO-20260120-01)
         =========================================================================== -->
    <Service id="DP-SVC-test-support" type="library">
      <Name>test-support</Name>
      <ArtifactId>test-support</ArtifactId>
      <Description>
        Shared test utilities: Testcontainers configurations, fixtures, assertions,
        test data builders, and ArchUnit rule library. Used by all services for
        consistent test infrastructure.
      </Description>
      <BoundedContext>testing-infrastructure</BoundedContext>
      <Responsibilities>
        <Item>Shared Testcontainers configurations with reusable container lifecycle</Item>
        <Item>Common test fixtures and test data builders for domain objects</Item>
        <Item>Shared ArchUnit rule library (HexagonalArchitectureRules.java)</Item>
        <Item>Custom AssertJ assertions for shared-kernel value objects</Item>
        <Item>gRPC test utilities: mock servers, test channel builders</Item>
        <Item>Kafka test utilities: embedded broker configuration, message assertions</Item>
      </Responsibilities>
      <Dependencies>
        <Dependency type="compile" scope="test">org.junit.jupiter:junit-jupiter</Dependency>
        <Dependency type="compile" scope="test">org.testcontainers:testcontainers</Dependency>
        <Dependency type="compile" scope="test">org.testcontainers:junit-jupiter</Dependency>
        <Dependency type="compile" scope="test">org.testcontainers:postgresql</Dependency>
        <Dependency type="compile" scope="test">org.testcontainers:kafka</Dependency>
        <Dependency type="compile" scope="test">org.testcontainers:elasticsearch</Dependency>
        <Dependency type="compile" scope="test">com.redis:testcontainers-redis</Dependency>
        <Dependency type="compile" scope="test">com.tngtech.archunit:archunit-junit5</Dependency>
        <Dependency type="compile" scope="test">org.assertj:assertj-core</Dependency>
        <Dependency type="compile" scope="test">io.grpc:grpc-testing</Dependency>
      </Dependencies>
      <Constraints>
        <Item>No production dependencies - test scope only</Item>
        <Item>No service-specific logic - only reusable utilities</Item>
        <Item>Must not depend on any service implementation modules</Item>
      </Constraints>
      <PackageLayout>
        <Package>com.kanokna.test.containers</Package>
        <Package>com.kanokna.test.containers.postgres</Package>
        <Package>com.kanokna.test.containers.kafka</Package>
        <Package>com.kanokna.test.containers.elasticsearch</Package>
        <Package>com.kanokna.test.containers.redis</Package>
        <Package>com.kanokna.test.fixtures</Package>
        <Package>com.kanokna.test.archunit</Package>
        <Package>com.kanokna.test.assertions</Package>
        <Package>com.kanokna.test.grpc</Package>
      </PackageLayout>
      <KeyClasses>
        <Class name="PostgresTestContainer">Singleton PostgreSQL container with Flyway migration support</Class>
        <Class name="KafkaTestContainer">Singleton Kafka (Redpanda) container with topic auto-creation</Class>
        <Class name="ElasticsearchTestContainer">Singleton Elasticsearch container with index templates</Class>
        <Class name="RedisTestContainer">Singleton Redis container</Class>
        <Class name="HexagonalArchitectureRules">Shared ArchUnit rules for hexagonal layer enforcement</Class>
        <Class name="GrpcTestChannelBuilder">Utility for building in-process gRPC test channels</Class>
      </KeyClasses>
      <Links>
        <Link ref="Technology.xml#DEC-TEST-SHARED-UTILS" />
        <Link ref="Technology.xml#TECH-testcontainers" />
        <Link ref="Technology.xml#TECH-archunit" />
      </Links>
    </Service>

    <Service id="DP-SVC-e2e-tests" type="test-module">
      <Name>e2e-tests</Name>
      <ArtifactId>e2e-tests</ArtifactId>
      <Description>
        End-to-end tests for cross-service flows with full infrastructure.
        Tests complete business scenarios spanning multiple bounded contexts.
      </Description>
      <BoundedContext>testing-infrastructure</BoundedContext>
      <Responsibilities>
        <Item>Cross-service flow testing: CPQ flow, order lifecycle, measurement workflow</Item>
        <Item>Full stack validation with all Testcontainers (PostgreSQL, Kafka, Redis, Elasticsearch)</Item>
        <Item>Event propagation testing: verify Kafka events flow correctly between services</Item>
        <Item>Data consistency testing: verify eventual consistency across bounded contexts</Item>
        <Item>grpcurl-based smoke tests and CLI verification scripts</Item>
      </Responsibilities>
      <Dependencies>
        <Dependency type="test">DP-SVC-test-support</Dependency>
        <Dependency type="test">DP-SVC-gateway (as test subject)</Dependency>
        <Dependency type="test">All service modules (started via Docker Compose or embedded)</Dependency>
      </Dependencies>
      <TestCategories>
        <Category id="E2E-CPQ" name="CPQ Flow Tests">
          <Description>Configure → Price → Quote → Cart flow across catalog, pricing, cart services</Description>
          <Services>catalog-configuration-service, pricing-service, cart-service</Services>
        </Category>
        <Category id="E2E-ORDER" name="Order Lifecycle Tests">
          <Description>Order creation → payment → fulfillment state transitions</Description>
          <Services>cart-service, order-service, notification-service</Services>
        </Category>
        <Category id="E2E-MEASUREMENT" name="Measurement Flow Tests">
          <Description>Measurement request → scheduling → results → repricing</Description>
          <Services>workflow-service, field-ops-service, pricing-service</Services>
        </Category>
        <Category id="E2E-SEARCH" name="Search Indexing Tests">
          <Description>Product changes → Kafka events → Elasticsearch indexing → search results</Description>
          <Services>catalog-configuration-service, search-service</Services>
        </Category>
      </TestCategories>
      <Execution>
        <MavenProfile>e2e</MavenProfile>
        <Command>mvn verify -Pe2e -pl e2e-tests</Command>
        <CIStage>Post-integration, optional per-commit, mandatory pre-release</CIStage>
      </Execution>
      <Links>
        <Link ref="Technology.xml#DEC-TEST-E2E" />
        <Link ref="Technology.xml#TECH-testcontainers" />
      </Links>
    </Service>

    <!-- ===========================================================================
         INFRASTRUCTURE SERVICES
         =========================================================================== -->
    <Service id="DP-SVC-config-server" type="infrastructure">
      <Name>config-server</Name>
      <ArtifactId>config-server</ArtifactId>
      <Description>
        Centralized configuration management using Spring Cloud Config Server.
        Serves configuration to all services based on profile (dev/stage/prod).
      </Description>
      <BoundedContext>infrastructure</BoundedContext>
      <Responsibilities>
        <Item>Serve externalized configuration from Git or file system</Item>
        <Item>Support encryption of sensitive values</Item>
        <Item>Enable runtime config refresh</Item>
      </Responsibilities>
      <Dependencies>
        <Dependency type="compile">spring-cloud-config-server</Dependency>
      </Dependencies>
      <Port>8888</Port>
      <Links>
        <Link ref="Technology.xml#TECH-spring-cloud" />
      </Links>
    </Service>

    <Service id="DP-SVC-gateway" type="infrastructure">
      <Name>gateway</Name>
      <ArtifactId>gateway</ArtifactId>
      <Description>
        API Gateway using Spring Cloud Gateway. Routes requests to backend services,
        handles authentication, rate limiting, and correlation ID injection.
      </Description>
      <BoundedContext>infrastructure</BoundedContext>
      <Responsibilities>
        <Item>Route requests to backend services based on path prefixes</Item>
        <Item>Validate JWT tokens (first line of defense)</Item>
        <Item>Inject correlation ID header for distributed tracing</Item>
        <Item>Apply rate limiting per client</Item>
        <Item>CORS handling</Item>
      </Responsibilities>
      <Dependencies>
        <Dependency type="compile">spring-cloud-starter-gateway</Dependency>
        <Dependency type="compile">spring-boot-starter-oauth2-resource-server</Dependency>
        <Dependency type="compile">spring-cloud-starter-circuitbreaker-reactor-resilience4j</Dependency>
      </Dependencies>
      <Port>8080</Port>
      <Routes>
        <Route path="/api/catalog/**" target="catalog-configuration-service" />
        <Route path="/api/pricing/**" target="pricing-service" />
        <Route path="/api/cart/**" target="cart-service" />
        <Route path="/api/orders/**" target="order-service" />
        <Route path="/api/accounts/**" target="account-service" />
        <Route path="/api/media/**" target="media-service" />
        <Route path="/api/search/**" target="search-service" />
        <Route path="/api/workflow/**" target="workflow-service" />
        <Route path="/api/field/**" target="field-ops-service" />
        <Route path="/api/documents/**" target="document-service" />
        <Route path="/api/billing/**" target="billing-service" />
        <Route path="/api/support/**" target="support-service" />
        <Route path="/api/reports/**" target="reporting-service" />
      </Routes>
      <Links>
        <Link ref="Technology.xml#TECH-spring-cloud" />
        <Link ref="RequirementsAnalysis.xml#NFR-SEC-AUTHENTICATION" />
      </Links>
    </Service>

    <!-- ===========================================================================
         DOMAIN SERVICES - EXISTING
         =========================================================================== -->
    <Service id="DP-SVC-catalog-configuration-service" type="service">
      <Name>catalog-configuration-service</Name>
      <ArtifactId>catalog-configuration-service</ArtifactId>
      <Description>
        Manages product catalog (windows, doors), configuration options, and validation rules.
        Validates customer configurations against business rules.
      </Description>
      <BoundedContext>catalog-configuration</BoundedContext>
      <Responsibilities>
        <Item>CRUD for product templates (window types, door types)</Item>
        <Item>Define option groups (materials, glazing, colors, accessories)</Item>
        <Item>Define configuration rules (compatibility, constraints, dependencies)</Item>
        <Item>Validate configurations against rules</Item>
        <Item>Resolve BOM (bill of materials) for configurations</Item>
        <Item>Publish ProductTemplatePublishedEvent for search indexing</Item>
      </Responsibilities>
      <Dependencies>
        <ServiceRef ref="DP-SVC-shared-kernel" type="compile" />
        <ServiceRef ref="DP-SVC-api-contracts" type="compile" />
        <ServiceRef ref="DP-SVC-pricing-service" type="grpc">For price quotes during configuration</ServiceRef>
        <ServiceRef ref="DP-SVC-search-service" type="async">Publish events for indexing</ServiceRef>
        <ServiceRef ref="DP-SVC-media-service" type="grpc">Resolve media metadata</ServiceRef>
      </Dependencies>
      <Database>
        <Engine ref="Technology.xml#TECH-postgresql" />
        <Schema>catalog_configuration</Schema>
      </Database>
      <Ports>
        <Port type="http">8081</Port>
        <Port type="grpc">9081</Port>
      </Ports>
      <PackageLayout>
        <Package>com.kanokna.catalog_configuration_service.domain.model</Package>
        <Package>com.kanokna.catalog_configuration_service.domain.service</Package>
        <Package>com.kanokna.catalog_configuration_service.domain.event</Package>
        <Package>com.kanokna.catalog_configuration_service.domain.exception</Package>
        <Package>com.kanokna.catalog_configuration_service.application.port.in</Package>
        <Package>com.kanokna.catalog_configuration_service.application.port.out</Package>
        <Package>com.kanokna.catalog_configuration_service.application.service</Package>
        <Package>com.kanokna.catalog_configuration_service.application.dto</Package>
        <Package>com.kanokna.catalog_configuration_service.adapters.in.web</Package>
        <Package>com.kanokna.catalog_configuration_service.adapters.in.grpc</Package>
        <Package>com.kanokna.catalog_configuration_service.adapters.out.persistence</Package>
        <Package>com.kanokna.catalog_configuration_service.adapters.out.grpc</Package>
        <Package>com.kanokna.catalog_configuration_service.adapters.out.kafka</Package>
        <Package>com.kanokna.catalog_configuration_service.adapters.config</Package>
      </PackageLayout>
      <Aggregates>
        <Aggregate name="ProductTemplate">Root for product definitions</Aggregate>
        <Aggregate name="ConfigurationRuleSet">Root for configuration rules</Aggregate>
        <Aggregate name="BomTemplate">Bill of materials template</Aggregate>
        <Aggregate name="CatalogVersion">Versioned catalog snapshot</Aggregate>
      </Aggregates>
      <DomainEvents>
        <Event name="ProductTemplatePublishedEvent">Triggers search indexing</Event>
        <Event name="CatalogVersionPublishedEvent">Triggers cache invalidation</Event>
        <Event name="ConfigurationValidatedEvent">Audit trail for validations</Event>
      </DomainEvents>
      <Links>
        <Link ref="RequirementsAnalysis.xml#UC-B2C-CPQ-01" />
        <Link ref="RequirementsAnalysis.xml#UC-CATALOG-BROWSE" />
      </Links>
    </Service>

    <Service id="DP-SVC-pricing-service" type="service">
      <Name>pricing-service</Name>
      <ArtifactId>pricing-service</ArtifactId>
      <Description>
        Calculates prices for product configurations including base price, option premiums,
        campaigns, discounts, partner tiers, and taxes. Supports multiple currencies.
      </Description>
      <BoundedContext>pricing</BoundedContext>
      <Responsibilities>
        <Item>Manage price books (base prices per product, per-m2 rates)</Item>
        <Item>Define option premiums (absolute or percentage)</Item>
        <Item>Manage campaigns and promotional discounts</Item>
        <Item>Support partner pricing tiers for B2B</Item>
        <Item>Configure tax rules per region</Item>
        <Item>Calculate quotes with decision trace for auditability</Item>
        <Item>Support installment schedule display (if configured)</Item>
      </Responsibilities>
      <Dependencies>
        <ServiceRef ref="DP-SVC-shared-kernel" type="compile" />
        <ServiceRef ref="DP-SVC-api-contracts" type="compile" />
      </Dependencies>
      <Database>
        <Engine ref="Technology.xml#TECH-postgresql" />
        <Schema>pricing</Schema>
      </Database>
      <Cache ref="Technology.xml#TECH-redis">
        <Usage>Quote caching with 5-minute TTL</Usage>
      </Cache>
      <Ports>
        <Port type="http">8082</Port>
        <Port type="grpc">9082</Port>
      </Ports>
      <PackageLayout>
        <!-- Updated per DEC-PACKAGE-NAMING-CONVENTION: pricing_service → pricing -->
        <Package>com.kanokna.pricing.domain.model</Package>
        <Package>com.kanokna.pricing.domain.service</Package>
        <Package>com.kanokna.pricing.domain.event</Package>
        <Package>com.kanokna.pricing.domain.exception</Package>
        <Package>com.kanokna.pricing.application.port.in</Package>
        <Package>com.kanokna.pricing.application.port.out</Package>
        <Package>com.kanokna.pricing.application.service</Package>
        <Package>com.kanokna.pricing.application.dto</Package>
        <Package>com.kanokna.pricing.adapters.in.web</Package>
        <Package>com.kanokna.pricing.adapters.in.grpc</Package>
        <Package>com.kanokna.pricing.adapters.out.persistence</Package>
        <Package>com.kanokna.pricing.adapters.out.redis</Package>
        <Package>com.kanokna.pricing.adapters.config</Package>
      </PackageLayout>
      <Aggregates>
        <Aggregate name="PriceBook">Versioned price definitions</Aggregate>
        <Aggregate name="Campaign">Promotional campaigns</Aggregate>
        <Aggregate name="TaxRule">Regional tax configurations</Aggregate>
        <Aggregate name="Quote">Calculated price quote (transient)</Aggregate>
        <Aggregate name="PartnerPriceTier">B2B partner-specific pricing</Aggregate>
      </Aggregates>
      <DomainEvents>
        <Event name="QuoteCalculatedEvent">Audit trail for pricing decisions</Event>
        <Event name="PriceBookPublishedEvent">Cache invalidation</Event>
      </DomainEvents>
      <Links>
        <Link ref="RequirementsAnalysis.xml#UC-B2C-CPQ-01" />
        <Link ref="RequirementsAnalysis.xml#UC-B2B-CPQ-01" />
        <Link ref="RequirementsAnalysis.xml#UC-CPQ-PROMO-01" />
      </Links>
    </Service>

    <Service id="DP-SVC-cart-service" type="service">
      <Name>cart-service</Name>
      <ArtifactId>cart-service</ArtifactId>
      <Description>
        Manages shopping carts for customers. Stores configured items with price snapshots,
        handles promo codes, and prepares cart for checkout.
      </Description>
      <BoundedContext>cart</BoundedContext>
      <Responsibilities>
        <Item>Create and manage carts (anonymous and authenticated)</Item>
        <Item>Add/update/remove configured items</Item>
        <Item>Validate configurations remain valid on cart operations</Item>
        <Item>Apply promo codes and recalculate totals</Item>
        <Item>Prepare cart snapshot for order creation</Item>
        <Item>Merge anonymous cart into authenticated cart on login</Item>
      </Responsibilities>
      <Dependencies>
        <ServiceRef ref="DP-SVC-shared-kernel" type="compile" />
        <ServiceRef ref="DP-SVC-api-contracts" type="compile" />
        <ServiceRef ref="DP-SVC-catalog-configuration-service" type="grpc" />
        <ServiceRef ref="DP-SVC-pricing-service" type="grpc" />
      </Dependencies>
      <Database>
        <Engine ref="Technology.xml#TECH-postgresql" />
        <Schema>cart</Schema>
      </Database>
      <Ports>
        <Port type="http">8083</Port>
        <Port type="grpc">9083</Port>
      </Ports>
      <Links>
        <Link ref="RequirementsAnalysis.xml#UC-B2C-ORDER-01" />
      </Links>
    </Service>

    <Service id="DP-SVC-order-service" type="service">
      <Name>order-service</Name>
      <ArtifactId>order-service</ArtifactId>
      <Description>
        Creates orders from carts, manages order lifecycle with extended state machine,
        handles payment integration, contract acceptance, and coordinates fulfillment.
      </Description>
      <BoundedContext>order</BoundedContext>
      <Responsibilities>
        <Item>Create orders from cart snapshots</Item>
        <Item>Manage extended order state machine with PAID status lock</Item>
        <Item>Record contract acceptance</Item>
        <Item>Integrate with payment gateway for authorization and capture</Item>
        <Item>Handle payment callbacks/webhooks</Item>
        <Item>Coordinate with field-ops-service for installation scheduling</Item>
        <Item>Publish order lifecycle events</Item>
        <Item>Maintain status audit trail</Item>
      </Responsibilities>
      <Dependencies>
        <ServiceRef ref="DP-SVC-shared-kernel" type="compile" />
        <ServiceRef ref="DP-SVC-api-contracts" type="compile" />
        <ServiceRef ref="DP-SVC-cart-service" type="grpc" />
        <ServiceRef ref="DP-SVC-field-ops-service" type="async" />
        <ServiceRef ref="DP-SVC-notification-service" type="async" />
        <ExternalRef ref="INT-PAYMENTS">Payment gateway</ExternalRef>
      </Dependencies>
      <Database>
        <Engine ref="Technology.xml#TECH-postgresql" />
        <Schema>orders</Schema>
      </Database>
      <Ports>
        <Port type="http">8084</Port>
        <Port type="grpc">9084</Port>
      </Ports>
      <PackageLayout>
        <Package>com.kanokna.order_service.domain.model</Package>
        <Package>com.kanokna.order_service.domain.service</Package>
        <Package>com.kanokna.order_service.domain.event</Package>
        <Package>com.kanokna.order_service.domain.exception</Package>
        <Package>com.kanokna.order_service.application.port.in</Package>
        <Package>com.kanokna.order_service.application.port.out</Package>
        <Package>com.kanokna.order_service.application.service</Package>
        <Package>com.kanokna.order_service.application.dto</Package>
        <Package>com.kanokna.order_service.adapters.in.web</Package>
        <Package>com.kanokna.order_service.adapters.in.listener</Package>
        <Package>com.kanokna.order_service.adapters.out.persistence</Package>
        <Package>com.kanokna.order_service.adapters.out.gateway</Package>
        <Package>com.kanokna.order_service.adapters.out.kafka</Package>
        <Package>com.kanokna.order_service.adapters.config</Package>
      </PackageLayout>
      <Aggregates>
        <Aggregate name="Order">Order aggregate with items, status, and contract acceptance</Aggregate>
        <Aggregate name="Payment">Payment authorization and capture</Aggregate>
        <Aggregate name="StatusAuditLog">Immutable audit records for status changes</Aggregate>
      </Aggregates>
      <DomainEvents>
        <Event name="OrderCreatedEvent">Triggers notification, workflow update</Event>
        <Event name="OrderPaidEvent">Order locked, ready for fulfillment</Event>
        <Event name="OrderInProductionEvent">Manufacturing started</Event>
        <Event name="OrderReadyToShipEvent">Production complete</Event>
        <Event name="OrderInTransitEvent">Out for delivery</Event>
        <Event name="OrderDeliveredEvent">Products delivered</Event>
        <Event name="OrderInstalledEvent">Installation complete</Event>
        <Event name="OrderCancelledEvent">Order cancelled</Event>
        <Event name="PaymentStatusChangedEvent">Payment status update</Event>
      </DomainEvents>
      <StateMachine id="OrderStateMachine">
        <Description>Extended order state machine with PAID lock and fulfillment stages</Description>
        <State name="CREATED" initial="true">Order placed, pending payment</State>
        <State name="PENDING_PAYMENT">Awaiting payment completion</State>
        <State name="PAID">Payment confirmed, order locked (immutable)</State>
        <State name="IN_PRODUCTION">Manufacturing started</State>
        <State name="READY_FOR_SHIPMENT">Production complete, ready to ship</State>
        <State name="IN_TRANSIT">Out for delivery</State>
        <State name="DELIVERED">Products delivered</State>
        <State name="INSTALLATION_SCHEDULED">Installation appointment set</State>
        <State name="INSTALLED" terminal="true">Installation complete</State>
        <State name="CANCELLED" terminal="true">Order cancelled</State>
        <Transition from="CREATED" to="PENDING_PAYMENT" event="PAYMENT_INITIATED" />
        <Transition from="PENDING_PAYMENT" to="PAID" event="PAYMENT_CAPTURED">Locks order</Transition>
        <Transition from="PENDING_PAYMENT" to="CANCELLED" event="PAYMENT_FAILED" />
        <Transition from="PAID" to="IN_PRODUCTION" event="PRODUCTION_STARTED" />
        <Transition from="IN_PRODUCTION" to="READY_FOR_SHIPMENT" event="PRODUCTION_COMPLETE" />
        <Transition from="READY_FOR_SHIPMENT" to="IN_TRANSIT" event="SHIPPED" />
        <Transition from="IN_TRANSIT" to="DELIVERED" event="DELIVERED" />
        <Transition from="DELIVERED" to="INSTALLATION_SCHEDULED" event="INSTALLATION_SCHEDULED" />
        <Transition from="INSTALLATION_SCHEDULED" to="INSTALLED" event="INSTALLATION_COMPLETE" />
        <Transition from="DELIVERED" to="INSTALLED" event="SELF_INSTALL_CONFIRMED" />
        <Transition from="CREATED,PENDING_PAYMENT" to="CANCELLED" event="CANCELLED" />
        <Constraint>After PAID status, order is immutable (no changes to items/prices)</Constraint>
      </StateMachine>
      <Links>
        <Link ref="RequirementsAnalysis.xml#UC-B2C-ORDER-01" />
        <Link ref="RequirementsAnalysis.xml#UC-B2C-TRACK-01" />
        <Link ref="RequirementsAnalysis.xml#StatusModel" />
      </Links>
    </Service>

    <Service id="DP-SVC-account-service" type="service">
      <Name>account-service</Name>
      <ArtifactId>account-service</ArtifactId>
      <Description>
        Manages user profiles, addresses, preferences, saved configurations, and B2B organizations.
        Integrates with Keycloak for identity management.
      </Description>
      <BoundedContext>account</BoundedContext>
      <Responsibilities>
        <Item>Store user profiles (synced from Keycloak on first login)</Item>
        <Item>Manage delivery addresses</Item>
        <Item>Store user preferences (language, currency, notifications)</Item>
        <Item>Manage saved configurations for later</Item>
        <Item>B2B: organization profiles, sub-users, partner tier assignment</Item>
        <Item>Role domain assignment (B2C, B2B, Staff, Field)</Item>
      </Responsibilities>
      <Dependencies>
        <ServiceRef ref="DP-SVC-shared-kernel" type="compile" />
        <ExternalRef ref="RequirementsAnalysis.xml#ACT-IDENTITY-PROVIDER">Keycloak</ExternalRef>
      </Dependencies>
      <Database>
        <Engine ref="Technology.xml#TECH-postgresql" />
        <Schema>accounts</Schema>
      </Database>
      <Port>8085</Port>
      <Aggregates>
        <Aggregate name="UserProfile">User profile aggregate</Aggregate>
        <Aggregate name="SavedConfiguration">Saved product configurations (drafts)</Aggregate>
        <Aggregate name="PartnerOrganization">B2B organization profile</Aggregate>
      </Aggregates>
      <Links>
        <Link ref="RequirementsAnalysis.xml#UC-B2C-CPQ-01" />
        <Link ref="RequirementsAnalysis.xml#UC-RBAC-01" />
      </Links>
    </Service>

    <Service id="DP-SVC-media-service" type="service">
      <Name>media-service</Name>
      <ArtifactId>media-service</ArtifactId>
      <Description>
        Manages media assets: product images, renders, manuals, and operational documents.
        Stores metadata in database, actual files in S3-compatible storage.
      </Description>
      <BoundedContext>media</BoundedContext>
      <Responsibilities>
        <Item>Upload and store media assets</Item>
        <Item>Generate image variants (thumbnail, web, original)</Item>
        <Item>Serve media via presigned URLs or direct proxy</Item>
        <Item>Manage asset metadata (tags, descriptions, associations)</Item>
        <Item>Garbage collect orphaned assets</Item>
      </Responsibilities>
      <Dependencies>
        <ServiceRef ref="DP-SVC-shared-kernel" type="compile" />
        <ExternalRef ref="Technology.xml#TECH-s3-compatible">Object storage</ExternalRef>
      </Dependencies>
      <Database>
        <Engine ref="Technology.xml#TECH-postgresql" />
        <Schema>media</Schema>
      </Database>
      <Port>8087</Port>
      <Aggregates>
        <Aggregate name="MediaAsset">Asset metadata and variants</Aggregate>
      </Aggregates>
      <Links>
        <Link ref="RequirementsAnalysis.xml#UC-CATALOG-BROWSE" />
      </Links>
    </Service>

    <Service id="DP-SVC-notification-service" type="service">
      <Name>notification-service</Name>
      <ArtifactId>notification-service</ArtifactId>
      <Description>
        Sends transactional notifications (email, SMS, push) based on domain events.
        Manages templates, localization, and delivery tracking.
      </Description>
      <BoundedContext>notification</BoundedContext>
      <Responsibilities>
        <Item>Subscribe to domain events from Kafka</Item>
        <Item>Manage notification templates with localization</Item>
        <Item>Render templates with event data</Item>
        <Item>Send via external providers (SendGrid, Twilio)</Item>
        <Item>Track delivery status</Item>
        <Item>Handle abandoned cart reminders (scheduled)</Item>
      </Responsibilities>
      <Dependencies>
        <ServiceRef ref="DP-SVC-shared-kernel" type="compile" />
        <ExternalRef ref="RequirementsAnalysis.xml#ACT-NOTIFICATION-PROVIDER">Email/SMS providers</ExternalRef>
      </Dependencies>
      <Database>
        <Engine ref="Technology.xml#TECH-postgresql" />
        <Schema>notifications</Schema>
      </Database>
      <Port>8088</Port>
      <NotificationEvents>
        <Event trigger="MeasurementRequestCreated">Confirmation to customer</Event>
        <Event trigger="MeasurementTaskAssigned">Notification to technician</Event>
        <Event trigger="OrderPaid">Order confirmation to customer</Event>
        <Event trigger="OrderInTransit">Shipping notification</Event>
        <Event trigger="OrderDelivered">Delivery confirmation</Event>
        <Event trigger="InstallationScheduled">Appointment confirmation</Event>
        <Event trigger="InstallationCompleted">Completion notification</Event>
        <Event trigger="ServiceRequestCreated">Support ticket confirmation</Event>
      </NotificationEvents>
      <Links>
        <Link ref="RequirementsAnalysis.xml#UC-B2C-TRACK-01" />
      </Links>
    </Service>

    <Service id="DP-SVC-search-service" type="service">
      <Name>search-service</Name>
      <ArtifactId>search-service</ArtifactId>
      <Description>
        Provides full-text and faceted search over product catalog using Elasticsearch.
      </Description>
      <BoundedContext>search</BoundedContext>
      <Dependencies>
        <ServiceRef ref="DP-SVC-shared-kernel" type="compile" />
        <ServiceRef ref="DP-SVC-catalog-configuration-service" type="async" />
        <ExternalRef ref="Technology.xml#TECH-elasticsearch">Search engine</ExternalRef>
      </Dependencies>
      <Port>8089</Port>
      <Links>
        <Link ref="RequirementsAnalysis.xml#UC-CATALOG-BROWSE" />
        <Link ref="RequirementsAnalysis.xml#NFR-PERF-SEARCH-LATENCY" />
      </Links>
    </Service>

    <Service id="DP-SVC-reporting-service" type="service">
      <Name>reporting-service</Name>
      <ArtifactId>reporting-service</ArtifactId>
      <Description>
        Aggregates data for dashboards and reports including conversion funnel.
      </Description>
      <BoundedContext>reporting</BoundedContext>
      <Responsibilities>
        <Item>Consume domain events and build read models</Item>
        <Item>Provide sales, conversion, and product performance reports</Item>
        <Item>Support date range and dimension filters</Item>
        <Item>Export reports in CSV/Excel formats</Item>
      </Responsibilities>
      <Dependencies>
        <ServiceRef ref="DP-SVC-shared-kernel" type="compile" />
        <ServiceRef ref="DP-SVC-order-service" type="async" />
        <ServiceRef ref="DP-SVC-workflow-service" type="async" />
      </Dependencies>
      <Database>
        <Engine ref="Technology.xml#TECH-postgresql" />
        <Schema>reporting</Schema>
      </Database>
      <Port>8090</Port>
      <Reports>
        <Report name="ConversionFunnel">Lead -> Measurement -> Contract -> Paid -> Delivered ->
          Installed</Report>
        <Report name="SalesByChannel">B2C vs B2B revenue breakdown</Report>
        <Report name="ProductPerformance">Configuration popularity, average order value</Report>
        <Report name="OperationalMetrics">Lead time, installation SLA compliance</Report>
      </Reports>
      <Links>
        <Link ref="RequirementsAnalysis.xml#ACT-ADMIN" />
      </Links>
    </Service>

    <!-- ===========================================================================
         NEW DOMAIN SERVICES
         =========================================================================== -->
    <Service id="DP-SVC-workflow-service" type="service">
      <Name>workflow-service</Name>
      <ArtifactId>workflow-service</ArtifactId>
      <Description>
        CRM-lite workflow for leads/deals/projects, tasks, reminders, and pipeline stages.
        Owns omnichannel lead capture and deal progression.
      </Description>
      <BoundedContext>sales-workflow</BoundedContext>
      <Responsibilities>
        <Item>Capture leads from website, telephony, messengers, offline</Item>
        <Item>Manage deal pipeline stages (New -> Consultation -> Measurement -> Quote -> Contract
          -> Converted)</Item>
        <Item>Create and track tasks/reminders for managers</Item>
        <Item>Create measurement/installation requests (delegates to field-ops-service)</Item>
        <Item>Provide Kanban/pipeline dashboard queries</Item>
        <Item>Sync with external CRM if configured</Item>
      </Responsibilities>
      <Dependencies>
        <ServiceRef ref="DP-SVC-shared-kernel" type="compile" />
        <ServiceRef ref="DP-SVC-api-contracts" type="compile" />
        <ServiceRef ref="DP-SVC-catalog-configuration-service" type="grpc" />
        <ServiceRef ref="DP-SVC-pricing-service" type="grpc" />
        <ServiceRef ref="DP-SVC-field-ops-service" type="grpc" />
        <ServiceRef ref="DP-SVC-document-service" type="grpc" />
        <ServiceRef ref="DP-SVC-notification-service" type="async" />
        <ServiceRef ref="DP-SVC-reporting-service" type="async" />
        <ExternalRef ref="INT-CRM-ERP">External CRM sync</ExternalRef>
      </Dependencies>
      <Database>
        <Engine ref="Technology.xml#TECH-postgresql" />
        <Schema>workflow</Schema>
      </Database>
      <Ports>
        <Port type="http">8091</Port>
        <Port type="grpc">9091</Port>
      </Ports>
      <Aggregates>
        <Aggregate name="Lead">Initial customer inquiry</Aggregate>
        <Aggregate name="Deal">Qualified lead progressing through pipeline</Aggregate>
        <Aggregate name="Task">Manager task/reminder</Aggregate>
        <Aggregate name="PipelineStage">Configurable pipeline stages</Aggregate>
      </Aggregates>
      <DomainEvents>
        <Event name="LeadCreatedEvent">New lead intake</Event>
        <Event name="DealStageChangedEvent">Pipeline progression</Event>
        <Event name="TaskCreatedEvent">Task assigned</Event>
        <Event name="MeasurementRequestedEvent">Measurement visit requested</Event>
      </DomainEvents>
      <Links>
        <Link ref="RequirementsAnalysis.xml#UC-B2C-MEASURE-01" />
        <Link ref="RequirementsAnalysis.xml#UC-STAFF-CRM-01" />
        <Link ref="Flow-Measurement-Visit" />
      </Links>
    </Service>

    <Service id="DP-SVC-field-ops-service" type="service">
      <Name>field-ops-service</Name>
      <ArtifactId>field-ops-service</ArtifactId>
      <Description>
        Field operations tasks: measurement visits, installation jobs, logistics/warehouse
        milestones.
        Provides mobile-friendly APIs for field staff with offline-first capability.
      </Description>
      <BoundedContext>field-operations</BoundedContext>
      <Responsibilities>
        <Item>Create/assign/track measurement tasks</Item>
        <Item>Create/assign/track installation tasks</Item>
        <Item>Capture measurement results (dimensions, photos, notes)</Item>
        <Item>Capture installation completion (checklist, acceptance certificate, photos)</Item>
        <Item>Capture logistics milestones (ready-to-ship, in-transit, delivered)</Item>
        <Item>Provide "My Tasks" API for field staff mobile app</Item>
        <Item>Emit events to update deals and orders</Item>
        <Item>Support offline data sync with conflict resolution (BP-ISSUE-001)</Item>
        <Item>Manage offline task queue with retry mechanism</Item>
      </Responsibilities>
      <!-- BP-ISSUE-001 Resolution: Offline Architecture -->
      <OfflineCapability>
        <Description>
          Field technicians work in areas with poor connectivity. Service supports offline-first
          architecture with eventual consistency and conflict resolution.
        </Description>
        <SyncStrategy>
          <Item>Tasks cached locally on mobile devices via service worker or native storage</Item>
          <Item>Background sync on reconnect with exponential backoff retry</Item>
          <Item>Optimistic UI updates with rollback on sync failure</Item>
          <Item>Version vectors attached to each entity for conflict detection</Item>
        </SyncStrategy>
        <ConflictResolution>
          <Rule priority="1">Non-conflicting field changes: auto-merge using last-write-wins</Rule>
          <Rule priority="2">Conflicting measurement values: queue for supervisor review via
            workflow-service</Rule>
          <Rule priority="3">Status transitions: server state wins, conflicting local changes
            re-queued</Rule>
          <Rule priority="4">Photo uploads: always additive, no conflict possible</Rule>
        </ConflictResolution>
        <OfflineQueue>
          <Item>At-least-once delivery guarantee for queued operations</Item>
          <Item>Operations persisted to IndexedDB/SQLite before execution</Item>
          <Item>Idempotency keys prevent duplicate submissions</Item>
          <Item>Queue status visible to technician in mobile app</Item>
        </OfflineQueue>
        <DataCaching>
          <Item>Assigned tasks prefetched when online</Item>
          <Item>Product specs and checklists cached for offline reference</Item>
          <Item>Customer details (address, contact) cached per task</Item>
          <Item>Cache TTL: 24 hours with manual refresh option</Item>
        </DataCaching>
      </OfflineCapability>
      <Dependencies>
        <ServiceRef ref="DP-SVC-shared-kernel" type="compile" />
        <ServiceRef ref="DP-SVC-api-contracts" type="compile" />
        <ServiceRef ref="DP-SVC-order-service" type="grpc" />
        <ServiceRef ref="DP-SVC-media-service" type="grpc" />
        <ServiceRef ref="DP-SVC-notification-service" type="async" />
        <ExternalRef ref="INT-LOGISTICS">Logistics integration</ExternalRef>
      </Dependencies>
      <Database>
        <Engine ref="Technology.xml#TECH-postgresql" />
        <Schema>field_ops</Schema>
      </Database>
      <Ports>
        <Port type="http">8092</Port>
        <Port type="grpc">9092</Port>
      </Ports>
      <Aggregates>
        <Aggregate name="MeasurementTask">On-site measurement visit</Aggregate>
        <Aggregate name="InstallationTask">Installation job with checklist</Aggregate>
        <Aggregate name="LogisticsTask">Delivery/warehouse tasks</Aggregate>
      </Aggregates>
      <DomainEvents>
        <Event name="MeasurementTaskAssignedEvent">Task assigned to technician</Event>
        <Event name="MeasurementCompletedEvent">Measurements submitted</Event>
        <Event name="InstallationTaskAssignedEvent">Job assigned to installer</Event>
        <Event name="InstallationCompletedEvent">Installation done with acceptance</Event>
        <Event name="DeliveryStatusUpdatedEvent">Logistics milestone update</Event>
      </DomainEvents>
      <Links>
        <Link ref="RequirementsAnalysis.xml#UC-FIELD-MEASURE-01" />
        <Link ref="RequirementsAnalysis.xml#UC-FIELD-INSTALL-01" />
        <Link ref="Flow-Measurement-Visit" />
      </Links>
    </Service>

    <Service id="DP-SVC-document-service" type="service">
      <Name>document-service</Name>
      <ArtifactId>document-service</ArtifactId>
      <Description>
        Document generation and versioning: proposals, invoices, contracts, acceptance certificates.
        Template-driven with placeholder bindings from order/deal/config data.
      </Description>
      <BoundedContext>documents</BoundedContext>
      <Responsibilities>
        <Item>Manage document templates (proposal, invoice, contract, acceptance)</Item>
        <Item>Generate documents from templates with data binding</Item>
        <Item>Version document history</Item>
        <Item>Store document binaries via media-service</Item>
        <Item>Support e-contract acceptance (checkbox or e-sign integration)</Item>
      </Responsibilities>
      <Dependencies>
        <ServiceRef ref="DP-SVC-shared-kernel" type="compile" />
        <ServiceRef ref="DP-SVC-api-contracts" type="compile" />
        <ServiceRef ref="DP-SVC-media-service" type="grpc" />
        <ServiceRef ref="DP-SVC-order-service" type="grpc" />
        <ServiceRef ref="DP-SVC-billing-service" type="grpc" />
      </Dependencies>
      <Database>
        <Engine ref="Technology.xml#TECH-postgresql" />
        <Schema>documents</Schema>
      </Database>
      <Ports>
        <Port type="http">8093</Port>
        <Port type="grpc">9093</Port>
      </Ports>
      <Aggregates>
        <Aggregate name="DocumentTemplate">Template with placeholders</Aggregate>
        <Aggregate name="GeneratedDocument">Document instance with version history</Aggregate>
      </Aggregates>
      <Links>
        <Link ref="RequirementsAnalysis.xml#UC-STAFF-CRM-01" />
        <Link ref="RequirementsAnalysis.xml#UC-DOC-GENERATE-01" />
        <Link ref="RequirementsAnalysis.xml#UC-B2B-CPQ-01" />
      </Links>
    </Service>

    <Service id="DP-SVC-billing-service" type="service">
      <Name>billing-service</Name>
      <ArtifactId>billing-service</ArtifactId>
      <Description>
        B2B billing: invoices, payment schedules, partner balances, settlements.
        Integrates with payment gateways for status updates.
      </Description>
      <BoundedContext>billing-finance</BoundedContext>
      <Responsibilities>
        <Item>Issue invoices for B2B orders</Item>
        <Item>Manage payment schedules (deposit, balance due)</Item>
        <Item>Track partner balances and credit indicators</Item>
        <Item>Generate settlement reports</Item>
        <Item>Receive payment status updates from gateways</Item>
      </Responsibilities>
      <Dependencies>
        <ServiceRef ref="DP-SVC-shared-kernel" type="compile" />
        <ServiceRef ref="DP-SVC-api-contracts" type="compile" />
        <ServiceRef ref="DP-SVC-notification-service" type="async" />
        <ServiceRef ref="DP-SVC-reporting-service" type="async" />
        <ExternalRef ref="INT-PAYMENTS">Payment gateway</ExternalRef>
      </Dependencies>
      <Database>
        <Engine ref="Technology.xml#TECH-postgresql" />
        <Schema>billing</Schema>
      </Database>
      <Ports>
        <Port type="http">8094</Port>
        <Port type="grpc">9094</Port>
      </Ports>
      <Aggregates>
        <Aggregate name="Invoice">B2B invoice</Aggregate>
        <Aggregate name="PaymentSchedule">Deposit and balance schedule</Aggregate>
        <Aggregate name="PartnerBalance">Partner financial status</Aggregate>
      </Aggregates>
      <DomainEvents>
        <Event name="InvoiceIssuedEvent">Invoice created</Event>
        <Event name="PaymentReceivedEvent">Payment status update</Event>
      </DomainEvents>
      <Links>
        <Link ref="RequirementsAnalysis.xml#UC-B2B-CPQ-01" />
        <Link ref="RequirementsAnalysis.xml#UC-BILLING-VIEW-INVOICES-01" />
      </Links>
    </Service>

    <Service id="DP-SVC-support-service" type="service">
      <Name>support-service</Name>
      <ArtifactId>support-service</ArtifactId>
      <Description>
        After-sales support: service requests, warranty claims, issue tracking.
        Links requests to orders and tracks SLA/status.
      </Description>
      <BoundedContext>after-sales-support</BoundedContext>
      <Responsibilities>
        <Item>Create service requests linked to orders</Item>
        <Item>Track request status and SLA</Item>
        <Item>Store communication history</Item>
        <Item>Optionally integrate with external service desk</Item>
      </Responsibilities>
      <Dependencies>
        <ServiceRef ref="DP-SVC-shared-kernel" type="compile" />
        <ServiceRef ref="DP-SVC-api-contracts" type="compile" />
        <ServiceRef ref="DP-SVC-order-service" type="grpc" />
        <ServiceRef ref="DP-SVC-media-service" type="grpc" />
        <ServiceRef ref="DP-SVC-notification-service" type="async" />
      </Dependencies>
      <Database>
        <Engine ref="Technology.xml#TECH-postgresql" />
        <Schema>support</Schema>
      </Database>
      <Ports>
        <Port type="http">8095</Port>
        <Port type="grpc">9095</Port>
      </Ports>
      <Aggregates>
        <Aggregate name="ServiceRequest">Service/warranty request</Aggregate>
        <Aggregate name="Communication">Message thread on request</Aggregate>
      </Aggregates>
      <DomainEvents>
        <Event name="ServiceRequestCreatedEvent">Request submitted</Event>
        <Event name="ServiceRequestResolvedEvent">Issue resolved</Event>
      </DomainEvents>
      <Links>
        <Link ref="RequirementsAnalysis.xml#UC-SUPPORT-CREATE-01" />
      </Links>
    </Service>
  </Services>

  <!-- ===============================================================================
       FLOWS
       =============================================================================== -->
  <Flows>
    <Flow id="Flow-Config-Pricing">
      <Name>Configuration Validation and Pricing</Name>
      <Description>
        Shared CPQ sub-flow: validate a configuration and calculate a price quote.
        Used by B2C configurator, B2B dealer quoting, cart recalculation, and measurement repricing.
      </Description>
      <Sequence>
        <Step order="1" from="frontend" to="gateway">Submit configuration for validation</Step>
        <Step order="2" from="gateway" to="catalog-configuration-service">Validate configuration</Step>
        <Step order="3" from="catalog-configuration-service" to="pricing-service">Calculate quote</Step>
        <Step order="4" from="pricing-service" to="catalog-configuration-service">Return quote and decision trace</Step>
        <Step order="5" from="catalog-configuration-service" to="frontend">Return validation result with quote</Step>
      </Sequence>
      <Links>
        <Link ref="RequirementsAnalysis.xml#UC-CATALOG-CONFIGURE-ITEM" />
        <Link ref="RequirementsAnalysis.xml#UC-PRICING-QUOTE" />
        <Link ref="RequirementsAnalysis.xml#UC-B2C-CPQ-01" />
        <Link ref="RequirementsAnalysis.xml#UC-B2B-CPQ-01" />
      </Links>
    </Flow>

    <Flow id="Flow-B2C-CPQ">
      <Name>B2C CPQ: Configure + Instant Price + Save Draft</Name>
      <Description>Customer configures product, receives instant pricing, and saves draft</Description>
      <Sequence>
        <Step order="1" from="frontend" to="gateway">Load product template</Step>
        <Step order="2" from="gateway" to="catalog-configuration-service">Get product template with
          options</Step>
        <Step order="3" from="frontend" to="gateway">Submit configuration for validation</Step>
        <Step order="4" from="gateway" to="catalog-configuration-service">Validate configuration</Step>
        <Step order="5" from="catalog-configuration-service" to="pricing-service">Calculate price
          quote</Step>
        <Step order="6" from="pricing-service" to="catalog-configuration-service">Return Quote with
          promos</Step>
        <Step order="7" from="catalog-configuration-service" to="frontend">Return validated config
          with price</Step>
        <Step order="8" from="frontend" to="account-service">Save draft configuration (if
          authenticated)</Step>
      </Sequence>
      <PerformanceRequirement>Price recalculation within 300ms of user input</PerformanceRequirement>
      <Links>
        <Link ref="RequirementsAnalysis.xml#UC-B2C-CPQ-01" />
        <Link ref="RequirementsAnalysis.xml#NFR-PERF-CPQ-RECALC" />
      </Links>
    </Flow>

    <Flow id="Flow-Measurement-Visit">
      <Name>Measurement Request and Visit Flow</Name>
      <Description>
        Customer requests measurement; task created; technician completes; repricing triggered.
        Includes variance handling with threshold-based re-approval (BP-ISSUE-003 Resolution).
      </Description>
      <Sequence>
        <Step order="1" from="frontend" to="workflow-service">Request measurement with address +
          slot</Step>
        <Step order="2" from="workflow-service" to="field-ops-service">Create measurement task</Step>
        <Step order="3" from="field-ops-service" to="notification-service">Notify technician +
          customer</Step>
        <Step order="4" from="field-app" to="field-ops-service">Technician submits
          measurements/photos</Step>
        <Step order="5" from="field-ops-service" to="workflow-service">Emit MEASUREMENT_COMPLETED
          event</Step>
        <Step order="6" from="workflow-service" to="pricing-service">Recalculate with measured
          dimensions</Step>
        <Step order="7" from="workflow-service" to="workflow-service">Calculate price variance
          percentage</Step>
        <Step order="8" from="workflow-service" to="notification-service">Branch based on variance
          threshold</Step>
      </Sequence>
      <!-- BP-ISSUE-003 Resolution: Measurement Variance Handling -->
      <VarianceBranches>
        <Branch id="variance-auto-accept" condition="variance &lt;= 5%">
          <Description>Minor variance: auto-accept with notification</Description>
          <Steps>
            <Step order="8a" from="workflow-service" to="database">Update quote with measured price
              (auto-accepted)</Step>
            <Step order="8b" from="notification-service" to="customer">Send info notification:
              "Minor adjustment applied"</Step>
            <Step order="8c" from="workflow-service" to="workflow-service">Continue to ordering flow</Step>
          </Steps>
        </Branch>
        <Branch id="variance-confirmation" condition="5% &lt; variance &lt;= 10%">
          <Description>Moderate variance: require customer confirmation</Description>
          <Steps>
            <Step order="8a" from="workflow-service" to="database">Create pending quote requiring
              confirmation</Step>
            <Step order="8b" from="notification-service" to="customer">Send email/SMS with updated
              quote + confirm link</Step>
            <Step order="8c" from="frontend" to="workflow-service">Customer clicks confirm/reject
              link</Step>
            <Step order="8d-confirm" from="workflow-service" to="database">If confirmed: accept
              quote, continue to ordering</Step>
            <Step order="8d-reject" from="workflow-service" to="workflow-service">If rejected:
              return to configuration or cancel</Step>
            <Step order="8e" from="workflow-service" to="workflow-service">Timeout after 72h: quote
              expires, notify customer</Step>
          </Steps>
        </Branch>
        <Branch id="variance-requote" condition="variance &gt; 10%">
          <Description>Significant variance: generate new quote, full re-approval</Description>
          <Steps>
            <Step order="8a" from="workflow-service" to="database">Invalidate original quote</Step>
            <Step order="8b" from="workflow-service" to="pricing-service">Generate new quote with
              measured dimensions</Step>
            <Step order="8c" from="notification-service" to="customer">Send notification explaining
              significant change</Step>
            <Step order="8d" from="frontend" to="catalog-configuration-service">Customer reviews
              updated configuration</Step>
            <Step order="8e" from="frontend" to="workflow-service">Customer accepts new quote or
              cancels</Step>
          </Steps>
        </Branch>
      </VarianceBranches>
      <AuditRequirement>
        Log all variance decisions: original quote ID, measured quote ID, variance %,
        threshold applied, customer response, timestamps.
      </AuditRequirement>
      <Links>
        <Link ref="RequirementsAnalysis.xml#UC-B2C-MEASURE-01" />
        <Link ref="RequirementsAnalysis.xml#UC-FIELD-MEASURE-01" />
        <Link ref="RequirementsAnalysis.xml#MeasurementVarianceHandling" />
      </Links>
    </Flow>

    <Flow id="Flow-Checkout-Payment">
      <Name>Checkout, Contract Acceptance, and Payment</Name>
      <Description>Customer checks out, accepts contract, pays, and order is locked</Description>
      <Sequence>
        <Step order="1" from="frontend" to="cart-service">Get cart for checkout</Step>
        <Step order="2" from="cart-service" to="pricing-service">Verify current prices</Step>
        <Step order="3" from="frontend" to="order-service">Create order from cart</Step>
        <Step order="4" from="order-service" to="database">Persist order with CREATED status</Step>
        <Step order="5" from="frontend" to="order-service">Accept contract terms</Step>
        <Step order="6" from="order-service" to="database">Record contract acceptance</Step>
        <Step order="7" from="order-service" to="payment-gateway">Initiate payment</Step>
        <Step order="8" from="payment-gateway" to="frontend">Redirect to payment form</Step>
        <Step order="9" from="payment-gateway" to="order-service">Webhook: payment captured</Step>
        <Step order="10" from="order-service" to="database">Update to PAID status (lock order)</Step>
        <Step order="11" from="order-service" to="kafka">Publish OrderPaidEvent</Step>
        <Step order="12" from="notification-service" to="customer">Send order confirmation</Step>
      </Sequence>
      <AlternateFlows>
        <Flow trigger="Payment fails">
          <Step>order-service receives failure webhook</Step>
          <Step>Order remains in PENDING_PAYMENT or moves to CANCELLED</Step>
          <Step>Customer notified of failure</Step>
        </Flow>
      </AlternateFlows>
      <Links>
        <Link ref="RequirementsAnalysis.xml#UC-B2C-ORDER-01" />
      </Links>
    </Flow>

    <Flow id="Flow-Order-Fulfillment">
      <Name>Order Fulfillment through Installation</Name>
      <Description>Order progresses from PAID through production, delivery, and installation</Description>
      <Sequence>
        <Step order="1" from="order-service" to="kafka">Order in PAID status</Step>
        <Step order="2" from="external/ERP" to="order-service">Production started</Step>
        <Step order="3" from="order-service" to="database">Update to IN_PRODUCTION</Step>
        <Step order="4" from="external/ERP" to="order-service">Production complete</Step>
        <Step order="5" from="order-service" to="database">Update to READY_FOR_SHIPMENT</Step>
        <Step order="6" from="field-ops-service" to="order-service">Shipment dispatched</Step>
        <Step order="7" from="order-service" to="database">Update to IN_TRANSIT</Step>
        <Step order="8" from="field-ops-service" to="order-service">Delivery confirmed</Step>
        <Step order="9" from="order-service" to="database">Update to DELIVERED</Step>
        <Step order="10" from="workflow-service" to="field-ops-service">Schedule installation</Step>
        <Step order="11" from="field-ops-service" to="order-service">Installation task created</Step>
        <Step order="12" from="order-service" to="database">Update to INSTALLATION_SCHEDULED</Step>
        <Step order="13" from="field-app" to="field-ops-service">Installation completed</Step>
        <Step order="14" from="field-ops-service" to="order-service">Emit InstallationCompletedEvent</Step>
        <Step order="15" from="order-service" to="database">Update to INSTALLED</Step>
      </Sequence>
      <AuditRequirement>Each status transition creates immutable audit record</AuditRequirement>
      <Links>
        <Link ref="RequirementsAnalysis.xml#UC-B2C-TRACK-01" />
        <Link ref="RequirementsAnalysis.xml#UC-FIELD-INSTALL-01" />
        <Link ref="RequirementsAnalysis.xml#StatusModel" />
      </Links>
    </Flow>

    <Flow id="Flow-B2B-Project-Order">
      <Name>B2B Project Order with Partner Pricing</Name>
      <Description>Dealer creates project order with batch items, partner pricing, and documents</Description>
      <Sequence>
        <Step order="1" from="frontend" to="order-service">Create order from cart</Step>
        <Step order="2" from="order-service" to="cart-service">Get cart snapshot</Step>
        <Step order="3" from="order-service" to="database">Create Order with CREATED status</Step>
        <Step order="4" from="order-service" to="payment-gateway">Initiate payment session</Step>
        <Step order="5" from="payment-gateway" to="frontend">Redirect to payment form</Step>
        <Step order="6" from="frontend" to="payment-gateway">Customer submits payment</Step>
        <Step order="7" from="payment-gateway" to="order-service">Webhook: payment authorized</Step>
        <Step order="8" from="order-service" to="payment-gateway">Capture payment</Step>
        <Step order="9" from="order-service" to="database">Update Order to CONFIRMED</Step>
        <Step order="10" from="order-service" to="kafka">Publish OrderCreatedEvent</Step>
        <Step order="11" from="notification-service" to="customer">Send order confirmation email</Step>
      </Sequence>
      <AlternateFlows>
        <Flow trigger="Payment fails">
          <Step order="7a">payment-gateway returns failure</Step>
          <Step order="7b">order-service marks order as CANCELLED</Step>
          <Step order="7c">frontend displays payment error</Step>
        </Flow>
      </AlternateFlows>
      <Links>
        <Link ref="RequirementsAnalysis.xml#UC-ORDER-PLACE" />
      </Links>
    </Flow>

    <Flow id="Flow-Order-Lifecycle">
      <Name>Order Lifecycle Flow</Name>
      <Description>Order progresses through states from creation to completion</Description>
      <Sequence>
        <Step order="1" from="order-service" to="kafka">OrderCreatedEvent</Step>
        <Step order="2" from="field-ops-service" to="order-service">Schedule installation if
          requested</Step>
        <Step order="3" from="order-service" to="kafka">Order moves to PROCESSING</Step>
        <Step order="4" from="logistics-system" to="order-service">Order shipped (external trigger)</Step>
        <Step order="5" from="order-service" to="kafka">OrderShippedEvent</Step>
        <Step order="6" from="notification-service" to="customer">Send shipping notification</Step>
        <Step order="7" from="logistics-system" to="order-service">Order delivered (external
          trigger)</Step>
        <Step order="8" from="order-service" to="kafka">OrderDeliveredEvent</Step>
        <Step order="9" from="field-ops-service" to="order-service">Installation completed</Step>
        <Step order="10" from="order-service" to="kafka">OrderCompletedEvent</Step>
      </Sequence>
      <Links>
        <Link ref="RequirementsAnalysis.xml#UC-B2C-TRACK-01" />
        <Link ref="DP-SVC-order-service" />
      </Links>
    </Flow>

    <!-- ISS-SEARCH-001: Flow-ProductSearch added 2026-01-08 -->
    <Flow id="Flow-ProductSearch">
      <Name>Product Search and Discovery</Name>
      <Description>
        User searches product catalog with full-text query and faceted filtering.
        Results returned with pagination and aggregated facet counts.
      </Description>
      <Sequence>
        <Step order="1" from="frontend" to="gateway">User submits search query with filters</Step>
        <Step order="2" from="gateway" to="search-service">Route to search-service (REST or gRPC)</Step>
        <Step order="3" from="search-service" to="search-service">Build Elasticsearch query from
          SearchQuery</Step>
        <Step order="4" from="search-service" to="elasticsearch">Execute search query</Step>
        <Step order="5" from="elasticsearch" to="search-service">Return matching documents and
          aggregations</Step>
        <Step order="6" from="search-service" to="search-service">Map response to SearchResult with
          facets</Step>
        <Step order="7" from="search-service" to="frontend">Return paginated results with facet
          counts</Step>
      </Sequence>
      <AlternateFlows>
        <Flow trigger="Autocomplete request">
          <Step order="2a" from="gateway" to="search-service">Route autocomplete request</Step>
          <Step order="3a" from="search-service" to="elasticsearch">Execute completion suggester
            query</Step>
          <Step order="4a" from="search-service" to="frontend">Return suggestions list</Step>
        </Flow>
      </AlternateFlows>
      <PerformanceRequirement>P95 search latency &lt; 200ms, P95 autocomplete latency &lt; 100ms</PerformanceRequirement>
      <Links>
        <Link ref="RequirementsAnalysis.xml#UC-CATALOG-BROWSE" />
        <Link ref="RequirementsAnalysis.xml#NFR-PERF-SEARCH-LATENCY" />
        <Link ref="DP-SVC-search-service" />
      </Links>
    </Flow>

    <Flow id="Flow-Document-Issue">
      <Name>Document Issuance (Proposal / Invoice / Contract)</Name>
      <Description>
        Staff generates proposal/invoice/contract for a deal/order. document-service renders and versions the
        document, stores the binary via media-service, and notifies recipients with a secure link.
      </Description>
      <Sequence>
        <Step order="1" from="workflow-service" to="document-service">Request document generation</Step>
        <Step order="2" from="document-service" to="order-service">Load order snapshot (if order-based)</Step>
        <Step order="3" from="document-service" to="billing-service">Load invoice/schedule data (if invoice-based)</Step>
        <Step order="4" from="document-service" to="media-service">Store generated binary and return media reference</Step>
        <Step order="5" from="document-service" to="notification-service">Notify recipients with document link</Step>
      </Sequence>
      <AlternateFlows>
        <Flow trigger="E-signature required">
          <Step order="2a" from="document-service" to="external-esign">Initiate e-sign flow (provider TBD)</Step>
          <Step order="2b" from="external-esign" to="document-service">Receive signature status updates</Step>
        </Flow>
      </AlternateFlows>
      <Links>
        <Link ref="RequirementsAnalysis.xml#UC-DOC-GENERATE-01" />
        <Link ref="RequirementsAnalysis.xml#DEC-OPEN-ESIGN" />
        <Link ref="DP-SVC-document-service" />
        <Link ref="DP-SVC-media-service" />
        <Link ref="DP-SVC-notification-service" />
      </Links>
    </Flow>

    <Flow id="Flow-B2B-Finance">
      <Name>B2B Finance: Invoices, Schedules, Settlements</Name>
      <Description>
        Dealer views invoices, payment schedules, and settlement totals. billing-service is the source of truth
        for finance metadata and exposes partner-scoped queries; documents are accessed via document-service/media-service.
      </Description>
      <Sequence>
        <Step order="1" from="frontend" to="gateway">Request partner invoices and balances</Step>
        <Step order="2" from="gateway" to="billing-service">Query invoices, schedules, balances, settlements</Step>
        <Step order="3" from="billing-service" to="document-service">Resolve invoice document references (optional)</Step>
        <Step order="4" from="billing-service" to="frontend">Return finance view with document links</Step>
      </Sequence>
      <Links>
        <Link ref="RequirementsAnalysis.xml#UC-BILLING-VIEW-INVOICES-01" />
        <Link ref="DP-SVC-billing-service" />
        <Link ref="DP-SVC-document-service" />
      </Links>
    </Flow>

    <Flow id="Flow-Event-Driven">
      <Name>Asynchronous Event-Driven Communication</Name>
      <Description>Services communicate asynchronously via Kafka domain events</Description>
      <Producers>
        <Producer service="catalog-configuration-service"
          events="ProductTemplatePublishedEvent, ProductTemplateUnpublishedEvent, ProductTemplateUpdatedEvent, CatalogVersionPublishedEvent" />
        <Producer service="pricing-service" events="QuoteCalculatedEvent, PriceBookPublishedEvent" />
        <Producer service="order-service"
          events="OrderCreatedEvent, OrderPaidEvent, OrderInProductionEvent, OrderDeliveredEvent, OrderInstalledEvent, OrderCancelledEvent" />
        <Producer service="workflow-service"
          events="LeadCreatedEvent, DealStageChangedEvent, MeasurementRequestedEvent" />
        <Producer service="field-ops-service"
          events="MeasurementCompletedEvent, InstallationCompletedEvent, DeliveryStatusUpdatedEvent" />
        <Producer service="billing-service" events="InvoiceIssuedEvent, PaymentReceivedEvent" />
        <Producer service="support-service"
          events="ServiceRequestCreatedEvent, ServiceRequestResolvedEvent" />
      </Producers>
      <Consumers>
        <!-- ISS-SEARCH-005: Updated to include all 3 search events -->
        <Consumer service="search-service"
          events="ProductTemplatePublishedEvent, ProductTemplateUnpublishedEvent, ProductTemplateUpdatedEvent">
          <Action event="ProductTemplatePublishedEvent">Index or update product document</Action>
          <Action event="ProductTemplateUnpublishedEvent">Delete product document from index</Action>
          <Action event="ProductTemplateUpdatedEvent">Update product document if indexed</Action>
        </Consumer>
        <Consumer service="notification-service"
          events="OrderPaidEvent, MeasurementCompletedEvent, InstallationCompletedEvent, ServiceRequestCreatedEvent" />
        <Consumer service="reporting-service"
          events="OrderPaidEvent, OrderInstalledEvent, LeadCreatedEvent, DealStageChangedEvent" />
        <Consumer service="order-service"
          events="InstallationCompletedEvent, DeliveryStatusUpdatedEvent, PaymentReceivedEvent" />
        <Consumer service="workflow-service" events="MeasurementCompletedEvent, OrderPaidEvent" />
      </Consumers>
      <Links>
        <Link ref="Technology.xml#TECH-kafka" />
      </Links>
    </Flow>
  </Flows>

  <!-- ===============================================================================
       INTEGRATION CONTRACTS
       =============================================================================== -->
  <Integrations>
    <Integration id="INT-CRM-ERP">
      <Name>CRM/ERP Integration</Name>
      <Type>bidirectional</Type>
      <Description>Sync leads, deals, tasks, and order statuses with external CRM/ERP</Description>
      <OutboundEvents>
        <Event name="LeadCreatedEvent">Sent when new lead captured</Event>
        <Event name="DealStageChangedEvent">Sent when pipeline stage changes</Event>
        <Event name="TaskCreatedEvent">Sent when task created</Event>
        <Event name="OrderStatusChangedEvent">Sent when order status changes</Event>
      </OutboundEvents>
      <InboundEvents>
        <Event name="OrderProductionStatusUpdate">Received from ERP for production milestones</Event>
      </InboundEvents>
      <SourceOfTruth>
        <Field name="Lead/Deal stages">Our system (primary)</Field>
        <Field name="Production status">TBD - see DEC-OPEN-STATUS-SOT</Field>
      </SourceOfTruth>
      <ImplementingService ref="DP-SVC-workflow-service" />
      <Links>
        <Link ref="RequirementsAnalysis.xml#INT-REQ-CRM" />
      </Links>
    </Integration>

    <Integration id="INT-CAD">
      <Name>CAD/CPQ Integration</Name>
      <Type>sync-request</Type>
      <Description>Feasibility validation, drawing generation, visualization</Description>
      <Operations>
        <Operation name="validateFeasibility">
          <Input>Configuration spec (dimensions, materials, options)</Input>
          <Output>Feasibility result (pass/fail with reasons)</Output>
          <SLA>TBD - see DEC-OPEN-CAD-FORMAT</SLA>
        </Operation>
        <Operation name="generateDrawing">
          <Input>Configuration spec</Input>
          <Output>Drawing files (PDF, DXF)</Output>
        </Operation>
        <Operation name="getVisualization">
          <Input>Configuration spec</Input>
          <Output>Image/3D model URL</Output>
        </Operation>
      </Operations>
      <ImplementingService ref="DP-SVC-catalog-configuration-service" />
      <Links>
        <Link ref="RequirementsAnalysis.xml#INT-REQ-CAD" />
      </Links>
    </Integration>

    <Integration id="INT-ERP">
      <Name>ERP/Manufacturing Integration</Name>
      <Type>bidirectional</Type>
      <Description>Order sync and production status updates</Description>
      <OutboundEvents>
        <Event name="OrderPaidEvent">Order ready for production</Event>
      </OutboundEvents>
      <InboundEvents>
        <Event name="ProductionStarted">Manufacturing began</Event>
        <Event name="ProductionComplete">Ready for shipment</Event>
      </InboundEvents>
      <SourceOfTruth>
        <Field name="Production stages">ERP (likely) - see DEC-OPEN-STATUS-SOT</Field>
      </SourceOfTruth>
      <ImplementingService ref="DP-SVC-order-service" />
      <Links>
        <Link ref="RequirementsAnalysis.xml#INT-REQ-ERP" />
      </Links>
    </Integration>

    <Integration id="INT-LOGISTICS">
      <Name>Logistics/Delivery Integration</Name>
      <Type>bidirectional</Type>
      <Description>
        Route planning, tracking, and proof of delivery.
        POD requires both photo and digital signature (BP-ISSUE-004 Resolution).
      </Description>
      <OutboundEvents>
        <Event name="DeliveryRequested">Delivery address and items</Event>
      </OutboundEvents>
      <InboundEvents>
        <Event name="ShipmentDispatched">In transit with tracking number</Event>
        <Event name="DeliveryCompleted">Delivered with proof of delivery payload</Event>
        <Event name="DeliveryException">Failed delivery attempt with reason</Event>
      </InboundEvents>
      <!-- BP-ISSUE-004 Resolution: Proof of Delivery Data Structure -->
      <ProofOfDeliveryContract>
        <Description>
          POD data structure received in DeliveryCompleted event.
          Both photo and signature are REQUIRED for valid delivery confirmation.
        </Description>
        <DataStructure>
          <Field name="orderId" type="UUID" required="true">Reference to order being delivered</Field>
          <Field name="deliveryTimestamp" type="ISO8601DateTime" required="true">Actual delivery
            time</Field>
          <Field name="trackingNumber" type="String" required="true">Carrier tracking reference</Field>
          <Field name="photos" type="Array[PhotoCapture]" required="true" minItems="1">
            <Description>GPS-tagged delivery photos</Description>
            <ItemSchema>
              <Field name="url" type="URL">Hosted photo URL</Field>
              <Field name="gpsLatitude" type="Decimal">Photo GPS latitude</Field>
              <Field name="gpsLongitude" type="Decimal">Photo GPS longitude</Field>
              <Field name="captureTimestamp" type="ISO8601DateTime">When photo was taken</Field>
              <Field name="resolution" type="String">Image resolution (min 1280x720)</Field>
            </ItemSchema>
          </Field>
          <Field name="signature" type="SignatureCapture" required="true">
            <Description>Digital signature from recipient</Description>
            <Schema>
              <Field name="signatureImage" type="Base64">Signature image data</Field>
              <Field name="signerName" type="String" required="true">Printed name of signer</Field>
              <Field name="signerRelation" type="Enum" required="true">CUSTOMER | NEIGHBOR | AGENT</Field>
              <Field name="captureTimestamp" type="ISO8601DateTime">When signature was captured</Field>
              <Field name="deviceId" type="String">Delivery device identifier</Field>
            </Schema>
          </Field>
          <Field name="gpsCoordinates" type="GeoPoint" required="true">
            <Description>Delivery location coordinates</Description>
            <Schema>
              <Field name="latitude" type="Decimal" />
              <Field name="longitude" type="Decimal" />
              <Field name="accuracy" type="Decimal">GPS accuracy in meters</Field>
            </Schema>
          </Field>
          <Field name="deliveryNotes" type="String" required="false">Optional notes from driver</Field>
          <Field name="neighborDelivery" type="NeighborInfo" required="false">
            <Description>Required if signerRelation is NEIGHBOR</Description>
            <Schema>
              <Field name="neighborName" type="String">Neighbor's full name</Field>
              <Field name="neighborAddress" type="String">Neighbor's address</Field>
              <Field name="relationToCustomer" type="String">e.g., "Next door", "Apartment 2B"</Field>
            </Schema>
          </Field>
        </DataStructure>
        <FallbackScenarios>
          <Scenario id="NEIGHBOR_DELIVERY">
            <Condition>Customer unavailable, neighbor accepts delivery</Condition>
            <RequiredFields>photos, signature (neighbor), neighborDelivery</RequiredFields>
            <PostDeliveryAction>Notify customer of neighbor delivery location</PostDeliveryAction>
          </Scenario>
          <Scenario id="SAFE_PLACE">
            <Condition>Customer pre-authorized safe place delivery</Condition>
            <RequiredFields>photos, gpsCoordinates (signature optional)</RequiredFields>
            <PostDeliveryAction>Immediate customer notification with photo</PostDeliveryAction>
          </Scenario>
        </FallbackScenarios>
        <CustomerConfirmation>
          <Description>Optional post-delivery confirmation flow</Description>
          <NotificationTrigger>Sent within 1 hour of DeliveryCompleted event</NotificationTrigger>
          <ResponseWindow>24 hours</ResponseWindow>
          <AutoConfirmOnTimeout>true</AutoConfirmOnTimeout>
          <DisputeFlow>If customer reports issue, create support ticket via support-service</DisputeFlow>
        </CustomerConfirmation>
      </ProofOfDeliveryContract>
      <ImplementingService ref="DP-SVC-field-ops-service" />
      <Links>
        <Link ref="RequirementsAnalysis.xml#INT-REQ-LOGISTICS" />
        <Link ref="RequirementsAnalysis.xml#UC-DELIVERY-TRACK-01" />
        <Link ref="RequirementsAnalysis.xml#PODRequirements" />
      </Links>
    </Integration>

    <Integration id="INT-PAYMENTS">
      <Name>Payment Gateway Integration</Name>
      <Type>sync-request + webhook</Type>
      <Description>Payment initiation and webhook status updates</Description>
      <Operations>
        <Operation name="initiatePayment">
          <Input>Amount, currency, order reference, return URLs</Input>
          <Output>Payment session URL or token</Output>
        </Operation>
        <Operation name="capturePayment">
          <Input>Payment ID</Input>
          <Output>Capture result</Output>
        </Operation>
        <Operation name="refundPayment">
          <Input>Payment ID, amount</Input>
          <Output>Refund result</Output>
        </Operation>
      </Operations>
      <Webhooks>
        <Webhook event="payment.succeeded">Payment captured successfully</Webhook>
        <Webhook event="payment.failed">Payment failed</Webhook>
        <Webhook event="refund.succeeded">Refund processed</Webhook>
      </Webhooks>
      <Security>
        <Item>Webhook signature verification required</Item>
        <Item>No card data stored (PCI on provider)</Item>
        <Item>Payment tokens used for references</Item>
      </Security>
      <ImplementingService ref="DP-SVC-order-service" />
      <ImplementingService ref="DP-SVC-billing-service" />
      <Links>
        <Link ref="RequirementsAnalysis.xml#INT-REQ-PAYMENTS" />
        <Link ref="RequirementsAnalysis.xml#NFR-SEC-PAYMENT" />
      </Links>
    </Integration>
  </Integrations>

  <!-- ===============================================================================
       CONTRACT EVOLUTION POLICY
       =============================================================================== -->
  <ContractEvolutionPolicy id="ContractEvolutionPolicy">
    <REST>
      <Versioning>URL path versioning (/api/v1/, /api/v2/)</Versioning>
      <Deprecation>6-month deprecation window with Sunset header</Deprecation>
      <CompatibilityRules>
        <Rule>Adding optional fields is backward compatible</Rule>
        <Rule>Removing required fields requires new version</Rule>
        <Rule>Changing field types requires new version</Rule>
      </CompatibilityRules>
    </REST>
    <Events>
      <SchemaFormat>Protobuf</SchemaFormat>
      <Registry>Confluent Schema Registry or equivalent</Registry>
      <CompatibilityMode>BACKWARD</CompatibilityMode>
      <CompatibilityRules>
        <Rule>Add optional fields only; never remove or rename</Rule>
        <Rule>Use reserved field numbers for deprecated fields</Rule>
        <Rule>Event type name includes version if breaking change required (e.g.,
          OrderCreatedEventV2)</Rule>
      </CompatibilityRules>
    </Events>
    <ContractTesting>
      <Tools>
        <Tool id="CT-OPENAPI">OpenAPI contract validation (spectral)</Tool>
        <Tool id="CT-PROTOBUF">Protobuf compatibility checks (buf)</Tool>
        <Tool id="CT-SPRING-CONTRACT">Spring Cloud Contract for consumer-driven contracts</Tool>
      </Tools>
      <Policy>Contract tests run in CI before merge</Policy>
      <Links>
        <Link ref="Technology.xml#DEC-TEST-CONTRACTS" />
      </Links>
    </ContractTesting>
    <Links>
      <Link ref="Technology.xml#TECH-protobuf" />
      <Link ref="Technology.xml#TECH-contract-testing" />
    </Links>
  </ContractEvolutionPolicy>

  <!-- ===============================================================================
       TESTING STRATEGY
       =============================================================================== -->
  <TestingStrategy id="TestingStrategy">
    <!-- ─────────────────────────────────────────────────────────────────────────
         TESTING PYRAMID
         ───────────────────────────────────────────────────────────────────────── -->
    <TestingPyramid>
      <Layer name="Unit" percentage="70">
        <Description>Domain logic, services, validators</Description>
        <Tools>JUnit 5, Mockito, AssertJ</Tools>
        <Coverage>80% minimum for domain and application layers</Coverage>
      </Layer>
      <Layer name="Slice" percentage="15">
        <Description>Layer-specific tests (web, persistence, gRPC)</Description>
        <Tools>@WebMvcTest, @DataJpaTest, @JsonTest, @GrpcClientTest</Tools>
        <Scope>Controller request/response, repository queries, gRPC client/server</Scope>
      </Layer>
      <Layer name="Integration" percentage="10">
        <Description>Full stack with real dependencies</Description>
        <Tools>Testcontainers (PostgreSQL, Kafka, Redis, Elasticsearch)</Tools>
        <Scope>End-to-end service flows, event publishing/consuming</Scope>
      </Layer>
      <Layer name="Contract" percentage="5">
        <Description>API and event contract validation</Description>
        <Tools>Spring Cloud Contract, OpenAPI validators, buf (Protobuf)</Tools>
        <Scope>Producer/consumer contract alignment</Scope>
      </Layer>
    </TestingPyramid>

    <!-- ─────────────────────────────────────────────────────────────────────────
         HEXAGONAL LAYER MAPPING (AWO-20260120-01)
         ───────────────────────────────────────────────────────────────────────── -->
    <HexagonalLayerMapping>
      <Description>
        Maps test types to hexagonal architecture layers. Each layer has specific
        testing tools, naming conventions, and coverage expectations.
      </Description>

      <Layer name="domain" package="com.kanokna.{svc}.domain.**">
        <TestType>Unit tests only (pure Java, no Spring context)</TestType>
        <Location>src/test/java/{package}/domain/**/*Test.java</Location>
        <Tools>
          <Tool>JUnit 5 with @Nested for scenario organization</Tool>
          <Tool>AssertJ for fluent assertions</Tool>
          <Tool>Mockito (minimal - domain is mostly pure logic)</Tool>
        </Tools>
        <MockingPolicy>
          Avoid mocking within domain layer. Domain objects should be tested
          as pure functions with real collaborators. Mock only external interfaces
          if absolutely necessary.
        </MockingPolicy>
        <Examples>
          <Example service="pricing-service">PriceCalculationServiceTest, DiscountServiceTest</Example>
          <Example service="cart-service">CartTest, CartItemTest</Example>
          <Example service="catalog-configuration-service">RuleEvaluatorTest, ValidationResultTest</Example>
        </Examples>
      </Layer>

      <Layer name="application" package="com.kanokna.{svc}.application.**">
        <TestType>Unit tests with mocked driven ports</TestType>
        <Location>src/test/java/{package}/application/**/*Test.java</Location>
        <Tools>
          <Tool>JUnit 5</Tool>
          <Tool>Mockito for mocking port.out interfaces (repositories, external services)</Tool>
          <Tool>AssertJ</Tool>
        </Tools>
        <MockingPolicy>
          Mock all driven ports (port.out.*) to isolate application service logic.
          Verify interactions with ports using Mockito.verify().
          Do NOT mock domain objects - use real domain instances.
        </MockingPolicy>
        <Examples>
          <Example service="cart-service">AddToCartUseCaseTest, CheckoutUseCaseTest</Example>
          <Example service="account-service">ProfileServiceTest, AddressServiceTest</Example>
        </Examples>
      </Layer>

      <Layer name="adapters.in.grpc" package="com.kanokna.{svc}.adapters.in.grpc.**">
        <TestType>gRPC integration tests (SpringBootTest + @GrpcClientTest)</TestType>
        <Location>src/test/java/{package}/*GrpcIntegrationTest.java</Location>
        <Tools>
          <Tool>@SpringBootTest with grpc-inprocess channel</Tool>
          <Tool>@GrpcClientTest for client-side tests</Tool>
          <Tool>GrpcMock for mocking external gRPC dependencies</Tool>
        </Tools>
        <Scope>
          <Item>Verify Protobuf request/response serialization</Item>
          <Item>Verify error handling and gRPC status codes</Item>
          <Item>Verify interceptor behavior (auth, logging, metrics)</Item>
        </Scope>
        <Examples>
          <Example service="search-service">SearchServiceGrpcContractTest</Example>
          <Example service="pricing-service">PricingServiceGrpcIntegrationTest</Example>
        </Examples>
      </Layer>

      <Layer name="adapters.in.web" package="com.kanokna.{svc}.adapters.in.web.**">
        <TestType>REST/Web integration tests (MockMvc/WebTestClient)</TestType>
        <Location>src/test/java/{package}/*ControllerTest.java or *RestIntegrationTest.java</Location>
        <Tools>
          <Tool>@WebMvcTest for sliced controller tests</Tool>
          <Tool>MockMvc for synchronous request/response testing</Tool>
          <Tool>WebTestClient for reactive/gateway tests</Tool>
        </Tools>
        <Scope>
          <Item>Verify request/response JSON serialization</Item>
          <Item>Verify input validation (@Valid) error responses</Item>
          <Item>Verify authentication/authorization behavior</Item>
        </Scope>
      </Layer>

      <Layer name="adapters.out.persistence" package="com.kanokna.{svc}.adapters.out.persistence.**">
        <TestType>Repository integration tests with Testcontainers</TestType>
        <Location>src/test/java/{package}/adapters/out/persistence/*RepositoryIT.java</Location>
        <Tools>
          <Tool>@DataJpaTest for sliced persistence tests</Tool>
          <Tool>@SpringBootTest for full context persistence tests</Tool>
          <Tool>Testcontainers (PostgreSQL) via test-support module</Tool>
          <Tool>Flyway for schema migration in tests</Tool>
        </Tools>
        <Scope>
          <Item>Verify custom JPQL/native queries</Item>
          <Item>Verify entity mappings and cascade behavior</Item>
          <Item>Verify transaction boundaries</Item>
        </Scope>
        <Examples>
          <Example service="cart-service">CartRepositoryIT</Example>
          <Example service="search-service">ElasticsearchIntegrationTest</Example>
        </Examples>
      </Layer>

      <Layer name="adapters.out.grpc" package="com.kanokna.{svc}.adapters.out.grpc.**">
        <TestType>Outbound gRPC client tests (mocked servers)</TestType>
        <Location>src/test/java/{package}/adapters/out/grpc/*ClientTest.java</Location>
        <Tools>
          <Tool>grpc-testing with in-process mock servers</Tool>
          <Tool>GrpcMock for declarative stub configuration</Tool>
        </Tools>
        <Scope>
          <Item>Verify client correctly maps domain to Protobuf requests</Item>
          <Item>Verify client correctly maps Protobuf responses to domain</Item>
          <Item>Verify error handling for gRPC failures (UNAVAILABLE, DEADLINE_EXCEEDED)</Item>
        </Scope>
      </Layer>

      <Layer name="adapters.out.kafka" package="com.kanokna.{svc}.adapters.out.kafka.**">
        <TestType>Kafka integration tests with Testcontainers</TestType>
        <Location>src/test/java/{package}/adapters/out/kafka/*KafkaIT.java</Location>
        <Tools>
          <Tool>Testcontainers (Kafka/Redpanda) via test-support module</Tool>
          <Tool>@EmbeddedKafka for lighter-weight tests</Tool>
        </Tools>
        <Scope>
          <Item>Verify event serialization (Protobuf)</Item>
          <Item>Verify topic routing</Item>
          <Item>Verify idempotent consumer behavior</Item>
        </Scope>
      </Layer>
    </HexagonalLayerMapping>

    <!-- ─────────────────────────────────────────────────────────────────────────
         NAMING CONVENTIONS
         ───────────────────────────────────────────────────────────────────────── -->
    <NamingConventions>
      <Convention pattern="*Test.java" runner="surefire" phase="test">
        Unit tests - domain and application layer, ArchUnit rules
      </Convention>
      <Convention pattern="*IT.java" runner="failsafe" phase="integration-test">
        Integration tests - persistence, Kafka, external services
      </Convention>
      <Convention pattern="*GrpcIntegrationTest.java" runner="failsafe" phase="integration-test">
        gRPC integration tests - client/server communication
      </Convention>
      <Convention pattern="*ContractTest.java" runner="failsafe" phase="integration-test">
        Contract tests - Spring Cloud Contract verifier
      </Convention>
      <Convention pattern="*E2ETest.java" runner="failsafe" phase="verify" profile="e2e">
        End-to-end tests - full stack with all infrastructure (e2e-tests module)
      </Convention>
      <Convention pattern="ArchitectureTest.java" runner="surefire" phase="test">
        Architecture tests - ArchUnit hexagonal layer enforcement
      </Convention>
    </NamingConventions>

    <!-- ─────────────────────────────────────────────────────────────────────────
         CI PIPELINE INTEGRATION
         ───────────────────────────────────────────────────────────────────────── -->
    <CIPipelineIntegration>
      <Stage order="1" phase="test" plugin="surefire">
        <Name>Unit Tests</Name>
        <Includes>*Test.java, ArchitectureTest.java</Includes>
        <FailBuild>true</FailBuild>
      </Stage>
      <Stage order="2" phase="verify" plugin="failsafe">
        <Name>Integration Tests</Name>
        <Includes>*IT.java, *GrpcIntegrationTest.java</Includes>
        <RequiresTestcontainers>true</RequiresTestcontainers>
        <FailBuild>true</FailBuild>
      </Stage>
      <Stage order="3" phase="verify" plugin="failsafe">
        <Name>Contract Tests</Name>
        <Includes>*ContractTest.java</Includes>
        <FailBuild>true</FailBuild>
      </Stage>
      <Stage order="4" phase="verify" plugin="jacoco">
        <Name>Coverage Report</Name>
        <Thresholds>
          <Line minimum="0.80">80% line coverage</Line>
          <Branch minimum="0.70">70% branch coverage</Branch>
        </Thresholds>
        <FailBuild>true</FailBuild>
      </Stage>
      <Stage order="5" phase="verify" profile="e2e" optional="true">
        <Name>E2E Tests</Name>
        <Module>e2e-tests</Module>
        <Includes>*E2ETest.java</Includes>
        <CITrigger>Manual or pre-release only</CITrigger>
        <FailBuild>true</FailBuild>
      </Stage>
      <Stage order="6" phase="post-build" tool="codeql">
        <Name>Security Scanning (CodeQL)</Name>
        <Tool>GitHub CodeQL</Tool>
        <ConfigFile>.github/codeql-config.yml</ConfigFile>
        <WorkflowFile>.github/workflows/codeql.yml</WorkflowFile>
        <Languages>java</Languages>
        <CITrigger>Every push and PR to main/develop</CITrigger>
        <FailBuild>true (on HIGH severity only)</FailBuild>
        <Links>
          <Link ref="Technology.xml#DEC-SEC-CODEQL-EXCLUSIONS" />
        </Links>
      </Stage>
    </CIPipelineIntegration>

    <!-- ─────────────────────────────────────────────────────────────────────────
         SECURITY SCANNING (AWO-20260121-01)
         ───────────────────────────────────────────────────────────────────────── -->
    <SecurityScanning>
      <Tool id="SS-CODEQL">
        <Name>GitHub CodeQL</Name>
        <Purpose>Static Application Security Testing (SAST)</Purpose>
        <Configuration>
          <ConfigFile path=".github/codeql-config.yml">
            Custom config with exclusions for generated code
          </ConfigFile>
          <Workflow path=".github/workflows/codeql.yml">
            GitHub Actions workflow for automated scanning
          </Workflow>
        </Configuration>
        <ExcludedPaths>
          <Path>**/target/generated-sources/**</Path>
          <Path>**/target/generated-test-sources/**</Path>
          <Path>**/*Proto.java</Path>
          <Path>**/*Grpc.java</Path>
        </ExcludedPaths>
        <SuppressedRules>
          <Rule id="java/spring-disabled-csrf-protection">
            Suppressed per DEC-SEC-CSRF-STATELESS - stateless JWT APIs
          </Rule>
        </SuppressedRules>
      </Tool>
      <Mitigations>
        <Mitigation id="MIT-LOG-INJECTION">
          <Vulnerability>Log Injection (java/log-injection)</Vulnerability>
          <Solution>LogSanitizer utility in shared-kernel using OWASP Encoder</Solution>
          <Contract ref="MC-shared-kernel-logging-LogSanitizer" />
          <Links>
            <Link ref="Technology.xml#DEC-SEC-LOG-SANITIZATION" />
          </Links>
        </Mitigation>
        <Mitigation id="MIT-CSRF">
          <Vulnerability>Disabled CSRF (java/spring-disabled-csrf-protection)</Vulnerability>
          <Solution>Documented as intentional - stateless JWT APIs do not require CSRF</Solution>
          <Links>
            <Link ref="Technology.xml#DEC-SEC-CSRF-STATELESS" />
          </Links>
        </Mitigation>
      </Mitigations>
      <Links>
        <Link ref="Technology.xml#DEC-SEC-CODEQL-EXCLUSIONS" />
        <Link ref="RequirementsAnalysis.xml#NFR-SEC-VULNERABILITY-SCAN" />
      </Links>
    </SecurityScanning>

    <!-- ─────────────────────────────────────────────────────────────────────────
         ADDITIONAL TESTING
         ───────────────────────────────────────────────────────────────────────── -->
    <AdditionalTesting>
      <ArchitectureTests>
        <Tool>ArchUnit</Tool>
        <Location>Each service: src/test/java/.../ArchitectureTest.java</Location>
        <SharedRules>test-support module: HexagonalArchitectureRules.java</SharedRules>
        <Rules>
          <Rule id="ARCH-001">Domain layer has no Spring/JPA dependencies</Rule>
          <Rule id="ARCH-002">Application layer has no adapter dependencies</Rule>
          <Rule id="ARCH-003">Adapters implement port interfaces</Rule>
          <Rule id="ARCH-004">No cyclic dependencies between packages</Rule>
          <Rule id="ARCH-005">gRPC generated stubs confined to adapters packages</Rule>
        </Rules>
      </ArchitectureTests>
      <MutationTesting enabled="optional">
        <Tool>Pitest</Tool>
        <Scope>Critical domain logic (pricing, configuration validation)</Scope>
        <CITrigger>Weekly scheduled job, not per-commit</CITrigger>
      </MutationTesting>
      <PerformanceTesting>
        <Tool>Gatling (preferred) or k6</Tool>
        <Scope>Load testing for P95 latency validation</Scope>
        <CITrigger>Pre-release gate</CITrigger>
      </PerformanceTesting>
    </AdditionalTesting>

    <Links>
      <Link ref="RequirementsAnalysis.xml#NFR-MAINT-TESTABILITY" />
      <Link ref="Technology.xml#TECH-testcontainers" />
      <Link ref="Technology.xml#TECH-archunit" />
      <Link ref="Technology.xml#DEC-TEST-UNIT" />
      <Link ref="Technology.xml#DEC-TEST-GRPC-INTEGRATION" />
      <Link ref="Technology.xml#DEC-TEST-GATEWAY" />
      <Link ref="Technology.xml#DEC-TEST-E2E" />
      <Link ref="Technology.xml#DEC-TEST-CONTRACTS" />
      <Link ref="Technology.xml#DEC-TEST-COVERAGE" />
      <Link ref="DevelopmentPlan.xml#DP-SVC-test-support" />
      <Link ref="DevelopmentPlan.xml#DP-SVC-e2e-tests" />
    </Links>
  </TestingStrategy>

  <!-- ===============================================================================
       DEPLOYMENT STRATEGY
       =============================================================================== -->
  <Deployment id="Deployment-Overview">
    <Environments>
      <Environment name="dev">
        <Description>Local development with Docker Compose</Description>
        <Infrastructure>
          <Item>PostgreSQL, Redis, Kafka, Elasticsearch via Docker Compose</Item>
          <Item>Keycloak for local OIDC</Item>
          <Item>MinIO for S3-compatible storage</Item>
        </Infrastructure>
        <Profile>spring.profiles.active=dev</Profile>
      </Environment>
      <Environment name="stage">
        <Description>Pre-production environment mirroring prod</Description>
        <Infrastructure>
          <Item>Kubernetes cluster (same config as prod)</Item>
          <Item>Managed PostgreSQL, Redis, Kafka</Item>
          <Item>Feature flags enabled for testing</Item>
        </Infrastructure>
        <Profile>spring.profiles.active=stage</Profile>
      </Environment>
      <Environment name="prod">
        <Description>Production environment</Description>
        <Infrastructure>
          <Item>Kubernetes cluster with HPA</Item>
          <Item>Managed PostgreSQL (RDS or Cloud SQL)</Item>
          <Item>Managed Kafka (MSK or Confluent)</Item>
          <Item>Managed Redis (ElastiCache)</Item>
          <Item>Managed Elasticsearch (OpenSearch Service)</Item>
          <Item>S3 for object storage with CloudFront CDN</Item>
        </Infrastructure>
        <Profile>spring.profiles.active=prod</Profile>
      </Environment>
    </Environments>
    <RolloutStrategy>
      <Default>Rolling update with readiness probes</Default>
      <HighRisk>Blue-green for payment or order services</HighRisk>
      <DatabaseMigrations>
        <Strategy>Expand-Migrate-Contract</Strategy>
        <Steps>
          <Step order="1">Deploy code that works with old AND new schema</Step>
          <Step order="2">Run Flyway migrations</Step>
          <Step order="3">Deploy code that only uses new schema</Step>
          <Step order="4">Clean up old columns/tables (later release)</Step>
        </Steps>
      </DatabaseMigrations>
    </RolloutStrategy>
    <Observability>
      <HealthChecks>
        <Liveness>/actuator/health/liveness</Liveness>
        <Readiness>/actuator/health/readiness</Readiness>
      </HealthChecks>
      <Dashboards>
        <Dashboard>Service health overview</Dashboard>
        <Dashboard>Request latency and error rates</Dashboard>
        <Dashboard>Business metrics (orders, conversions)</Dashboard>
        <Dashboard>Kafka lag monitoring</Dashboard>
      </Dashboards>
      <Alerting>
        <Alert trigger="P95 latency > 1s" severity="warning" />
        <Alert trigger="Error rate > 1%" severity="warning" />
        <Alert trigger="Error rate > 5%" severity="critical" />
        <Alert trigger="Service unavailable" severity="critical" />
      </Alerting>
    </Observability>
    <Links>
      <Link ref="Technology.xml#TECH-kubernetes" />
      <Link ref="Technology.xml#TECH-ci-pipeline" />
    </Links>
  </Deployment>

  <!-- ===============================================================================
       SEMANTIC CONTRACTS REGISTRY
       =============================================================================== -->
  <Contracts>
    <ContractRegistry>
      <Description>
        Central registry of MODULE_CONTRACT and FUNCTION_CONTRACT IDs.
        Actual contracts are embedded in source code; this section provides an index.
      </Description>

      <!-- catalog-configuration-service -->
      <ModuleContract id="MC-catalog-configuration-service-domain-ConfigurationValidation">
        <Service>catalog-configuration-service</Service>
        <Layer>domain.service</Layer>
        <Description>Configuration validation domain service</Description>
        <Links>
          <Link ref="RequirementsAnalysis.xml#UC-CATALOG-CONFIGURE-ITEM" />
        </Links>
      </ModuleContract>

      <FunctionContract
        id="FC-catalog-configuration-service-UC-CATALOG-CONFIGURE-ITEM-validateConfiguration">
        <Service>catalog-configuration-service</Service>
        <UseCase>UC-CATALOG-CONFIGURE-ITEM</UseCase>
        <Method>validateConfiguration</Method>
        <Criticality>HIGH</Criticality>
        <Links>
          <Link ref="MC-catalog-configuration-service-domain-ConfigurationValidation" />
        </Links>
      </FunctionContract>

      <FunctionContract id="FC-catalog-configuration-service-UC-CATALOG-CONFIGURE-ITEM-resolveBom">
        <Service>catalog-configuration-service</Service>
        <UseCase>UC-CATALOG-CONFIGURE-ITEM</UseCase>
        <Method>resolveBom</Method>
        <Criticality>MEDIUM</Criticality>
      </FunctionContract>

      <!-- pricing-service -->
      <ModuleContract id="MC-pricing-service-domain-PriceCalculation">
        <Service>pricing-service</Service>
        <Layer>domain.service</Layer>
        <Description>Price calculation domain service</Description>
        <Criticality>HIGH</Criticality>
        <Links>
          <Link ref="RequirementsAnalysis.xml#UC-PRICING-QUOTE" />
          <Link ref="Technology.xml#DEC-ARCH-RULE-ENGINE-STRATEGY" />
        </Links>
      </ModuleContract>

      <FunctionContract id="FC-pricing-service-UC-PRICING-QUOTE-calculateQuote">
        <Service>pricing-service</Service>
        <UseCase>UC-PRICING-QUOTE</UseCase>
        <Method>calculateQuote</Method>
        <Criticality>HIGH</Criticality>
        <Links>
          <Link ref="MC-pricing-service-domain-PriceCalculation" />
        </Links>
      </FunctionContract>

      <FunctionContract id="FC-pricing-service-UC-PRICING-QUOTE-validatePromoCode">
        <Service>pricing-service</Service>
        <UseCase>UC-PRICING-QUOTE</UseCase>
        <Method>validatePromoCode</Method>
        <Criticality>MEDIUM</Criticality>
        <Links>
          <Link ref="RequirementsAnalysis.xml#UC-PRICING-QUOTE" />
        </Links>
      </FunctionContract>

      <FunctionContract id="FC-pricing-service-UC-PRICING-ADMIN-MANAGE-createPriceBook">
        <Service>pricing-service</Service>
        <UseCase>UC-PRICING-ADMIN-MANAGE</UseCase>
        <Method>createPriceBook</Method>
        <Criticality>HIGH</Criticality>
        <Links>
          <Link ref="RequirementsAnalysis.xml#UC-PRICING-ADMIN-MANAGE" />
          <Link ref="Technology.xml#DEC-ARCH-ENTITY-VERSIONING" />
        </Links>
      </FunctionContract>

      <FunctionContract id="FC-pricing-service-UC-PRICING-ADMIN-MANAGE-publishPriceBook">
        <Service>pricing-service</Service>
        <UseCase>UC-PRICING-ADMIN-MANAGE</UseCase>
        <Method>publishPriceBook</Method>
        <Criticality>HIGH</Criticality>
        <Links>
          <Link ref="RequirementsAnalysis.xml#UC-PRICING-ADMIN-MANAGE" />
          <Link ref="Technology.xml#DEC-ARCH-ENTITY-VERSIONING" />
        </Links>
      </FunctionContract>

      <!-- order-service -->
      <ModuleContract id="MC-order-service-domain-OrderAggregate">
        <Service>order-service</Service>
        <Layer>domain.model</Layer>
        <Description>Order aggregate root with state machine</Description>
        <Links>
          <Link ref="RequirementsAnalysis.xml#UC-ORDER-PLACE" />
        </Links>
      </ModuleContract>

      <ModuleContract id="MC-order-service-application-OrderPlacement">
        <Service>order-service</Service>
        <Layer>application.service</Layer>
        <Description>Order placement use case service</Description>
        <Links>
          <Link ref="RequirementsAnalysis.xml#UC-ORDER-PLACE" />
          <Link ref="Flow-Checkout-Payment" />
        </Links>
      </ModuleContract>

      <FunctionContract id="FC-order-service-UC-ORDER-PLACE-placeOrder">
        <Service>order-service</Service>
        <UseCase>UC-ORDER-PLACE</UseCase>
        <Method>placeOrder</Method>
        <Criticality>HIGH</Criticality>
        <Links>
          <Link ref="MC-order-service-application-OrderPlacement" />
        </Links>
      </FunctionContract>

      <FunctionContract id="FC-order-service-UC-ORDER-PLACE-initiatePayment">
        <Service>order-service</Service>
        <UseCase>UC-ORDER-PLACE</UseCase>
        <Method>initiatePayment</Method>
        <Criticality>HIGH</Criticality>
      </FunctionContract>

      <FunctionContract id="FC-order-service-UC-ORDER-PLACE-handlePaymentCallback">
        <Service>order-service</Service>
        <UseCase>UC-ORDER-PLACE</UseCase>
        <Method>handlePaymentCallback</Method>
        <Criticality>HIGH</Criticality>
      </FunctionContract>

      <!-- document-service -->
      <ModuleContract id="MC-document-service-application-DocumentIssuance">
        <Service>document-service</Service>
        <Layer>application.service</Layer>
        <Description>Generate and version business documents (proposal/invoice/contract)</Description>
        <Criticality>MEDIUM</Criticality>
        <Links>
          <Link ref="RequirementsAnalysis.xml#UC-DOC-GENERATE-01" />
          <Link ref="Flow-Document-Issue" />
        </Links>
      </ModuleContract>

      <FunctionContract id="FC-document-service-UC-DOC-GENERATE-01-generateDocument">
        <Service>document-service</Service>
        <UseCase>UC-DOC-GENERATE-01</UseCase>
        <Method>generateDocument</Method>
        <Criticality>MEDIUM</Criticality>
        <Links>
          <Link ref="MC-document-service-application-DocumentIssuance" />
        </Links>
      </FunctionContract>

      <!-- billing-service -->
      <ModuleContract id="MC-billing-service-application-PartnerBillingQueries">
        <Service>billing-service</Service>
        <Layer>application.service</Layer>
        <Description>Partner-scoped invoice, schedule, balance, and settlement queries</Description>
        <Criticality>MEDIUM</Criticality>
        <Links>
          <Link ref="RequirementsAnalysis.xml#UC-BILLING-VIEW-INVOICES-01" />
          <Link ref="Flow-B2B-Finance" />
        </Links>
      </ModuleContract>

      <FunctionContract id="FC-billing-service-UC-BILLING-VIEW-INVOICES-01-listInvoices">
        <Service>billing-service</Service>
        <UseCase>UC-BILLING-VIEW-INVOICES-01</UseCase>
        <Method>listInvoices</Method>
        <Criticality>MEDIUM</Criticality>
        <Links>
          <Link ref="MC-billing-service-application-PartnerBillingQueries" />
        </Links>
      </FunctionContract>

      <!-- catalog-configuration-service admin operations -->
      <FunctionContract
        id="FC-catalog-configuration-service-UC-CATALOG-ADMIN-MANAGE-createProductTemplate">
        <Service>catalog-configuration-service</Service>
        <UseCase>UC-CATALOG-ADMIN-MANAGE</UseCase>
        <Method>createProductTemplate</Method>
        <Criticality>HIGH</Criticality>
        <Links>
          <Link ref="MC-catalog-configuration-service-domain-ConfigurationValidation" />
          <Link ref="RequirementsAnalysis.xml#UC-CATALOG-ADMIN-MANAGE" />
        </Links>
      </FunctionContract>

      <FunctionContract
        id="FC-catalog-configuration-service-UC-CATALOG-ADMIN-MANAGE-updateProductTemplate">
        <Service>catalog-configuration-service</Service>
        <UseCase>UC-CATALOG-ADMIN-MANAGE</UseCase>
        <Method>updateProductTemplate</Method>
        <Criticality>HIGH</Criticality>
        <Links>
          <Link ref="RequirementsAnalysis.xml#UC-CATALOG-ADMIN-MANAGE" />
        </Links>
      </FunctionContract>

      <FunctionContract
        id="FC-catalog-configuration-service-UC-CATALOG-ADMIN-MANAGE-publishCatalogVersion">
        <Service>catalog-configuration-service</Service>
        <UseCase>UC-CATALOG-ADMIN-MANAGE</UseCase>
        <Method>publishCatalogVersion</Method>
        <Criticality>HIGH</Criticality>
        <Links>
          <Link ref="RequirementsAnalysis.xml#UC-CATALOG-ADMIN-MANAGE" />
          <Link ref="Technology.xml#DEC-ARCH-ENTITY-VERSIONING" />
        </Links>
      </FunctionContract>

      <!-- Domain Error Handling Contracts -->
      <ModuleContract id="MC-catalog-domain-errors">
        <Service>catalog-configuration-service</Service>
        <Layer>domain.exception</Layer>
        <Description>Static factory for catalog-configuration-service domain exceptions</Description>
        <Class>com.kanokna.catalog.domain.exception.CatalogDomainErrors</Class>
        <Responsibilities>
          <Item>Provide factory methods for all catalog domain error types</Item>
          <Item>Ensure consistent error codes (ERR-CAT-*)</Item>
          <Item>Include contextual values in error messages</Item>
        </Responsibilities>
        <Links>
          <Link ref="Technology.xml#DEC-DOMAIN-ERROR-PATTERN" />
          <Link ref="RequirementsAnalysis.xml#NFR-CODE-DOMAIN-ERROR-HANDLING" />
        </Links>
      </ModuleContract>

      <ModuleContract id="MC-pricing-domain-errors">
        <Service>pricing-service</Service>
        <Layer>domain.exception</Layer>
        <Description>Static factory for pricing-service domain exceptions</Description>
        <Class>com.kanokna.pricing.domain.exception.PricingDomainErrors</Class>
        <Responsibilities>
          <Item>Provide factory methods for all pricing domain error types</Item>
          <Item>Ensure consistent error codes (ERR-PRICE-*)</Item>
          <Item>Include contextual values in error messages</Item>
        </Responsibilities>
        <Links>
          <Link ref="Technology.xml#DEC-DOMAIN-ERROR-PATTERN" />
          <Link ref="RequirementsAnalysis.xml#NFR-CODE-DOMAIN-ERROR-HANDLING" />
        </Links>
      </ModuleContract>

      <FunctionContract id="FC-catalog-CatalogDomainErrors-dimensionOutOfRange">
        <Service>catalog-configuration-service</Service>
        <Layer>domain.exception</Layer>
        <Method>dimensionOutOfRange</Method>
        <Intent>Create exception for dimension constraint violations</Intent>
        <Input>dimension name (String), value (int), min (int), max (int)</Input>
        <Output>DomainException with ERR-CAT-DIMENSION-OUT-OF-RANGE code</Output>
        <ErrorCode>ERR-CAT-DIMENSION-OUT-OF-RANGE</ErrorCode>
        <Criticality>MEDIUM</Criticality>
        <Links>
          <Link ref="MC-catalog-domain-errors" />
        </Links>
      </FunctionContract>

      <FunctionContract id="FC-pricing-PricingDomainErrors-currencyMismatch">
        <Service>pricing-service</Service>
        <Layer>domain.exception</Layer>
        <Method>currencyMismatch</Method>
        <Intent>Create exception for money operations with mismatched currencies</Intent>
        <Input>operation (String), currency1 (String), currency2 (String)</Input>
        <Output>DomainException with ERR-PRICE-CURRENCY-MISMATCH code</Output>
        <ErrorCode>ERR-PRICE-CURRENCY-MISMATCH</ErrorCode>
        <Criticality>HIGH</Criticality>
        <Links>
          <Link ref="MC-pricing-domain-errors" />
        </Links>
      </FunctionContract>

      <!-- Account Service Decomposition (DEC-ACCOUNT-DECOMPOSITION) -->
      <ModuleContract id="MC-account-profile-service">
        <Service>account-service</Service>
        <Layer>application.service</Layer>
        <Description>Specialized service for user profile operations</Description>
        <Class>com.kanokna.account.application.service.ProfileService</Class>
        <Responsibilities>
          <Item>Get user profile (with auto-create from Keycloak on first access)</Item>
          <Item>Update user profile fields (name, phone, preferences)</Item>
          <Item>Create profile from Keycloak claims</Item>
        </Responsibilities>
        <Dependencies>
          <Item>UserProfileRepository</Item>
          <Item>EventPublisher</Item>
          <Item>CurrentUserProvider</Item>
          <Item>AccountProperties</Item>
        </Dependencies>
        <Links>
          <Link ref="Technology.xml#DEC-ACCOUNT-DECOMPOSITION" />
          <Link ref="RequirementsAnalysis.xml#UC-ACCOUNT-MANAGE-PROFILE" />
        </Links>
      </ModuleContract>

      <ModuleContract id="MC-account-address-service">
        <Service>account-service</Service>
        <Layer>application.service</Layer>
        <Description>Specialized service for address management operations</Description>
        <Class>com.kanokna.account.application.service.AddressService</Class>
        <Responsibilities>
          <Item>Add address with optional set-as-default</Item>
          <Item>Update address details and label</Item>
          <Item>Delete address</Item>
          <Item>List addresses sorted by label</Item>
        </Responsibilities>
        <Dependencies>
          <Item>SavedAddressRepository</Item>
          <Item>UserProfileRepository (for loading profile with addresses)</Item>
          <Item>EventPublisher</Item>
          <Item>CurrentUserProvider</Item>
        </Dependencies>
        <Links>
          <Link ref="Technology.xml#DEC-ACCOUNT-DECOMPOSITION" />
          <Link ref="RequirementsAnalysis.xml#UC-ACCOUNT-MANAGE-PROFILE" />
        </Links>
      </ModuleContract>

      <ModuleContract id="MC-account-savedconfig-service">
        <Service>account-service</Service>
        <Layer>application.service</Layer>
        <Description>Specialized service for saved product configuration operations</Description>
        <Class>com.kanokna.account.application.service.SavedConfigurationService</Class>
        <Responsibilities>
          <Item>Save product configuration draft</Item>
          <Item>List user's saved configurations</Item>
          <Item>Delete saved configuration</Item>
        </Responsibilities>
        <Dependencies>
          <Item>SavedConfigurationRepository</Item>
          <Item>EventPublisher</Item>
          <Item>CurrentUserProvider</Item>
          <Item>ConfigurationSnapshotValidator</Item>
        </Dependencies>
        <Links>
          <Link ref="Technology.xml#DEC-ACCOUNT-DECOMPOSITION" />
          <Link ref="RequirementsAnalysis.xml#UC-B2C-CPQ-01" />
        </Links>
      </ModuleContract>

      <!-- ═══════════════════════════════════════════════════════════════════════════
           SECURITY: Log Sanitization (AWO-20260121-01)
           ═══════════════════════════════════════════════════════════════════════════ -->
      <ModuleContract id="MC-shared-kernel-logging-LogSanitizer">
        <Service>shared-kernel</Service>
        <Layer>core</Layer>
        <Package>com.kanokna.shared.logging</Package>
        <BoundedContext>shared-kernel</BoundedContext>
        <Purpose>
          Utility for sanitizing user-provided input before logging to prevent log injection
          attacks. Wraps OWASP Java Encoder for comprehensive output encoding.
        </Purpose>
        <Responsibilities>
          <Item>Sanitize strings to prevent newline injection (CRLF)</Item>
          <Item>Sanitize strings to prevent ANSI escape sequence injection</Item>
          <Item>Sanitize strings to prevent Unicode control character injection</Item>
          <Item>Provide bulk sanitization for maps/collections of log parameters</Item>
        </Responsibilities>
        <Invariants>
          <Item>Output is always safe to include in log statements</Item>
          <Item>Normal alphanumeric strings pass through unchanged</Item>
          <Item>Null input returns "[null]" string (never throws NPE)</Item>
          <Item>Empty input returns empty string</Item>
        </Invariants>
        <Dependencies>
          <Item>org.owasp.encoder:encoder:1.2.3</Item>
        </Dependencies>
        <FunctionContracts>
          <FunctionContract id="FC-LogSanitizer-sanitize">
            <Method>public static String sanitize(String input)</Method>
            <Intent>Sanitize a single string for safe logging</Intent>
            <Input>String input - potentially malicious user input</Input>
            <Output>String - sanitized string safe for logging</Output>
            <SideEffects>None (pure function)</SideEffects>
            <Preconditions>None</Preconditions>
            <Postconditions>
              <Item>Return value contains no CR, LF, TAB, or ANSI escape sequences</Item>
              <Item>Return value is non-null</Item>
            </Postconditions>
            <ErrorHandling>
              <Item>Null input returns "[null]"</Item>
              <Item>Never throws exceptions</Item>
            </ErrorHandling>
            <Example>
              LogSanitizer.sanitize("normal") -> "normal"
              LogSanitizer.sanitize("line1\nline2") -> "line1\\nline2"
              LogSanitizer.sanitize("\u001b[31mred") -> "\\u001b[31mred"
              LogSanitizer.sanitize(null) -> "[null]"
            </Example>
          </FunctionContract>
          <FunctionContract id="FC-LogSanitizer-sanitizeMap">
            <Method>public static Map&lt;String, String&gt; sanitizeMap(Map&lt;String, ?&gt; input)</Method>
            <Intent>Sanitize all values in a map for safe structured logging</Intent>
            <Input>Map with string keys and any values (toString() called on values)</Input>
            <Output>New map with all values sanitized</Output>
            <SideEffects>None (returns new map, does not modify input)</SideEffects>
            <Preconditions>None</Preconditions>
            <Postconditions>
              <Item>All values in returned map are sanitized</Item>
              <Item>Original map is not modified</Item>
            </Postconditions>
            <ErrorHandling>
              <Item>Null input returns empty map</Item>
              <Item>Null values in map converted to "[null]"</Item>
            </ErrorHandling>
          </FunctionContract>
        </FunctionContracts>
        <TestCases>
          <TestCase id="TC-LOG-SANITIZE-001">
            <Description>Verify newline injection is sanitized</Description>
            <Input>"line1\nline2\rline3"</Input>
            <ExpectedOutput>"line1\\nline2\\rline3"</ExpectedOutput>
          </TestCase>
          <TestCase id="TC-LOG-SANITIZE-002">
            <Description>Verify ANSI escape sequences are sanitized</Description>
            <Input>"\u001b[31mRED\u001b[0m"</Input>
            <ExpectedOutput>Encoded equivalent with escape chars replaced</ExpectedOutput>
          </TestCase>
          <TestCase id="TC-LOG-SANITIZE-003">
            <Description>Verify normal strings pass through unchanged</Description>
            <Input>"normal-string-123_ABC"</Input>
            <ExpectedOutput>"normal-string-123_ABC"</ExpectedOutput>
          </TestCase>
          <TestCase id="TC-LOG-SANITIZE-004">
            <Description>Verify null input handling</Description>
            <Input>null</Input>
            <ExpectedOutput>"[null]"</ExpectedOutput>
          </TestCase>
        </TestCases>
        <Links>
          <Link ref="Technology.xml#DEC-SEC-LOG-SANITIZATION" />
          <Link ref="RequirementsAnalysis.xml#NFR-SEC-VULNERABILITY-SCAN" />
        </Links>
      </ModuleContract>
    </ContractRegistry>

    <BlockAnchorRegistry>
      <Description>
        Index of BLOCK_ANCHOR IDs for critical code segments.
        Used for log correlation and RAG navigation.
      </Description>

      <!-- Configuration validation anchors -->
      <BlockAnchor id="BA-CFG-VAL-01" service="catalog-configuration-service"
        purpose="Check dimension constraints" />
      <BlockAnchor id="BA-CFG-VAL-02" service="catalog-configuration-service"
        purpose="Check material/glazing compatibility" />
      <BlockAnchor id="BA-CFG-VAL-03" service="catalog-configuration-service"
        purpose="Check option dependencies" />
      <BlockAnchor id="BA-CFG-VAL-99" service="catalog-configuration-service"
        purpose="Final validation result" />

      <!-- Pricing calculation anchors -->
      <BlockAnchor id="BA-PRC-CALC-01" service="pricing-service"
        purpose="Load price book for product" />
      <BlockAnchor id="BA-PRC-CALC-02" service="pricing-service"
        purpose="Calculate base price from dimensions" />
      <BlockAnchor id="BA-PRC-CALC-03" service="pricing-service" purpose="Apply option premiums" />
      <BlockAnchor id="BA-PRC-CALC-04" service="pricing-service" purpose="Apply campaign discounts" />
      <BlockAnchor id="BA-PRC-CALC-05" service="pricing-service" purpose="Apply promo code discount" />
      <BlockAnchor id="BA-PRC-CALC-06" service="pricing-service" purpose="Calculate subtotal" />
      <BlockAnchor id="BA-PRC-CALC-07" service="pricing-service" purpose="Calculate tax" />
      <BlockAnchor id="BA-PRC-CALC-08" service="pricing-service" purpose="Apply rounding" />
      <BlockAnchor id="BA-PRC-CALC-99" service="pricing-service" purpose="Final quote result" />

      <!-- Promo code validation anchors -->
      <BlockAnchor id="BA-PROMO-VAL-01" service="pricing-service" purpose="Load promo code" />
      <BlockAnchor id="BA-PROMO-VAL-02" service="pricing-service" purpose="Check expiry" />
      <BlockAnchor id="BA-PROMO-VAL-03" service="pricing-service" purpose="Check usage limits" />
      <BlockAnchor id="BA-PROMO-VAL-04" service="pricing-service"
        purpose="Calculate discount amount" />

      <!-- Price book admin anchors -->
      <BlockAnchor id="BA-PB-CREATE-01" service="pricing-service"
        purpose="Validate admin authorization for create" />
      <BlockAnchor id="BA-PB-CREATE-02" service="pricing-service" purpose="Validate price book data" />
      <BlockAnchor id="BA-PB-CREATE-03" service="pricing-service"
        purpose="Build PriceBook aggregate" />
      <BlockAnchor id="BA-PB-CREATE-04" service="pricing-service" purpose="Persist and return ID" />

      <BlockAnchor id="BA-PB-PUBLISH-01" service="pricing-service"
        purpose="Validate admin authorization for publish" />
      <BlockAnchor id="BA-PB-PUBLISH-02" service="pricing-service" purpose="Load price book" />
      <BlockAnchor id="BA-PB-PUBLISH-03" service="pricing-service" purpose="Create version snapshot" />
      <BlockAnchor id="BA-PB-PUBLISH-04" service="pricing-service" purpose="Archive previous active" />
      <BlockAnchor id="BA-PB-PUBLISH-05" service="pricing-service" purpose="Invalidate cache" />
      <BlockAnchor id="BA-PB-PUBLISH-06" service="pricing-service" purpose="Emit event" />

      <!-- Order placement anchors -->
      <BlockAnchor id="BA-ORD-PLACE-01" service="order-service" purpose="Validate cart snapshot" />
      <BlockAnchor id="BA-ORD-PLACE-02" service="order-service" purpose="Check idempotency key" />
      <BlockAnchor id="BA-ORD-PLACE-03" service="order-service" purpose="Create order aggregate" />
      <BlockAnchor id="BA-ORD-PLACE-04" service="order-service" purpose="Persist order to database" />
      <BlockAnchor id="BA-ORD-PLACE-05" service="order-service"
        purpose="Initiate payment with gateway" />
      <BlockAnchor id="BA-ORD-PLACE-99" service="order-service" purpose="Order placement result" />

      <!-- Payment callback anchors -->
      <BlockAnchor id="BA-PAY-CB-01" service="order-service" purpose="Verify webhook signature" />
      <BlockAnchor id="BA-PAY-CB-02" service="order-service"
        purpose="Load order by payment reference" />
      <BlockAnchor id="BA-PAY-CB-03" service="order-service"
        purpose="Apply payment status transition" />
      <BlockAnchor id="BA-PAY-CB-04" service="order-service" purpose="Publish OrderConfirmedEvent" />

      <!-- Document issuance anchors -->
      <BlockAnchor id="BA-DOC-GEN-01" service="document-service" purpose="Load template and authorize access" />
      <BlockAnchor id="BA-DOC-GEN-02" service="document-service" purpose="Load canonical data snapshot" />
      <BlockAnchor id="BA-DOC-GEN-03" service="document-service" purpose="Render document from template" />
      <BlockAnchor id="BA-DOC-GEN-04" service="document-service" purpose="Store binary via media-service" />
      <BlockAnchor id="BA-DOC-GEN-99" service="document-service" purpose="Document issuance result" />

      <!-- Billing query anchors -->
      <BlockAnchor id="BA-BILL-VIEW-01" service="billing-service" purpose="Authorize partner scope" />
      <BlockAnchor id="BA-BILL-VIEW-02" service="billing-service" purpose="Load invoices and schedules" />
      <BlockAnchor id="BA-BILL-VIEW-03" service="billing-service" purpose="Resolve document links (optional)" />
      <BlockAnchor id="BA-BILL-VIEW-99" service="billing-service" purpose="Billing view response" />

      <!-- Catalog admin operation anchors -->
      <BlockAnchor id="BA-CAT-CREATE-01" service="catalog-configuration-service"
        purpose="Validate admin authorization for create" />
      <BlockAnchor id="BA-CAT-CREATE-02" service="catalog-configuration-service"
        purpose="Validate uniqueness constraints" />
      <BlockAnchor id="BA-CAT-CREATE-03" service="catalog-configuration-service"
        purpose="Build ProductTemplate aggregate" />
      <BlockAnchor id="BA-CAT-CREATE-04" service="catalog-configuration-service"
        purpose="Persist and return ID" />

      <BlockAnchor id="BA-CAT-UPDATE-01" service="catalog-configuration-service"
        purpose="Validate admin authorization for update" />
      <BlockAnchor id="BA-CAT-UPDATE-02" service="catalog-configuration-service"
        purpose="Load existing template" />
      <BlockAnchor id="BA-CAT-UPDATE-03" service="catalog-configuration-service"
        purpose="Apply updates or clone" />
      <BlockAnchor id="BA-CAT-UPDATE-04" service="catalog-configuration-service"
        purpose="Persist changes" />

      <BlockAnchor id="BA-CAT-PUBLISH-01" service="catalog-configuration-service"
        purpose="Validate admin authorization for publish" />
      <BlockAnchor id="BA-CAT-PUBLISH-02" service="catalog-configuration-service"
        purpose="Load DRAFT templates" />
      <BlockAnchor id="BA-CAT-PUBLISH-03" service="catalog-configuration-service"
        purpose="Validate all templates" />
      <BlockAnchor id="BA-CAT-PUBLISH-04" service="catalog-configuration-service"
        purpose="Create CatalogVersion snapshot" />
      <BlockAnchor id="BA-CAT-PUBLISH-05" service="catalog-configuration-service"
        purpose="Transition statuses" />
      <BlockAnchor id="BA-CAT-PUBLISH-06" service="catalog-configuration-service"
        purpose="Emit domain events" />

      <!-- Account-service anchors (from FC-account-service-functions.xml) -->
      <BlockAnchor id="BA-ACCT-PROF-01" service="account-service"
        purpose="Fetch user profile from repository" />
      <BlockAnchor id="BA-ACCT-PROF-02" service="account-service"
        purpose="Validate and apply profile updates" />
      <BlockAnchor id="BA-ACCT-PROF-03" service="account-service"
        purpose="Sync profile from Keycloak on first login" />
      <BlockAnchor id="BA-ACCT-ADDR-01" service="account-service"
        purpose="Validate address input" />
      <BlockAnchor id="BA-ACCT-ADDR-02" service="account-service"
        purpose="Check for duplicate address" />
      <BlockAnchor id="BA-ACCT-ADDR-03" service="account-service"
        purpose="Update default address flag" />
      <BlockAnchor id="BA-ACCT-CFG-01" service="account-service"
        purpose="Validate configuration snapshot structure" />
      <BlockAnchor id="BA-ACCT-CFG-02" service="account-service"
        purpose="Persist saved configuration" />
      <BlockAnchor id="BA-ACCT-CFG-03" service="account-service"
        purpose="Emit ConfigurationSavedEvent" />
      <BlockAnchor id="BA-ACCT-CFG-04" service="account-service"
        purpose="List saved configurations" />
      <BlockAnchor id="BA-ACCT-CFG-05" service="account-service"
        purpose="Delete saved configuration" />
      <BlockAnchor id="BA-ACCT-AUTH-01" service="account-service"
        purpose="Verify caller authorization" />
      <BlockAnchor id="BA-ACCT-ADDR-04" service="account-service"
        purpose="List user addresses" />

      <!-- Cart-service anchors (from FC-cart-service-functions.xml) -->
      <BlockAnchor id="BA-CART-GET-01" service="cart-service"
        purpose="Resolve cart ID from customerId or sessionId" />
      <BlockAnchor id="BA-CART-GET-02" service="cart-service"
        purpose="Load cart from repository" />
      <BlockAnchor id="BA-CART-GET-03" service="cart-service"
        purpose="Revalidate item configurations (lazy)" />
      <BlockAnchor id="BA-CART-GET-04" service="cart-service"
        purpose="Check price staleness for each item" />
      <BlockAnchor id="BA-CART-GET-05" service="cart-service"
        purpose="Return cart response" />
      <BlockAnchor id="BA-CART-ADD-01" service="cart-service"
        purpose="Resolve or create cart" />
      <BlockAnchor id="BA-CART-ADD-02" service="cart-service"
        purpose="Validate configuration via catalog-configuration-service" />
      <BlockAnchor id="BA-CART-ADD-03" service="cart-service"
        purpose="Get/verify price quote from pricing-service" />
      <BlockAnchor id="BA-CART-ADD-04" service="cart-service"
        purpose="Create CartItem with configuration snapshot" />
      <BlockAnchor id="BA-CART-ADD-05" service="cart-service"
        purpose="Compute configuration hash" />
      <BlockAnchor id="BA-CART-ADD-06" service="cart-service"
        purpose="Recalculate cart totals" />
      <BlockAnchor id="BA-CART-ADD-07" service="cart-service"
        purpose="Persist cart and publish event" />
      <BlockAnchor id="BA-CART-UPDATE-01" service="cart-service"
        purpose="Load cart and find item" />
      <BlockAnchor id="BA-CART-UPDATE-02" service="cart-service"
        purpose="Validate quantity" />
      <BlockAnchor id="BA-CART-UPDATE-03" service="cart-service"
        purpose="Update quantity and line total" />
      <BlockAnchor id="BA-CART-UPDATE-04" service="cart-service"
        purpose="Recalculate cart totals" />
      <BlockAnchor id="BA-CART-UPDATE-05" service="cart-service"
        purpose="Persist and publish event" />
      <BlockAnchor id="BA-CART-REMOVE-01" service="cart-service"
        purpose="Load cart and find item" />
      <BlockAnchor id="BA-CART-REMOVE-02" service="cart-service"
        purpose="Remove item from cart" />
      <BlockAnchor id="BA-CART-REMOVE-03" service="cart-service"
        purpose="Recalculate cart totals" />
      <BlockAnchor id="BA-CART-REMOVE-04" service="cart-service"
        purpose="Persist and publish event" />
      <BlockAnchor id="BA-CART-PROMO-01" service="cart-service"
        purpose="Load cart and validate not empty" />
      <BlockAnchor id="BA-CART-PROMO-02" service="cart-service"
        purpose="Call pricing-service.ValidatePromoCode" />
      <BlockAnchor id="BA-CART-PROMO-03" service="cart-service"
        purpose="Apply discount to cart" />
      <BlockAnchor id="BA-CART-PROMO-04" service="cart-service"
        purpose="Recalculate totals" />
      <BlockAnchor id="BA-CART-PROMO-05" service="cart-service"
        purpose="Persist and publish event" />
      <BlockAnchor id="BA-CART-PROMO-REMOVE-01" service="cart-service"
        purpose="Load cart" />
      <BlockAnchor id="BA-CART-PROMO-REMOVE-02" service="cart-service"
        purpose="Remove promo code" />
      <BlockAnchor id="BA-CART-PROMO-REMOVE-03" service="cart-service"
        purpose="Recalculate totals" />
      <BlockAnchor id="BA-CART-PROMO-REMOVE-04" service="cart-service"
        purpose="Persist and publish event" />
      <BlockAnchor id="BA-CART-CLEAR-01" service="cart-service"
        purpose="Resolve cart from customerId or sessionId" />
      <BlockAnchor id="BA-CART-CLEAR-02" service="cart-service"
        purpose="Validate cart exists and caller authorized" />
      <BlockAnchor id="BA-CART-CLEAR-03" service="cart-service"
        purpose="Remove all items from cart" />
      <BlockAnchor id="BA-CART-CLEAR-04" service="cart-service"
        purpose="Remove applied promo code" />
      <BlockAnchor id="BA-CART-CLEAR-05" service="cart-service"
        purpose="Reset cart totals to zero" />
      <BlockAnchor id="BA-CART-CLEAR-06" service="cart-service"
        purpose="Persist and publish CartClearedEvent" />
      <BlockAnchor id="BA-CART-REFRESH-01" service="cart-service"
        purpose="Load cart and validate not empty" />
      <BlockAnchor id="BA-CART-REFRESH-02" service="cart-service"
        purpose="Call pricing-service.CalculateQuote for each item" />
      <BlockAnchor id="BA-CART-REFRESH-03" service="cart-service"
        purpose="Update item prices and quote IDs" />
      <BlockAnchor id="BA-CART-REFRESH-04" service="cart-service"
        purpose="Clear price_stale flags" />
      <BlockAnchor id="BA-CART-REFRESH-05" service="cart-service"
        purpose="Recalculate cart totals" />
      <BlockAnchor id="BA-CART-REFRESH-06" service="cart-service"
        purpose="Recalculate promo discount if applied" />
      <BlockAnchor id="BA-CART-REFRESH-07" service="cart-service"
        purpose="Persist and publish CartPricesRefreshedEvent" />

      <!-- Search-service anchors (from FC-search-service-functions.xml) -->
      <BlockAnchor id="BA-SEARCH-QUERY-01" service="search-service"
        purpose="Build Elasticsearch query from SearchQuery" />
      <BlockAnchor id="BA-SEARCH-QUERY-02" service="search-service"
        purpose="Execute query and collect results" />
      <BlockAnchor id="BA-SEARCH-QUERY-03" service="search-service"
        purpose="Process facet aggregations" />
      <BlockAnchor id="BA-SEARCH-QUERY-04" service="search-service"
        purpose="Map Elasticsearch response to SearchResult" />
      <BlockAnchor id="BA-AUTO-01" service="search-service"
        purpose="Validate prefix length constraint" />
      <BlockAnchor id="BA-AUTO-02" service="search-service"
        purpose="Build completion suggester query" />
      <BlockAnchor id="BA-AUTO-03" service="search-service"
        purpose="Execute suggestion query" />
      <BlockAnchor id="BA-AUTO-04" service="search-service"
        purpose="Map suggestions to result" />
      <BlockAnchor id="BA-INDEX-01" service="search-service"
        purpose="Validate and extract event payload" />
      <BlockAnchor id="BA-INDEX-02" service="search-service"
        purpose="Transform event to ProductSearchDocument" />
      <BlockAnchor id="BA-INDEX-03" service="search-service"
        purpose="Execute index/update operation" />
      <BlockAnchor id="BA-INDEX-04" service="search-service"
        purpose="Confirm indexing success" />
      <BlockAnchor id="BA-DELETE-01" service="search-service"
        purpose="Extract productId from event" />
      <BlockAnchor id="BA-DELETE-02" service="search-service"
        purpose="Execute delete operation" />
      <BlockAnchor id="BA-DELETE-03" service="search-service"
        purpose="Log outcome" />
      <BlockAnchor id="BA-FACET-01" service="search-service"
        purpose="Validate requested facet fields" />
      <BlockAnchor id="BA-FACET-02" service="search-service"
        purpose="Build aggregation query" />
      <BlockAnchor id="BA-FACET-03" service="search-service"
        purpose="Execute aggregation query" />
      <BlockAnchor id="BA-FACET-04" service="search-service"
        purpose="Map aggregations to FacetValuesResult" />
      <BlockAnchor id="BA-GET-01" service="search-service"
        purpose="Validate productId" />
      <BlockAnchor id="BA-GET-02" service="search-service"
        purpose="Execute get-by-id query" />
      <BlockAnchor id="BA-GET-03" service="search-service"
        purpose="Map document to ProductSearchDocument" />
      <BlockAnchor id="BA-REINDEX-01" service="search-service"
        purpose="Acquire distributed lock for reindex" />
      <BlockAnchor id="BA-REINDEX-02" service="search-service"
        purpose="Create new versioned index with mapping" />
      <BlockAnchor id="BA-REINDEX-03" service="search-service"
        purpose="Fetch all products from catalog-configuration-service" />
      <BlockAnchor id="BA-REINDEX-04" service="search-service"
        purpose="Bulk index products into new index" />
      <BlockAnchor id="BA-REINDEX-05" service="search-service"
        purpose="Swap alias to new index (atomic)" />
      <BlockAnchor id="BA-REINDEX-06" service="search-service"
        purpose="Release lock and log completion" />
    </BlockAnchorRegistry>
  </Contracts>

  <!-- ===============================================================================
       OPEN DECISIONS (Tracked from RA)
       =============================================================================== -->
  <OpenDecisions>
    <Decision id="DEC-DP-STATUS-SOT" status="OPEN" blocking="true">
      <Topic>Status source of truth for production/logistics</Topic>
      <Question>Is ERP/logistics the SoT for production/delivery statuses, or do we maintain
        parallel?</Question>
      <Impact>Affects integration contract design and status reconciliation logic</Impact>
      <Links>
        <Link ref="RequirementsAnalysis.xml#DEC-OPEN-STATUS-SOT" />
      </Links>
    </Decision>

    <Decision id="DEC-DP-CAD-FORMAT" status="OPEN" blocking="false">
      <Topic>CAD integration API format</Topic>
      <Question>REST API, file exchange, or proprietary protocol?</Question>
      <Impact>Affects catalog-configuration-service adapter implementation</Impact>
      <Links>
        <Link ref="RequirementsAnalysis.xml#DEC-OPEN-CAD-FORMAT" />
      </Links>
    </Decision>
  </OpenDecisions>

  <!-- ===============================================================================
       ASSUMPTIONS
       =============================================================================== -->
  <Assumptions>
    <Assumption id="DP-ASSUM-001">
      Port numbers are defaults for local development; production uses Kubernetes service discovery.
    </Assumption>
    <Assumption id="DP-ASSUM-002" status="SUPERSEDED">
      SUPERSEDED by DEC-INTER-SERVICE-COMM: gRPC is REQUIRED for inter-service sync communication.
    </Assumption>
    <Assumption id="DP-ASSUM-003">
      New services (workflow, field-ops, document, billing, support) follow same hexagonal
      architecture as existing services.
    </Assumption>
    <Assumption id="DP-ASSUM-004">
      Phase deliverables may be adjusted based on integration availability (e.g., CAD, logistics).
    </Assumption>
  </Assumptions>

</DevelopmentPlan>
