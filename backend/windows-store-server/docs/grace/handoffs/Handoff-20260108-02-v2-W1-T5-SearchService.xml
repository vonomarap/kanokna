<?xml version="1.0" encoding="UTF-8"?>
<!--
  ═══════════════════════════════════════════════════════════════════════════════
  GRACE HANDOFF: Handoff-20260108-02-v2-W1-T5-SearchService
  ═══════════════════════════════════════════════════════════════════════════════
  Schema Version:  grace-markup-v2
  Status:          PROPOSED
  Wave:            W1 (CPQ Core)
  Task:            W1-T5-FIX (search-service)
  Created:         2026-01-08T18:41:30+03:00
  Updated:         2026-01-08T20:45:00+03:00
  Author:          GRACE-ARCHITECT
  Purpose:         Implementation blueprint for search-service (version 2, all issues resolved)
  ═══════════════════════════════════════════════════════════════════════════════
  
  VERSION 2 CHANGES (per W1-T5-FIX):
  - ISS-SEARCH-001: Flow-ProductSearch added to DevelopmentPlan.xml
  - ISS-SEARCH-002: Added FC-search-getFacetValues and FC-search-getProductById
  - ISS-SEARCH-003: Added FC-search-reindexCatalog with alias swap block anchors
  - ISS-SEARCH-004: Extended ProductTemplatePublishedEvent with all required fields
  - ISS-SEARCH-005: Updated Flow-Event-Driven with all 3 search events
  
  APPROVAL REQUIRED before Coder agent may proceed with implementation.
  ═══════════════════════════════════════════════════════════════════════════════
-->
<GRACE_HANDOFF
    id="Handoff-20260108-02-v2-W1-T5-SearchService"
    status="PROPOSED"
    schemaVersion="grace-markup-v2"
    created="2026-01-08T18:41:30+03:00"
    updated="2026-01-08T20:45:00+03:00"
    author="GRACE-ARCHITECT"
    taskRef="W1-T5-FIX"
    planRef="DevelopmentPlan.xml#DP-SVC-search-service"
    blueprintRef="DevelopmentPlan.xml"
    techRef="Technology.xml#TECH-elasticsearch,Technology.xml#TECH-kafka,Technology.xml#DEC-SEARCH-ENGINE"
    requirementsRef="RequirementsAnalysis.xml#UC-CATALOG-BROWSE,RequirementsAnalysis.xml#NFR-PERF-SEARCH-LATENCY"
    previousVersion="Handoff-20260108-02-W1-T5-SearchService">

    <!-- ═══════════════════════════════════════════════════════════════════════ -->
    <!-- RESOLVED ISSUES: Changes made in this version                          -->
    <!-- ═══════════════════════════════════════════════════════════════════════ -->
    <ResolvedIssues>
        <Issue id="ISS-SEARCH-001" status="RESOLVED">
            <Title>Add Flow-ProductSearch to DevelopmentPlan.xml</Title>
            <Resolution>Added Flow-ProductSearch with 7 steps + autocomplete alternate flow</Resolution>
            <AffectedArtifacts>
                <Artifact>DevelopmentPlan.xml</Artifact>
            </AffectedArtifacts>
        </Issue>

        <Issue id="ISS-SEARCH-002" status="RESOLVED">
            <Title>Add missing FUNCTION_CONTRACTs</Title>
            <Resolution>Added FC-search-getFacetValues and FC-search-getProductById with block
                anchors BA-FACET-01..04 and BA-GET-01..03</Resolution>
            <AffectedArtifacts>
                <Artifact>FC-search-service-functions.xml</Artifact>
            </AffectedArtifacts>
        </Issue>

        <Issue id="ISS-SEARCH-003" status="RESOLVED">
            <Title>Define ReindexCatalogUseCase</Title>
            <Resolution>Added FC-search-reindexCatalog with ADMIN role requirement, distributed
                lock, and alias swap block anchors BA-REINDEX-01..06</Resolution>
            <AffectedArtifacts>
                <Artifact>FC-search-service-functions.xml</Artifact>
            </AffectedArtifacts>
        </Issue>

        <Issue id="ISS-SEARCH-004" status="RESOLVED">
            <Title>Complete catalog event payload</Title>
            <Resolution>Extended ProductTemplatePublishedEvent with: description, profile_system,
                opening_types, materials, colors, max_price, status, thumbnail_url, popularity.
                Added ProductStatus enum.</Resolution>
            <AffectedArtifacts>
                <Artifact>api-contracts/.../catalog_events.proto</Artifact>
            </AffectedArtifacts>
        </Issue>

        <Issue id="ISS-SEARCH-005" status="RESOLVED">
            <Title>Align Flow-Event-Driven with Kafka configuration</Title>
            <Resolution>Updated catalog-configuration-service producer and search-service consumer
                to include ProductTemplatePublishedEvent, ProductTemplateUnpublishedEvent, and
                ProductTemplateUpdatedEvent with action descriptions.</Resolution>
            <AffectedArtifacts>
                <Artifact>DevelopmentPlan.xml</Artifact>
            </AffectedArtifacts>
        </Issue>
    </ResolvedIssues>

    <!-- ═══════════════════════════════════════════════════════════════════════ -->
    <!-- SCOPE: Services and Use Cases covered by this handoff                   -->
    <!-- ═══════════════════════════════════════════════════════════════════════ -->
    <Scope>
        <Description>
            Wave 1 Task 5: Implement search-service to complete the CPQ catalog browsing capability.
            Provides full-text search, faceted filtering, autocomplete, and event-driven indexing
            from catalog-configuration-service via Kafka. Service is stateless — Elasticsearch
            is the sole data store.
        </Description>

        <Services>
            <ServiceRef ref="DP-SVC-search-service">Full-text search, facets, autocomplete</ServiceRef>
        </Services>

        <UseCases>
            <UseCaseRef ref="UC-CATALOG-BROWSE">Browse product catalog with filtering and search</UseCaseRef>
        </UseCases>

        <NFRs>
            <NFRRef ref="NFR-PERF-SEARCH-LATENCY">P95 search response time &lt; 200ms</NFRRef>
        </NFRs>

        <Flows>
            <FlowRef ref="Flow-Event-Driven">Consumer of ProductTemplatePublishedEvent for indexing</FlowRef>
            <FlowRef ref="Flow-ProductSearch">NEW: User product search flow (ISS-SEARCH-001)</FlowRef>
        </Flows>

        <Aggregates>
            <Aggregate name="ProductSearchDocument">Denormalized search document (read model)</Aggregate>
        </Aggregates>
    </Scope>

    <!-- ═══════════════════════════════════════════════════════════════════════ -->
    <!-- ARTIFACTS: Canonical sources referenced by this handoff                 -->
    <!-- ═══════════════════════════════════════════════════════════════════════ -->
    <Artifacts>
        <Artifact ref="RequirementsAnalysis.xml" version="1.0.0" />
        <Artifact ref="Technology.xml" version="1.2.0" />
        <Artifact ref="DevelopmentPlan.xml" version="1.5.0"
            note="Updated: Flow-ProductSearch, Flow-Event-Driven" />
        <Artifact ref="catalog_events.proto" version="1.1.0"
            note="Updated: Extended ProductTemplatePublishedEvent" />
    </Artifacts>

    <!-- ═══════════════════════════════════════════════════════════════════════ -->
    <!-- CONTRACTS: Semantic contracts governing implementation                  -->
    <!-- ═══════════════════════════════════════════════════════════════════════ -->
    <Contracts>
        <ModuleContractRef id="MC-search-service-domain" status="PROPOSED" />

        <!-- Original function contracts -->
        <FunctionContractRef id="FC-search-searchProducts" status="PROPOSED" />
        <FunctionContractRef id="FC-search-autocomplete" status="PROPOSED" />
        <FunctionContractRef id="FC-search-indexProduct" status="PROPOSED" />
        <FunctionContractRef id="FC-search-deleteProduct" status="PROPOSED" />

        <!-- NEW: Added per ISS-SEARCH-002 -->
        <FunctionContractRef id="FC-search-getFacetValues" status="PROPOSED" note="ISS-SEARCH-002" />
        <FunctionContractRef id="FC-search-getProductById" status="PROPOSED" note="ISS-SEARCH-002" />

        <!-- NEW: Added per ISS-SEARCH-003 -->
        <FunctionContractRef id="FC-search-reindexCatalog" status="PROPOSED" note="ISS-SEARCH-003" />

        <!-- Block Anchors: SearchProducts -->
        <BlockAnchorRef id="BA-SEARCH-QUERY-01" />
        <BlockAnchorRef id="BA-SEARCH-QUERY-02" />
        <BlockAnchorRef id="BA-SEARCH-QUERY-03" />
        <BlockAnchorRef id="BA-SEARCH-QUERY-04" />

        <!-- Block Anchors: Autocomplete -->
        <BlockAnchorRef id="BA-AUTO-01" />
        <BlockAnchorRef id="BA-AUTO-02" />
        <BlockAnchorRef id="BA-AUTO-03" />
        <BlockAnchorRef id="BA-AUTO-04" />

        <!-- Block Anchors: IndexProduct -->
        <BlockAnchorRef id="BA-INDEX-01" />
        <BlockAnchorRef id="BA-INDEX-02" />
        <BlockAnchorRef id="BA-INDEX-03" />
        <BlockAnchorRef id="BA-INDEX-04" />

        <!-- Block Anchors: DeleteProduct -->
        <BlockAnchorRef id="BA-DELETE-01" />
        <BlockAnchorRef id="BA-DELETE-02" />
        <BlockAnchorRef id="BA-DELETE-03" />

        <!-- NEW Block Anchors: GetFacetValues (ISS-SEARCH-002) -->
        <BlockAnchorRef id="BA-FACET-01" />
        <BlockAnchorRef id="BA-FACET-02" />
        <BlockAnchorRef id="BA-FACET-03" />
        <BlockAnchorRef id="BA-FACET-04" />

        <!-- NEW Block Anchors: GetProductById (ISS-SEARCH-002) -->
        <BlockAnchorRef id="BA-GET-01" />
        <BlockAnchorRef id="BA-GET-02" />
        <BlockAnchorRef id="BA-GET-03" />

        <!-- NEW Block Anchors: ReindexCatalog (ISS-SEARCH-003) -->
        <BlockAnchorRef id="BA-REINDEX-01" />
        <BlockAnchorRef id="BA-REINDEX-02" />
        <BlockAnchorRef id="BA-REINDEX-03" />
        <BlockAnchorRef id="BA-REINDEX-04" />
        <BlockAnchorRef id="BA-REINDEX-05" />
        <BlockAnchorRef id="BA-REINDEX-06" />
    </Contracts>

    <!-- ═══════════════════════════════════════════════════════════════════════ -->
    <!-- API CONTRACTS: External contract references                             -->
    <!-- ═══════════════════════════════════════════════════════════════════════ -->
    <ApiContracts>
        <Contract type="gRPC"
            path="api-contracts/src/main/proto/kanokna/search/v1/search_service.proto">
            <Description>gRPC service definition for search operations</Description>
            <Methods>
                <Method>SearchProducts</Method>
                <Method>GetAutocompleteSuggestions</Method>
                <Method>GetFacetValues</Method>
                <Method>GetProductById</Method>
            </Methods>
        </Contract>
        <Contract type="event"
            path="api-contracts/src/main/proto/kanokna/catalog/v1/catalog_events.proto"
            version="1.1.0">
            <Description>Consumed events for indexing (UPDATED: ISS-SEARCH-004)</Description>
            <Events>
                <Event>ProductTemplatePublishedEvent (extended with all search fields)</Event>
                <Event>ProductTemplateUnpublishedEvent</Event>
                <Event>ProductTemplateUpdatedEvent</Event>
            </Events>
        </Contract>
    </ApiContracts>

    <!-- ═══════════════════════════════════════════════════════════════════════ -->
    <!-- SERVICE DEFINITION: Implementation blueprint                            -->
    <!-- ═══════════════════════════════════════════════════════════════════════ -->
    <ServiceDefinition>
        <BoundedContext>search</BoundedContext>
        <ArtifactId>search-service</ArtifactId>
        <Ports>
            <Port type="http">8089</Port>
            <Port type="grpc">9089</Port>
        </Ports>
        <Database>
            <Note>NONE - Stateless service. Elasticsearch is external search engine.</Note>
        </Database>
        <SearchEngine ref="Technology.xml#TECH-elasticsearch">
            <Index name="product_templates" alias="product_templates">
                <Version>product_templates_v1</Version>
            </Index>
        </SearchEngine>

        <PackageLayout>
            <Layer name="domain">
                <Package>com.kanokna.search.domain.model</Package>
                <Package>com.kanokna.search.domain.service</Package>
            </Layer>
            <Layer name="application">
                <Package>com.kanokna.search.application.port.in</Package>
                <Package>com.kanokna.search.application.port.out</Package>
                <Package>com.kanokna.search.application.service</Package>
                <Package>com.kanokna.search.application.dto</Package>
            </Layer>
            <Layer name="adapters">
                <Package>com.kanokna.search.adapters.in.web</Package>
                <Package>com.kanokna.search.adapters.in.grpc</Package>
                <Package>com.kanokna.search.adapters.in.kafka</Package>
                <Package>com.kanokna.search.adapters.out.elasticsearch</Package>
                <Package>com.kanokna.search.adapters.out.catalog</Package>
                <Package>com.kanokna.search.adapters.config</Package>
            </Layer>
        </PackageLayout>
    </ServiceDefinition>

    <!-- ═══════════════════════════════════════════════════════════════════════ -->
    <!-- ELASTICSEARCH INDEX MAPPING                                             -->
    <!-- ═══════════════════════════════════════════════════════════════════════ -->
    <ElasticsearchIndexMapping>
        <IndexName>product_templates</IndexName>
        <AliasStrategy>Versioned indices with alias swap for zero-downtime reindex</AliasStrategy>
        <Mapping>
            <Field name="id" type="keyword" />
            <Field name="name" type="text" analyzer="standard">
                <SubField name="keyword" type="keyword" />
            </Field>
            <Field name="description" type="text" analyzer="standard" />
            <Field name="family" type="keyword" facet="true" />
            <Field name="profileSystem" type="keyword" facet="true" />
            <Field name="openingTypes" type="keyword" facet="true" multi="true" />
            <Field name="materials" type="keyword" facet="true" multi="true" />
            <Field name="colors" type="keyword" facet="true" multi="true" />
            <Field name="minPrice" type="long" description="Price in minor currency units" />
            <Field name="maxPrice" type="long" />
            <Field name="currency" type="keyword" />
            <Field name="popularity" type="integer" />
            <Field name="status" type="keyword" />
            <Field name="publishedAt" type="date" format="strict_date_optional_time" />
            <Field name="thumbnailUrl" type="keyword" index="false" />
            <Field name="optionCount" type="integer" />
            <Field name="suggest" type="completion">
                <Description>Autocomplete suggestions from name and family</Description>
            </Field>
        </Mapping>
        <Settings>
            <Setting name="number_of_shards">1</Setting>
            <Setting name="number_of_replicas">1</Setting>
            <Setting name="refresh_interval">1s</Setting>
        </Settings>
    </ElasticsearchIndexMapping>

    <!-- ═══════════════════════════════════════════════════════════════════════ -->
    <!-- KAFKA CONSUMER CONFIGURATION                                            -->
    <!-- ═══════════════════════════════════════════════════════════════════════ -->
    <KafkaConfiguration>
        <ConsumerGroup>search-service</ConsumerGroup>
        <Topics>
            <Topic name="catalog.product.published">
                <Event>ProductTemplatePublishedEvent</Event>
                <Action>Index or update product document</Action>
            </Topic>
            <Topic name="catalog.product.unpublished">
                <Event>ProductTemplateUnpublishedEvent</Event>
                <Action>Delete product document from index</Action>
            </Topic>
            <Topic name="catalog.product.updated">
                <Event>ProductTemplateUpdatedEvent</Event>
                <Action>Update product document (if indexed)</Action>
            </Topic>
        </Topics>
        <Configuration>
            <Item>auto.offset.reset=earliest</Item>
            <Item>enable.auto.commit=false (manual commit after processing)</Item>
            <Item>max.poll.records=100</Item>
            <Item>Protobuf deserialization via Schema Registry</Item>
        </Configuration>
        <ErrorHandling>
            <Item>Retry transient failures with exponential backoff</Item>
            <Item>Dead letter topic for poison messages after 3 retries</Item>
            <Item>Log and skip invalid events (do not block consumer)</Item>
        </ErrorHandling>
    </KafkaConfiguration>

    <!-- ═══════════════════════════════════════════════════════════════════════ -->
    <!-- VERIFICATION: Testing and validation requirements                       -->
    <!-- ═══════════════════════════════════════════════════════════════════════ -->
    <Verification>
        <TestCounts>
            <Unit minimum="25">Domain and application service tests (increased for new FCs)</Unit>
            <Slice minimum="7">Elasticsearch integration tests</Slice>
            <Integration minimum="5">Testcontainers with Elasticsearch + Kafka</Integration>
            <Contract minimum="2">gRPC contract validation against proto</Contract>
        </TestCounts>

        <TestCases>
            <!-- FC-search-searchProducts -->
            <TestCaseRef id="TC-FUNC-SEARCH-001" through="TC-FUNC-SEARCH-010" />
            <!-- FC-search-autocomplete -->
            <TestCaseRef id="TC-FUNC-AUTO-001" through="TC-FUNC-AUTO-005" />
            <!-- FC-search-indexProduct -->
            <TestCaseRef id="TC-FUNC-INDEX-001" through="TC-FUNC-INDEX-005" />
            <!-- FC-search-deleteProduct -->
            <TestCaseRef id="TC-FUNC-DELETE-001" through="TC-FUNC-DELETE-003" />
            <!-- FC-search-getFacetValues (NEW) -->
            <TestCaseRef id="TC-FUNC-FACET-001" through="TC-FUNC-FACET-005" />
            <!-- FC-search-getProductById (NEW) -->
            <TestCaseRef id="TC-FUNC-GET-001" through="TC-FUNC-GET-004" />
            <!-- FC-search-reindexCatalog (NEW) -->
            <TestCaseRef id="TC-FUNC-REINDEX-001" through="TC-FUNC-REINDEX-006" />
        </TestCases>

        <AcceptanceGates>
            <Gate>All unit tests pass (25+ tests)</Gate>
            <Gate>gRPC adapter implements all proto methods correctly</Gate>
            <Gate>ArchUnit rules pass (domain layer framework-free)</Gate>
            <Gate>Integration test: index product from Kafka event</Gate>
            <Gate>Integration test: search returns indexed products</Gate>
            <Gate>Integration test: GetFacetValues returns facet buckets</Gate>
            <Gate>Integration test: GetProductById returns single document</Gate>
            <Gate>Integration test: reindex swaps alias atomically</Gate>
            <Gate>P95 search latency &lt; 200ms (load test with 100 concurrent queries)</Gate>
            <Gate>Kafka consumer processes events without errors</Gate>
            <Gate>Health check includes Elasticsearch cluster status</Gate>
        </AcceptanceGates>
    </Verification>

    <!-- ═══════════════════════════════════════════════════════════════════════ -->
    <!-- CONSISTENCY CHECKLIST                                                   -->
    <!-- ═══════════════════════════════════════════════════════════════════════ -->
    <ConsistencyChecklist>
        <Item status="PASS">ISS-SEARCH-001: Flow-ProductSearch exists in DevelopmentPlan.xml</Item>
        <Item status="PASS">ISS-SEARCH-002: All gRPC methods have corresponding FUNCTION_CONTRACTs</Item>
        <Item status="PASS">ISS-SEARCH-003: FC-search-reindexCatalog defined with alias swap block
            anchors</Item>
        <Item status="PASS">ISS-SEARCH-004: ProductTemplatePublishedEvent contains all fields for
            indexing</Item>
        <Item status="PASS">ISS-SEARCH-005: Flow-Event-Driven includes all 3 consumed events</Item>
        <Item status="PASS">IDs follow conventions (UC-/NFR-/DP-SVC-/MC-/FC-/BA-)</Item>
        <Item status="PASS">All Link ref targets exist in canonical artifacts</Item>
        <Item status="PASS">No ambiguity in canonical artifacts; decisions recorded</Item>
        <Item status="PASS">Traceability: UC → Flow → FC/MC → BA → TC is complete (28 block anchors)</Item>
        <Item status="PASS">Test case count: 38 test cases across 7 function contracts</Item>
    </ConsistencyChecklist>

</GRACE_HANDOFF>

<!--
  ═══════════════════════════════════════════════════════════════════════════════
  APPROVAL INSTRUCTION (for Human Architect)
  ═══════════════════════════════════════════════════════════════════════════════
  
  To approve this handoff, add the following entry to approvals.log:
  
  <GRACE_APPROVAL
    ref="Handoff-20260108-02-v2-W1-T5-SearchService"
    status="APPROVED"
    approved="2026-01-08T##:##:##±##:##"
    approver="Human"
  />
  
  Implementation MUST NOT proceed until approval is recorded.
  ═══════════════════════════════════════════════════════════════════════════════
-->