<?xml version="1.0" encoding="UTF-8"?>
<!--
  GRACE Handoff: Security Scan Remediation
  AWO Reference: AWO-20260121-01-SECURITY-SCAN-REMEDIATION.xml
  Created: 2026-01-21T14:00:00+03:00
  CreatedBy: GRACE-ARCHITECT
  Status: APPROVED
  SchemaVersion: grace-markup-v2
-->

<!-- ═══════════════════════════════════════════════════════════════════════════
     GIT_IMPACT (MANDATORY per Section 19A.4)
     Advisory block for Coordinator - Architect does NOT perform Git operations
     ═══════════════════════════════════════════════════════════════════════════ -->
<GIT_IMPACT id="GIT-20260121-01" status="ADVISORY">
  <ChangeClassification>bugfix</ChangeClassification>
  <Rationale>
    Security vulnerability remediation (HIGH severity: CSRF documentation, Log Injection fix)
    and code quality fixes from GitHub CodeQL analysis. Classified as bugfix due to
    security-related nature of changes.
  </Rationale>
  <AffectedServices>
    <ServiceRef ref="DP-SVC-shared-kernel" note="Add OWASP Encoder dependency + LogSanitizer" />
    <ServiceRef ref="DP-SVC-pricing-service" note="Fix log injection in PriceCalculationUseCaseService" />
    <ServiceRef ref="DP-SVC-account-service" note="Fix null deref in AddressService, add CSRF comment" />
    <ServiceRef ref="DP-SVC-cart-service" note="Fix unread var in CartPricingService, add CSRF comment" />
    <ServiceRef ref="DP-SVC-search-service" note="Fix switch case + deprecated call, add CSRF comment" />
    <ServiceRef ref="DP-SVC-catalog-configuration-service" note="Fix NFE in BomResolutionService, add CSRF comment" />
    <ServiceRef ref="DP-SVC-gateway" note="Add CSRF comment" />
    <ServiceRef ref="DP-SVC-config-server" note="Add CSRF comment" />
  </AffectedServices>
  <InfrastructureChanges>
    <File path=".github/codeql-config.yml" action="CREATE">CodeQL exclusions config</File>
    <File path=".github/workflows/codeql.yml" action="UPDATE">Reference new config file</File>
  </InfrastructureChanges>
  <DefaultRouting>
    <BaseBranch>develop</BaseBranch>
    <PRTarget>develop</PRTarget>
    <RequiresBackMergeToDevelop>false</RequiresBackMergeToDevelop>
    <PreferredMergeMethod>squash</PreferredMergeMethod>
  </DefaultRouting>
  <BranchNaming>
    <Pattern>bugfix/W1-security-scan-remediation</Pattern>
    <TicketPolicy status="ASSUMED">No external ticket; use W1-SECURITY-SCAN as reference</TicketPolicy>
  </BranchNaming>
  <RiskNotes>
    <Item>MEDIUM RISK: Adds new dependency (OWASP Encoder) to shared-kernel</Item>
    <Item>LOW RISK: Code quality fixes are localized and straightforward</Item>
    <Item>Changes to SecurityConfig files are comment-only (no behavior change)</Item>
    <Item>Verify all services still build and tests pass after shared-kernel change</Item>
    <Item>CodeQL config changes may affect future security scan behavior</Item>
  </RiskNotes>
</GIT_IMPACT>

<GRACE_HANDOFF
    id="Handoff-20260121-01-W1-SECURITY-SCAN-REMEDIATION"
    status="APPROVED"
    schemaVersion="grace-markup-v2"
    created="2026-01-21T14:00:00+03:00"
    author="GRACE-ARCHITECT"
    taskRef="W1-SECURITY-SCAN"
    awoRef="AWO-20260121-01-SECURITY-SCAN-REMEDIATION"
>
  <Summary>
    Remediate GitHub CodeQL security alerts (HIGH severity: CSRF documentation, Log Injection)
    and code quality issues. Configure CodeQL to exclude generated Protobuf sources.
  </Summary>

  <!-- ═══════════════════════════════════════════════════════════════════════════
       DECISIONS MADE
       ═══════════════════════════════════════════════════════════════════════════ -->
  <DecisionsSummary>
    <Decision id="DEC-SEC-CSRF-STATELESS" status="APPROVED">
      CSRF intentionally disabled for stateless JWT APIs - documented architectural decision
    </Decision>
    <Decision id="DEC-SEC-LOG-SANITIZATION" status="APPROVED">
      OWASP Java Encoder with LogSanitizer utility in shared-kernel
    </Decision>
    <Decision id="DEC-SEC-CODEQL-EXCLUSIONS" status="APPROVED">
      Custom CodeQL config excluding generated sources and suppressing CSRF rule
    </Decision>
  </DecisionsSummary>

  <!-- ═══════════════════════════════════════════════════════════════════════════
       ARTIFACTS UPDATED
       ═══════════════════════════════════════════════════════════════════════════ -->
  <ArtifactsUpdated>
    <Artifact path="docs/grace/Technology.xml">
      <Change>Added DEC-SEC-CSRF-STATELESS decision with justification</Change>
      <Change>Added DEC-SEC-LOG-SANITIZATION decision (OWASP Encoder chosen)</Change>
      <Change>Added DEC-SEC-CODEQL-EXCLUSIONS decision with config details</Change>
    </Artifact>
    <Artifact path="docs/grace/DevelopmentPlan.xml">
      <Change>Added MC-shared-kernel-logging-LogSanitizer contract with function contracts</Change>
      <Change>Added SecurityScanning section with CodeQL configuration</Change>
      <Change>Added Stage order="6" for CodeQL in CIPipelineIntegration</Change>
    </Artifact>
  </ArtifactsUpdated>

  <!-- ═══════════════════════════════════════════════════════════════════════════
       IMPLEMENTATION TASKS FOR CODER
       ═══════════════════════════════════════════════════════════════════════════ -->
  <ImplementationTasks>
    <TaskGroup id="TG-1" name="HIGH SEVERITY - Log Injection Fix" priority="CRITICAL">
      <Description>
        Fix log injection vulnerabilities in pricing-service by adding LogSanitizer
        utility to shared-kernel and updating logging calls.
      </Description>
      <Tasks>
        <Task id="T-1.1">
          <Action>Add OWASP Encoder dependency to shared-kernel pom.xml</Action>
          <Dependency>
            <GroupId>org.owasp.encoder</GroupId>
            <ArtifactId>encoder</ArtifactId>
            <Version>1.2.3</Version>
          </Dependency>
        </Task>
        <Task id="T-1.2">
          <Action>Create LogSanitizer.java utility class</Action>
          <Package>com.kanokna.shared.logging</Package>
          <Contract ref="MC-shared-kernel-logging-LogSanitizer" />
          <Methods>
            <Method>public static String sanitize(String input)</Method>
            <Method>public static Map&lt;String, String&gt; sanitizeMap(Map&lt;String, ?&gt; input)</Method>
          </Methods>
        </Task>
        <Task id="T-1.3">
          <Action>Create LogSanitizerTest.java with test cases</Action>
          <TestCases>
            <TestCase ref="TC-LOG-SANITIZE-001">Newline injection sanitized</TestCase>
            <TestCase ref="TC-LOG-SANITIZE-002">ANSI escape sequences sanitized</TestCase>
            <TestCase ref="TC-LOG-SANITIZE-003">Normal strings unchanged</TestCase>
            <TestCase ref="TC-LOG-SANITIZE-004">Null input handling</TestCase>
          </TestCases>
        </Task>
        <Task id="T-1.4">
          <Action>Update PriceCalculationUseCaseService.java to use LogSanitizer</Action>
          <File>services/pricing-service/src/main/java/.../PriceCalculationUseCaseService.java</File>
          <Lines>110, 203</Lines>
          <Before>logger.info("message {}", userInput);</Before>
          <After>logger.info("message {}", LogSanitizer.sanitize(userInput));</After>
        </Task>
      </Tasks>
    </TaskGroup>

    <TaskGroup id="TG-2" name="HIGH SEVERITY - CSRF Documentation" priority="HIGH">
      <Description>
        Add explanatory comments to SecurityConfig files explaining why CSRF is disabled.
        This is documentation-only; no functional code changes.
      </Description>
      <Tasks>
        <Task id="T-2.1">
          <Action>Add CSRF disabled comment to all SecurityConfig files</Action>
          <Comment><![CDATA[
// CSRF protection is intentionally disabled per DEC-SEC-CSRF-STATELESS:
// - All APIs use stateless JWT bearer token authentication (no cookies)
// - No browser-based form submissions or cookie-based sessions
// - CSRF attacks require cookie-based auth which is not present
// See: Technology.xml#DEC-SEC-CSRF-STATELESS
          ]]></Comment>
          <Files>
            <File>config-server/src/main/java/.../SecurityConfig.java</File>
            <File>gateway/src/main/java/.../SecurityConfig.java</File>
            <File>services/pricing-service/src/main/java/.../SecurityConfig.java</File>
            <File>services/account-service/src/main/java/.../SecurityConfig.java</File>
            <File>services/cart-service/src/main/java/.../SecurityConfig.java</File>
            <File>services/catalog-configuration-service/src/main/java/.../SecurityConfig.java</File>
            <File>services/search-service/src/main/java/.../SecurityConfig.java</File>
          </Files>
        </Task>
      </Tasks>
    </TaskGroup>

    <TaskGroup id="TG-3" name="CodeQL Configuration" priority="HIGH">
      <Description>
        Create CodeQL configuration to exclude generated sources and suppress documented rules.
      </Description>
      <Tasks>
        <Task id="T-3.1">
          <Action>Create .github/codeql-config.yml</Action>
          <Content><![CDATA[
name: "Kanokna CodeQL Config"

# Exclude generated sources from analysis
paths-ignore:
  - '**/target/generated-sources/**'
  - '**/target/generated-test-sources/**'
  - '**/generated/**'
  - '**/*Proto.java'
  - '**/*Grpc.java'

# Suppress specific rules with documented justification
query-filters:
  - exclude:
      id: java/spring-disabled-csrf-protection
      # Justification: DEC-SEC-CSRF-STATELESS - stateless JWT APIs do not need CSRF
          ]]></Content>
        </Task>
        <Task id="T-3.2">
          <Action>Update .github/workflows/codeql.yml to reference config file</Action>
          <Change>Add config-file parameter to Initialize CodeQL step</Change>
          <Example><![CDATA[
- name: Initialize CodeQL
  uses: github/codeql-action/init@v3
  with:
    languages: java
    config-file: ./.github/codeql-config.yml
          ]]></Example>
        </Task>
      </Tasks>
    </TaskGroup>

    <TaskGroup id="TG-4" name="Code Quality Fixes" priority="MEDIUM">
      <Description>
        Fix non-security code quality issues flagged by CodeQL.
      </Description>
      <Tasks>
        <Task id="T-4.1">
          <Action>Fix null dereference in AddressService.java</Action>
          <File>services/account-service/.../AddressService.java</File>
          <Line>186</Line>
          <Fix>Add null check or use Optional.orElseThrow()</Fix>
        </Task>
        <Task id="T-4.2">
          <Action>Fix missing switch case in ElasticsearchSearchRepository.java</Action>
          <File>services/search-service/.../ElasticsearchSearchRepository.java</File>
          <Line>316</Line>
          <Fix>Add missing enum cases or add default case with explicit handling</Fix>
        </Task>
        <Task id="T-4.3">
          <Action>Fix unread variable in CartPricingService.java</Action>
          <File>services/cart-service/.../CartPricingService.java</File>
          <Line>152</Line>
          <Fix>Remove unused variable or use its value</Fix>
        </Task>
        <Task id="T-4.4">
          <Action>Fix uncaught NumberFormatException in BomResolutionService.java</Action>
          <File>services/catalog-configuration-service/.../BomResolutionService.java</File>
          <Lines>131, 134, 136</Lines>
          <Fix>Wrap Integer.parseInt in try-catch or use domain exception with proper message</Fix>
        </Task>
        <Task id="T-4.5">
          <Action>Fix deprecated call in JacksonConfig.java</Action>
          <File>services/search-service/.../JacksonConfig.java</File>
          <Line>30</Line>
          <Fix>Replace deprecated API with recommended alternative</Fix>
        </Task>
        <Task id="T-4.6" optional="true">
          <Action>Address unused parameters (~20 instances)</Action>
          <Fix>
            Review each case and either:
            (A) Remove if not needed by interface
            (B) Prefix with underscore (_param) if required by interface
            (C) Add @SuppressWarnings("unused") with comment
          </Fix>
          <Note>Many are in gRPC clients - may be intentional placeholders</Note>
        </Task>
      </Tasks>
    </TaskGroup>
  </ImplementationTasks>

  <!-- ═══════════════════════════════════════════════════════════════════════════
       ACCEPTANCE CRITERIA
       ═══════════════════════════════════════════════════════════════════════════ -->
  <AcceptanceCriteria>
    <Criterion id="AC-1" from="AWO" status="SATISFIED">
      DEC-SEC-CSRF-STATELESS recorded in Technology.xml with status="APPROVED"
    </Criterion>
    <Criterion id="AC-2" from="AWO" status="SATISFIED">
      DEC-SEC-LOG-SANITIZATION recorded in Technology.xml with chosen approach (OWASP Encoder)
    </Criterion>
    <Criterion id="AC-3" from="AWO" status="SATISFIED">
      DEC-SEC-CODEQL-EXCLUSIONS recorded in Technology.xml
    </Criterion>
    <Criterion id="AC-4" from="AWO" status="SATISFIED">
      No "OR" ambiguity in Technology.xml or DevelopmentPlan.xml
    </Criterion>
    <Criterion id="AC-5" from="AWO" status="SATISFIED">
      LogSanitizer contract (MC/FC) defined in DevelopmentPlan.xml
    </Criterion>
    <Criterion id="AC-6" from="AWO" status="SATISFIED">
      Test cases defined for log sanitization (TC-LOG-SANITIZE-001 through 004)
    </Criterion>
    <Criterion id="AC-7" from="AWO" status="SATISFIED">
      CodeQL config changes specified in handoff
    </Criterion>
    <Criterion id="AC-8" from="AWO" status="SATISFIED">
      All HIGH severity alerts have documented fix approach
    </Criterion>
    <Criterion id="AC-9" from="AWO" status="SATISFIED (this document)">
      GRACE_HANDOFF produced with scope matching work order
    </Criterion>
    <Criterion id="AC-10" from="AWO" status="SATISFIED">
      GIT_IMPACT block included with appropriate branch strategy
    </Criterion>
    <!-- Implementation criteria for CODER -->
    <Criterion id="AC-IMPL-1" for="CODER">
      LogSanitizer.java created in shared-kernel with OWASP Encoder
    </Criterion>
    <Criterion id="AC-IMPL-2" for="CODER">
      LogSanitizerTest.java passes all 4 test cases
    </Criterion>
    <Criterion id="AC-IMPL-3" for="CODER">
      PriceCalculationUseCaseService uses LogSanitizer for user input logging
    </Criterion>
    <Criterion id="AC-IMPL-4" for="CODER">
      All SecurityConfig files have CSRF explanation comment
    </Criterion>
    <Criterion id="AC-IMPL-5" for="CODER">
      .github/codeql-config.yml created with exclusions
    </Criterion>
    <Criterion id="AC-IMPL-6" for="CODER">
      codeql.yml workflow references new config file
    </Criterion>
    <Criterion id="AC-IMPL-7" for="CODER">
      All code quality fixes applied and tests pass
    </Criterion>
    <Criterion id="AC-IMPL-8" for="CODER">
      mvn clean verify succeeds on all affected modules
    </Criterion>
  </AcceptanceCriteria>

  <!-- ═══════════════════════════════════════════════════════════════════════════
       VERIFICATION
       ═══════════════════════════════════════════════════════════════════════════ -->
  <Verification>
    <Step order="1">Run: mvn clean verify -pl shared/shared-kernel</Step>
    <Step order="2">Run: mvn clean verify -pl services/pricing-service</Step>
    <Step order="3">Run: mvn clean verify (all modules)</Step>
    <Step order="4">Push to branch and verify CodeQL workflow runs with new config</Step>
    <Step order="5">Check GitHub Security tab - HIGH severity alerts should be resolved</Step>
  </Verification>

  <!-- ═══════════════════════════════════════════════════════════════════════════
       LINKS
       ═══════════════════════════════════════════════════════════════════════════ -->
  <Links>
    <Link ref="docs/grace/awo/AWO-20260121-01-SECURITY-SCAN-REMEDIATION.xml" type="source" />
    <Link ref="docs/grace/Technology.xml#DEC-SEC-CSRF-STATELESS" type="decision" />
    <Link ref="docs/grace/Technology.xml#DEC-SEC-LOG-SANITIZATION" type="decision" />
    <Link ref="docs/grace/Technology.xml#DEC-SEC-CODEQL-EXCLUSIONS" type="decision" />
    <Link ref="docs/grace/DevelopmentPlan.xml#MC-shared-kernel-logging-LogSanitizer" type="contract" />
    <Link ref="docs/grace/DevelopmentPlan.xml#SecurityScanning" type="section" />
  </Links>
</GRACE_HANDOFF>
