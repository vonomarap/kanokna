<?xml version="1.0" encoding="UTF-8"?>
<!--
  GRACE Handoff Document: Pricing Service
  Handoff ID: Handoff-20251231-02
  Scope: W1-T3 + W1-T4 (Skeleton + Domain Logic)
  Status: APPROVED (approval in docs/grace/approvals.log)
  Author: GRACE-ARCHITECT
-->
<GRACE_HANDOFF
  id="Handoff-20251231-02"
  status="APPROVED"
  schemaVersion="grace-markup-v2"
  created="2025-12-31T14:00:00+03:00"
  author="GRACE-ARCHITECT"
  taskRef="W1-T3,W1-T4"
  planRef="DevelopmentExecutionPlan.xml#W1-T3,DevelopmentExecutionPlan.xml#W1-T4"
  blueprintRef="DevelopmentPlan.xml#DP-SVC-pricing-service"
  techRef="Technology.xml#TECH-spring-boot,Technology.xml#TECH-spring-data-jpa,Technology.xml#TECH-grpc,Technology.xml#TECH-redis,Technology.xml#DEC-ARCH-RULE-ENGINE-STRATEGY,Technology.xml#DEC-ARCH-ENTITY-VERSIONING,Technology.xml#DEC-PRICING-BASE-PRICE-FORMULA,Technology.xml#DEC-PRICING-PREMIUM-TYPES,Technology.xml#DEC-PRICING-DISCOUNT-PRECEDENCE,Technology.xml#DEC-PRICING-CURRENCY,Technology.xml#DEC-PRICING-TAX-STRATEGY,Technology.xml#DEC-PRICING-ROUNDING,Technology.xml#DEC-PRICING-QUOTE-TTL"
  requirementsRef="RequirementsAnalysis.xml#UC-PRICING-QUOTE,RequirementsAnalysis.xml#UC-PRICING-ADMIN-MANAGE"
>

  <!-- ═══════════════════════════════════════════════════════════════════════════
       1. INTENT SUMMARY
       ═══════════════════════════════════════════════════════════════════════════ -->
  <IntentSummary>
    <BusinessIntent>
      Implement the Pricing Service that calculates accurate price quotes for validated
      product configurations. The service applies base pricing from price books, adds
      option premiums (material upgrades, glazing types, accessories), applies promotional
      discounts (campaigns and promo codes), calculates regional taxes, and returns
      itemized quotes with full decision trace for auditability.
    </BusinessIntent>
    <TechnicalIntent>
      Create a hexagonal architecture microservice with:
      - Domain layer: Aggregates (PriceBook, Campaign, TaxRule), Value Objects (Quote, Money)
      - Application layer: Use case services with ports (in/out)
      - Adapters: REST (HTTP:8082), gRPC (9082), JPA persistence, Redis cache, Kafka events
      - Price calculation engine with formula-based rules
      - Quote caching with 5-minute TTL in Redis
      - Integration with catalog-configuration-service (upstream consumer)
    </TechnicalIntent>
    <Scope>
      <Task ref="DevelopmentExecutionPlan.xml#W1-T3">Skeleton structure</Task>
      <Task ref="DevelopmentExecutionPlan.xml#W1-T4">Domain logic implementation</Task>
      <Wave ref="DevelopmentExecutionPlan.xml#WAVE-1"/>
      <Service ref="DevelopmentPlan.xml#DP-SVC-pricing-service"/>
    </Scope>
  </IntentSummary>

  <!-- ═══════════════════════════════════════════════════════════════════════════
       2. DECISIONS SNAPSHOT
       ═══════════════════════════════════════════════════════════════════════════ -->
  <DecisionsSnapshot>
    <!-- Inherited from Technology.xml -->
    <Decision ref="Technology.xml#TECH-spring-boot">Spring Boot 3.2.x</Decision>
    <Decision ref="Technology.xml#TECH-spring-data-jpa">JPA for persistence</Decision>
    <Decision ref="Technology.xml#TECH-grpc">gRPC for inter-service sync calls</Decision>
    <Decision ref="Technology.xml#TECH-postgresql">PostgreSQL for OLTP</Decision>
    <Decision ref="Technology.xml#TECH-redis">Redis for quote caching</Decision>
    <Decision ref="Technology.xml#TECH-kafka">Kafka for domain events</Decision>

    <!-- Architectural patterns from Technology.xml -->
    <Decision ref="Technology.xml#DEC-ARCH-RULE-ENGINE-STRATEGY">
      Domain-native rule evaluation for pricing formulas
    </Decision>
    <Decision ref="Technology.xml#DEC-ARCH-ENTITY-VERSIONING">
      Soft-delete with versioned snapshots for PriceBook history
    </Decision>

    <!-- Service-specific pricing decisions (canonical source: Technology.xml) -->
    <Decision ref="Technology.xml#DEC-PRICING-BASE-PRICE-FORMULA">
      Area-based pricing: base_price = area_m2 * price_per_m2
    </Decision>
    <Decision ref="Technology.xml#DEC-PRICING-PREMIUM-TYPES">
      Two premium types: ABSOLUTE (fixed amount) and PERCENTAGE (of base price)
    </Decision>
    <Decision ref="Technology.xml#DEC-PRICING-DISCOUNT-PRECEDENCE">
      Campaign discounts apply first, then promo codes. Max combined discount: 30%
    </Decision>
    <Decision ref="Technology.xml#DEC-PRICING-CURRENCY">
      Single currency (RUB) initially; multi-currency deferred to Wave 5
    </Decision>
    <Decision ref="Technology.xml#DEC-PRICING-TAX-STRATEGY">
      Region-based VAT with Russia (20%) as default
    </Decision>
    <Decision ref="Technology.xml#DEC-PRICING-ROUNDING">
      HALF_UP rounding to 2 decimal places for RUB
    </Decision>
    <Decision ref="Technology.xml#DEC-PRICING-QUOTE-TTL">
      5 minutes TTL in Redis for quote caching
    </Decision>
  </DecisionsSnapshot>

  <!-- ═══════════════════════════════════════════════════════════════════════════
       3. FILES TO CREATE
       ═══════════════════════════════════════════════════════════════════════════ -->
  <FilesToCreate>

    <!-- ─────────────────────────────────────────────────────────────────────────
         BUILD CONFIGURATION
         ───────────────────────────────────────────────────────────────────────── -->
    <FileGroup name="Build">
      <File path="pricing-service/pom.xml" action="CREATE">
        Maven module with Spring Boot, JPA, gRPC, Redis, Kafka dependencies
      </File>
      <File path="pricing-service/Dockerfile" action="CREATE">
        Multi-stage build with Jib fallback
      </File>
    </FileGroup>

    <!-- ─────────────────────────────────────────────────────────────────────────
         DOMAIN LAYER - Pure Java, No Framework Dependencies
         ───────────────────────────────────────────────────────────────────────── -->
    <FileGroup name="Domain Model">
      <File path="pricing-service/src/main/java/com/kanokna/pricing/domain/model/PriceBook.java" action="CREATE">
        Aggregate root for price definitions (base prices, option premiums)
      </File>
      <File path="pricing-service/src/main/java/com/kanokna/pricing/domain/model/PriceBookId.java" action="CREATE">
        Typed ID for PriceBook
      </File>
      <File path="pricing-service/src/main/java/com/kanokna/pricing/domain/model/PriceBookStatus.java" action="CREATE">
        Enum: DRAFT, ACTIVE, ARCHIVED (per DEC-ARCH-ENTITY-VERSIONING)
      </File>
      <File path="pricing-service/src/main/java/com/kanokna/pricing/domain/model/BasePriceEntry.java" action="CREATE">
        Entity: Base price per m² for a product template
      </File>
      <File path="pricing-service/src/main/java/com/kanokna/pricing/domain/model/OptionPremium.java" action="CREATE">
        Entity: Premium for an option (ABSOLUTE or PERCENTAGE)
      </File>
      <File path="pricing-service/src/main/java/com/kanokna/pricing/domain/model/PremiumType.java" action="CREATE">
        Enum: ABSOLUTE, PERCENTAGE
      </File>
      <File path="pricing-service/src/main/java/com/kanokna/pricing/domain/model/Campaign.java" action="CREATE">
        Aggregate root for promotional campaigns
      </File>
      <File path="pricing-service/src/main/java/com/kanokna/pricing/domain/model/CampaignId.java" action="CREATE">
        Typed ID for Campaign
      </File>
      <File path="pricing-service/src/main/java/com/kanokna/pricing/domain/model/CampaignRule.java" action="CREATE">
        Entity: Campaign discount rule (percentage or fixed)
      </File>
      <File path="pricing-service/src/main/java/com/kanokna/pricing/domain/model/CampaignStatus.java" action="CREATE">
        Enum: SCHEDULED, ACTIVE, EXPIRED, CANCELLED
      </File>
      <File path="pricing-service/src/main/java/com/kanokna/pricing/domain/model/PromoCode.java" action="CREATE">
        Entity: Promotional code with usage limits
      </File>
      <File path="pricing-service/src/main/java/com/kanokna/pricing/domain/model/PromoCodeId.java" action="CREATE">
        Typed ID for PromoCode
      </File>
      <File path="pricing-service/src/main/java/com/kanokna/pricing/domain/model/TaxRule.java" action="CREATE">
        Aggregate root for regional tax configurations
      </File>
      <File path="pricing-service/src/main/java/com/kanokna/pricing/domain/model/TaxRuleId.java" action="CREATE">
        Typed ID for TaxRule
      </File>
      <File path="pricing-service/src/main/java/com/kanokna/pricing/domain/model/Quote.java" action="CREATE">
        Value object: Calculated price quote (immutable)
      </File>
      <File path="pricing-service/src/main/java/com/kanokna/pricing/domain/model/QuoteId.java" action="CREATE">
        Typed ID for Quote
      </File>
      <File path="pricing-service/src/main/java/com/kanokna/pricing/domain/model/PremiumLine.java" action="CREATE">
        Value object: Single option premium in quote
      </File>
      <File path="pricing-service/src/main/java/com/kanokna/pricing/domain/model/PricingDecision.java" action="CREATE">
        Value object: Single decision in audit trace
      </File>
      <File path="pricing-service/src/main/java/com/kanokna/pricing/domain/model/DiscountType.java" action="CREATE">
        Enum: CAMPAIGN, PROMO_CODE
      </File>
      <File path="pricing-service/src/main/java/com/kanokna/pricing/domain/model/PriceBookVersion.java" action="CREATE">
        Aggregate: Versioned price book snapshot (per DEC-ARCH-ENTITY-VERSIONING)
      </File>
    </FileGroup>

    <FileGroup name="Domain Services">
      <File path="pricing-service/src/main/java/com/kanokna/pricing/domain/service/PriceCalculationService.java" action="CREATE">
        Domain service: Calculates quotes from configurations
      </File>
      <File path="pricing-service/src/main/java/com/kanokna/pricing/domain/service/DiscountService.java" action="CREATE">
        Domain service: Applies campaign and promo discounts
      </File>
      <File path="pricing-service/src/main/java/com/kanokna/pricing/domain/service/TaxCalculationService.java" action="CREATE">
        Domain service: Calculates regional taxes
      </File>
      <File path="pricing-service/src/main/java/com/kanokna/pricing/domain/service/RoundingService.java" action="CREATE">
        Domain service: Applies currency-specific rounding
      </File>
    </FileGroup>

    <FileGroup name="Domain Events">
      <File path="pricing-service/src/main/java/com/kanokna/pricing/domain/event/QuoteCalculatedEvent.java" action="CREATE">
        Event: Published when quote is calculated (for analytics)
      </File>
      <File path="pricing-service/src/main/java/com/kanokna/pricing/domain/event/PriceBookPublishedEvent.java" action="CREATE">
        Event: Published when price book is activated
      </File>
      <File path="pricing-service/src/main/java/com/kanokna/pricing/domain/event/PromoCodeAppliedEvent.java" action="CREATE">
        Event: Published when promo code is used
      </File>
    </FileGroup>

    <FileGroup name="Domain Exceptions">
      <File path="pricing-service/src/main/java/com/kanokna/pricing/domain/exception/PriceBookNotFoundException.java" action="CREATE">
        Exception: No active price book for product
      </File>
      <File path="pricing-service/src/main/java/com/kanokna/pricing/domain/exception/InvalidPromoCodeException.java" action="CREATE">
        Exception: Promo code invalid or expired
      </File>
      <File path="pricing-service/src/main/java/com/kanokna/pricing/domain/exception/TaxRuleNotFoundException.java" action="CREATE">
        Exception: No tax rule for region
      </File>
      <File path="pricing-service/src/main/java/com/kanokna/pricing/domain/exception/DiscountLimitExceededException.java" action="CREATE">
        Exception: Combined discounts exceed 30% cap
      </File>
    </FileGroup>

    <!-- ─────────────────────────────────────────────────────────────────────────
         APPLICATION LAYER - Use Cases and Ports
         ───────────────────────────────────────────────────────────────────────── -->
    <FileGroup name="Application Ports (Inbound)">
      <File path="pricing-service/src/main/java/com/kanokna/pricing/application/port/in/CalculateQuoteUseCase.java" action="CREATE">
        Port: Calculate quote for configuration
      </File>
      <File path="pricing-service/src/main/java/com/kanokna/pricing/application/port/in/ValidatePromoCodeUseCase.java" action="CREATE">
        Port: Validate promo code
      </File>
      <File path="pricing-service/src/main/java/com/kanokna/pricing/application/port/in/GetPriceBookQuery.java" action="CREATE">
        Port: Get price book details (admin)
      </File>
      <File path="pricing-service/src/main/java/com/kanokna/pricing/application/port/in/CreatePriceBookUseCase.java" action="CREATE">
        Port: Create price book (admin)
      </File>
      <File path="pricing-service/src/main/java/com/kanokna/pricing/application/port/in/PublishPriceBookUseCase.java" action="CREATE">
        Port: Publish price book version (admin)
      </File>
      <File path="pricing-service/src/main/java/com/kanokna/pricing/application/port/in/CreateCampaignUseCase.java" action="CREATE">
        Port: Create campaign (admin)
      </File>
      <File path="pricing-service/src/main/java/com/kanokna/pricing/application/port/in/CreatePromoCodeUseCase.java" action="CREATE">
        Port: Create promo code (admin)
      </File>
    </FileGroup>

    <FileGroup name="Application Ports (Outbound)">
      <File path="pricing-service/src/main/java/com/kanokna/pricing/application/port/out/PriceBookRepository.java" action="CREATE">
        Port: Price book persistence
      </File>
      <File path="pricing-service/src/main/java/com/kanokna/pricing/application/port/out/CampaignRepository.java" action="CREATE">
        Port: Campaign persistence
      </File>
      <File path="pricing-service/src/main/java/com/kanokna/pricing/application/port/out/PromoCodeRepository.java" action="CREATE">
        Port: Promo code persistence
      </File>
      <File path="pricing-service/src/main/java/com/kanokna/pricing/application/port/out/TaxRuleRepository.java" action="CREATE">
        Port: Tax rule persistence
      </File>
      <File path="pricing-service/src/main/java/com/kanokna/pricing/application/port/out/QuoteCache.java" action="CREATE">
        Port: Quote cache (Redis)
      </File>
      <File path="pricing-service/src/main/java/com/kanokna/pricing/application/port/out/EventPublisher.java" action="CREATE">
        Port: Domain event publishing (Kafka)
      </File>
    </FileGroup>

    <FileGroup name="Application Services">
      <File path="pricing-service/src/main/java/com/kanokna/pricing/application/service/PriceCalculationUseCaseService.java" action="CREATE">
        Implements CalculateQuoteUseCase, ValidatePromoCodeUseCase
      </File>
      <File path="pricing-service/src/main/java/com/kanokna/pricing/application/service/PriceBookQueryService.java" action="CREATE">
        Implements GetPriceBookQuery
      </File>
      <File path="pricing-service/src/main/java/com/kanokna/pricing/application/service/PriceBookCommandService.java" action="CREATE">
        Implements Create/Publish price book use cases
      </File>
      <File path="pricing-service/src/main/java/com/kanokna/pricing/application/service/CampaignCommandService.java" action="CREATE">
        Implements CreateCampaignUseCase
      </File>
    </FileGroup>

    <FileGroup name="Application DTOs">
      <File path="pricing-service/src/main/java/com/kanokna/pricing/application/dto/CalculateQuoteCommand.java" action="CREATE">
        Command DTO for quote calculation
      </File>
      <File path="pricing-service/src/main/java/com/kanokna/pricing/application/dto/QuoteResponse.java" action="CREATE">
        Response DTO with itemized quote
      </File>
      <File path="pricing-service/src/main/java/com/kanokna/pricing/application/dto/ValidatePromoCodeCommand.java" action="CREATE">
        Command DTO for promo code validation
      </File>
      <File path="pricing-service/src/main/java/com/kanokna/pricing/application/dto/PromoCodeValidationResponse.java" action="CREATE">
        Response DTO for promo validation
      </File>
      <File path="pricing-service/src/main/java/com/kanokna/pricing/application/dto/CreatePriceBookCommand.java" action="CREATE">
        Command DTO for price book creation
      </File>
      <File path="pricing-service/src/main/java/com/kanokna/pricing/application/dto/CreateCampaignCommand.java" action="CREATE">
        Command DTO for campaign creation
      </File>
    </FileGroup>

    <!-- ─────────────────────────────────────────────────────────────────────────
         ADAPTERS LAYER - Infrastructure
         ───────────────────────────────────────────────────────────────────────── -->
    <FileGroup name="REST Adapter (Inbound)">
      <File path="pricing-service/src/main/java/com/kanokna/pricing/adapters/in/web/PricingController.java" action="CREATE">
        REST controller for pricing operations (public)
      </File>
      <File path="pricing-service/src/main/java/com/kanokna/pricing/adapters/in/web/AdminPricingController.java" action="CREATE">
        REST controller for admin operations
      </File>
      <File path="pricing-service/src/main/java/com/kanokna/pricing/adapters/in/web/GlobalExceptionHandler.java" action="CREATE">
        Exception handler with problem details
      </File>
    </FileGroup>

    <FileGroup name="gRPC Adapter (Inbound)">
      <File path="pricing-service/src/main/java/com/kanokna/pricing/adapters/in/grpc/PricingGrpcService.java" action="CREATE">
        gRPC service implementation (for catalog-service, cart-service)
      </File>
      <File path="pricing-service/src/main/java/com/kanokna/pricing/adapters/in/grpc/GrpcExceptionAdvice.java" action="CREATE">
        gRPC exception handler
      </File>
      <File path="pricing-service/src/main/java/com/kanokna/pricing/adapters/in/grpc/PricingGrpcMapper.java" action="CREATE">
        Mapper: Domain &lt;-&gt; Protobuf (from api-contracts)
      </File>
    </FileGroup>

    <FileGroup name="Persistence Adapter (Outbound)">
      <File path="pricing-service/src/main/java/com/kanokna/pricing/adapters/out/persistence/PriceBookJpaEntity.java" action="CREATE">
        JPA entity for PriceBook
      </File>
      <File path="pricing-service/src/main/java/com/kanokna/pricing/adapters/out/persistence/BasePriceEntryJpaEntity.java" action="CREATE">
        JPA entity for BasePriceEntry
      </File>
      <File path="pricing-service/src/main/java/com/kanokna/pricing/adapters/out/persistence/OptionPremiumJpaEntity.java" action="CREATE">
        JPA entity for OptionPremium
      </File>
      <File path="pricing-service/src/main/java/com/kanokna/pricing/adapters/out/persistence/CampaignJpaEntity.java" action="CREATE">
        JPA entity for Campaign
      </File>
      <File path="pricing-service/src/main/java/com/kanokna/pricing/adapters/out/persistence/CampaignRuleJpaEntity.java" action="CREATE">
        JPA entity for CampaignRule
      </File>
      <File path="pricing-service/src/main/java/com/kanokna/pricing/adapters/out/persistence/PromoCodeJpaEntity.java" action="CREATE">
        JPA entity for PromoCode
      </File>
      <File path="pricing-service/src/main/java/com/kanokna/pricing/adapters/out/persistence/TaxRuleJpaEntity.java" action="CREATE">
        JPA entity for TaxRule
      </File>
      <File path="pricing-service/src/main/java/com/kanokna/pricing/adapters/out/persistence/PriceBookVersionJpaEntity.java" action="CREATE">
        JPA entity for PriceBookVersion snapshots
      </File>
      <File path="pricing-service/src/main/java/com/kanokna/pricing/adapters/out/persistence/PriceBookJpaRepository.java" action="CREATE">
        Spring Data JPA repository
      </File>
      <File path="pricing-service/src/main/java/com/kanokna/pricing/adapters/out/persistence/PriceBookRepositoryAdapter.java" action="CREATE">
        Adapter implementing PriceBookRepository port
      </File>
      <File path="pricing-service/src/main/java/com/kanokna/pricing/adapters/out/persistence/PriceBookMapper.java" action="CREATE">
        Mapper: Domain &lt;-&gt; JPA entity
      </File>
      <File path="pricing-service/src/main/java/com/kanokna/pricing/adapters/out/persistence/CampaignJpaRepository.java" action="CREATE">
        Spring Data JPA repository
      </File>
      <File path="pricing-service/src/main/java/com/kanokna/pricing/adapters/out/persistence/CampaignRepositoryAdapter.java" action="CREATE">
        Adapter implementing CampaignRepository port
      </File>
      <File path="pricing-service/src/main/java/com/kanokna/pricing/adapters/out/persistence/PromoCodeJpaRepository.java" action="CREATE">
        Spring Data JPA repository
      </File>
      <File path="pricing-service/src/main/java/com/kanokna/pricing/adapters/out/persistence/PromoCodeRepositoryAdapter.java" action="CREATE">
        Adapter implementing PromoCodeRepository port
      </File>
      <File path="pricing-service/src/main/java/com/kanokna/pricing/adapters/out/persistence/TaxRuleJpaRepository.java" action="CREATE">
        Spring Data JPA repository
      </File>
      <File path="pricing-service/src/main/java/com/kanokna/pricing/adapters/out/persistence/TaxRuleRepositoryAdapter.java" action="CREATE">
        Adapter implementing TaxRuleRepository port
      </File>
    </FileGroup>

    <FileGroup name="Redis Adapter (Outbound)">
      <File path="pricing-service/src/main/java/com/kanokna/pricing/adapters/out/redis/QuoteRedisCache.java" action="CREATE">
        Redis cache adapter for quotes
      </File>
      <File path="pricing-service/src/main/java/com/kanokna/pricing/adapters/out/redis/QuoteCacheKey.java" action="CREATE">
        Cache key generator (hash of inputs)
      </File>
    </FileGroup>

    <FileGroup name="Kafka Adapter (Outbound)">
      <File path="pricing-service/src/main/java/com/kanokna/pricing/adapters/out/kafka/KafkaEventPublisher.java" action="CREATE">
        Kafka producer for domain events
      </File>
      <File path="pricing-service/src/main/java/com/kanokna/pricing/adapters/out/kafka/EventSerializer.java" action="CREATE">
        Protobuf serializer for events
      </File>
    </FileGroup>

    <FileGroup name="Configuration">
      <File path="pricing-service/src/main/java/com/kanokna/pricing/adapters/config/PersistenceConfig.java" action="CREATE">
        JPA and transaction configuration
      </File>
      <File path="pricing-service/src/main/java/com/kanokna/pricing/adapters/config/GrpcConfig.java" action="CREATE">
        gRPC server configuration
      </File>
      <File path="pricing-service/src/main/java/com/kanokna/pricing/adapters/config/RedisConfig.java" action="CREATE">
        Redis connection and serialization
      </File>
      <File path="pricing-service/src/main/java/com/kanokna/pricing/adapters/config/KafkaConfig.java" action="CREATE">
        Kafka producer configuration
      </File>
      <File path="pricing-service/src/main/java/com/kanokna/pricing/adapters/config/SecurityConfig.java" action="CREATE">
        OAuth2 resource server configuration
      </File>
      <File path="pricing-service/src/main/java/com/kanokna/pricing/PricingServiceApplication.java" action="CREATE">
        Spring Boot main class
      </File>
    </FileGroup>

    <FileGroup name="Resources">
      <File path="pricing-service/src/main/resources/application.yml" action="CREATE">
        Application configuration
      </File>
      <File path="pricing-service/src/main/resources/application-dev.yml" action="CREATE">
        Development profile
      </File>
      <File path="pricing-service/src/main/resources/db/migration/V1__init_pricing_schema.sql" action="CREATE">
        Flyway migration: Initial schema
      </File>
      <File path="pricing-service/src/main/resources/db/migration/V2__seed_pricing_data.sql" action="CREATE">
        Flyway migration: Seed data for development
      </File>
    </FileGroup>

    <!-- ─────────────────────────────────────────────────────────────────────────
         TESTS
         ───────────────────────────────────────────────────────────────────────── -->
    <FileGroup name="Unit Tests">
      <File path="pricing-service/src/test/java/com/kanokna/pricing/domain/service/PriceCalculationServiceTest.java" action="CREATE">
        Unit tests for price calculation
      </File>
      <File path="pricing-service/src/test/java/com/kanokna/pricing/domain/service/DiscountServiceTest.java" action="CREATE">
        Unit tests for discount application
      </File>
      <File path="pricing-service/src/test/java/com/kanokna/pricing/domain/service/TaxCalculationServiceTest.java" action="CREATE">
        Unit tests for tax calculation
      </File>
      <File path="pricing-service/src/test/java/com/kanokna/pricing/domain/model/QuoteTest.java" action="CREATE">
        Unit tests for Quote value object
      </File>
    </FileGroup>

    <FileGroup name="Integration Tests">
      <File path="pricing-service/src/test/java/com/kanokna/pricing/adapters/in/grpc/PricingGrpcServiceIntegrationTest.java" action="CREATE">
        Integration tests for gRPC endpoints
      </File>
      <File path="pricing-service/src/test/java/com/kanokna/pricing/adapters/out/persistence/PriceBookRepositoryIntegrationTest.java" action="CREATE">
        Integration tests with Testcontainers
      </File>
      <File path="pricing-service/src/test/java/com/kanokna/pricing/adapters/out/redis/QuoteCacheIntegrationTest.java" action="CREATE">
        Integration tests for Redis cache
      </File>
    </FileGroup>

    <FileGroup name="Architecture Tests">
      <File path="pricing-service/src/test/java/com/kanokna/pricing/ArchitectureTest.java" action="CREATE">
        ArchUnit tests for hexagonal layering
      </File>
    </FileGroup>

  </FilesToCreate>

  <!-- ═══════════════════════════════════════════════════════════════════════════
       4. SEMANTIC CONTRACTS
       ═══════════════════════════════════════════════════════════════════════════ -->
  <SemanticContractsAndAnchors>

    <!-- ─────────────────────────────────────────────────────────────────────────
         MODULE CONTRACT: Price Calculation Domain Service
         ───────────────────────────────────────────────────────────────────────── -->
    <ModuleContract id="MC-pricing-service-domain-PriceCalculation">
      <EmbedInFile>pricing-service/src/main/java/com/kanokna/pricing/domain/service/PriceCalculationService.java</EmbedInFile>
      <Contract><![CDATA[
/* <MODULE_CONTRACT id="MC-pricing-service-domain-PriceCalculation"
     ROLE="DomainService"
     SERVICE="pricing-service"
     LAYER="domain"
     BOUNDED_CONTEXT="pricing"
     SPECIFICATION="UC-PRICING-QUOTE">
  <PURPOSE>
    Domain service that calculates price quotes for validated product configurations.
    Orchestrates base price calculation, option premiums, discounts, and taxes to
    produce itemized quotes with full decision trace for auditability.
  </PURPOSE>

  <RESPONSIBILITIES>
    <Item>Load active price book for product template</Item>
    <Item>Calculate base price from area (m²) and price_per_m2</Item>
    <Item>Apply option premiums (ABSOLUTE or PERCENTAGE)</Item>
    <Item>Apply campaign discounts (if active campaigns exist)</Item>
    <Item>Apply promo code discounts (if provided and valid)</Item>
    <Item>Enforce discount cap (30% max combined)</Item>
    <Item>Calculate regional tax (VAT)</Item>
    <Item>Apply currency-specific rounding</Item>
    <Item>Build decision trace for audit</Item>
  </RESPONSIBILITIES>

  <INVARIANTS>
    <Item>Quote calculation is deterministic for same inputs</Item>
    <Item>Base price is always positive</Item>
    <Item>Combined discounts never exceed 30% of subtotal</Item>
    <Item>Tax is calculated on discounted subtotal</Item>
    <Item>All amounts use correct currency precision</Item>
  </INVARIANTS>

  <CONTEXT>
    <UPSTREAM>
      <Item>PricingGrpcService: receives requests from catalog-configuration-service</Item>
      <Item>PricingController: REST API for direct quote requests</Item>
    </UPSTREAM>
    <DOWNSTREAM>
      <Item>PriceBookRepository: loads price books</Item>
      <Item>CampaignRepository: loads active campaigns</Item>
      <Item>PromoCodeRepository: validates promo codes</Item>
      <Item>TaxRuleRepository: loads tax rules</Item>
      <Item>QuoteCache: caches calculated quotes</Item>
    </DOWNSTREAM>
  </CONTEXT>

  <PUBLIC_API>
    <Method name="calculateQuote" input="CalculateQuoteCommand" output="Quote"/>
  </PUBLIC_API>

  <BUSINESS_RULES>
    <Rule id="BR-PRC-001">Base price = area_m2 * price_per_m2 (minimum 1m² charge)</Rule>
    <Rule id="BR-PRC-002">ABSOLUTE premiums add fixed amount</Rule>
    <Rule id="BR-PRC-003">PERCENTAGE premiums add (base_price * percentage / 100)</Rule>
    <Rule id="BR-PRC-004">Campaign discounts apply to subtotal before promo codes</Rule>
    <Rule id="BR-PRC-005">Combined discounts capped at 30%</Rule>
    <Rule id="BR-PRC-006">Russia VAT is 20% on discounted subtotal</Rule>
    <Rule id="BR-PRC-007">Final price rounded HALF_UP to 2 decimals for RUB</Rule>
  </BUSINESS_RULES>

  <ERROR_HANDLING>
    <Item type="BUSINESS" code="ERR-PRC-NO-PRICEBOOK">No active price book for product</Item>
    <Item type="BUSINESS" code="ERR-PRC-INVALID-PROMO">Promo code invalid, expired, or exhausted</Item>
    <Item type="BUSINESS" code="ERR-PRC-NO-TAXRULE">No tax rule for region</Item>
    <Item type="BUSINESS" code="ERR-PRC-DISCOUNT-EXCEEDED">Combined discounts exceed 30% cap</Item>
    <Item type="TECHNICAL" code="ERR-PRC-CALCULATION-FAILED">Unexpected calculation error</Item>
  </ERROR_HANDLING>

  <LOGGING>
    <FORMAT>[SVC=pricing-service][UC=UC-PRICING-QUOTE][BLOCK=...][STATE=...] eventType=... decision=... keyValues=...</FORMAT>
    <EXAMPLES>
      <Item>[SVC=pricing-service][UC=UC-PRICING-QUOTE][BLOCK=BA-PRC-CALC-01][STATE=LOAD_PRICEBOOK] eventType=PRICING_STEP decision=FOUND keyValues=priceBookId,productTemplateId</Item>
      <Item>[SVC=pricing-service][UC=UC-PRICING-QUOTE][BLOCK=BA-PRC-CALC-99][STATE=FINAL] eventType=QUOTE_CALCULATED decision=SUCCESS keyValues=quoteId,total_rub</Item>
    </EXAMPLES>
  </LOGGING>

  <TESTS>
    <Case id="TC-PRC-001">Standard configuration returns correct base price</Case>
    <Case id="TC-PRC-002">Option premiums (ABSOLUTE) added correctly</Case>
    <Case id="TC-PRC-003">Option premiums (PERCENTAGE) calculated on base price</Case>
    <Case id="TC-PRC-004">Active campaign discount applied</Case>
    <Case id="TC-PRC-005">Valid promo code discount applied</Case>
    <Case id="TC-PRC-006">Campaign + promo stacking respects 30% cap</Case>
    <Case id="TC-PRC-007">Russia VAT (20%) calculated correctly</Case>
    <Case id="TC-PRC-008">Missing price book returns ERR-PRC-NO-PRICEBOOK</Case>
    <Case id="TC-PRC-009">Invalid promo code returns ERR-PRC-INVALID-PROMO</Case>
    <Case id="TC-PRC-010">Expired campaign not applied</Case>
    <Case id="TC-PRC-011">Quote cached and retrieved on repeat request</Case>
    <Case id="TC-PRC-012">Decision trace contains all calculation steps</Case>
  </TESTS>

  <LINKS>
    <Link ref="RequirementsAnalysis.xml#UC-PRICING-QUOTE"/>
    <Link ref="DevelopmentPlan.xml#DP-SVC-pricing-service"/>
    <Link ref="DevelopmentPlan.xml#Flow-Config-Pricing"/>
    <Link ref="Technology.xml#DEC-ARCH-RULE-ENGINE-STRATEGY"/>
  </LINKS>
</MODULE_CONTRACT> */
      ]]></Contract>
    </ModuleContract>

    <!-- ─────────────────────────────────────────────────────────────────────────
         FUNCTION CONTRACT: calculateQuote
         ───────────────────────────────────────────────────────────────────────── -->
    <FunctionContract id="FC-pricing-service-UC-PRICING-QUOTE-calculateQuote">
      <EmbedInFile>pricing-service/src/main/java/com/kanokna/pricing/domain/service/PriceCalculationService.java</EmbedInFile>
      <Contract><![CDATA[
/* <FUNCTION_CONTRACT id="FC-pricing-service-UC-PRICING-QUOTE-calculateQuote"
     LAYER="domain.service"
     INTENT="Calculate a complete price quote for a validated product configuration"
     INPUT="CalculateQuoteCommand (productTemplateId, dimensions, resolvedBom, currency, promoCode?, region)"
     OUTPUT="Quote"
     SIDE_EFFECTS="Cache quote in Redis, publish QuoteCalculatedEvent"
     LINKS="RequirementsAnalysis.xml#UC-PRICING-QUOTE;DevelopmentPlan.xml#Flow-Config-Pricing">
  <PRECONDITIONS>
    <Item>command.productTemplateId is not null</Item>
    <Item>command.dimensions is valid (50-400cm range)</Item>
    <Item>command.resolvedBom is not empty</Item>
    <Item>command.currency is supported (RUB initially)</Item>
    <Item>command.region is provided (default: "RU")</Item>
  </PRECONDITIONS>

  <POSTCONDITIONS>
    <Item>Quote is never null</Item>
    <Item>Quote.total equals base_price + premiums - discounts + tax</Item>
    <Item>Quote.decisionTrace contains all calculation steps</Item>
    <Item>Quote.validUntil is 5 minutes from calculation</Item>
    <Item>Quote is cached in Redis with quoteId as key</Item>
  </POSTCONDITIONS>

  <INVARIANTS>
    <Item>Calculation is deterministic for same inputs and price book version</Item>
    <Item>All Money values use same currency</Item>
    <Item>Rounding applied only at final step</Item>
  </INVARIANTS>

  <ERROR_HANDLING>
    <Item type="BUSINESS" code="ERR-PRC-NO-PRICEBOOK">No active price book found</Item>
    <Item type="BUSINESS" code="ERR-PRC-INVALID-PROMO">Promo code invalid or expired</Item>
    <Item type="BUSINESS" code="ERR-PRC-NO-TAXRULE">No tax rule for region</Item>
  </ERROR_HANDLING>

  <BLOCK_ANCHORS>
    <Item id="BA-PRC-CALC-01">Load price book for product</Item>
    <Item id="BA-PRC-CALC-02">Calculate base price from dimensions</Item>
    <Item id="BA-PRC-CALC-03">Apply option premiums</Item>
    <Item id="BA-PRC-CALC-04">Apply campaign discounts</Item>
    <Item id="BA-PRC-CALC-05">Apply promo code discount</Item>
    <Item id="BA-PRC-CALC-06">Calculate subtotal</Item>
    <Item id="BA-PRC-CALC-07">Calculate tax</Item>
    <Item id="BA-PRC-CALC-08">Apply rounding</Item>
    <Item id="BA-PRC-CALC-99">Final quote result</Item>
  </BLOCK_ANCHORS>

  <LOGGING>
    <Item>[SVC=pricing-service][UC=UC-PRICING-QUOTE][BLOCK=BA-PRC-CALC-01][STATE=LOAD_PRICEBOOK] eventType=PRICING_STEP decision=FOUND|NOT_FOUND keyValues=productTemplateId,priceBookId</Item>
    <Item>[SVC=pricing-service][UC=UC-PRICING-QUOTE][BLOCK=BA-PRC-CALC-02][STATE=BASE_PRICE] eventType=PRICING_STEP decision=CALCULATED keyValues=area_m2,price_per_m2,base_price_rub</Item>
    <Item>[SVC=pricing-service][UC=UC-PRICING-QUOTE][BLOCK=BA-PRC-CALC-03][STATE=PREMIUMS] eventType=PRICING_STEP decision=APPLIED keyValues=premium_count,total_premium_rub</Item>
    <Item>[SVC=pricing-service][UC=UC-PRICING-QUOTE][BLOCK=BA-PRC-CALC-04][STATE=CAMPAIGN] eventType=PRICING_STEP decision=APPLIED|NONE keyValues=campaignId,discount_rub</Item>
    <Item>[SVC=pricing-service][UC=UC-PRICING-QUOTE][BLOCK=BA-PRC-CALC-05][STATE=PROMO] eventType=PRICING_STEP decision=APPLIED|INVALID|NONE keyValues=promoCode,discount_rub</Item>
    <Item>[SVC=pricing-service][UC=UC-PRICING-QUOTE][BLOCK=BA-PRC-CALC-07][STATE=TAX] eventType=PRICING_STEP decision=CALCULATED keyValues=region,tax_rate_pct,tax_rub</Item>
    <Item>[SVC=pricing-service][UC=UC-PRICING-QUOTE][BLOCK=BA-PRC-CALC-99][STATE=FINAL] eventType=QUOTE_CALCULATED decision=SUCCESS keyValues=quoteId,total_rub,valid_until</Item>
  </LOGGING>

  <TESTS>
    <Case id="TC-FUNC-CALC-001">Valid configuration returns quote with all fields populated</Case>
    <Case id="TC-FUNC-CALC-002">Area calculated correctly from dimensions (width_cm * height_cm / 10000)</Case>
    <Case id="TC-FUNC-CALC-003">Minimum area charge applied for small configurations</Case>
    <Case id="TC-FUNC-CALC-004">Multiple ABSOLUTE premiums summed correctly</Case>
    <Case id="TC-FUNC-CALC-005">PERCENTAGE premium calculated on base price only</Case>
    <Case id="TC-FUNC-CALC-006">Best campaign discount selected when multiple active</Case>
    <Case id="TC-FUNC-CALC-007">Promo code validates usage limits</Case>
    <Case id="TC-FUNC-CALC-008">30% discount cap enforced</Case>
    <Case id="TC-FUNC-CALC-009">Tax calculated on discounted subtotal</Case>
    <Case id="TC-FUNC-CALC-010">Rounding applied consistently</Case>
    <Case id="TC-FUNC-CALC-011">Quote cached with correct TTL</Case>
    <Case id="TC-FUNC-CALC-012">Cached quote returned for identical inputs</Case>
  </TESTS>
</FUNCTION_CONTRACT> */
      ]]></Contract>
    </FunctionContract>

    <!-- ─────────────────────────────────────────────────────────────────────────
         FUNCTION CONTRACT: validatePromoCode
         ───────────────────────────────────────────────────────────────────────── -->
    <FunctionContract id="FC-pricing-service-UC-PRICING-QUOTE-validatePromoCode">
      <EmbedInFile>pricing-service/src/main/java/com/kanokna/pricing/application/service/PriceCalculationUseCaseService.java</EmbedInFile>
      <Contract><![CDATA[
/* <FUNCTION_CONTRACT id="FC-pricing-service-UC-PRICING-QUOTE-validatePromoCode"
     LAYER="application.service"
     INTENT="Validate a promotional code and calculate potential discount"
     INPUT="ValidatePromoCodeCommand (promoCode, subtotal)"
     OUTPUT="PromoCodeValidationResponse"
     SIDE_EFFECTS="None (validation only)"
     LINKS="RequirementsAnalysis.xml#UC-PRICING-QUOTE">
  <PRECONDITIONS>
    <Item>command.promoCode is not blank</Item>
    <Item>command.subtotal is positive</Item>
  </PRECONDITIONS>

  <POSTCONDITIONS>
    <Item>Response.valid is true iff code exists, not expired, and has remaining uses</Item>
    <Item>Response.discountAmount is calculated if valid</Item>
    <Item>Response.errorMessage explains invalidity if not valid</Item>
  </POSTCONDITIONS>

  <ERROR_HANDLING>
    <Item type="BUSINESS" code="ERR-PROMO-NOT-FOUND">Promo code does not exist</Item>
    <Item type="BUSINESS" code="ERR-PROMO-EXPIRED">Promo code has expired</Item>
    <Item type="BUSINESS" code="ERR-PROMO-EXHAUSTED">Promo code usage limit reached</Item>
    <Item type="BUSINESS" code="ERR-PROMO-MIN-SUBTOTAL">Subtotal below minimum for promo</Item>
  </ERROR_HANDLING>

  <BLOCK_ANCHORS>
    <Item id="BA-PROMO-VAL-01">Load promo code</Item>
    <Item id="BA-PROMO-VAL-02">Check expiry</Item>
    <Item id="BA-PROMO-VAL-03">Check usage limits</Item>
    <Item id="BA-PROMO-VAL-04">Calculate discount amount</Item>
  </BLOCK_ANCHORS>

  <TESTS>
    <Case id="TC-PROMO-001">Valid promo code returns valid=true with discount amount</Case>
    <Case id="TC-PROMO-002">Non-existent code returns valid=false with ERR-PROMO-NOT-FOUND</Case>
    <Case id="TC-PROMO-003">Expired code returns valid=false with ERR-PROMO-EXPIRED</Case>
    <Case id="TC-PROMO-004">Exhausted code returns valid=false with ERR-PROMO-EXHAUSTED</Case>
    <Case id="TC-PROMO-005">Subtotal below minimum returns valid=false with ERR-PROMO-MIN-SUBTOTAL</Case>
  </TESTS>
</FUNCTION_CONTRACT> */
      ]]></Contract>
    </FunctionContract>

    <!-- ─────────────────────────────────────────────────────────────────────────
         FUNCTION CONTRACT: createPriceBook (Admin)
         ───────────────────────────────────────────────────────────────────────── -->
    <FunctionContract id="FC-pricing-service-UC-PRICING-ADMIN-MANAGE-createPriceBook">
      <EmbedInFile>pricing-service/src/main/java/com/kanokna/pricing/application/service/PriceBookCommandService.java</EmbedInFile>
      <Contract><![CDATA[
/* <FUNCTION_CONTRACT id="FC-pricing-service-UC-PRICING-ADMIN-MANAGE-createPriceBook"
     LAYER="application.service"
     INTENT="Create a new price book for a product template"
     INPUT="CreatePriceBookCommand"
     OUTPUT="PriceBookId"
     SIDE_EFFECTS="Persists new PriceBook in DRAFT status"
     LINKS="RequirementsAnalysis.xml#UC-PRICING-ADMIN-MANAGE;Technology.xml#DEC-ARCH-ENTITY-VERSIONING">
  <PRECONDITIONS>
    <Item>Caller has PRICING_ADMIN or ADMIN role</Item>
    <Item>command.productTemplateId references existing product</Item>
    <Item>command.currency is supported</Item>
    <Item>command.pricePerM2 is positive</Item>
  </PRECONDITIONS>

  <POSTCONDITIONS>
    <Item>PriceBook is persisted with DRAFT status</Item>
    <Item>PriceBookId is returned</Item>
    <Item>Audit fields populated</Item>
  </POSTCONDITIONS>

  <ERROR_HANDLING>
    <Item type="SECURITY" code="ERR-AUTH-FORBIDDEN">Caller lacks required role</Item>
    <Item type="BUSINESS" code="ERR-PRC-INVALID-PRICE">Price per m² must be positive</Item>
  </ERROR_HANDLING>

  <BLOCK_ANCHORS>
    <Item id="BA-PB-CREATE-01">Validate admin authorization</Item>
    <Item id="BA-PB-CREATE-02">Validate price book data</Item>
    <Item id="BA-PB-CREATE-03">Build PriceBook aggregate</Item>
    <Item id="BA-PB-CREATE-04">Persist and return ID</Item>
  </BLOCK_ANCHORS>

  <TESTS>
    <Case id="TC-PB-CREATE-001">Valid command creates price book in DRAFT status</Case>
    <Case id="TC-PB-CREATE-002">Non-admin user returns ERR-AUTH-FORBIDDEN</Case>
    <Case id="TC-PB-CREATE-003">Zero or negative price returns ERR-PRC-INVALID-PRICE</Case>
  </TESTS>
</FUNCTION_CONTRACT> */
      ]]></Contract>
    </FunctionContract>

    <!-- ─────────────────────────────────────────────────────────────────────────
         FUNCTION CONTRACT: publishPriceBook (Admin)
         ───────────────────────────────────────────────────────────────────────── -->
    <FunctionContract id="FC-pricing-service-UC-PRICING-ADMIN-MANAGE-publishPriceBook">
      <EmbedInFile>pricing-service/src/main/java/com/kanokna/pricing/application/service/PriceBookCommandService.java</EmbedInFile>
      <Contract><![CDATA[
/* <FUNCTION_CONTRACT id="FC-pricing-service-UC-PRICING-ADMIN-MANAGE-publishPriceBook"
     LAYER="application.service"
     INTENT="Publish a price book version, making it active"
     INPUT="PublishPriceBookCommand (priceBookId)"
     OUTPUT="PriceBookVersionId"
     SIDE_EFFECTS="Creates PriceBookVersion snapshot, transitions DRAFT->ACTIVE, archives previous, invalidates cache, emits event"
     LINKS="RequirementsAnalysis.xml#UC-PRICING-ADMIN-MANAGE;Technology.xml#DEC-ARCH-ENTITY-VERSIONING">
  <PRECONDITIONS>
    <Item>Caller has PRICING_ADMIN or ADMIN role</Item>
    <Item>PriceBook exists with given ID</Item>
    <Item>PriceBook is in DRAFT status</Item>
  </PRECONDITIONS>

  <POSTCONDITIONS>
    <Item>PriceBookVersion snapshot created</Item>
    <Item>PriceBook status transitioned to ACTIVE</Item>
    <Item>Previous ACTIVE price book for same product archived</Item>
    <Item>Quote cache invalidated for affected product</Item>
    <Item>PriceBookPublishedEvent emitted</Item>
  </POSTCONDITIONS>

  <ERROR_HANDLING>
    <Item type="SECURITY" code="ERR-AUTH-FORBIDDEN">Caller lacks required role</Item>
    <Item type="BUSINESS" code="ERR-PRC-PB-NOT-FOUND">Price book not found</Item>
    <Item type="BUSINESS" code="ERR-PRC-PB-NOT-DRAFT">Price book is not in DRAFT status</Item>
  </ERROR_HANDLING>

  <BLOCK_ANCHORS>
    <Item id="BA-PB-PUBLISH-01">Validate admin authorization</Item>
    <Item id="BA-PB-PUBLISH-02">Load price book</Item>
    <Item id="BA-PB-PUBLISH-03">Create version snapshot</Item>
    <Item id="BA-PB-PUBLISH-04">Archive previous active</Item>
    <Item id="BA-PB-PUBLISH-05">Invalidate cache</Item>
    <Item id="BA-PB-PUBLISH-06">Emit event</Item>
  </BLOCK_ANCHORS>

  <TESTS>
    <Case id="TC-PB-PUBLISH-001">Valid publish creates version and transitions status</Case>
    <Case id="TC-PB-PUBLISH-002">Previous active price book archived</Case>
    <Case id="TC-PB-PUBLISH-003">Quote cache invalidated</Case>
    <Case id="TC-PB-PUBLISH-004">PriceBookPublishedEvent emitted</Case>
    <Case id="TC-PB-PUBLISH-005">Non-DRAFT price book returns ERR-PRC-PB-NOT-DRAFT</Case>
  </TESTS>
</FUNCTION_CONTRACT> */
      ]]></Contract>
    </FunctionContract>

    <!-- Block Anchor Registry -->
    <BlockAnchorRegistry>
      <!-- Price calculation anchors -->
      <BlockAnchor id="BA-PRC-CALC-01" service="pricing-service" purpose="Load price book for product"/>
      <BlockAnchor id="BA-PRC-CALC-02" service="pricing-service" purpose="Calculate base price from dimensions"/>
      <BlockAnchor id="BA-PRC-CALC-03" service="pricing-service" purpose="Apply option premiums"/>
      <BlockAnchor id="BA-PRC-CALC-04" service="pricing-service" purpose="Apply campaign discounts"/>
      <BlockAnchor id="BA-PRC-CALC-05" service="pricing-service" purpose="Apply promo code discount"/>
      <BlockAnchor id="BA-PRC-CALC-06" service="pricing-service" purpose="Calculate subtotal"/>
      <BlockAnchor id="BA-PRC-CALC-07" service="pricing-service" purpose="Calculate tax"/>
      <BlockAnchor id="BA-PRC-CALC-08" service="pricing-service" purpose="Apply rounding"/>
      <BlockAnchor id="BA-PRC-CALC-99" service="pricing-service" purpose="Final quote result"/>

      <!-- Promo validation anchors -->
      <BlockAnchor id="BA-PROMO-VAL-01" service="pricing-service" purpose="Load promo code"/>
      <BlockAnchor id="BA-PROMO-VAL-02" service="pricing-service" purpose="Check expiry"/>
      <BlockAnchor id="BA-PROMO-VAL-03" service="pricing-service" purpose="Check usage limits"/>
      <BlockAnchor id="BA-PROMO-VAL-04" service="pricing-service" purpose="Calculate discount amount"/>

      <!-- Price book admin anchors -->
      <BlockAnchor id="BA-PB-CREATE-01" service="pricing-service" purpose="Validate admin authorization for create"/>
      <BlockAnchor id="BA-PB-CREATE-02" service="pricing-service" purpose="Validate price book data"/>
      <BlockAnchor id="BA-PB-CREATE-03" service="pricing-service" purpose="Build PriceBook aggregate"/>
      <BlockAnchor id="BA-PB-CREATE-04" service="pricing-service" purpose="Persist and return ID"/>

      <BlockAnchor id="BA-PB-PUBLISH-01" service="pricing-service" purpose="Validate admin authorization for publish"/>
      <BlockAnchor id="BA-PB-PUBLISH-02" service="pricing-service" purpose="Load price book"/>
      <BlockAnchor id="BA-PB-PUBLISH-03" service="pricing-service" purpose="Create version snapshot"/>
      <BlockAnchor id="BA-PB-PUBLISH-04" service="pricing-service" purpose="Archive previous active"/>
      <BlockAnchor id="BA-PB-PUBLISH-05" service="pricing-service" purpose="Invalidate cache"/>
      <BlockAnchor id="BA-PB-PUBLISH-06" service="pricing-service" purpose="Emit event"/>
    </BlockAnchorRegistry>

  </SemanticContractsAndAnchors>

  <!-- ═══════════════════════════════════════════════════════════════════════════
       5. IMPLEMENTATION SPECIFICATIONS
       ═══════════════════════════════════════════════════════════════════════════ -->
  <ImplementationSpecifications>

    <!-- POM -->
    <PomSpec file="pricing-service/pom.xml">
      <![CDATA[
<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0"
         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0
                             http://maven.apache.org/xsd/maven-4.0.0.xsd">
    <modelVersion>4.0.0</modelVersion>

    <parent>
        <groupId>com.kanokna</groupId>
        <artifactId>windows-store-server</artifactId>
        <version>1.0-SNAPSHOT</version>
    </parent>

    <artifactId>pricing-service</artifactId>
    <name>pricing-service</name>
    <description>Price calculation service for product configurations</description>

    <dependencies>
        <!-- Internal modules -->
        <dependency>
            <groupId>com.kanokna</groupId>
            <artifactId>shared-kernel</artifactId>
        </dependency>
        <dependency>
            <groupId>com.kanokna</groupId>
            <artifactId>api-contracts</artifactId>
        </dependency>

        <!-- Spring Boot -->
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-web</artifactId>
        </dependency>
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-data-jpa</artifactId>
        </dependency>
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-validation</artifactId>
        </dependency>
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-actuator</artifactId>
        </dependency>
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-oauth2-resource-server</artifactId>
        </dependency>
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-data-redis</artifactId>
        </dependency>

        <!-- gRPC -->
        <dependency>
            <groupId>net.devh</groupId>
            <artifactId>grpc-server-spring-boot-starter</artifactId>
        </dependency>

        <!-- Kafka -->
        <dependency>
            <groupId>org.springframework.kafka</groupId>
            <artifactId>spring-kafka</artifactId>
        </dependency>

        <!-- Database -->
        <dependency>
            <groupId>org.postgresql</groupId>
            <artifactId>postgresql</artifactId>
            <scope>runtime</scope>
        </dependency>
        <dependency>
            <groupId>org.flywaydb</groupId>
            <artifactId>flyway-core</artifactId>
        </dependency>

        <!-- Observability -->
        <dependency>
            <groupId>io.micrometer</groupId>
            <artifactId>micrometer-registry-prometheus</artifactId>
        </dependency>
        <dependency>
            <groupId>io.micrometer</groupId>
            <artifactId>micrometer-tracing-bridge-otel</artifactId>
        </dependency>
        <dependency>
            <groupId>net.logstash.logback</groupId>
            <artifactId>logstash-logback-encoder</artifactId>
        </dependency>

        <!-- Test -->
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-test</artifactId>
            <scope>test</scope>
        </dependency>
        <dependency>
            <groupId>org.testcontainers</groupId>
            <artifactId>postgresql</artifactId>
            <scope>test</scope>
        </dependency>
        <dependency>
            <groupId>org.testcontainers</groupId>
            <artifactId>kafka</artifactId>
            <scope>test</scope>
        </dependency>
        <dependency>
            <groupId>com.redis.testcontainers</groupId>
            <artifactId>testcontainers-redis-junit</artifactId>
            <scope>test</scope>
        </dependency>
        <dependency>
            <groupId>com.tngtech.archunit</groupId>
            <artifactId>archunit-junit5</artifactId>
            <scope>test</scope>
        </dependency>
    </dependencies>

    <build>
        <plugins>
            <plugin>
                <groupId>org.springframework.boot</groupId>
                <artifactId>spring-boot-maven-plugin</artifactId>
            </plugin>
            <plugin>
                <groupId>com.google.cloud.tools</groupId>
                <artifactId>jib-maven-plugin</artifactId>
            </plugin>
        </plugins>
    </build>
</project>
      ]]>
    </PomSpec>

    <!-- Application Configuration -->
    <ApplicationYml file="pricing-service/src/main/resources/application.yml">
      <![CDATA[
server:
  port: 8082

spring:
  application:
    name: pricing-service
  config:
    import: optional:configserver:http://localhost:8888
  datasource:
    url: jdbc:postgresql://localhost:5432/pricing
    username: ${DB_USERNAME:kanokna}
    password: ${DB_PASSWORD:kanokna_dev}
  jpa:
    hibernate:
      ddl-auto: validate
    open-in-view: false
    properties:
      hibernate:
        default_schema: pricing
  flyway:
    schemas: pricing
  data:
    redis:
      host: ${REDIS_HOST:localhost}
      port: ${REDIS_PORT:6379}
  kafka:
    bootstrap-servers: ${KAFKA_BOOTSTRAP_SERVERS:localhost:9092}
    producer:
      key-serializer: org.apache.kafka.common.serialization.StringSerializer
      value-serializer: io.confluent.kafka.serializers.protobuf.KafkaProtobufSerializer

grpc:
  server:
    port: 9082

pricing:
  quote:
    cache-ttl-minutes: 5
  discount:
    max-combined-percent: 30
  tax:
    default-region: RU
    default-rate-percent: 20

management:
  endpoints:
    web:
      exposure:
        include: health,info,prometheus
  endpoint:
    health:
      show-details: always
      probes:
        enabled: true
  tracing:
    sampling:
      probability: ${TRACING_SAMPLE_PROBABILITY:1.0}

logging:
  level:
    com.kanokna.pricing: DEBUG
      ]]>
    </ApplicationYml>

    <!-- Flyway Initial Migration -->
    <FlywayMigration file="pricing-service/src/main/resources/db/migration/V1__init_pricing_schema.sql">
      <![CDATA[
-- Schema: pricing
CREATE SCHEMA IF NOT EXISTS pricing;

-- Price Books
CREATE TABLE pricing.price_books (
    id UUID PRIMARY KEY,
    product_template_id VARCHAR(100) NOT NULL,
    currency VARCHAR(3) NOT NULL DEFAULT 'RUB',
    price_per_m2 DECIMAL(12, 2) NOT NULL,
    minimum_area_m2 DECIMAL(6, 4) NOT NULL DEFAULT 0.25,
    minimum_charge DECIMAL(12, 2),
    status VARCHAR(20) NOT NULL DEFAULT 'DRAFT',
    version BIGINT NOT NULL DEFAULT 0,
    created_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW(),
    created_by VARCHAR(100),
    updated_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW()
);

CREATE INDEX idx_price_books_product ON pricing.price_books(product_template_id);
CREATE INDEX idx_price_books_status ON pricing.price_books(status);
CREATE UNIQUE INDEX idx_price_books_active ON pricing.price_books(product_template_id, currency)
    WHERE status = 'ACTIVE';

-- Option Premiums
CREATE TABLE pricing.option_premiums (
    id UUID PRIMARY KEY,
    price_book_id UUID NOT NULL REFERENCES pricing.price_books(id),
    option_id VARCHAR(100) NOT NULL,
    option_name VARCHAR(200) NOT NULL,
    premium_type VARCHAR(20) NOT NULL,
    amount DECIMAL(12, 2) NOT NULL,
    created_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW()
);

CREATE INDEX idx_option_premiums_pricebook ON pricing.option_premiums(price_book_id);

-- Campaigns
CREATE TABLE pricing.campaigns (
    id UUID PRIMARY KEY,
    name VARCHAR(200) NOT NULL,
    description TEXT,
    discount_type VARCHAR(20) NOT NULL,
    discount_value DECIMAL(10, 2) NOT NULL,
    max_discount DECIMAL(12, 2),
    applicable_products JSONB,
    start_date TIMESTAMP WITH TIME ZONE NOT NULL,
    end_date TIMESTAMP WITH TIME ZONE NOT NULL,
    status VARCHAR(20) NOT NULL DEFAULT 'SCHEDULED',
    priority INT NOT NULL DEFAULT 0,
    created_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW(),
    created_by VARCHAR(100)
);

CREATE INDEX idx_campaigns_status ON pricing.campaigns(status);
CREATE INDEX idx_campaigns_dates ON pricing.campaigns(start_date, end_date);

-- Promo Codes
CREATE TABLE pricing.promo_codes (
    id UUID PRIMARY KEY,
    code VARCHAR(50) NOT NULL UNIQUE,
    description TEXT,
    discount_type VARCHAR(20) NOT NULL,
    discount_value DECIMAL(10, 2) NOT NULL,
    max_discount DECIMAL(12, 2),
    min_subtotal DECIMAL(12, 2),
    usage_limit INT,
    usage_count INT NOT NULL DEFAULT 0,
    start_date TIMESTAMP WITH TIME ZONE NOT NULL,
    end_date TIMESTAMP WITH TIME ZONE NOT NULL,
    active BOOLEAN NOT NULL DEFAULT true,
    created_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW(),
    created_by VARCHAR(100)
);

CREATE INDEX idx_promo_codes_code ON pricing.promo_codes(code);
CREATE INDEX idx_promo_codes_active ON pricing.promo_codes(active, start_date, end_date);

-- Tax Rules
CREATE TABLE pricing.tax_rules (
    id UUID PRIMARY KEY,
    region VARCHAR(10) NOT NULL UNIQUE,
    region_name VARCHAR(100) NOT NULL,
    tax_rate_percent DECIMAL(5, 2) NOT NULL,
    tax_type VARCHAR(20) NOT NULL DEFAULT 'VAT',
    active BOOLEAN NOT NULL DEFAULT true,
    created_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW()
);

CREATE INDEX idx_tax_rules_region ON pricing.tax_rules(region);

-- Price Book Versions (for audit/history)
CREATE TABLE pricing.price_book_versions (
    id UUID PRIMARY KEY,
    price_book_id UUID NOT NULL REFERENCES pricing.price_books(id),
    version_number INT NOT NULL,
    snapshot JSONB NOT NULL,
    published_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW(),
    published_by VARCHAR(100),
    UNIQUE(price_book_id, version_number)
);

CREATE INDEX idx_price_book_versions_pricebook ON pricing.price_book_versions(price_book_id);

-- Quote Audit Log (optional, for analytics)
CREATE TABLE pricing.quote_audit_log (
    id UUID PRIMARY KEY,
    quote_id VARCHAR(100) NOT NULL,
    product_template_id VARCHAR(100) NOT NULL,
    customer_id VARCHAR(100),
    base_price DECIMAL(12, 2) NOT NULL,
    total DECIMAL(12, 2) NOT NULL,
    currency VARCHAR(3) NOT NULL,
    promo_code VARCHAR(50),
    discount DECIMAL(12, 2),
    decision_trace JSONB,
    calculated_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW()
);

CREATE INDEX idx_quote_audit_product ON pricing.quote_audit_log(product_template_id);
CREATE INDEX idx_quote_audit_date ON pricing.quote_audit_log(calculated_at);
      ]]>
    </FlywayMigration>

    <!-- Seed Data -->
    <FlywayMigration file="pricing-service/src/main/resources/db/migration/V2__seed_pricing_data.sql">
      <![CDATA[
-- Development seed data

-- Default tax rule for Russia
INSERT INTO pricing.tax_rules (id, region, region_name, tax_rate_percent, tax_type)
VALUES ('a0000000-0000-0000-0000-000000000001', 'RU', 'Russia', 20.00, 'VAT');

-- Sample price book for windows (requires matching product template in catalog)
-- INSERT INTO pricing.price_books (id, product_template_id, currency, price_per_m2, minimum_area_m2, minimum_charge, status)
-- VALUES ('b0000000-0000-0000-0000-000000000001', 'WINDOW-PVC-STANDARD', 'RUB', 15000.00, 0.25, 5000.00, 'ACTIVE');

-- Sample campaign
-- INSERT INTO pricing.campaigns (id, name, description, discount_type, discount_value, start_date, end_date, status, priority)
-- VALUES ('c0000000-0000-0000-0000-000000000001', 'New Year Sale 2026', '10% off all windows', 'PERCENTAGE', 10, '2026-01-01', '2026-01-31', 'SCHEDULED', 10);

-- Sample promo code
-- INSERT INTO pricing.promo_codes (id, code, description, discount_type, discount_value, usage_limit, start_date, end_date)
-- VALUES ('d0000000-0000-0000-0000-000000000001', 'WELCOME10', 'First order 10% off', 'PERCENTAGE', 10, 1000, '2025-01-01', '2025-12-31');
      ]]>
    </FlywayMigration>

  </ImplementationSpecifications>

  <!-- ═══════════════════════════════════════════════════════════════════════════
       6. ACCEPTANCE CRITERIA
       ═══════════════════════════════════════════════════════════════════════════ -->
  <AcceptanceCriteria ref="DevelopmentExecutionPlan.xml#W1-T3,W1-T4">
    <!-- W1-T3: Skeleton -->
    <Criterion id="AC-PRC-001">Package structure follows hexagonal architecture</Criterion>
    <Criterion id="AC-PRC-002">Domain model has no Spring/JPA annotations</Criterion>
    <Criterion id="AC-PRC-003">Application ports define clear interfaces</Criterion>
    <Criterion id="AC-PRC-004">ArchUnit tests pass for layer dependencies</Criterion>
    <Criterion id="AC-PRC-005">Flyway migrations create schema successfully</Criterion>
    <Criterion id="AC-PRC-006">Service starts on ports 8082 (HTTP) and 9082 (gRPC)</Criterion>
    <Criterion id="AC-PRC-007">Connects to PostgreSQL and Redis</Criterion>

    <!-- W1-T4: Domain Logic -->
    <Criterion id="AC-PRC-008">Base price calculated from area and price_per_m2</Criterion>
    <Criterion id="AC-PRC-009">Option premiums (ABSOLUTE and PERCENTAGE) applied correctly</Criterion>
    <Criterion id="AC-PRC-010">Active campaign discounts applied</Criterion>
    <Criterion id="AC-PRC-011">Promo code validation works</Criterion>
    <Criterion id="AC-PRC-012">Discount cap (30%) enforced</Criterion>
    <Criterion id="AC-PRC-013">Tax calculated correctly for Russia (20% VAT)</Criterion>
    <Criterion id="AC-PRC-014">Quotes cached with 5-minute TTL</Criterion>
    <Criterion id="AC-PRC-015">Decision trace included in quote response</Criterion>
    <Criterion id="AC-PRC-016">Logs contain block anchor IDs</Criterion>
    <Criterion id="AC-PRC-017">gRPC CalculateQuote matches api-contracts proto</Criterion>
    <Criterion id="AC-PRC-018">Health endpoint returns UP</Criterion>
    <Criterion id="AC-PRC-019">Unit tests achieve >80% coverage for domain layer</Criterion>
    <Criterion id="AC-PRC-020">All TC-PRC-* test cases pass</Criterion>
  </AcceptanceCriteria>

  <!-- ═══════════════════════════════════════════════════════════════════════════
       7. CONSISTENCY CHECKLIST
       ═══════════════════════════════════════════════════════════════════════════ -->
  <ConsistencyChecklist>
    <Check status="PASS">All IDs follow naming conventions (UC-/MC-/FC-/BA-/TC-)</Check>
    <Check status="PASS">All Link refs target existing IDs in canonical artifacts</Check>
    <Check status="PASS">Package layout matches DevelopmentPlan.xml#DP-SVC-pricing-service</Check>
    <Check status="PASS">Ports match blueprint (HTTP:8082, gRPC:9082)</Check>
    <Check status="PASS">gRPC service matches api-contracts/pricing_service.proto</Check>
    <Check status="PASS">Domain events match api-contracts/pricing_events.proto</Check>
    <Check status="PASS">Aggregates match blueprint (PriceBook, Campaign, TaxRule, Quote)</Check>
    <Check status="PASS">Decisions align with Technology.xml (DEC-ARCH-*)</Check>
    <Check status="PASS">Quote caching uses Redis per Technology.xml#TECH-redis</Check>
  </ConsistencyChecklist>

  <!-- ═══════════════════════════════════════════════════════════════════════════
       8. SCOPE
       ═══════════════════════════════════════════════════════════════════════════ -->
  <Scope>
    <Services>
      <ServiceRef ref="DevelopmentPlan.xml#DP-SVC-pricing-service"/>
    </Services>
    <UseCases>
      <UseCaseRef ref="RequirementsAnalysis.xml#UC-PRICING-QUOTE"/>
      <UseCaseRef ref="RequirementsAnalysis.xml#UC-PRICING-ADMIN-MANAGE"/>
    </UseCases>
    <Tasks>
      <TaskRef ref="DevelopmentExecutionPlan.xml#W1-T3"/>
      <TaskRef ref="DevelopmentExecutionPlan.xml#W1-T4"/>
    </Tasks>
  </Scope>

  <Artifacts>
    <Artifact ref="RequirementsAnalysis.xml" version="1.0.0"/>
    <Artifact ref="Technology.xml" version="1.2.0"/>
    <Artifact ref="DevelopmentPlan.xml" version="1.3.0"/>
  </Artifacts>

  <Contracts>
    <ModuleContractRef id="MC-pricing-service-domain-PriceCalculation"/>
    <FunctionContractRef id="FC-pricing-service-UC-PRICING-QUOTE-calculateQuote"/>
    <FunctionContractRef id="FC-pricing-service-UC-PRICING-QUOTE-validatePromoCode"/>
    <FunctionContractRef id="FC-pricing-service-UC-PRICING-ADMIN-MANAGE-createPriceBook"/>
    <FunctionContractRef id="FC-pricing-service-UC-PRICING-ADMIN-MANAGE-publishPriceBook"/>
    <BlockAnchorRef id="BA-PRC-CALC-01"/>
    <BlockAnchorRef id="BA-PRC-CALC-02"/>
    <BlockAnchorRef id="BA-PRC-CALC-03"/>
    <BlockAnchorRef id="BA-PRC-CALC-04"/>
    <BlockAnchorRef id="BA-PRC-CALC-05"/>
    <BlockAnchorRef id="BA-PRC-CALC-06"/>
    <BlockAnchorRef id="BA-PRC-CALC-07"/>
    <BlockAnchorRef id="BA-PRC-CALC-08"/>
    <BlockAnchorRef id="BA-PRC-CALC-99"/>
    <BlockAnchorRef id="BA-PROMO-VAL-01"/>
    <BlockAnchorRef id="BA-PROMO-VAL-02"/>
    <BlockAnchorRef id="BA-PROMO-VAL-03"/>
    <BlockAnchorRef id="BA-PROMO-VAL-04"/>
    <BlockAnchorRef id="BA-PB-CREATE-01"/>
    <BlockAnchorRef id="BA-PB-CREATE-02"/>
    <BlockAnchorRef id="BA-PB-CREATE-03"/>
    <BlockAnchorRef id="BA-PB-CREATE-04"/>
    <BlockAnchorRef id="BA-PB-PUBLISH-01"/>
    <BlockAnchorRef id="BA-PB-PUBLISH-02"/>
    <BlockAnchorRef id="BA-PB-PUBLISH-03"/>
    <BlockAnchorRef id="BA-PB-PUBLISH-04"/>
    <BlockAnchorRef id="BA-PB-PUBLISH-05"/>
    <BlockAnchorRef id="BA-PB-PUBLISH-06"/>
  </Contracts>

  <!-- Approval recorded in docs/grace/approvals.log per approvals.log-only policy -->

</GRACE_HANDOFF>
