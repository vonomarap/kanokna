<?xml version="1.0" encoding="UTF-8"?>
<!--
  GRACE Architect Work Order
  Generated by: GRACE-COORDINATOR
  Created: 2026-01-31T18:22:09+03:00
-->
<ARCHITECT_WORK_ORDER id="AWO-20260131-01" status="PROPOSED">
  <Task>
    <WaveRef>W2</WaveRef>
    <TaskRef>W2-T2</TaskRef>
    <UserRequest>Create order-service skeleton as the next priority deliverable</UserRequest>
    <PrimaryGoal>
      Generate complete hexagonal architecture skeleton for order-service including:
      - Order aggregate with state machine (DRAFT → PENDING_PAYMENT → PAID → PROCESSING → SHIPPED → DELIVERED → COMPLETED)
      - Payment aggregate for tracking payment attempts and captures
      - Outbox table pattern for reliable event publishing
      - Integration touchpoints for cart-service (gRPC), YooKassa payment gateway, and Kafka
    </PrimaryGoal>
  </Task>

  <KnownArtifacts>
    <Artifact name="RequirementsAnalysis.xml" provided="yes"/>
    <Artifact name="Technology.xml" provided="yes"/>
    <Artifact name="DevelopmentPlan.xml" provided="yes"/>
    <Artifact name="DevelopmentExecutionPlan.xml" provided="yes">Task W2-T2 defined with deliverables</Artifact>
  </KnownArtifacts>

  <Scope>
    <Services>
      <ServiceRef ref="DP-SVC-order-service"/>
    </Services>
    <UseCases>
      <UseCaseRef ref="UC-ORDER-PLACE-01">Place Order from Cart Snapshot</UseCaseRef>
      <UseCaseRef ref="UC-ORDER-TRACK-01">Track Order Status</UseCaseRef>
      <UseCaseRef ref="UC-PAYMENT-INITIATE-01">Initiate Payment Session</UseCaseRef>
      <UseCaseRef ref="UC-PAYMENT-CALLBACK-01">Handle Payment Gateway Callback</UseCaseRef>
    </UseCases>
    <Flows>
      <FlowRef ref="Flow-B2C-Checkout">Checkout → Payment → Order Creation</FlowRef>
      <FlowRef ref="Flow-Order-Lifecycle">Order state transitions</FlowRef>
    </Flows>
  </Scope>

  <RequiredOutputs>
    <Artifacts>
      <RequirementsAnalysisUpdates>
        <Item>Verify UC-ORDER-*, UC-PAYMENT-* use cases exist; create if missing</Item>
      </RequirementsAnalysisUpdates>
      <TechnologyUpdates>
        <Item>Confirm DEC-ORDER-STATE-MACHINE decision (Spring State Machine vs custom)</Item>
        <Item>Confirm DEC-OUTBOX-RELAY decision (polling vs Debezium CDC)</Item>
      </TechnologyUpdates>
      <DevelopmentPlanUpdates>
        <Item>Ensure DP-SVC-order-service entry is complete with package structure</Item>
        <Item>Add Flow-Order-Lifecycle with state transition diagram</Item>
      </DevelopmentPlanUpdates>
    </Artifacts>

    <Decisions>
      <Item>Record DEC-ORDER-STATE-MACHINE: Spring State Machine vs domain-embedded state machine</Item>
      <Item>Record DEC-OUTBOX-RELAY: Polling-based outbox relay vs Debezium CDC</Item>
      <Item>Record DEC-ORDER-IDEMPOTENCY: Idempotency key strategy for order placement</Item>
      <Item>Provide DecisionsSnapshot in handoff; all DEC-* must match Technology.xml</Item>
    </Decisions>

    <Contracts>
      <ModuleContracts>
        <Item id="MC-order-service-domain-Order">Order aggregate with state machine, domain events</Item>
        <Item id="MC-order-service-domain-Payment">Payment aggregate for tracking gateway interactions</Item>
        <Item id="MC-order-service-application-OrderPlacement">Order placement use case orchestration</Item>
        <Item id="MC-order-service-adapters-persistence-Outbox">Outbox table and relay mechanism</Item>
      </ModuleContracts>
      <FunctionContracts>
        <Item id="FC-order-service-UC-ORDER-PLACE-01-placeOrder">Place order from cart snapshot</Item>
        <Item id="FC-order-service-UC-PAYMENT-INITIATE-01-initiatePayment">Create payment session</Item>
        <Item id="FC-order-service-UC-PAYMENT-CALLBACK-01-handleCallback">Process payment gateway callback</Item>
        <Item id="FC-order-service-Order-transition">State machine transition validation</Item>
      </FunctionContracts>
      <BlockAnchors>
        <Item>BA-ORD-PLACE-01 through BA-ORD-PLACE-10 (order placement flow)</Item>
        <Item>BA-ORD-STATE-01 through BA-ORD-STATE-10 (state transitions)</Item>
        <Item>BA-PAY-INIT-01 through BA-PAY-INIT-05 (payment initiation)</Item>
        <Item>BA-PAY-CB-01 through BA-PAY-CB-05 (payment callback handling)</Item>
        <Item>BA-OUTBOX-01 through BA-OUTBOX-05 (outbox publishing)</Item>
      </BlockAnchors>
      <TestCases>
        <Item>At least 3-4 TC-* per critical FC (order placement, state transitions, payment callback)</Item>
      </TestCases>
    </Contracts>

    <SkeletonDeliverables>
      <Item>Package structure per DevelopmentPlan.xml hexagonal layout</Item>
      <Item>Order aggregate (OrderId, OrderNumber, customerId, items, totals, status, timestamps)</Item>
      <Item>OrderItem value object (configuration snapshot, pricing snapshot)</Item>
      <Item>OrderStatus enum with allowed transitions</Item>
      <Item>Payment aggregate (paymentId, orderId, amount, provider, status, externalId)</Item>
      <Item>PaymentStatus enum (PENDING, AUTHORIZED, CAPTURED, FAILED, REFUNDED)</Item>
      <Item>Application ports: OrderRepository, PaymentRepository, PaymentGatewayPort, CartServicePort</Item>
      <Item>Outbox entity and OutboxRepository</Item>
      <Item>Flyway migrations: V1__order_schema.sql, V2__outbox_table.sql</Item>
      <Item>REST controller stubs for order API</Item>
      <Item>gRPC service stub (from api-contracts)</Item>
      <Item>application.yml with profiles (dev, stage, prod)</Item>
      <Item>Dockerfile for containerization</Item>
      <Item>ArchUnit test for hexagonal layer enforcement</Item>
    </SkeletonDeliverables>

    <Handoff>
      <GRACE_HANDOFF required="true"/>
      <GIT_IMPACT required="true">Architect must include GIT_IMPACT block</GIT_IMPACT>
    </Handoff>
  </RequiredOutputs>

  <AcceptanceCriteria>
    <Item>Canonical artifacts contain no "OR" choices; alternatives captured as Decisions</Item>
    <Item>DEC-* are consistent and linkable across Technology.xml and handoff DecisionsSnapshot</Item>
    <Item>Traceability: UC → Flow → FC/MC → BA → TC is complete for order-service scope</Item>
    <Item>No cross-service joins; order-service owns its database exclusively</Item>
    <Item>Order state machine clearly defines all valid transitions and guards</Item>
    <Item>Outbox pattern documented with clear relay mechanism decision</Item>
    <Item>Payment gateway port abstracted for YooKassa (implementation in W2-T4)</Item>
    <Item>If any Decision is PENDING_HUMAN, it is explicitly flagged</Item>
  </AcceptanceCriteria>

  <ContextFromExistingServices>
    <Note>cart-service exists and provides CartSnapshot for checkout</Note>
    <Note>api-contracts module should have order.proto and order_events.proto</Note>
    <Note>pricing-service integration pattern can be referenced from catalog-configuration-service</Note>
    <Note>Observe existing hexagonal patterns in cart-service and pricing-service</Note>
  </ContextFromExistingServices>
</ARCHITECT_WORK_ORDER>
