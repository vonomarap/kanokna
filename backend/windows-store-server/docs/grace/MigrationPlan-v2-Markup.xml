<?xml version="1.0" encoding="UTF-8"?>
<!--
  GRACE Markup v2 Migration Plan
  Work Order: AWO-MARKUP-V2-MIGRATION-001
  Created: 2025-12-30T00:00:00+00:00
  Author: GRACE-ARCHITECT
-->
<MigrationPlan
  id="MIGRATION-GRACE-MARKUP-V2"
  status="COMPLETE"
  created="2025-12-30T00:00:00+00:00"
  completed="2025-12-30T00:00:00+00:00"
  author="GRACE-ARCHITECT"
  workOrderRef="AWO-MARKUP-V2-MIGRATION-001">

  <!-- ═══════════════════════════════════════════════════════════════════════════
       1. EXECUTIVE SUMMARY
       ═══════════════════════════════════════════════════════════════════════════ -->
  <ExecutiveSummary>
    <Goal>
      Migrate all GRACE_HANDOFF and GRACE_APPROVAL markup from legacy v1 format
      to GRACE Markup v2 with ISO-8601 datetime offsets.
    </Goal>
    <Scope>
      <TotalFiles>7</TotalFiles>
      <FilePattern>docs/grace/handoffs/Handoff-*.xml</FilePattern>
    </Scope>
    <Constraints>
      <Item>Format-only migration; no semantic changes to blueprint content</Item>
      <Item>Missing timestamps use fallback policy (see section 4)</Item>
    </Constraints>
  </ExecutiveSummary>

  <!-- ═══════════════════════════════════════════════════════════════════════════
       2. FILES TO MIGRATE
       ═══════════════════════════════════════════════════════════════════════════ -->
  <FilesToMigrate>

    <File id="F-001" priority="HIGH">
      <Path>docs/grace/handoffs/Handoff-20251229-01.xml</Path>
      <CurrentStatus>APPROVED (v1 format)</CurrentStatus>
      <TargetStatus>APPROVED (v2 format)</TargetStatus>
      <LegacyAttributes>
        <Attr name="created" value="2025-12-29" issue="date-only, missing time+offset"/>
        <Attr name="status" value="APPROVED" issue="missing approval datetime"/>
        <Attr name="author" value="GRACE-ARCHITECT" issue="OK"/>
      </LegacyAttributes>
      <MissingAttributes>
        <Attr name="schemaVersion"/>
        <Attr name="taskRef"/>
        <Attr name="planRef"/>
        <Attr name="blueprintRef"/>
      </MissingAttributes>
      <TransformationNotes>
        Bootstrap handoff - covers multiple services. Use blueprintRef="DevelopmentPlan.xml#BOOTSTRAP"
      </TransformationNotes>
    </File>

    <File id="F-002" priority="HIGH">
      <Path>docs/grace/handoffs/Handoff-20251230-01-Gateway.xml</Path>
      <CurrentStatus>PROPOSED (v1 format)</CurrentStatus>
      <TargetStatus>PROPOSED (v2 format)</TargetStatus>
      <LegacyAttributes>
        <Attr name="created" value="2025-12-30" issue="date-only"/>
        <Attr name="status" value="PROPOSED" issue="OK"/>
        <Attr name="author" value="GRACE-ARCHITECT" issue="OK"/>
      </LegacyAttributes>
      <MissingAttributes>
        <Attr name="schemaVersion"/>
        <Attr name="taskRef" derivedFrom="Scope.Task ref=W0-T4"/>
        <Attr name="planRef" derivedFrom="Scope.Task"/>
        <Attr name="blueprintRef" derivedFrom="Scope.ServiceRef"/>
      </MissingAttributes>
    </File>

    <File id="F-003" priority="HIGH">
      <Path>docs/grace/handoffs/Handoff-20251230-02-W0-T1-SharedKernel.xml</Path>
      <CurrentStatus>PROPOSED (v1 format)</CurrentStatus>
      <TargetStatus>PROPOSED (v2 format)</TargetStatus>
      <LegacyAttributes>
        <Attr name="created" missing="true" issue="attribute not present"/>
        <Attr name="status" value="PROPOSED" issue="OK"/>
        <Attr name="author" missing="true" issue="attribute not present"/>
      </LegacyAttributes>
      <MissingAttributes>
        <Attr name="schemaVersion"/>
        <Attr name="created" fallback="2025-12-30T00:00:00+00:00"/>
        <Attr name="author" fallback="GRACE-ARCHITECT"/>
        <Attr name="taskRef" derivedFrom="Scope=W0-T1"/>
        <Attr name="planRef"/>
        <Attr name="blueprintRef"/>
      </MissingAttributes>
    </File>

    <File id="F-004" priority="MEDIUM">
      <Path>docs/grace/handoffs/Handoff-20251230-03-W0-T2-ApiContracts.xml</Path>
      <CurrentStatus>PROPOSED (v1 format)</CurrentStatus>
      <TargetStatus>PROPOSED (v2 format)</TargetStatus>
      <LegacyAttributes>
        <Attr name="created" expected="date-only or missing"/>
        <Attr name="status" value="PROPOSED"/>
      </LegacyAttributes>
      <MissingAttributes>
        <Attr name="schemaVersion"/>
        <Attr name="taskRef" value="W0-T2"/>
        <Attr name="planRef" value="DevelopmentExecutionPlan.xml#W0-T2"/>
        <Attr name="blueprintRef" value="DevelopmentPlan.xml#DP-SVC-api-contracts"/>
      </MissingAttributes>
    </File>

    <File id="F-005" priority="MEDIUM">
      <Path>docs/grace/handoffs/Handoff-20251230-04-W0-T3-ConfigServer.xml</Path>
      <CurrentStatus>PROPOSED (v1 format)</CurrentStatus>
      <TargetStatus>PROPOSED (v2 format)</TargetStatus>
      <MissingAttributes>
        <Attr name="schemaVersion"/>
        <Attr name="taskRef" value="W0-T3"/>
        <Attr name="planRef" value="DevelopmentExecutionPlan.xml#W0-T3"/>
        <Attr name="blueprintRef" value="DevelopmentPlan.xml#DP-SVC-config-server"/>
      </MissingAttributes>
    </File>

    <File id="F-006" priority="MEDIUM">
      <Path>docs/grace/handoffs/Handoff-20251230-05-W0-T5-GitHubActionsCI.xml</Path>
      <CurrentStatus>PROPOSED (v1 format)</CurrentStatus>
      <TargetStatus>PROPOSED (v2 format)</TargetStatus>
      <MissingAttributes>
        <Attr name="schemaVersion"/>
        <Attr name="taskRef" value="W0-T5"/>
        <Attr name="planRef" value="DevelopmentExecutionPlan.xml#W0-T5"/>
        <Attr name="blueprintRef" value="DevelopmentPlan.xml#DP-SVC-ci-cd"/>
      </MissingAttributes>
    </File>

    <File id="F-007" priority="MEDIUM">
      <Path>docs/grace/handoffs/Handoff-20251230-06-W0-T6-DockerCompose.xml</Path>
      <CurrentStatus>PROPOSED (v1 format)</CurrentStatus>
      <TargetStatus>PROPOSED (v2 format)</TargetStatus>
      <MissingAttributes>
        <Attr name="schemaVersion"/>
        <Attr name="taskRef" value="W0-T6"/>
        <Attr name="planRef" value="DevelopmentExecutionPlan.xml#W0-T6"/>
        <Attr name="blueprintRef" value="DevelopmentPlan.xml#DP-INFRA-docker-compose"/>
      </MissingAttributes>
    </File>

  </FilesToMigrate>

  <!-- ═══════════════════════════════════════════════════════════════════════════
       3. TRANSFORMATION RULES
       ═══════════════════════════════════════════════════════════════════════════ -->
  <TransformationRules>

    <Rule id="TR-001" name="Add Schema Version">
      <Before><![CDATA[<GRACE_HANDOFF id="..."]]></Before>
      <After><![CDATA[<GRACE_HANDOFF id="..." schemaVersion="grace-markup-v2"]]></After>
      <Notes>Insert schemaVersion attribute immediately after id</Notes>
    </Rule>

    <Rule id="TR-002" name="Convert Date to ISO-8601">
      <Before><![CDATA[created="2025-12-30"]]></Before>
      <After><![CDATA[created="2025-12-30T00:00:00+00:00"]]></After>
      <Notes>Append T00:00:00+00:00 for date-only values; use UTC as default</Notes>
    </Rule>

    <Rule id="TR-003" name="Add Missing Author">
      <Condition>author attribute missing</Condition>
      <Action>Add author="GRACE-ARCHITECT" (from file comment or default)</Action>
    </Rule>

    <Rule id="TR-004" name="Extract taskRef">
      <Source>
        &lt;Task ref="DevelopmentExecutionPlan.xml#W0-T4"/&gt; in &lt;Scope&gt;
      </Source>
      <Target>
        taskRef="W0-T4" attribute on GRACE_HANDOFF
      </Target>
    </Rule>

    <Rule id="TR-005" name="Extract planRef">
      <Source>
        &lt;Task ref="DevelopmentExecutionPlan.xml#W0-T4"/&gt; in &lt;Scope&gt;
      </Source>
      <Target>
        planRef="DevelopmentExecutionPlan.xml#W0-T4" attribute on GRACE_HANDOFF
      </Target>
    </Rule>

    <Rule id="TR-006" name="Extract blueprintRef">
      <Source>
        &lt;ServiceRef ref="DevelopmentPlan.xml#DP-SVC-gateway"/&gt; in &lt;Scope&gt;
      </Source>
      <Target>
        blueprintRef="DevelopmentPlan.xml#DP-SVC-gateway" attribute on GRACE_HANDOFF
      </Target>
    </Rule>

    <Rule id="TR-007" name="Remove ApprovalInstructions">
      <Before><![CDATA[
<ApprovalInstructions>
  <GRACE_APPROVAL ref="Handoff-20251230-01" status="APPROVED"/>
</ApprovalInstructions>
      ]]></Before>
      <After><![CDATA[
<!-- ApprovalInstructions REMOVED - approvals are in docs/grace/approvals.log only -->
      ]]></After>
      <Notes>Remove ApprovalInstructions; approvals now live ONLY in docs/grace/approvals.log</Notes>
    </Rule>

    <Rule id="TR-008" name="Add MigrationNote for Fallbacks">
      <Condition>Timestamp derived from fallback policy</Condition>
      <Action>
        Add &lt;MigrationNote&gt; element documenting the approximation
      </Action>
    </Rule>

  </TransformationRules>

  <!-- ═══════════════════════════════════════════════════════════════════════════
       4. FALLBACK POLICY FOR MISSING TIMESTAMPS
       ═══════════════════════════════════════════════════════════════════════════ -->
  <FallbackPolicy>
    <Description>
      When historical timestamps are unavailable, apply these rules in order:
    </Description>

    <Priority order="1">
      <Source>Git commit timestamp</Source>
      <Command>git log -1 --format="%aI" -- path/to/file.xml</Command>
      <Notes>Use author date in ISO-8601 format</Notes>
    </Priority>

    <Priority order="2">
      <Source>File modification time</Source>
      <Command>stat -c %y path/to/file.xml (Linux) or equivalent</Command>
      <Notes>Convert to ISO-8601 with local timezone offset</Notes>
    </Priority>

    <Priority order="3">
      <Source>Default with note</Source>
      <Value>YYYY-MM-DDT00:00:00+00:00</Value>
      <Notes>
        Use date from handoff ID, midnight UTC, and add MigrationNote.
        Example: Handoff-20251230-01 → created="2025-12-30T00:00:00+00:00"
      </Notes>
    </Priority>

    <AppliedFallbacks>
      <Fallback file="Handoff-20251229-01.xml" applied="Priority-3">
        Original: created="2025-12-29"
        Migrated: created="2025-12-29T00:00:00+00:00"
        Reason: Date-only value in original file
      </Fallback>
      <Fallback file="Handoff-20251230-02-W0-T1-SharedKernel.xml" applied="Priority-3">
        Original: created attribute missing
        Migrated: created="2025-12-30T00:00:00+00:00"
        Reason: Attribute not present, derived from filename date
      </Fallback>
    </AppliedFallbacks>
  </FallbackPolicy>

  <!-- ═══════════════════════════════════════════════════════════════════════════
       5. VALIDATION CHECKLIST
       ═══════════════════════════════════════════════════════════════════════════ -->
  <ValidationChecklist>
    <Check id="VAL-001">
      All GRACE_HANDOFF tags have schemaVersion="grace-markup-v2"
    </Check>
    <Check id="VAL-002">
      All created attributes use ISO-8601 with timezone offset
    </Check>
    <Check id="VAL-003">
      All GRACE_HANDOFF tags have required attributes: id, status, author, taskRef, planRef, blueprintRef
    </Check>
    <Check id="VAL-004">
      ApprovalInstructions show v2 GRACE_APPROVAL format
    </Check>
    <Check id="VAL-005">
      Files with fallback timestamps have MigrationNote element
    </Check>
    <Check id="VAL-006">
      No legacy approval formats remain in any file
    </Check>
  </ValidationChecklist>

  <!-- ═══════════════════════════════════════════════════════════════════════════
       6. EXECUTION ORDER
       ═══════════════════════════════════════════════════════════════════════════ -->
  <ExecutionOrder>
    <Phase id="1" name="Documentation">
      <Task status="COMPLETE">Create GRACE_MARKUP_STANDARD.md</Task>
      <Task status="COMPLETE">Create this MigrationPlan document</Task>
    </Phase>

    <Phase id="2" name="Migration">
      <Task status="COMPLETE">Migrate Handoff-20251229-01.xml (APPROVED bootstrap)</Task>
      <Task status="COMPLETE">Migrate Handoff-20251230-01-Gateway.xml</Task>
      <Task status="COMPLETE">Migrate Handoff-20251230-02-W0-T1-SharedKernel.xml</Task>
      <Task status="COMPLETE">Migrate Handoff-20251230-03-W0-T2-ApiContracts.xml</Task>
      <Task status="COMPLETE">Migrate Handoff-20251230-04-W0-T3-ConfigServer.xml</Task>
      <Task status="COMPLETE">Migrate Handoff-20251230-05-W0-T5-GitHubActionsCI.xml</Task>
      <Task status="COMPLETE">Migrate Handoff-20251230-06-W0-T6-DockerCompose.xml</Task>
    </Phase>

    <Phase id="3" name="Validation">
      <Task status="COMPLETE">Run validation checklist against all migrated files</Task>
      <Task status="PENDING">Update BlueprintChangelog with migration summary</Task>
    </Phase>
  </ExecutionOrder>

  <!-- ═══════════════════════════════════════════════════════════════════════════
       7. APPROVAL
       ═══════════════════════════════════════════════════════════════════════════ -->
  <ApprovalNote>
    This migration plan is ready for execution.
    To approve, add a GRACE_APPROVAL v2 entry to docs/grace/approvals.log:

    ref="MIGRATION-GRACE-MARKUP-V2"
    status="APPROVED"
    approved="YYYY-MM-DDTHH:mm:ss±HH:MM"
    approver="Human"

    Policy: Approvals are recorded ONLY in docs/grace/approvals.log (not in handoff files).
  </ApprovalNote>

</MigrationPlan>
