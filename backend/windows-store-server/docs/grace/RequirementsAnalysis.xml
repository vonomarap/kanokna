<?xml version="1.0" encoding="UTF-8"?>
<!--
  GRACE Canonical Artifact: RequirementsAnalysis.xml
  Purpose: Formalize business intent, actors, use cases, and non-functional requirements
  Version: 1.4.0
  Last Updated: 2026-01-09T16:00:00+03:00
  Changes:
    - v1.4.0: Added UC-CART-MANAGE and UC-CART-APPLY-PROMO for cart-service
              (from Handoff-20260109-01-W1-T6-CartService)
    - v1.1.0: Added B2C CPQ, B2B, Staff, Field actors and use cases per new-business-requirements.txt
              Added status model with audit trail requirements
              Added domain glossary
              Added integration requirements (CRM, CAD, ERP, Logistics, Payments)
              Added MUST/SHOULD/LATER prioritization
-->
<RequirementsAnalysis version="1.4.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">

  <!-- ===============================================================================
       DOMAIN DEFINITION
       =============================================================================== -->
  <Domain id="windows-doors-ecommerce">
    <Name>Windows and Doors E-Commerce Platform</Name>
    <Description>
      A unified B2C and B2B e-commerce web application for selling configurable windows and doors.
      Customers can browse products, configure dimensions/materials/glazing/accessories,
      receive real-time pricing (CPQ), save drafts, request on-site measurements, place orders,
      accept contracts, pay prepayments, and track the full lifecycle from lead to installation.
      The system supports B2B dealers with partner pricing, project orders, and finance workflows.
      Internal staff manage leads/pipelines/CRM, while field staff execute measurements and
      installations.
    </Description>
    <BusinessGoals>
      <Goal id="BG-SALES">Enable online sales of configurable window and door products</Goal>
      <Goal id="BG-SELF-SERVICE">Provide self-service CPQ: configure + instant pricing + save draft</Goal>
      <Goal id="BG-B2B">Support B2B dealers with partner pricing, project orders, and document
        workflows</Goal>
      <Goal id="BG-OMNICHANNEL">Capture leads from website, telephony, messengers, and offline
        sources</Goal>
      <Goal id="BG-MEASUREMENT">Enable measurement request scheduling with CRM task creation</Goal>
      <Goal id="BG-LIFECYCLE">Full status tracking from lead through installation with notifications</Goal>
      <Goal id="BG-ANALYTICS">Provide insights into sales, conversion, and operational performance</Goal>
    </BusinessGoals>
    <Links>
      <Link ref="Technology.xml#TECH-spring-boot" />
      <Link ref="DevelopmentPlan.xml#DP-SVC-catalog-configuration-service" />
    </Links>
  </Domain>

  <!-- ===============================================================================
       ACTORS
       =============================================================================== -->
  <Actors>
    <!-- Primary Actors - B2C -->
    <Actor id="ACT-B2C-CUSTOMER" type="primary">
      <Name>B2C Customer</Name>
      <Description>
        Retail end-user who browses products, configures windows/doors, saves drafts,
        requests measurements, places orders with contract acceptance and prepayment,
        and tracks full lifecycle through installation and after-sales.
      </Description>
      <Goals>
        <Goal id="ACT-B2C-G1">Browse and search for window/door products</Goal>
        <Goal id="ACT-B2C-G2">Configure products with custom dimensions, materials, and options</Goal>
        <Goal id="ACT-B2C-G3">Receive instant pricing with promotions/discounts displayed</Goal>
        <Goal id="ACT-B2C-G4">Save configuration drafts and resume from account</Goal>
        <Goal id="ACT-B2C-G5">Request on-site measurement visit with date/time slot</Goal>
        <Goal id="ACT-B2C-G6">Accept contract and pay prepayment/full amount</Goal>
        <Goal id="ACT-B2C-G7">Track order status through production/delivery/installation</Goal>
        <Goal id="ACT-B2C-G8">Receive notifications for status changes</Goal>
        <Goal id="ACT-B2C-G9">Submit service/warranty requests post-installation</Goal>
      </Goals>
      <Links>
        <Link ref="DevelopmentPlan.xml#DP-SVC-account-service" />
      </Links>
    </Actor>

    <!-- Primary Actors - B2B -->
    <Actor id="ACT-B2B-DEALER" type="primary">
      <Name>B2B Dealer / Partner</Name>
      <Description>
        Wholesale partner who configures products with dealer-specific rules/pricing,
        generates quotes, manages project orders by job site, uploads BOMs/drawings,
        and handles invoices/settlements.
      </Description>
      <Goals>
        <Goal id="ACT-B2B-G1">Configure products with dealer-specific rules and options</Goal>
        <Goal id="ACT-B2B-G2">Generate quotes with partner-tier pricing</Goal>
        <Goal id="ACT-B2B-G3">Create project orders grouped by job site/object</Goal>
        <Goal id="ACT-B2B-G4">Upload BOM/drawings and run CAD feasibility checks</Goal>
        <Goal id="ACT-B2B-G5">Access documents (drawings, specs, contracts)</Goal>
        <Goal id="ACT-B2B-G6">View invoices, payment schedules, balances, and settlements</Goal>
      </Goals>
      <Links>
        <Link ref="DevelopmentPlan.xml#DP-SVC-account-service" />
        <Link ref="DevelopmentPlan.xml#DP-SVC-billing-service" />
      </Links>
    </Actor>

    <!-- Primary Actors - Internal Staff -->
    <Actor id="ACT-SALES-MANAGER" type="primary">
      <Name>Sales/Project Manager (Internal Staff)</Name>
      <Description>
        Internal company staff who manages leads/deals/pipeline, schedules measurements
        and installations, generates quotes/invoices/contracts, and monitors progress.
      </Description>
      <Goals>
        <Goal id="ACT-SM-G1">Ingest omnichannel leads (website, telephony, messengers, offline)</Goal>
        <Goal id="ACT-SM-G2">Manage pipeline stages and deal progression</Goal>
        <Goal id="ACT-SM-G3">Generate quotes, invoices, and contracts from templates</Goal>
        <Goal id="ACT-SM-G4">Schedule measurement visits and installation appointments</Goal>
        <Goal id="ACT-SM-G5">Receive completion updates from field operations</Goal>
        <Goal id="ACT-SM-G6">Track tasks, reminders, and calendar</Goal>
      </Goals>
      <Links>
        <Link ref="DevelopmentPlan.xml#DP-SVC-workflow-service" />
      </Links>
    </Actor>

    <!-- Primary Actors - Field Staff -->
    <Actor id="ACT-MEASUREMENT-TECHNICIAN" type="primary">
      <Name>Measurement Technician (Field Staff)</Name>
      <Description>
        Field staff who receives measurement tasks, performs on-site measurements,
        captures dimensions/photos/notes, and updates configurations.
      </Description>
      <Goals>
        <Goal id="ACT-MT-G1">View assigned measurement tasks</Goal>
        <Goal id="ACT-MT-G2">Accept, reschedule, or decline tasks</Goal>
        <Goal id="ACT-MT-G3">Submit measured dimensions, photos, and notes</Goal>
        <Goal id="ACT-MT-G4">Adjust configuration on-site if needed</Goal>
      </Goals>
      <Links>
        <Link ref="DevelopmentPlan.xml#DP-SVC-field-ops-service" />
      </Links>
    </Actor>

    <Actor id="ACT-INSTALLER" type="primary">
      <Name>Installer Crew (Field Staff)</Name>
      <Description>
        Field staff who views assigned installation jobs, executes installation
        with checklist, captures completion evidence, and marks job complete.
      </Description>
      <Goals>
        <Goal id="ACT-INS-G1">View assigned installation jobs</Goal>
        <Goal id="ACT-INS-G2">Execute installation with checklist</Goal>
        <Goal id="ACT-INS-G3">Capture acceptance certificate and photos</Goal>
        <Goal id="ACT-INS-G4">Mark installation as completed</Goal>
      </Goals>
      <Links>
        <Link ref="DevelopmentPlan.xml#DP-SVC-field-ops-service" />
      </Links>
    </Actor>

    <Actor id="ACT-LOGISTICS-COORDINATOR" type="primary">
      <Name>Logistics Coordinator</Name>
      <Description>
        Staff responsible for delivery planning, routing, and status updates.
      </Description>
      <Goals>
        <Goal id="ACT-LOG-G1">Plan delivery routes and schedule</Goal>
        <Goal id="ACT-LOG-G2">Update "in transit" and "delivered" statuses</Goal>
        <Goal id="ACT-LOG-G3">Record delivery exceptions and reschedules</Goal>
      </Goals>
      <Links>
        <Link ref="DevelopmentPlan.xml#DP-SVC-field-ops-service" />
      </Links>
    </Actor>

    <Actor id="ACT-WAREHOUSE-STAFF" type="primary">
      <Name>Warehouse Staff</Name>
      <Description>
        Staff who marks picking/kitting completion and readiness-to-ship.
      </Description>
      <Goals>
        <Goal id="ACT-WH-G1">Mark picking/kitting complete</Goal>
        <Goal id="ACT-WH-G2">Mark order ready for shipment</Goal>
      </Goals>
      <Links>
        <Link ref="DevelopmentPlan.xml#DP-SVC-field-ops-service" />
      </Links>
    </Actor>

    <Actor id="ACT-ADMIN" type="primary">
      <Name>System Administrator</Name>
      <Description>
        Back-office user who manages products, pricing rules, campaigns, users,
        roles/permissions, and monitors system health.
      </Description>
      <Goals>
        <Goal id="ACT-ADMIN-G1">Manage product catalog (CRUD products, options, rules)</Goal>
        <Goal id="ACT-ADMIN-G2">Configure pricing rules, discounts, and campaigns</Goal>
        <Goal id="ACT-ADMIN-G3">Manage user accounts, roles, and permissions</Goal>
        <Goal id="ACT-ADMIN-G4">View sales reports and analytics dashboards</Goal>
        <Goal id="ACT-ADMIN-G5">Monitor system health and audit logs</Goal>
      </Goals>
      <Links>
        <Link ref="DevelopmentPlan.xml#DP-SVC-reporting-service" />
      </Links>
    </Actor>

    <!-- External System Actors -->
    <Actor id="ACT-CRM-ERP" type="external-system">
      <Name>External CRM/ERP System</Name>
      <Description>
        External CRM/ERP for lead/deal/pipeline management, tasks, and order sync.
        May be source of truth for certain fields (defined in integration contract).
      </Description>
      <Goals>
        <Goal id="ACT-CRM-G1">Receive lead/deal creation events</Goal>
        <Goal id="ACT-CRM-G2">Sync pipeline stages and tasks</Goal>
        <Goal id="ACT-CRM-G3">Sync order status updates</Goal>
      </Goals>
      <Links>
        <Link ref="DevelopmentPlan.xml#INT-CRM-ERP" />
      </Links>
    </Actor>

    <Actor id="ACT-CAD-SYSTEM" type="external-system">
      <Name>External CAD/CPQ System</Name>
      <Description>
        CAD/design system for feasibility validation, drawing/spec generation,
        and visualization artifacts.
      </Description>
      <Goals>
        <Goal id="ACT-CAD-G1">Validate configuration feasibility/manufacturability</Goal>
        <Goal id="ACT-CAD-G2">Generate drawings and specifications</Goal>
        <Goal id="ACT-CAD-G3">Provide visualization artifacts (2D/3D)</Goal>
      </Goals>
      <Links>
        <Link ref="DevelopmentPlan.xml#INT-CAD" />
      </Links>
    </Actor>

    <Actor id="ACT-LOGISTICS-SYSTEM" type="external-system">
      <Name>External Logistics/Delivery System</Name>
      <Description>
        Logistics system for route planning, delivery tracking, and proof of delivery.
      </Description>
      <Goals>
        <Goal id="ACT-LOGISTICS-G1">Provide route planning and ETA</Goal>
        <Goal id="ACT-LOGISTICS-G2">Track delivery status in real-time</Goal>
        <Goal id="ACT-LOGISTICS-G3">Capture proof of delivery</Goal>
      </Goals>
      <Links>
        <Link ref="DevelopmentPlan.xml#INT-LOGISTICS" />
      </Links>
    </Actor>

    <Actor id="ACT-PAYMENT-GATEWAY" type="external-system">
      <Name>Payment Gateway</Name>
      <Description>
        External payment processor for deposit, full payment, and invoice payments.
        PCI compliance handled on provider side; secure token/webhook handling.
      </Description>
      <Goals>
        <Goal id="ACT-PG-G1">Authorize and capture payments</Goal>
        <Goal id="ACT-PG-G2">Process refunds</Goal>
        <Goal id="ACT-PG-G3">Notify of payment status changes via webhooks</Goal>
      </Goals>
      <Links>
        <Link ref="DevelopmentPlan.xml#INT-PAYMENTS" />
      </Links>
    </Actor>

    <Actor id="ACT-NOTIFICATION-PROVIDER" type="external-system">
      <Name>Notification Provider</Name>
      <Description>
        External services for sending emails, SMS, and push notifications.
      </Description>
      <Goals>
        <Goal id="ACT-NP-G1">Deliver transactional emails</Goal>
        <Goal id="ACT-NP-G2">Send SMS notifications</Goal>
        <Goal id="ACT-NP-G3">Send push notifications</Goal>
        <Goal id="ACT-NP-G4">Report delivery status</Goal>
      </Goals>
      <Links>
        <Link ref="DevelopmentPlan.xml#DP-SVC-notification-service" />
      </Links>
    </Actor>

    <Actor id="ACT-IDENTITY-PROVIDER" type="external-system">
      <Name>Identity Provider (OIDC)</Name>
      <Description>
        OAuth2/OIDC provider (Keycloak) for authentication and identity management.
      </Description>
      <Goals>
        <Goal id="ACT-IDP-G1">Authenticate users</Goal>
        <Goal id="ACT-IDP-G2">Issue and validate JWT tokens</Goal>
        <Goal id="ACT-IDP-G3">Manage user sessions</Goal>
      </Goals>
      <Links>
        <Link ref="Technology.xml#TECH-keycloak" />
      </Links>
    </Actor>
  </Actors>

  <!-- ===============================================================================
       USE CASES - PRIORITIZED (MUST/SHOULD/LATER)
       =============================================================================== -->
  <UseCases>
    <!-- ===========================================================================
         MUST (MVP): B2C CPQ - Configure + Instant Pricing + Save Draft
         =========================================================================== -->
    <UseCase id="UC-B2C-CPQ-01" priority="MUST">
      <ActorRef ref="ACT-B2C-CUSTOMER" />
      <Action>Configure product and get instant price</Action>
      <Goal>Create a valid, priced configuration that can be saved as draft and resumed</Goal>
      <Preconditions>
        <Item>Product template exists and is active</Item>
        <Item>Configuration rules are loaded</Item>
        <Item>Active price book exists</Item>
      </Preconditions>
      <Postconditions>
        <Item>Configuration passes all validation rules</Item>
        <Item>Price quote is calculated and displayed with applicable promos</Item>
        <Item>Draft can be saved to user account (if authenticated)</Item>
      </Postconditions>
      <MainFlow>
        <Step order="1">Customer selects product type (window/door)</Step>
        <Step order="2">System displays configurable options</Step>
        <Step order="3">Customer enters dimensions and selects options</Step>
        <Step order="4">System validates configuration in real-time</Step>
        <Step order="5">System calculates and displays price with applicable promotions</Step>
        <Step order="6">Any change triggers recalculation</Step>
        <Step order="7">Customer saves draft (creates or updates saved configuration)</Step>
      </MainFlow>
      <AlternateFlows>
        <Flow id="UC-B2C-CPQ-01-A1" trigger="Validation fails">
          <Step order="1">System displays validation errors with guidance</Step>
          <Step order="2">Customer adjusts configuration</Step>
        </Flow>
        <Flow id="UC-B2C-CPQ-01-A2" trigger="Anonymous user saves draft">
          <Step order="1">System prompts for login/registration</Step>
          <Step order="2">Draft is associated with account after authentication</Step>
        </Flow>
      </AlternateFlows>
      <AcceptanceCriteria>
        <Criterion id="AC-CPQ-01">Any change to configuration recalculates price</Criterion>
        <Criterion id="AC-CPQ-02">Draft can be resumed from personal account</Criterion>
        <Criterion id="AC-CPQ-03">Promotions/discounts are displayed inline</Criterion>
      </AcceptanceCriteria>
      <Links>
        <Link ref="DevelopmentPlan.xml#DP-SVC-catalog-configuration-service" />
        <Link ref="DevelopmentPlan.xml#DP-SVC-pricing-service" />
        <Link ref="DevelopmentPlan.xml#Flow-B2C-CPQ" />
      </Links>
    </UseCase>

    <!-- ===========================================================================
         MUST (MVP): Measurement Request Scheduling
         =========================================================================== -->
    <UseCase id="UC-B2C-MEASURE-01" priority="MUST">
      <ActorRef ref="ACT-B2C-CUSTOMER" />
      <Action>Request measurement slot</Action>
      <Goal>Schedule an on-site measurement visit and create CRM task</Goal>
      <Preconditions>
        <Item>Customer has a configuration (saved or in-session)</Item>
        <Item>Customer provides contact details and address</Item>
      </Preconditions>
      <Postconditions>
        <Item>Measurement request is created</Item>
        <Item>Task is created in workflow/CRM</Item>
        <Item>Confirmation is sent to customer</Item>
        <Item>Manager/technician is notified</Item>
      </Postconditions>
      <MainFlow>
        <Step order="1">Customer selects preferred date/time slot</Step>
        <Step order="2">Customer enters contact details and address</Step>
        <Step order="3">Customer submits measurement request</Step>
        <Step order="4">System creates measurement task in workflow-service</Step>
        <Step order="5">System sends confirmation to customer</Step>
        <Step order="6">System notifies manager/CRM</Step>
      </MainFlow>
      <AcceptanceCriteria>
        <Criterion id="AC-MEAS-01">Request creates a task in the system</Criterion>
        <Criterion id="AC-MEAS-02">Confirmation message is sent to customer</Criterion>
        <Criterion id="AC-MEAS-03">Task appears in manager/CRM pipeline</Criterion>
      </AcceptanceCriteria>
      <Links>
        <Link ref="DevelopmentPlan.xml#DP-SVC-workflow-service" />
        <Link ref="DevelopmentPlan.xml#DP-SVC-field-ops-service" />
        <Link ref="DevelopmentPlan.xml#Flow-Measurement-Visit" />
      </Links>
    </UseCase>

    <!-- ===========================================================================
         MUST (MVP): Cart Management
         =========================================================================== -->
    <UseCase id="UC-CART-MANAGE" priority="MUST">
      <ActorRef ref="ACT-B2C-CUSTOMER" />
      <Action>Manage shopping cart</Action>
      <Goal>Accumulate configured items before checkout</Goal>
      <Preconditions>
        <Item>Customer has a session (anonymous or authenticated)</Item>
      </Preconditions>
      <Postconditions>
        <Item>Cart reflects all added items with current prices</Item>
        <Item>Cart totals are recalculated on any change</Item>
        <Item>Cart state is persisted (Redis for anonymous, DB for authenticated)</Item>
      </Postconditions>
      <MainFlow>
        <Step order="1">Customer adds configured item to cart</Step>
        <Step order="2">System validates configuration is still valid via
          catalog-configuration-service</Step>
        <Step order="3">System retrieves current price quote from pricing-service</Step>
        <Step order="4">System adds item to cart with snapshot of configuration and price</Step>
        <Step order="5">System recalculates cart totals</Step>
        <Step order="6">System returns updated cart to customer</Step>
      </MainFlow>
      <AlternateFlows>
        <Flow id="UC-CART-MANAGE-A1" trigger="Update item quantity">
          <Step order="1">Customer changes quantity for existing cart item</Step>
          <Step order="2">System updates quantity and recalculates totals</Step>
        </Flow>
        <Flow id="UC-CART-MANAGE-A2" trigger="Remove item">
          <Step order="1">Customer removes item from cart</Step>
          <Step order="2">System removes item and recalculates totals</Step>
        </Flow>
        <Flow id="UC-CART-MANAGE-A3" trigger="Price changed notification">
          <Step order="1">System detects stale prices on GetCart</Step>
          <Step order="2">System marks items as price_stale</Step>
          <Step order="3">Frontend displays "Prices may have changed" warning</Step>
        </Flow>
        <Flow id="UC-CART-MANAGE-A4" trigger="Anonymous user logs in">
          <Step order="1">User authenticates (login/signup)</Step>
          <Step order="2">System detects anonymous cart exists</Step>
          <Step order="3">System merges anonymous cart into authenticated cart per DEC-CART-MERGE
            rules</Step>
          <Step order="4">System deletes anonymous cart</Step>
        </Flow>
      </AlternateFlows>
      <AcceptanceCriteria>
        <Criterion id="AC-CART-01">Items added to cart have valid configurations</Criterion>
        <Criterion id="AC-CART-02">Cart totals (subtotal, discount, tax, total) are accurate</Criterion>
        <Criterion id="AC-CART-03">Anonymous carts are merged on login per DEC-CART-MERGE</Criterion>
        <Criterion id="AC-CART-04">Stale prices are flagged on cart retrieval</Criterion>
        <Criterion id="AC-CART-05">CartItemAddedEvent published on add</Criterion>
      </AcceptanceCriteria>
      <Links>
        <Link ref="DevelopmentPlan.xml#DP-SVC-cart-service" />
        <Link ref="DevelopmentPlan.xml#DP-SVC-catalog-configuration-service" />
        <Link ref="DevelopmentPlan.xml#DP-SVC-pricing-service" />
        <Link ref="Technology.xml#DEC-CART-ANONYMOUS" />
        <Link ref="Technology.xml#DEC-CART-MERGE" />
        <Link ref="Technology.xml#DEC-CART-PRICE-LOCK" />
      </Links>
    </UseCase>

    <!-- ===========================================================================
         MUST (MVP): Apply Promotional Code to Cart
         =========================================================================== -->
    <UseCase id="UC-CART-APPLY-PROMO" priority="MUST">
      <ActorRef ref="ACT-B2C-CUSTOMER" />
      <Action>Apply promotional code to cart</Action>
      <Goal>Receive discount by entering a valid promo code</Goal>
      <Preconditions>
        <Item>Cart exists with at least one item</Item>
        <Item>Customer has promo code to apply</Item>
      </Preconditions>
      <Postconditions>
        <Item>Valid promo code is applied to cart</Item>
        <Item>Discount amount is calculated and stored</Item>
        <Item>Cart totals are recalculated with discount</Item>
        <Item>PromoCodeAppliedEvent is published</Item>
      </Postconditions>
      <MainFlow>
        <Step order="1">Customer enters promo code</Step>
        <Step order="2">cart-service validates code via pricing-service.ValidatePromoCode</Step>
        <Step order="3">pricing-service returns validation result (valid, expired, minimum not met,
          etc.)</Step>
        <Step order="4">System applies discount and recalculates totals</Step>
        <Step order="5">System returns updated cart with applied promo code details</Step>
      </MainFlow>
      <AlternateFlows>
        <Flow id="UC-CART-APPLY-PROMO-A1" trigger="Invalid promo code">
          <Step order="1">pricing-service returns PROMO_INVALID error</Step>
          <Step order="2">System returns error to customer with message</Step>
          <Step order="3">Cart remains unchanged</Step>
        </Flow>
        <Flow id="UC-CART-APPLY-PROMO-A2" trigger="Minimum not met">
          <Step order="1">pricing-service returns PROMO_MINIMUM_NOT_MET error</Step>
          <Step order="2">System returns error with minimum amount required</Step>
          <Step order="3">Cart remains unchanged</Step>
        </Flow>
        <Flow id="UC-CART-APPLY-PROMO-A3" trigger="Remove promo code">
          <Step order="1">Customer requests to remove applied promo code</Step>
          <Step order="2">System removes promo code and recalculates totals</Step>
          <Step order="3">PromoCodeRemovedEvent published</Step>
        </Flow>
      </AlternateFlows>
      <AcceptanceCriteria>
        <Criterion id="AC-PROMO-CART-01">Valid promo codes are applied correctly</Criterion>
        <Criterion id="AC-PROMO-CART-02">Invalid promo codes return appropriate error messages</Criterion>
        <Criterion id="AC-PROMO-CART-03">Only one promo code can be applied at a time</Criterion>
        <Criterion id="AC-PROMO-CART-04">Discount does not exceed subtotal</Criterion>
        <Criterion id="AC-PROMO-CART-05">Promo code is preserved during cart operations</Criterion>
      </AcceptanceCriteria>
      <Links>
        <Link ref="DevelopmentPlan.xml#DP-SVC-cart-service" />
        <Link ref="DevelopmentPlan.xml#DP-SVC-pricing-service" />
        <Link ref="Technology.xml#DEC-PRICING-DISCOUNT-PRECEDENCE" />
      </Links>
    </UseCase>

    <!-- ===========================================================================
         MUST (MVP): Order Placement (Checkout Flow)
         =========================================================================== -->
    <UseCase id="UC-ORDER-PLACE" priority="MUST">
      <ActorRef ref="ACT-B2C-CUSTOMER" />
      <Action>Place order from cart snapshot</Action>
      <Goal>Convert cart checkout snapshot into a submitted order</Goal>
      <Preconditions>
        <Item>Customer is authenticated</Item>
        <Item>Cart has at least one item with VALID status</Item>
        <Item>All configurations have been validated</Item>
        <Item>All prices have been refreshed</Item>
      </Preconditions>
      <Postconditions>
        <Item>Cart snapshot is created with fresh prices</Item>
        <Item>Order is created from snapshot</Item>
        <Item>Cart is cleared (status = CHECKED_OUT)</Item>
        <Item>CartCheckedOutEvent is published</Item>
      </Postconditions>
      <MainFlow>
        <Step order="1">Customer initiates checkout from cart</Step>
        <Step order="2">cart-service validates all item configurations</Step>
        <Step order="3">cart-service refreshes all prices from pricing-service</Step>
        <Step order="4">If prices changed, customer must acknowledge changes</Step>
        <Step order="5">cart-service creates immutable cart snapshot</Step>
        <Step order="6">order-service creates order from snapshot</Step>
        <Step order="7">cart-service clears cart and sets status to CHECKED_OUT</Step>
        <Step order="8">System publishes CartCheckedOutEvent</Step>
      </MainFlow>
      <AlternateFlows>
        <Flow id="UC-ORDER-PLACE-A1" trigger="Invalid configuration found">
          <Step order="1">Validation fails for one or more items</Step>
          <Step order="2">System returns error with list of invalid items</Step>
          <Step order="3">Customer must reconfigure or remove invalid items</Step>
        </Flow>
        <Flow id="UC-ORDER-PLACE-A2" trigger="Price change not acknowledged">
          <Step order="1">Prices have changed since last view</Step>
          <Step order="2">acknowledge_price_changes flag is false</Step>
          <Step order="3">System returns error requiring acknowledgement</Step>
        </Flow>
        <Flow id="UC-ORDER-PLACE-A3" trigger="Empty cart">
          <Step order="1">Cart has no items</Step>
          <Step order="2">System returns EMPTY_CART error</Step>
        </Flow>
      </AlternateFlows>
      <AcceptanceCriteria>
        <Criterion id="AC-ORDER-PLACE-01">Snapshot contains all cart items with validated
          configurations</Criterion>
        <Criterion id="AC-ORDER-PLACE-02">Snapshot prices are refreshed at creation time</Criterion>
        <Criterion id="AC-ORDER-PLACE-03">Snapshot has 15-minute validity period</Criterion>
        <Criterion id="AC-ORDER-PLACE-04">Cart is cleared after successful snapshot creation</Criterion>
        <Criterion id="AC-ORDER-PLACE-05">Anonymous users cannot create snapshots (UNAUTHENTICATED
          error)</Criterion>
      </AcceptanceCriteria>
      <Links>
        <Link ref="DevelopmentPlan.xml#DP-SVC-cart-service" />
        <Link ref="DevelopmentPlan.xml#DP-SVC-order-service" />
        <Link ref="DevelopmentPlan.xml#Flow-Checkout-Payment" />
        <Link ref="Technology.xml#DEC-CART-PRICE-LOCK" />
        <Link ref="Technology.xml#DEC-CART-STATE-MACHINE" />
      </Links>
    </UseCase>

    <!-- ===========================================================================
         MUST (MVP): B2C Ordering - Contract + Prepayment + Lock
         =========================================================================== -->
    <UseCase id="UC-B2C-ORDER-01" priority="MUST">
      <ActorRef ref="ACT-B2C-CUSTOMER" />
      <Action>Place order, accept contract, pay prepayment</Action>
      <Goal>Convert confirmed configuration into locked paid order</Goal>
      <Preconditions>
        <Item>Configuration is validated (potentially after measurement update)</Item>
        <Item>Customer is authenticated</Item>
        <Item>Delivery/installation options are selected</Item>
      </Preconditions>
      <Postconditions>
        <Item>Order is created and locked</Item>
        <Item>Contract is accepted (e-contract or checkbox confirmation)</Item>
        <Item>Payment (prepayment or full) is processed</Item>
        <Item>Order status is set to PAID</Item>
        <Item>Status transition is audited</Item>
      </Postconditions>
      <MainFlow>
        <Step order="1">Customer confirms final configuration (after measurement if applicable)</Step>
        <Step order="2">Customer selects delivery and installation options</Step>
        <Step order="3">Customer reviews and accepts contract terms</Step>
        <Step order="4">Customer proceeds to payment</Step>
        <Step order="5">System processes payment (prepayment or full)</Step>
        <Step order="6">System locks order (no further changes)</Step>
        <Step order="7">System sets status to PAID</Step>
        <Step order="8">System publishes OrderPaidEvent</Step>
        <Step order="9">System sends order confirmation notification</Step>
      </MainFlow>
      <AcceptanceCriteria>
        <Criterion id="AC-ORD-01">Post-payment order is locked and cannot be modified</Criterion>
        <Criterion id="AC-ORD-02">Status transitions are recorded with audit trail</Criterion>
        <Criterion id="AC-ORD-03">Contract acceptance is recorded</Criterion>
      </AcceptanceCriteria>
      <Links>
        <Link ref="DevelopmentPlan.xml#DP-SVC-order-service" />
        <Link ref="DevelopmentPlan.xml#Flow-Checkout-Payment" />
      </Links>
    </UseCase>

    <!-- ===========================================================================
         MUST (MVP): Status Tracking + Notifications
         =========================================================================== -->
    <UseCase id="UC-B2C-TRACK-01" priority="MUST">
      <ActorRef ref="ACT-B2C-CUSTOMER" />
      <Action>Track order and receive notifications</Action>
      <Goal>View order lifecycle status and receive event-driven notifications</Goal>
      <Preconditions>
        <Item>Order exists for the customer</Item>
      </Preconditions>
      <Postconditions>
        <Item>Customer sees current status and history</Item>
        <Item>Notifications are received for status changes</Item>
      </Postconditions>
      <MainFlow>
        <Step order="1">Customer navigates to order tracking</Step>
        <Step order="2">System displays status timeline
          (measurement/production/delivery/installation)</Step>
        <Step order="3">System displays status history with timestamps</Step>
        <Step order="4">Customer receives notifications for each status change</Step>
      </MainFlow>
      <AcceptanceCriteria>
        <Criterion id="AC-TRACK-01">Status history is visible with timestamps</Criterion>
        <Criterion id="AC-TRACK-02">Notifications triggered by status events</Criterion>
        <Criterion id="AC-TRACK-03">Status names match between portal and CRM</Criterion>
      </AcceptanceCriteria>
      <Links>
        <Link ref="DevelopmentPlan.xml#DP-SVC-order-service" />
        <Link ref="DevelopmentPlan.xml#DP-SVC-notification-service" />
        <Link ref="DevelopmentPlan.xml#StatusModel" />
      </Links>
    </UseCase>

    <!-- ===========================================================================
         MUST (MVP): Core RBAC Domains
         =========================================================================== -->
    <UseCase id="UC-RBAC-01" priority="MUST">
      <ActorRef ref="ACT-ADMIN" />
      <Action>Manage roles and permissions</Action>
      <Goal>Define and enforce access control for B2C, B2B, Staff, and Field roles</Goal>
      <Preconditions>
        <Item>Admin is authenticated with admin privileges</Item>
      </Preconditions>
      <Postconditions>
        <Item>Roles are defined in identity provider</Item>
        <Item>Permissions are enforced at service level</Item>
      </Postconditions>
      <MainFlow>
        <Step order="1">Admin defines roles (B2C_CUSTOMER, B2B_DEALER, SALES_MANAGER,
          MEASUREMENT_TECH, INSTALLER, ADMIN)</Step>
        <Step order="2">Admin assigns permissions to roles</Step>
        <Step order="3">System enforces role-based access on all endpoints</Step>
      </MainFlow>
      <AcceptanceCriteria>
        <Criterion id="AC-RBAC-01">Four role domains defined: B2C, B2B, Staff, Field</Criterion>
        <Criterion id="AC-RBAC-02">Each endpoint enforces required role(s)</Criterion>
      </AcceptanceCriteria>
      <Links>
        <Link ref="DevelopmentPlan.xml#DP-SVC-account-service" />
        <Link ref="Technology.xml#TECH-keycloak" />
      </Links>
    </UseCase>

    <!-- ===========================================================================
         MUST (MVP): Status Audit Trail
         =========================================================================== -->
    <UseCase id="UC-AUDIT-01" priority="MUST">
      <ActorRef ref="ACT-ADMIN" />
      <Action>Audit status changes</Action>
      <Goal>Track all status changes with actor, timestamp, and source</Goal>
      <Preconditions>
        <Item>Status change occurs on any tracked entity</Item>
      </Preconditions>
      <Postconditions>
        <Item>Audit record created with all required fields</Item>
      </Postconditions>
      <MainFlow>
        <Step order="1">Status change is triggered (manual or integration)</Step>
        <Step order="2">System captures: timestamp, actor/system, source (manual/integration),
          entity ID</Step>
        <Step order="3">System persists audit record</Step>
        <Step order="4">Audit trail is queryable for reporting</Step>
      </MainFlow>
      <AcceptanceCriteria>
        <Criterion id="AC-AUDIT-01">Every status change has audit record</Criterion>
        <Criterion id="AC-AUDIT-02">Audit includes: timestamp, actor, source, entity ID, old/new
          status</Criterion>
      </AcceptanceCriteria>
      <Links>
        <Link ref="DevelopmentPlan.xml#StatusModel" />
      </Links>
    </UseCase>

    <!-- ===========================================================================
         MUST (MVP): B2B CPQ + Project Orders
         =========================================================================== -->
    <UseCase id="UC-B2B-CPQ-01" priority="MUST">
      <ActorRef ref="ACT-B2B-DEALER" />
      <Action>Configure/quote with dealer rules + create project order</Action>
      <Goal>Generate quote with partner pricing and create project order with documents</Goal>
      <Preconditions>
        <Item>Dealer is authenticated with B2B role</Item>
        <Item>Partner pricing tier is active</Item>
      </Preconditions>
      <Postconditions>
        <Item>Quote generated with dealer pricing</Item>
        <Item>Documents linked to order</Item>
        <Item>CAD feasibility check passed (if applicable)</Item>
      </Postconditions>
      <MainFlow>
        <Step order="1">Dealer configures products with dealer-specific rules</Step>
        <Step order="2">System applies partner pricing tier</Step>
        <Step order="3">Dealer generates quote document</Step>
        <Step order="4">Dealer uploads BOM/drawings (optional)</Step>
        <Step order="5">Dealer groups items by job site/object</Step>
        <Step order="6">System runs CAD feasibility check (if integrated)</Step>
        <Step order="7">Dealer submits project order</Step>
        <Step order="8">System links all documents to order</Step>
      </MainFlow>
      <AcceptanceCriteria>
        <Criterion id="AC-B2B-01">Quote generated with partner pricing</Criterion>
        <Criterion id="AC-B2B-02">Documents linked to order</Criterion>
        <Criterion id="AC-B2B-03">CAD feasibility validated when integrated</Criterion>
      </AcceptanceCriteria>
      <Links>
        <Link ref="DevelopmentPlan.xml#DP-SVC-pricing-service" />
        <Link ref="DevelopmentPlan.xml#DP-SVC-document-service" />
        <Link ref="DevelopmentPlan.xml#INT-CAD" />
      </Links>
    </UseCase>

    <!-- ===========================================================================
         MUST (MVP): Staff CRM/Pipeline Management
         =========================================================================== -->
    <UseCase id="UC-STAFF-CRM-01" priority="MUST">
      <ActorRef ref="ACT-SALES-MANAGER" />
      <Action>Manage leads/pipeline/quotes/calendar</Action>
      <Goal>Process omnichannel leads through pipeline to completion</Goal>
      <Preconditions>
        <Item>Manager is authenticated with Staff role</Item>
      </Preconditions>
      <Postconditions>
        <Item>Lead/deal progresses through pipeline stages</Item>
        <Item>Tasks and reminders are tracked</Item>
        <Item>Documents are generated</Item>
      </Postconditions>
      <MainFlow>
        <Step order="1">System ingests leads from website/telephony/messengers/offline</Step>
        <Step order="2">Manager views Kanban/pipeline dashboard</Step>
        <Step order="3">Manager progresses deals through stages</Step>
        <Step order="4">Manager generates quote/invoice from template</Step>
        <Step order="5">Manager schedules measurement or installation</Step>
        <Step order="6">Manager receives completion updates from field</Step>
      </MainFlow>
      <AcceptanceCriteria>
        <Criterion id="AC-CRM-01">Pipeline reflects status model stages</Criterion>
        <Criterion id="AC-CRM-02">Scheduling supports slot booking</Criterion>
        <Criterion id="AC-CRM-03">Documents generated from templates</Criterion>
      </AcceptanceCriteria>
      <Links>
        <Link ref="DevelopmentPlan.xml#DP-SVC-workflow-service" />
        <Link ref="DevelopmentPlan.xml#DP-SVC-document-service" />
      </Links>
    </UseCase>

    <!-- ===========================================================================
         MUST (MVP): Field Measurement Task
         =========================================================================== -->
    <UseCase id="UC-FIELD-MEASURE-01" priority="MUST">
      <ActorRef ref="ACT-MEASUREMENT-TECHNICIAN" />
      <Action>Capture measurements, photos, and completion act</Action>
      <Goal>Complete measurement task with all required data</Goal>
      <Preconditions>
        <Item>Measurement task is assigned</Item>
        <Item>Technician is authenticated with Field role</Item>
      </Preconditions>
      <Postconditions>
        <Item>Measurements are recorded</Item>
        <Item>Photos are uploaded</Item>
        <Item>Configuration is updated with measured dimensions</Item>
        <Item>Task status is updated</Item>
        <Item>Deal/order is repriced if dimensions changed</Item>
      </Postconditions>
      <MainFlow>
        <Step order="1">Technician views assigned task</Step>
        <Step order="2">Technician accepts and marks en-route</Step>
        <Step order="3">Technician performs measurements on-site</Step>
        <Step order="4">Technician enters dimensions and captures photos</Step>
        <Step order="5">Technician adjusts configuration if needed</Step>
        <Step order="6">Technician marks task complete</Step>
        <Step order="7">System triggers repricing with new dimensions</Step>
        <Step order="8">System updates deal/order status</Step>
      </MainFlow>
      <AcceptanceCriteria>
        <Criterion id="AC-FIELD-M-01">Measured dimensions trigger repricing</Criterion>
        <Criterion id="AC-FIELD-M-02">Photos stored and linked to task</Criterion>
        <Criterion id="AC-FIELD-M-03">Deal stage advances to MEASUREMENT_COMPLETED</Criterion>
      </AcceptanceCriteria>
      <Links>
        <Link ref="DevelopmentPlan.xml#DP-SVC-field-ops-service" />
        <Link ref="DevelopmentPlan.xml#Flow-Measurement-Visit" />
      </Links>
    </UseCase>

    <!-- ===========================================================================
         MUST (MVP): Field Installation Task
         =========================================================================== -->
    <UseCase id="UC-FIELD-INSTALL-01" priority="MUST">
      <ActorRef ref="ACT-INSTALLER" />
      <Action>Complete installation with checklist and acceptance act</Action>
      <Goal>Execute installation and capture completion evidence</Goal>
      <Preconditions>
        <Item>Installation task is assigned</Item>
        <Item>Products are delivered</Item>
        <Item>Installer is authenticated with Field role</Item>
      </Preconditions>
      <Postconditions>
        <Item>Installation checklist is completed</Item>
        <Item>Acceptance certificate is captured</Item>
        <Item>Photos are uploaded</Item>
        <Item>Order status advances to INSTALLED</Item>
      </Postconditions>
      <MainFlow>
        <Step order="1">Installer views assigned task with specs</Step>
        <Step order="2">Installer marks en-route</Step>
        <Step order="3">Installer completes installation checklist</Step>
        <Step order="4">Installer captures acceptance certificate (photo/signature)</Step>
        <Step order="5">Installer uploads completion photos</Step>
        <Step order="6">Installer marks task complete</Step>
        <Step order="7">System updates order status to INSTALLED</Step>
      </MainFlow>
      <AcceptanceCriteria>
        <Criterion id="AC-FIELD-I-01">Checklist must be completed before marking done</Criterion>
        <Criterion id="AC-FIELD-I-02">Acceptance certificate required</Criterion>
        <Criterion id="AC-FIELD-I-03">Order status updated automatically</Criterion>
      </AcceptanceCriteria>
      <Links>
        <Link ref="DevelopmentPlan.xml#DP-SVC-field-ops-service" />
      </Links>
    </UseCase>

    <!-- ===========================================================================
         SHOULD: Promotions/Discounts/Installments Display in CPQ
         =========================================================================== -->
    <UseCase id="UC-CPQ-PROMO-01" priority="SHOULD">
      <ActorRef ref="ACT-B2C-CUSTOMER" />
      <Action>View promotions, discounts, and installment options</Action>
      <Goal>See all applicable pricing incentives during configuration</Goal>
      <Preconditions>
        <Item>Active campaigns or promotions exist</Item>
        <Item>Installment plans are configured (if offered)</Item>
      </Preconditions>
      <Postconditions>
        <Item>Applicable promotions displayed with savings</Item>
        <Item>Installment options shown if available</Item>
      </Postconditions>
      <MainFlow>
        <Step order="1">System evaluates active campaigns during pricing</Step>
        <Step order="2">System displays applicable promotions with discount amount</Step>
        <Step order="3">System shows installment payment options (if configured)</Step>
        <Step order="4">Customer can apply promo codes</Step>
      </MainFlow>
      <AcceptanceCriteria>
        <Criterion id="AC-PROMO-01">Active promotions displayed inline</Criterion>
        <Criterion id="AC-PROMO-02">Savings amount shown</Criterion>
        <Criterion id="AC-PROMO-03">Installment schedule displayed when applicable</Criterion>
      </AcceptanceCriteria>
      <Links>
        <Link ref="DevelopmentPlan.xml#DP-SVC-pricing-service" />
      </Links>
    </UseCase>

    <!-- ===========================================================================
         SHOULD: Delivery Tracking with Proof of Delivery
         =========================================================================== -->
    <UseCase id="UC-DELIVERY-TRACK-01" priority="SHOULD">
      <ActorRef ref="ACT-B2C-CUSTOMER" />
      <Action>Track delivery with proof of delivery</Action>
      <Goal>Real-time delivery tracking and delivery confirmation</Goal>
      <Preconditions>
        <Item>Order is in SHIPPED status</Item>
        <Item>Logistics integration is active</Item>
      </Preconditions>
      <Postconditions>
        <Item>Customer sees delivery progress</Item>
        <Item>Proof of delivery is captured</Item>
      </Postconditions>
      <MainFlow>
        <Step order="1">Customer views order tracking</Step>
        <Step order="2">System displays delivery progress from logistics</Step>
        <Step order="3">Driver captures proof of delivery</Step>
        <Step order="4">System updates status to DELIVERED</Step>
        <Step order="5">Proof of delivery is viewable by customer</Step>
      </MainFlow>
      <AcceptanceCriteria>
        <Criterion id="AC-DEL-01">Real-time tracking updates displayed</Criterion>
        <Criterion id="AC-DEL-02">Proof of delivery captured and viewable</Criterion>
      </AcceptanceCriteria>
      <Links>
        <Link ref="DevelopmentPlan.xml#INT-LOGISTICS" />
      </Links>
    </UseCase>

    <!-- ===========================================================================
         LATER: 3D Visualization
         =========================================================================== -->
    <UseCase id="UC-VIS-3D-01" priority="LATER">
      <ActorRef ref="ACT-B2C-CUSTOMER" />
      <Action>View 3D visualization of configuration</Action>
      <Goal>Interactive 3D model of configured product</Goal>
      <Preconditions>
        <Item>3D visualization integration is available</Item>
        <Item>Product model supports 3D rendering</Item>
      </Preconditions>
      <Postconditions>
        <Item>3D model rendered with selected options</Item>
      </Postconditions>
      <MainFlow>
        <Step order="1">Customer opens 3D view</Step>
        <Step order="2">System requests 3D model from CAD integration</Step>
        <Step order="3">Customer rotates/zooms 3D model</Step>
        <Step order="4">Changes to configuration update 3D in real-time</Step>
      </MainFlow>
      <AcceptanceCriteria>
        <Criterion id="AC-3D-01">3D model reflects current configuration</Criterion>
        <Criterion id="AC-3D-02">Interactive rotation and zoom</Criterion>
      </AcceptanceCriteria>
      <Links>
        <Link ref="DevelopmentPlan.xml#INT-CAD" />
      </Links>
    </UseCase>

    <!-- ===========================================================================
         LATER: Advanced Logistics Auto-Routing
         =========================================================================== -->
    <UseCase id="UC-LOGISTICS-ROUTE-01" priority="LATER">
      <ActorRef ref="ACT-LOGISTICS-COORDINATOR" />
      <Action>Auto-route deliveries</Action>
      <Goal>Automated route optimization for delivery fleet</Goal>
      <Preconditions>
        <Item>Multiple deliveries pending</Item>
        <Item>Advanced logistics integration available</Item>
      </Preconditions>
      <Postconditions>
        <Item>Optimized routes generated</Item>
        <Item>Drivers assigned</Item>
      </Postconditions>
      <MainFlow>
        <Step order="1">System collects pending deliveries</Step>
        <Step order="2">System calls routing optimization</Step>
        <Step order="3">System assigns routes to drivers</Step>
        <Step order="4">Drivers receive route in mobile app</Step>
      </MainFlow>
      <AcceptanceCriteria>
        <Criterion id="AC-ROUTE-01">Routes optimized for distance/time</Criterion>
        <Criterion id="AC-ROUTE-02">Drivers receive turn-by-turn navigation</Criterion>
      </AcceptanceCriteria>
      <Links>
        <Link ref="DevelopmentPlan.xml#INT-LOGISTICS" />
      </Links>
    </UseCase>

    <!-- ===========================================================================
         Existing Use Cases (Updated Links)
         =========================================================================== -->
    <UseCase id="UC-CATALOG-BROWSE" priority="MUST">
      <ActorRef ref="ACT-B2C-CUSTOMER" />
      <Action>Browse product catalog</Action>
      <Goal>Discover available window and door products with filtering and search</Goal>
      <Preconditions>
        <Item>System is available</Item>
        <Item>Product catalog is populated</Item>
      </Preconditions>
      <Postconditions>
        <Item>Customer sees paginated product listings</Item>
        <Item>Filters are applied correctly</Item>
      </Postconditions>
      <MainFlow>
        <Step order="1">Customer navigates to catalog or search page</Step>
        <Step order="2">System displays product categories and filters</Step>
        <Step order="3">Customer applies filters (material, size range, price range)</Step>
        <Step order="4">System queries search-service and returns matching products</Step>
        <Step order="5">Customer selects a product to configure</Step>
      </MainFlow>
      <Links>
        <Link ref="DevelopmentPlan.xml#DP-SVC-search-service" />
        <Link ref="DevelopmentPlan.xml#DP-SVC-catalog-configuration-service" />
      </Links>
    </UseCase>

    <UseCase id="UC-SUPPORT-CREATE-01" priority="MUST">
      <ActorRef ref="ACT-B2C-CUSTOMER" />
      <Action>Create service or warranty request</Action>
      <Goal>Submit after-sales service request with tracking</Goal>
      <Preconditions>
        <Item>Order exists and is in INSTALLED or COMPLETED status</Item>
        <Item>Customer is authenticated</Item>
      </Preconditions>
      <Postconditions>
        <Item>Service request created and linked to order</Item>
        <Item>Customer receives confirmation</Item>
        <Item>Service team is notified</Item>
      </Postconditions>
      <MainFlow>
        <Step order="1">Customer selects order for service request</Step>
        <Step order="2">Customer describes issue and optionally uploads photos</Step>
        <Step order="3">System creates service request linked to order</Step>
        <Step order="4">System sends confirmation to customer</Step>
        <Step order="5">System notifies service department</Step>
        <Step order="6">Customer tracks request status</Step>
      </MainFlow>
      <AcceptanceCriteria>
        <Criterion id="AC-SUPPORT-01">Request linked to original order</Criterion>
        <Criterion id="AC-SUPPORT-02">Status tracking available</Criterion>
        <Criterion id="AC-SUPPORT-03">Communication history preserved</Criterion>
      </AcceptanceCriteria>
      <Links>
        <Link ref="DevelopmentPlan.xml#DP-SVC-support-service" />
      </Links>
    </UseCase>

    <!-- ===========================================================================
         MUST (MVP): Catalog Admin Management
         =========================================================================== -->
    <UseCase id="UC-CATALOG-ADMIN-MANAGE" priority="MUST">
      <ActorRef ref="ACT-ADMIN" />
      <Action>Manage product catalog (create, update, publish templates)</Action>
      <Goal>Maintain product catalog with configuration rules and publish versions</Goal>
      <Preconditions>
        <Item>User has ADMIN or CATALOG_ADMIN role</Item>
        <Item>catalog-configuration-service is available</Item>
      </Preconditions>
      <Postconditions>
        <Item>Product template is created/updated/published</Item>
        <Item>Search index is updated via CatalogVersionPublishedEvent</Item>
        <Item>Catalog version history is maintained</Item>
      </Postconditions>
      <MainFlow>
        <Step order="1">Admin creates new product template with base configuration</Step>
        <Step order="2">Admin defines option groups and configuration rules</Step>
        <Step order="3">Admin sets dimension constraints and compatibility rules</Step>
        <Step order="4">Admin saves template as draft</Step>
        <Step order="5">Admin publishes catalog version</Step>
        <Step order="6">System emits CatalogVersionPublishedEvent</Step>
        <Step order="7">search-service indexes new catalog data</Step>
      </MainFlow>
      <AlternateFlows>
        <Flow id="UC-CATALOG-ADMIN-MANAGE-A1" trigger="Update existing template">
          <Step order="1">Admin selects existing template</Step>
          <Step order="2">Admin modifies configuration rules or options</Step>
          <Step order="3">System validates changes don't break existing configurations</Step>
          <Step order="4">Admin saves and optionally publishes new version</Step>
        </Flow>
      </AlternateFlows>
      <AcceptanceCriteria>
        <Criterion id="AC-CAT-ADMIN-01">Templates can be created with full configuration options</Criterion>
        <Criterion id="AC-CAT-ADMIN-02">Catalog versions are immutable once published</Criterion>
        <Criterion id="AC-CAT-ADMIN-03">Search index updated within 5 seconds of publish</Criterion>
      </AcceptanceCriteria>
      <Links>
        <Link ref="DevelopmentPlan.xml#DP-SVC-catalog-configuration-service" />
        <Link ref="DevelopmentPlan.xml#DP-SVC-search-service" />
        <Link ref="Technology.xml#DEC-ARCH-ENTITY-VERSIONING" />
      </Links>
    </UseCase>
  </UseCases>

  <!-- ===============================================================================
       STATUS MODEL
       =============================================================================== -->
  <StatusModel id="StatusModel">
    <Description>
      Canonical status model for lead/deal/order lifecycle. Names MUST match
      between customer portal and CRM. All transitions are audited.
    </Description>

    <StatusDomains>
      <!-- Lead/Deal Pipeline Status -->
      <Domain name="Lead/Deal">
        <Status id="STATUS-LEAD-NEW" name="New Lead">Initial lead intake</Status>
        <Status id="STATUS-LEAD-CONSULTATION" name="Consultation">Initial contact/discussion</Status>
        <Status id="STATUS-LEAD-MEASURE-SCHEDULED" name="Measurement Scheduled">Measurement visit
          scheduled</Status>
        <Status id="STATUS-LEAD-MEASURE-COMPLETED" name="Measurement Completed">Measurements
          captured</Status>
        <Status id="STATUS-LEAD-QUOTE-SENT" name="Quote/Proposal Sent">Commercial proposal sent</Status>
        <Status id="STATUS-LEAD-CONTRACT-SIGNED" name="Contract Signed">Contract accepted</Status>
        <Status id="STATUS-LEAD-LOST" name="Lost" terminal="true">Lead closed without conversion</Status>
        <Status id="STATUS-LEAD-CONVERTED" name="Converted to Order" terminal="true">Order created</Status>
      </Domain>

      <!-- Order Fulfillment Status -->
      <Domain name="Order">
        <Status id="STATUS-ORD-CREATED" name="Created">Order placed</Status>
        <Status id="STATUS-ORD-PENDING-PAYMENT" name="Pending Payment">Awaiting payment</Status>
        <Status id="STATUS-ORD-PAID" name="Paid">Payment confirmed, order locked</Status>
        <Status id="STATUS-ORD-IN-PRODUCTION" name="In Production">Manufacturing started</Status>
        <Status id="STATUS-ORD-READY-SHIP" name="Ready for Shipment">Production complete, ready to
          ship</Status>
        <Status id="STATUS-ORD-IN-TRANSIT" name="In Transit">Out for delivery</Status>
        <Status id="STATUS-ORD-DELIVERED" name="Delivered">Products delivered</Status>
        <Status id="STATUS-ORD-INSTALL-SCHEDULED" name="Installation Scheduled">Install appointment
          set</Status>
        <Status id="STATUS-ORD-INSTALLED" name="Installed/Completed">Installation done</Status>
        <Status id="STATUS-ORD-CANCELLED" name="Cancelled" terminal="true">Order cancelled</Status>
      </Domain>

      <!-- Service Request Status -->
      <Domain name="Service">
        <Status id="STATUS-SVC-NEW" name="New Request">Request submitted</Status>
        <Status id="STATUS-SVC-IN-PROGRESS" name="In Progress">Being processed</Status>
        <Status id="STATUS-SVC-RESOLVED" name="Resolved" terminal="true">Issue resolved</Status>
        <Status id="STATUS-SVC-CLOSED" name="Closed" terminal="true">Request closed</Status>
      </Domain>
    </StatusDomains>

    <AuditRequirements>
      <Requirement>All status changes MUST be audited</Requirement>
      <Requirement>Audit record MUST include: timestamp (UTC), actor ID or system ID, source
        (manual|integration|system), correlation/order ID, old status, new status</Requirement>
      <Requirement>Audit records are immutable</Requirement>
      <Requirement>Audit trail queryable for reporting</Requirement>
    </AuditRequirements>

    <Links>
      <Link ref="UC-AUDIT-01" />
      <Link ref="DevelopmentPlan.xml#DP-SVC-order-service" />
    </Links>
  </StatusModel>

  <!-- ===============================================================================
       DOMAIN GLOSSARY
       =============================================================================== -->
  <DomainGlossary id="DomainGlossary">
    <Description>Canonical domain entities and their definitions</Description>

    <Entity id="GLOSS-USER">
      <Name>User</Name>
      <Definition>Any authenticated individual: B2C customer, B2B dealer contact, staff member, or
        field user</Definition>
    </Entity>

    <Entity id="GLOSS-PARTNER-ORG">
      <Name>PartnerOrg</Name>
      <Definition>B2B organization with legal/finance profile, multiple sub-users, and partner
        pricing tier</Definition>
    </Entity>

    <Entity id="GLOSS-STAFF-USER">
      <Name>StaffUser</Name>
      <Definition>Internal company employee (sales manager, admin, support) with Staff role</Definition>
    </Entity>

    <Entity id="GLOSS-FIELD-USER">
      <Name>FieldUser</Name>
      <Definition>Measurement technician, installer, logistics coordinator, or warehouse staff</Definition>
    </Entity>

    <Entity id="GLOSS-PRODUCT-CATALOG">
      <Name>ProductCatalog</Name>
      <Definition>Collection of product templates (windows, doors) with configuration rules</Definition>
    </Entity>

    <Entity id="GLOSS-PRICING-RULES">
      <Name>PricingRules</Name>
      <Definition>Price books, base rates, option premiums, partner tiers, campaigns</Definition>
    </Entity>

    <Entity id="GLOSS-DISCOUNT">
      <Name>Discount</Name>
      <Definition>Price reduction: promo code, campaign, partner tier, or volume</Definition>
    </Entity>

    <Entity id="GLOSS-CONFIGURATION">
      <Name>Configuration</Name>
      <Definition>Customer-specified product setup: dimensions, material, glazing, options,
        accessories</Definition>
    </Entity>

    <Entity id="GLOSS-LEAD">
      <Name>Lead</Name>
      <Definition>Initial customer inquiry/contact before qualification</Definition>
    </Entity>

    <Entity id="GLOSS-DEAL">
      <Name>Deal</Name>
      <Definition>Qualified lead progressing through sales pipeline stages</Definition>
    </Entity>

    <Entity id="GLOSS-QUOTE">
      <Name>Quote</Name>
      <Definition>Priced configuration snapshot presented as commercial proposal</Definition>
    </Entity>

    <Entity id="GLOSS-CONTRACT">
      <Name>Contract</Name>
      <Definition>Legal agreement between company and customer for order fulfillment</Definition>
    </Entity>

    <Entity id="GLOSS-PAYMENT">
      <Name>Payment</Name>
      <Definition>Monetary transaction: deposit, full payment, or invoice payment</Definition>
    </Entity>

    <Entity id="GLOSS-MEASUREMENT-VISIT">
      <Name>MeasurementVisit</Name>
      <Definition>On-site visit by technician to capture actual dimensions</Definition>
    </Entity>

    <Entity id="GLOSS-ORDER">
      <Name>Order</Name>
      <Definition>Confirmed customer purchase with items, delivery, and installation details</Definition>
    </Entity>

    <Entity id="GLOSS-ORDER-ITEM">
      <Name>OrderItem</Name>
      <Definition>Single configured product within an order</Definition>
    </Entity>

    <Entity id="GLOSS-DELIVERY">
      <Name>Delivery</Name>
      <Definition>Logistics operation to transport products to customer address</Definition>
    </Entity>

    <Entity id="GLOSS-INSTALLATION-JOB">
      <Name>InstallationJob</Name>
      <Definition>Field task for installer crew to install delivered products</Definition>
    </Entity>

    <Entity id="GLOSS-SERVICE-TICKET">
      <Name>ServiceTicket</Name>
      <Definition>After-sales service or warranty request</Definition>
    </Entity>

    <Entity id="GLOSS-DOCUMENT">
      <Name>Document</Name>
      <Definition>Generated artifact: proposal, invoice, contract, acceptance certificate, drawing</Definition>
    </Entity>
  </DomainGlossary>

  <!-- ===============================================================================
       INTEGRATION REQUIREMENTS
       =============================================================================== -->
  <IntegrationRequirements id="IntegrationRequirements">
    <Integration id="INT-REQ-CRM">
      <Name>CRM/ERP Integration</Name>
      <Purpose>Lead/deal/pipeline sync, task management, order status sync</Purpose>
      <DataFlows>
        <Flow direction="outbound">Lead/deal creation events</Flow>
        <Flow direction="outbound">Pipeline stage updates</Flow>
        <Flow direction="outbound">Task creation (measurement, installation)</Flow>
        <Flow direction="bidirectional">Order status updates</Flow>
      </DataFlows>
      <SourceOfTruth>
        <Field name="Lead/Deal stages">Our system (primary), sync to CRM</Field>
        <Field name="Order status after PAID">Requires Decision - ERP vs our system</Field>
      </SourceOfTruth>
      <Links>
        <Link ref="DevelopmentPlan.xml#INT-CRM-ERP" />
      </Links>
    </Integration>

    <Integration id="INT-REQ-CAD">
      <Name>CAD/CPQ Integration</Name>
      <Purpose>Feasibility validation, drawing/spec generation, visualization</Purpose>
      <DataFlows>
        <Flow direction="outbound">Configuration spec for validation</Flow>
        <Flow direction="inbound">Feasibility result (pass/fail with reasons)</Flow>
        <Flow direction="inbound">Generated drawings (PDF, DXF)</Flow>
        <Flow direction="inbound">Visualization artifacts (images, 3D)</Flow>
      </DataFlows>
      <OpenDecisions>
        <Decision id="DEC-CAD-FORMAT">Integration format (API, file exchange) - TBD</Decision>
        <Decision id="DEC-CAD-SLA">Response time SLA for feasibility check - TBD</Decision>
      </OpenDecisions>
      <Links>
        <Link ref="DevelopmentPlan.xml#INT-CAD" />
      </Links>
    </Integration>

    <Integration id="INT-REQ-ERP">
      <Name>ERP/Manufacturing Integration</Name>
      <Purpose>Order sync, production status, inventory</Purpose>
      <DataFlows>
        <Flow direction="outbound">Order details for production</Flow>
        <Flow direction="inbound">Production status updates</Flow>
        <Flow direction="inbound">Ready-to-ship notification</Flow>
      </DataFlows>
      <SourceOfTruth>
        <Field name="Production stages">Requires Decision - ERP is likely SoT</Field>
      </SourceOfTruth>
      <Links>
        <Link ref="DevelopmentPlan.xml#INT-ERP" />
      </Links>
    </Integration>

    <Integration id="INT-REQ-LOGISTICS">
      <Name>Logistics/Delivery Integration</Name>
      <Purpose>Route planning, real-time tracking, proof of delivery</Purpose>
      <DataFlows>
        <Flow direction="outbound">Delivery addresses and items</Flow>
        <Flow direction="inbound">Route/ETA information</Flow>
        <Flow direction="inbound">Real-time tracking updates</Flow>
        <Flow direction="inbound">Proof of delivery (photo, signature)</Flow>
      </DataFlows>
      <Links>
        <Link ref="DevelopmentPlan.xml#INT-LOGISTICS" />
      </Links>
    </Integration>

    <Integration id="INT-REQ-PAYMENTS">
      <Name>Payment Gateway Integration</Name>
      <Purpose>Deposit, full payment, invoice payment processing</Purpose>
      <DataFlows>
        <Flow direction="outbound">Payment initiation with amount/reference</Flow>
        <Flow direction="inbound">Payment status webhooks</Flow>
        <Flow direction="outbound">Refund requests</Flow>
      </DataFlows>
      <SecurityRequirements>
        <Item>PCI compliance handled by payment provider</Item>
        <Item>Secure token handling (no card data storage)</Item>
        <Item>Webhook signature verification</Item>
      </SecurityRequirements>
      <Links>
        <Link ref="DevelopmentPlan.xml#INT-PAYMENTS" />
      </Links>
    </Integration>
  </IntegrationRequirements>

  <!-- ===============================================================================
       NON-FUNCTIONAL REQUIREMENTS
       =============================================================================== -->
  <NonFunctionalRequirements>
    <!-- Performance -->
    <Requirement id="NFR-PERF-RESPONSE-TIME">
      <Category>Performance</Category>
      <Description>API response time for user-facing endpoints</Description>
      <Metric>P95 response time &lt; 500ms for CPQ, configuration validation, and pricing</Metric>
      <Links>
        <Link ref="DevelopmentPlan.xml#DP-SVC-catalog-configuration-service" />
        <Link ref="DevelopmentPlan.xml#DP-SVC-pricing-service" />
      </Links>
    </Requirement>

    <Requirement id="NFR-PERF-CPQ-RECALC">
      <Category>Performance</Category>
      <Description>CPQ recalculation on configuration change</Description>
      <Metric>Price recalculation completes within 300ms of user input</Metric>
      <Links>
        <Link ref="UC-B2C-CPQ-01" />
      </Links>
    </Requirement>

    <Requirement id="NFR-PERF-SEARCH-LATENCY">
      <Category>Performance</Category>
      <Description>Search query latency</Description>
      <Metric>P95 search response time &lt; 200ms</Metric>
      <Links>
        <Link ref="DevelopmentPlan.xml#DP-SVC-search-service" />
      </Links>
    </Requirement>

    <!-- Availability -->
    <Requirement id="NFR-AVAIL-UPTIME">
      <Category>Availability</Category>
      <Description>System uptime target</Description>
      <Metric>99.9% availability</Metric>
    </Requirement>

    <Requirement id="NFR-AVAIL-GRACEFUL">
      <Category>Availability</Category>
      <Description>Graceful degradation when dependencies fail</Description>
      <Metric>Core CPQ browsing remains available when optional integrations fail</Metric>
    </Requirement>

    <!-- Security -->
    <Requirement id="NFR-SEC-AUTHENTICATION">
      <Category>Security</Category>
      <Description>Authentication mechanism</Description>
      <Specification>OAuth2/OIDC with JWT tokens; all services act as resource servers</Specification>
    </Requirement>

    <Requirement id="NFR-SEC-RBAC">
      <Category>Security</Category>
      <Description>Role-based access control</Description>
      <Specification>
        Four role domains: B2C (CUSTOMER), B2B (DEALER), Staff (SALES_MANAGER, ADMIN),
        Field (MEASUREMENT_TECH, INSTALLER, LOGISTICS, WAREHOUSE).
        Fine-grained permissions enforced at service level.
      </Specification>
      <Links>
        <Link ref="UC-RBAC-01" />
      </Links>
    </Requirement>

    <Requirement id="NFR-SEC-PAYMENT">
      <Category>Security</Category>
      <Description>Payment security</Description>
      <Specification>
        PCI compliance delegated to payment provider.
        No card data stored in our systems.
        Webhook signatures verified.
        Payment tokens used for references.
      </Specification>
    </Requirement>

    <!-- Auditability -->
    <Requirement id="NFR-AUDIT-STATUS">
      <Category>Auditability</Category>
      <Description>Status change audit trail</Description>
      <Specification>
        All status changes audited with: timestamp, actor/system, source (manual/integration),
        entity ID, old/new status, correlation ID.
      </Specification>
      <Links>
        <Link ref="UC-AUDIT-01" />
        <Link ref="StatusModel" />
      </Links>
    </Requirement>

    <!-- Observability -->
    <Requirement id="NFR-OBS-LOGGING">
      <Category>Observability</Category>
      <Description>Structured logging</Description>
      <Specification>JSON-formatted logs with traceId, spanId, correlationId</Specification>
    </Requirement>

    <Requirement id="NFR-OBS-METRICS">
      <Category>Observability</Category>
      <Description>Metrics collection</Description>
      <Specification>
        Business metrics: cpq_calculations_total, orders_placed_total, measurement_requests_total.
        Technical metrics: request latency, error rates, JVM stats.
      </Specification>
    </Requirement>

    <!-- Testability -->
    <Requirement id="NFR-MAINT-TESTABILITY">
      <Category>Maintainability</Category>
      <Description>Testability</Description>
      <Specification>
        80% code coverage minimum.
        Testing pyramid: unit, slice, integration, contract tests.
      </Specification>
    </Requirement>

    <Requirement id="NFR-MAINT-MODULARITY">
      <Category>Maintainability</Category>
      <Description>Modular architecture</Description>
      <Specification>
        Hexagonal architecture enforced via ArchUnit.
        Domain layer has no framework dependencies.
      </Specification>
    </Requirement>

    <Requirement id="NFR-CODE-DOMAIN-ERROR-HANDLING">
      <Category>Code Quality</Category>
      <Description>Consistent domain error handling pattern</Description>
      <Specification>
        All domain layer validation failures MUST use typed domain exceptions created via
        static factory classes (e.g., CatalogDomainErrors, PricingDomainErrors).
        IllegalArgumentException/IllegalStateException are prohibited in domain layer for
        business rule violations. Error codes follow convention: ERR-{SERVICE-PREFIX}-{ERROR-TYPE}.
      </Specification>
      <Rationale>
        Typed domain errors enable: (1) consistent API error responses with codes clients can handle,
        (2) structured logging for observability, (3) clear distinction between programming errors
        and business rule violations, (4) testable error conditions.
      </Rationale>
      <Metric>Zero IllegalArgumentException in domain packages for business rule violations</Metric>
      <Links>
        <Link ref="Technology.xml#DEC-DOMAIN-ERROR-PATTERN" />
        <Link ref="Technology.xml#DEC-ERROR-CODE-REGISTRY" />
      </Links>
    </Requirement>
  </NonFunctionalRequirements>

  <!-- Field Operations (BP-ISSUE-001 Resolution) -->
  <Requirement id="NFR-FIELD-OFFLINE">
    <Category>Field Operations</Category>
    <Description>Offline capability for field technicians</Description>
    <Specification>
      Field operations (measurement and installation) support offline-first capability:
      - Data cached locally on mobile devices for offline access
      - Optimistic locking with version vectors for conflict detection
      - Timestamp-based auto-resolution for non-conflicting changes
      - Manual review queue for conflicting field updates
      - Automatic sync on reconnect with retry mechanism (exponential backoff)
      - Offline task queue with at-least-once delivery guarantee
    </Specification>
    <ConflictResolutionStrategy>
      <Rule priority="1">Non-conflicting changes: auto-merge using last-write-wins per field</Rule>
      <Rule priority="2">Conflicting measurement values: queue for supervisor review</Rule>
      <Rule priority="3">Status transitions: server state wins, local changes re-queued</Rule>
    </ConflictResolutionStrategy>
    <Links>
      <Link ref="DevelopmentPlan.xml#DP-SVC-field-ops-service" />
    </Links>
  </Requirement>

  <!-- Internationalization -->
  <Requirement id="NFR-I18N-MULTI-LANGUAGE">
    <Category>Internationalization</Category>
    <Description>Multi-language support</Description>
    <Specification>
      Product descriptions, UI, and notifications support multiple languages.
      LocalizedString value object in shared-kernel.
    </Specification>
  </Requirement>

  <Decision id="DEC-OPEN-CPQ-RULES">
    <Topic>CPQ rules/options governance</Topic>
    <Question>Who owns configuration rules? How are they maintained?</Question>
    <Status>OPEN</Status>
    <Blocking>false</Blocking>
  </Decision>

  <Decision id="DEC-OPEN-CAD-FORMAT">
    <Topic>CAD integration format/SLA</Topic>
    <Question>What API format for CAD integration? What is acceptable response time?</Question>
    <Status>OPEN</Status>
    <Blocking>false</Blocking>
  </Decision>

  <Decision id="DEC-OPEN-ESIGN">
    <Topic>E-signing legal level</Topic>
    <Question>What level of e-signature is legally required? Simple checkbox vs qualified e-sign?</Question>
    <Status>OPEN</Status>
    <Blocking>false</Blocking>
  </Decision>

  <Decision id="DEC-OPEN-STATUS-SOT">
    <Topic>Status source of truth</Topic>
    <Question>For production/logistics statuses, is ERP/logistics the SoT or do we maintain
      parallel?</Question>
    <Status>OPEN</Status>
    <Blocking>true</Blocking>
    <Recommendation>Define clear ownership in integration contract</Recommendation>
  </Decision>

  <Decision id="DEC-OPEN-NOTIF-CHANNELS">
    <Topic>Notification channels/templates/events</Topic>
    <Question>Which events trigger which channels? Template ownership?</Question>
    <Status>OPEN</Status>
    <Blocking>false</Blocking>
  </Decision>
  </OpenDecisions>

  <!-- 
       DOMAIN GLOSSARY (BP-ISSUE-002 Resolution)
        -->
  <DomainGlossary>
    <Entity id="DealerPriceView">
      <Name>Dealer Price View</Name>
      <Description>
        B2B dealer-specific pricing visibility model (BP-ISSUE-002 Resolution).
        Dealers see comprehensive pricing breakdown while customers see only final price.
      </Description>
      <BoundedContext>pricing</BoundedContext>
      <Attributes>
        <Attribute name="baseCostPrice" type="Money">Wholesale cost price visible to dealer</Attribute>
        <Attribute name="marginPercentage" type="Percentage">Dealer's configured margin</Attribute>
        <Attribute name="marginAmount" type="Money">Calculated margin amount</Attribute>
        <Attribute name="finalCustomerPrice" type="Money">Price shown to end customer</Attribute>
        <Attribute name="optionPremiums" type="List[OptionPremium]">Itemized option price breakdown</Attribute>
        <Attribute name="dealerTier" type="DealerTier">Partner tier affecting margin rules</Attribute>
      </Attributes>
      <AccessControl>
        <Rule>Only users with B2B_DEALER role can access baseCostPrice and marginPercentage</Rule>
        <Rule>Customers see only finalCustomerPrice regardless of channel</Rule>
        <Rule>API enforces role-based field filtering at serialization layer</Rule>
      </AccessControl>
      <Links>
        <Link ref="DevelopmentPlan.xml#DP-SVC-pricing-service" />
      </Links>
    </Entity>
  </DomainGlossary>

  <!-- 
       MEASUREMENT VARIANCE HANDLING (BP-ISSUE-003 Resolution)
        -->
  <MeasurementVarianceRules id="MeasurementVarianceHandling">
    <Description>
      Rules for handling price changes when actual measurements differ from customer estimates.
      Applied after technician submits measurement results.
    </Description>
    <ThresholdRules>
      <Rule id="MVR-AUTO-ACCEPT" threshold="5">
        <Condition>Price variance &lt;= 5%</Condition>
        <Action>Auto-accept with notification to customer</Action>
        <Notification>Email/SMS informing of minor adjustment, no action required</Notification>
      </Rule>
      <Rule id="MVR-CONFIRMATION" threshold="10">
        <Condition>Price variance between 5% and 10%</Condition>
        <Action>Require customer confirmation via email/SMS link</Action>
        <Notification>Email/SMS with updated quote and one-click confirm/reject link</Notification>
        <Timeout>72 hours before quote expires</Timeout>
      </Rule>
      <Rule id="MVR-REQUOTE" threshold="unlimited">
        <Condition>Price variance &gt; 10%</Condition>
        <Action>Generate new quote, require full re-approval flow</Action>
        <Notification>Email/SMS explaining significant change, link to review new quote</Notification>
        <Flow>Customer must revisit configurator to accept updated configuration</Flow>
      </Rule>
    </ThresholdRules>
    <CustomerOverride>
      Customer can always request manual review regardless of threshold by contacting support.
    </CustomerOverride>
    <AuditRequirement>
      All variance decisions logged with: original quote, measured quote, variance percentage,
      rule applied, customer response, timestamp.
    </AuditRequirement>
    <Links>
      <Link ref="DevelopmentPlan.xml#Flow-Measurement-Visit" />
    </Links>
  </MeasurementVarianceRules>

  <!-- 
       PROOF OF DELIVERY REQUIREMENTS (BP-ISSUE-004 Resolution)
        -->
  <ProofOfDeliveryRequirements id="PODRequirements">
    <Description>
      Requirements for valid proof of delivery documentation.
      Both photo and signature are required for standard delivery.
    </Description>
    <RequiredElements>
      <Element id="POD-PHOTO" required="true">
        <Name>GPS-Tagged Photo</Name>
        <Description>Photo of delivered goods at customer location</Description>
        <Requirements>
          <Item>Minimum resolution: 1280x720</Item>
          <Item>GPS coordinates embedded in EXIF data</Item>
          <Item>Timestamp embedded in EXIF data</Item>
          <Item>Must show delivered items and location context</Item>
        </Requirements>
      </Element>
      <Element id="POD-SIGNATURE" required="true">
        <Name>Digital Signature</Name>
        <Description>Customer signature captured on delivery device</Description>
        <Requirements>
          <Item>Touch/stylus signature capture</Item>
          <Item>Signer name (printed)</Item>
          <Item>Timestamp of signature</Item>
          <Item>Device ID for audit trail</Item>
        </Requirements>
      </Element>
      <Element id="POD-CONFIRMATION" required="false">
        <Name>Customer Confirmation</Name>
        <Description>Optional email/SMS confirmation within 24 hours</Description>
        <Requirements>
          <Item>Automated notification sent post-delivery</Item>
          <Item>One-click confirm/report-issue link</Item>
          <Item>24-hour response window before auto-confirm</Item>
        </Requirements>
      </Element>
    </RequiredElements>
    <FallbackScenarios>
      <Scenario id="POD-FALLBACK-NEIGHBOR">
        <Condition>Customer unavailable at delivery time</Condition>
        <Requirements>
          <Item>Neighbor delivery with neighbor's signature</Item>
          <Item>Photo of delivered goods at neighbor location</Item>
          <Item>Written note with neighbor's name and address</Item>
          <Item>Customer notification of neighbor delivery</Item>
        </Requirements>
      </Scenario>
      <Scenario id="POD-FALLBACK-SAFE-PLACE">
        <Condition>Customer pre-authorized safe place delivery</Condition>
        <Requirements>
          <Item>Photo of goods in designated safe place</Item>
          <Item>No signature required if pre-authorized</Item>
          <Item>Immediate customer notification</Item>
        </Requirements>
      </Scenario>
    </FallbackScenarios>
    <DataStructure>
      <Field name="orderId" type="UUID">Reference to order</Field>
      <Field name="deliveryTimestamp" type="DateTime">Actual delivery time</Field>
      <Field name="photoUrls" type="List[URL]">GPS-tagged delivery photos</Field>
      <Field name="signatureData" type="SignatureCapture">Digital signature blob</Field>
      <Field name="signerName" type="String">Name of person who signed</Field>
      <Field name="signerRelation" type="Enum">CUSTOMER, NEIGHBOR, AGENT</Field>
      <Field name="gpsCoordinates" type="GeoPoint">Delivery location</Field>
      <Field name="deviceId" type="String">Delivery device identifier</Field>
      <Field name="notes" type="String">Optional delivery notes</Field>
      <Field name="confirmationStatus" type="Enum">PENDING, CONFIRMED, DISPUTED</Field>
    </DataStructure>
    <Links>
      <Link ref="DevelopmentPlan.xml#INT-LOGISTICS" />
    </Links>
  </ProofOfDeliveryRequirements>

  <!-- 
       ASSUMPTIONS
       =============================================================================== -->
  <Assumptions>
    <Assumption id="ASSUM-001">
      Single frontend SPA consuming REST APIs; mobile apps for field staff use same APIs.
    </Assumption>
    <Assumption id="ASSUM-002">
      Measurement technicians and installers use mobile-friendly web or native app.
    </Assumption>
    <Assumption id="ASSUM-003">
      External CRM/ERP exists but our system is SoT for lead/deal pipeline stages.
    </Assumption>
    <Assumption id="ASSUM-004">
      Payment gateway handles PCI compliance; we never store card data.
    </Assumption>
    <Assumption id="ASSUM-005">
      Initial launch targets single market; multi-market is future scope.
    </Assumption>
  </Assumptions>

</RequirementsAnalysis>