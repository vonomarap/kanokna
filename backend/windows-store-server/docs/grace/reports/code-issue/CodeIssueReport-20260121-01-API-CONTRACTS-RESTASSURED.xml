<?xml version="1.0" encoding="UTF-8"?>
<!--
  GRACE Code Issue Report: API Contracts Spring Cloud Contract Architecture Issue
  Created: 2026-01-21T15:30:00+03:00
  Updated: 2026-01-21T16:50:00+03:00
  CreatedBy: GRACE-COORDINATOR
  UpdatedBy: GRACE-ARCHITECT (Opus 4.5)
  Context: Discovered during CWO-20260121-01 verification

  REVISION HISTORY:
  v1.0 (2026-01-21T15:30:00+03:00) - Initial report: missing RestAssured dependency
  v2.0 (2026-01-21T16:50:00+03:00) - REVISED: Root cause is architectural, not dependency
-->
<CodeIssueReport
  id="CODE-ISS-RPT-20260121-01"
  version="2.0"
  context="CWO-20260121-01-SECURITY-SCAN-REMEDIATION verification"
  gateStatus="RESOLVED"
  created="2026-01-21T15:30:00+03:00"
  updated="2026-01-21T16:50:00+03:00"
  validatedBy="GRACE-ARCHITECT"
>
  <Summary>
    Full build (mvn clean verify) fails at api-contracts module. Original diagnosis
    (missing RestAssured dependency) was incomplete. The actual root cause is
    architectural: Spring Cloud Contract Verifier tests execute in api-contracts
    (a library module) but require MockMVC with actual controllers, which this
    module cannot provide by design.

    Security remediation work (CWO-20260121-01) is complete and passes module-level
    verification. This is a pre-existing infrastructure issue.
  </Summary>

  <Issue id="ISS-API-CONTRACTS-001" status="RESOLVED">
    <Severity>BLOCKING</Severity>
    <Title>Spring Cloud Contract Verifier in Wrong Module</Title>

    <OriginalDescription status="SUPERSEDED">
      Spring Cloud Contract Maven plugin generates contract tests that require RestAssured MockMvc,
      but the api-contracts/pom.xml does not include the io.rest-assured:spring-mock-mvc dependency.
    </OriginalDescription>

    <RevisedDescription>
      Spring Cloud Contract Verifier is incorrectly configured in api-contracts (a library module).
      The verifier generates tests that require MockMVC context with actual REST controllers.
      Since api-contracts is defined as a framework-free contract definition module, it cannot
      provide controllers, and tests fail at runtime regardless of dependencies present.
    </RevisedDescription>

    <Evidence>
      <Item>File: api-contracts/pom.xml</Item>
      <Item>Has: spring-cloud-contract-maven-plugin with extensions=true</Item>
      <Item>Has: spring-cloud-contract-spec, spring-cloud-contract-verifier (test scope)</Item>
      <Item>Has: io.rest-assured:spring-mock-mvc (added, but insufficient)</Item>
      <Item>Has: Contract DSL files in src/test/resources/contracts/</Item>
      <Item>Generated: Pricing_serviceTest.java requiring MockMVC instance</Item>
      <Item>Error: IllegalStateException - "You haven't configured a MockMVC instance"</Item>
    </Evidence>

    <RootCauseAnalysis>
      <Finding id="RCA-01">
        api-contracts is defined as a library module for contract definitions only
        (Protobuf schemas, OpenAPI specs). Per Technology.xml and GRACE architecture,
        it MUST NOT depend on Spring Boot runtime or contain controller implementations.
      </Finding>
      <Finding id="RCA-02">
        Spring Cloud Contract verifier tests belong in producer services (services that
        implement the APIs), not in the contract definition module.
      </Finding>
      <Finding id="RCA-03">
        The contract DSL file (calculate_quote.groovy) defines a REST contract for
        pricing-service. This contract should be verified in pricing-service against
        the actual PricingController implementation.
      </Finding>
    </RootCauseAnalysis>

    <Impact>
      Full build fails. PR creation blocked for any work requiring full build verification.
    </Impact>

    <Resolution>
      <AWORef>AWO-20260121-02-API-CONTRACTS-RESTASSURED</AWORef>
      <Decision>Producer-Side Verification (Option A)</Decision>
      <Actions>
        <Action id="A-01">Remove spring-cloud-contract-maven-plugin from api-contracts</Action>
        <Action id="A-02">Remove spring-cloud-contract-* dependencies from api-contracts</Action>
        <Action id="A-03">Remove rest-assured dependency from api-contracts</Action>
        <Action id="A-04">Delete contracts directory from api-contracts</Action>
        <Action id="A-05" status="DEFERRED">Move contracts to producer services (future work)</Action>
      </Actions>
    </Resolution>

    <RequiredAgent>GRACE-CODER (implementation per AWO-20260121-02)</RequiredAgent>
  </Issue>

  <Recommendation status="SUPERSEDED">
    <!-- Original recommendation no longer applies -->
    <OriginalText>
      Two options for human decision:
      OPTION A (Recommended): Create separate bugfix for api-contracts dependency, merge first.
      OPTION B: Scope-expand CWO-20260121-01 to include api-contracts fix.
    </OriginalText>
    <RevisedRecommendation>
      GRACE-ARCHITECT has determined the correct solution is to remove Spring Cloud Contract
      verifier infrastructure from api-contracts entirely (not just add dependencies).
      AWO-20260121-02 provides the approved blueprint for GRACE-CODER implementation.
    </RevisedRecommendation>
  </Recommendation>

  <Links>
    <Link ref="AWO-20260121-02-API-CONTRACTS-RESTASSURED.xml"/>
    <Link ref="Technology.xml#TECH-spring-cloud"/>
    <Link ref="DevelopmentPlan.xml#DP-SVC-api-contracts"/>
  </Links>
</CodeIssueReport>
