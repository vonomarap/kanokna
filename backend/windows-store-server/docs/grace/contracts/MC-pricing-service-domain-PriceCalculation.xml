<?xml version="1.0" encoding="UTF-8"?>
<!--
  GRACE Semantic Contract: MODULE_CONTRACT
  Service: pricing-service
  Layer: domain.service
  Purpose: Price calculation domain service contract

  CANONICAL SOURCE: This file MUST match the embedded contract in
  Handoff-20251231-02-v2-W1-T3-T4-PricingService.xml (lines 491-593)

  Last synchronized: 2025-12-31
-->
<MODULE_CONTRACT
    id="MC-pricing-service-domain-PriceCalculation"
    ROLE="DomainService"
    SERVICE="pricing-service"
    LAYER="domain"
    BOUNDED_CONTEXT="pricing"
    SPECIFICATION="UC-PRICING-QUOTE">

  <PURPOSE>
    Domain service that calculates price quotes for validated product configurations.
    Orchestrates base price calculation, option premiums, discounts, and taxes to
    produce itemized quotes with full decision trace for auditability.
  </PURPOSE>

  <RESPONSIBILITIES>
    <Item>Load active price book for product template</Item>
    <Item>Calculate base price from area (m²) and price_per_m2</Item>
    <Item>Apply option premiums (ABSOLUTE or PERCENTAGE)</Item>
    <Item>Apply campaign discounts (if active campaigns exist)</Item>
    <Item>Apply promo code discounts (if provided and valid)</Item>
    <Item>Enforce discount cap (30% max combined)</Item>
    <Item>Calculate regional tax (VAT)</Item>
    <Item>Apply currency-specific rounding</Item>
    <Item>Build decision trace for audit</Item>
  </RESPONSIBILITIES>

  <INVARIANTS>
    <Item>Quote calculation is deterministic for same inputs</Item>
    <Item>Base price is always positive</Item>
    <Item>Combined discounts never exceed 30% of subtotal</Item>
    <Item>Tax is calculated on discounted subtotal</Item>
    <Item>All amounts use correct currency precision</Item>
  </INVARIANTS>

  <CONTEXT>
    <UPSTREAM>
      <Item>PricingGrpcService: receives requests from catalog-configuration-service</Item>
      <Item>PricingController: REST API for direct quote requests</Item>
    </UPSTREAM>
    <DOWNSTREAM>
      <Item>PriceBookRepository: loads price books</Item>
      <Item>CampaignRepository: loads active campaigns</Item>
      <Item>PromoCodeRepository: validates promo codes</Item>
      <Item>TaxRuleRepository: loads tax rules</Item>
      <Item>QuoteCache: caches calculated quotes</Item>
    </DOWNSTREAM>
  </CONTEXT>

  <ARCHITECTURE>
    <TECHNOLOGY>
      <Item ref="Technology.xml#TECH-java">Java 25 with records for Quote and components</Item>
      <Item>Pure domain logic; depends only on shared-kernel Money</Item>
      <Item>Caching handled by application layer via QuoteCache port</Item>
    </TECHNOLOGY>
    <PACKAGE>com.kanokna.pricing_service.domain.service</PACKAGE>
    <CLASS>PriceCalculationService</CLASS>
  </ARCHITECTURE>

  <PUBLIC_API>
    <Method name="calculateQuote" input="CalculateQuoteCommand" output="Quote"/>
  </PUBLIC_API>

  <BUSINESS_RULES>
    <Rule id="BR-PRC-001">Base price = max(area_m2, minimum_area_m2) * price_per_m2 (minimum_area_m2 default: 0.25m²)</Rule>
    <Rule id="BR-PRC-002">ABSOLUTE premiums add fixed amount</Rule>
    <Rule id="BR-PRC-003">PERCENTAGE premiums add (base_price * percentage / 100)</Rule>
    <Rule id="BR-PRC-004">Campaign discounts apply to subtotal before promo codes</Rule>
    <Rule id="BR-PRC-005">Combined discounts capped at 30%</Rule>
    <Rule id="BR-PRC-006">Russia VAT is 20% on discounted subtotal</Rule>
    <Rule id="BR-PRC-007">Final price rounded HALF_UP to 2 decimals for RUB</Rule>
  </BUSINESS_RULES>

  <ERROR_HANDLING>
    <Item type="BUSINESS" code="ERR-PRC-NO-PRICEBOOK">No active price book for product</Item>
    <Item type="BUSINESS" code="ERR-PRC-INVALID-PROMO">Promo code invalid, expired, or exhausted</Item>
    <Item type="BUSINESS" code="ERR-PRC-NO-TAXRULE">No tax rule for region</Item>
    <Item type="BUSINESS" code="ERR-PRC-DISCOUNT-EXCEEDED">Combined discounts exceed 30% cap</Item>
    <Item type="TECHNICAL" code="ERR-PRC-CALCULATION-FAILED">Unexpected calculation error</Item>
  </ERROR_HANDLING>

  <LOGGING>
    <FORMAT>[SVC=pricing-service][UC=UC-PRICING-QUOTE][BLOCK=...][STATE=...] eventType=... decision=... keyValues=...</FORMAT>
    <EXAMPLES>
      <Item>[SVC=pricing-service][UC=UC-PRICING-QUOTE][BLOCK=BA-PRC-CALC-01][STATE=LOAD_PRICEBOOK] eventType=PRICING_STEP decision=FOUND keyValues=priceBookId,productTemplateId</Item>
      <Item>[SVC=pricing-service][UC=UC-PRICING-QUOTE][BLOCK=BA-PRC-CALC-99][STATE=FINAL] eventType=QUOTE_CALCULATED decision=SUCCESS keyValues=quoteId,total_rub</Item>
    </EXAMPLES>
  </LOGGING>

  <TESTS>
    <Case id="TC-PRC-001">Standard configuration returns correct base price</Case>
    <Case id="TC-PRC-002">Option premiums (ABSOLUTE) added correctly</Case>
    <Case id="TC-PRC-003">Option premiums (PERCENTAGE) calculated on base price</Case>
    <Case id="TC-PRC-004">Active campaign discount applied</Case>
    <Case id="TC-PRC-005">Valid promo code discount applied</Case>
    <Case id="TC-PRC-006">Campaign + promo stacking respects 30% cap</Case>
    <Case id="TC-PRC-007">Russia VAT (20%) calculated correctly</Case>
    <Case id="TC-PRC-008">Missing price book returns ERR-PRC-NO-PRICEBOOK</Case>
    <Case id="TC-PRC-009">Invalid promo code returns ERR-PRC-INVALID-PROMO</Case>
    <Case id="TC-PRC-010">Expired campaign not applied</Case>
    <Case id="TC-PRC-011">Quote cached and retrieved on repeat request</Case>
    <Case id="TC-PRC-012">Decision trace contains all calculation steps</Case>
  </TESTS>

  <LINKS>
    <Link ref="RequirementsAnalysis.xml#UC-PRICING-QUOTE"/>
    <Link ref="DevelopmentPlan.xml#DP-SVC-pricing-service"/>
    <Link ref="DevelopmentPlan.xml#Flow-Config-Pricing"/>
    <Link ref="Technology.xml#DEC-ARCH-RULE-ENGINE-STRATEGY"/>
  </LINKS>

</MODULE_CONTRACT>
