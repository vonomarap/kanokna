<!--
  ═══════════════════════════════════════════════════════════════════════════════
  GRACE FUNCTION CONTRACTS: account-service
  ═══════════════════════════════════════════════════════════════════════════════
  Service:         account-service
  Wave:            W1 (CPQ Core)
  Task:            W1-T2
  Schema Version:  grace-markup-v2
  Created:         2026-01-08T14:20:25+03:00
  Author:          GRACE-ARCHITECT
  
  Contains FUNCTION_CONTRACTs for:
  - FC-account-getProfile
  - FC-account-updateProfile
  - FC-account-saveConfiguration
  - FC-account-manageAddresses
  ═══════════════════════════════════════════════════════════════════════════════
-->
<FUNCTION_CONTRACTS service="account-service">

    <!-- ═══════════════════════════════════════════════════════════════════════ -->
    <!-- FC-account-getProfile                                                   -->
    <!-- ═══════════════════════════════════════════════════════════════════════ -->
    <FUNCTION_CONTRACT id="FC-account-getProfile"
        LAYER="application.service"
        INTENT="Retrieve user profile by userId, creating from Keycloak claims if first access"
        INPUT="GetProfileQuery(userId: UUID)"
        OUTPUT="UserProfileDTO"
        SIDE_EFFECTS="May create profile on first access (write)"
        LINKS="RequirementsAnalysis.xml#UC-ACCOUNT-MANAGE-PROFILE;DevelopmentPlan.xml#DP-SVC-account-service">

        <PRECONDITIONS>
            <Item>userId is a valid UUID (from JWT sub claim)</Item>
            <Item>Caller is authenticated (JWT token present)</Item>
            <Item>Caller userId matches requested userId OR caller has ADMIN role</Item>
        </PRECONDITIONS>

        <POSTCONDITIONS>
            <Item>Returns UserProfileDTO with all profile fields populated</Item>
            <Item>If profile did not exist, it is created from Keycloak claims and
                UserProfileCreatedEvent is emitted</Item>
            <Item>Profile includes list of saved addresses</Item>
        </POSTCONDITIONS>

        <INVARIANTS>
            <Item>Profile is always returned for valid authenticated user (auto-create on first
                access)</Item>
            <Item>Read operation is idempotent for existing profiles</Item>
        </INVARIANTS>

        <ERROR_HANDLING>
            <Item type="BUSINESS" code="ERR-ACCT-UNAUTHORIZED">Caller attempting to access another
                user's profile without ADMIN role</Item>
            <Item type="TECHNICAL" code="ERR-ACCT-KEYCLOAK-UNAVAILABLE">Cannot fetch claims from
                Keycloak (rare, fallback to minimal profile)</Item>
        </ERROR_HANDLING>

        <BLOCK_ANCHORS>
            <Item id="BA-ACCT-PROF-01">Fetch user profile from repository</Item>
            <Item id="BA-ACCT-PROF-03">Sync profile from Keycloak on first login</Item>
        </BLOCK_ANCHORS>

        <LOGGING>
            <Item>[SVC=account-service][UC=UC-ACCOUNT-MANAGE-PROFILE][BLOCK=BA-ACCT-PROF-01][STATE=FETCHING]
                eventType=PROFILE_GET decision=LOOKUP keyValues=userId={uuid}</Item>
            <Item>[SVC=account-service][UC=UC-ACCOUNT-MANAGE-PROFILE][BLOCK=BA-ACCT-PROF-03][STATE=SYNCING]
                eventType=PROFILE_SYNC decision=CREATE_FROM_KEYCLOAK
                keyValues=userId={uuid},email={masked}</Item>
            <Item>[SVC=account-service][UC=UC-ACCOUNT-MANAGE-PROFILE][BLOCK=BA-ACCT-PROF-01][STATE=COMPLETE]
                eventType=PROFILE_GET decision=SUCCESS keyValues=userId={uuid},addressCount={n}</Item>
        </LOGGING>

        <TESTS>
            <Case id="TC-FUNC-PROF-001">Get profile for existing user returns complete
                UserProfileDTO</Case>
            <Case id="TC-FUNC-PROF-002">Get profile for new user creates profile from Keycloak
                claims</Case>
            <Case id="TC-FUNC-PROF-003">Get profile for another user without ADMIN role returns
                UNAUTHORIZED</Case>
            <Case id="TC-FUNC-PROF-004">ADMIN can access any user's profile</Case>
        </TESTS>

        <gRPC_MAPPING>
            <Method>AccountService.GetProfile</Method>
            <ProtoRequest>GetProfileRequest</ProtoRequest>
            <ProtoResponse>GetProfileResponse</ProtoResponse>
        </gRPC_MAPPING>
    </FUNCTION_CONTRACT>

    <!-- ═══════════════════════════════════════════════════════════════════════ -->
    <!-- FC-account-updateProfile                                                -->
    <!-- ═══════════════════════════════════════════════════════════════════════ -->
    <FUNCTION_CONTRACT id="FC-account-updateProfile"
        LAYER="application.service"
        INTENT="Update user profile fields (name, phone, preferences)"
        INPUT="UpdateProfileCommand(userId: UUID, firstName?: String, lastName?: String, phoneNumber?: String, preferredLanguage?: String, preferredCurrency?: String)"
        OUTPUT="UserProfileDTO"
        SIDE_EFFECTS="Persists profile changes, emits UserProfileUpdatedEvent"
        LINKS="RequirementsAnalysis.xml#UC-ACCOUNT-MANAGE-PROFILE;DevelopmentPlan.xml#DP-SVC-account-service">

        <PRECONDITIONS>
            <Item>userId is a valid UUID</Item>
            <Item>Profile exists for userId (auto-created on first getProfile)</Item>
            <Item>Caller is authenticated and owns this profile OR has ADMIN role</Item>
            <Item>At least one update field is provided</Item>
            <Item>If provided, phoneNumber matches valid phone format</Item>
            <Item>If provided, preferredLanguage is valid BCP-47 tag</Item>
            <Item>If provided, preferredCurrency is valid ISO-4217 code</Item>
        </PRECONDITIONS>

        <POSTCONDITIONS>
            <Item>Specified fields are updated in persistent storage</Item>
            <Item>updatedAt timestamp is refreshed</Item>
            <Item>UserProfileUpdatedEvent is published with list of changed fields</Item>
            <Item>Returns updated UserProfileDTO</Item>
        </POSTCONDITIONS>

        <INVARIANTS>
            <Item>Email cannot be updated via this method (managed by Keycloak)</Item>
            <Item>Optimistic locking prevents concurrent update conflicts</Item>
            <Item>Update is idempotent if same values are provided</Item>
        </INVARIANTS>

        <ERROR_HANDLING>
            <Item type="BUSINESS" code="ERR-ACCT-PROFILE-NOT-FOUND">Profile does not exist for
                userId</Item>
            <Item type="BUSINESS" code="ERR-ACCT-UNAUTHORIZED">Caller not owner and not ADMIN</Item>
            <Item type="BUSINESS" code="ERR-ACCT-INVALID-PHONE">Phone number format invalid</Item>
            <Item type="BUSINESS" code="ERR-ACCT-INVALID-LANGUAGE">Language code not recognized</Item>
            <Item type="BUSINESS" code="ERR-ACCT-INVALID-CURRENCY">Currency code not recognized</Item>
            <Item type="TECHNICAL" code="ERR-ACCT-CONCURRENT-MODIFICATION">Optimistic lock failure
                (retry)</Item>
        </ERROR_HANDLING>

        <BLOCK_ANCHORS>
            <Item id="BA-ACCT-PROF-01">Fetch user profile from repository</Item>
            <Item id="BA-ACCT-PROF-02">Validate and apply profile updates</Item>
        </BLOCK_ANCHORS>

        <LOGGING>
            <Item>[SVC=account-service][UC=UC-ACCOUNT-MANAGE-PROFILE][BLOCK=BA-ACCT-PROF-01][STATE=FETCHING]
                eventType=PROFILE_UPDATE_START decision=LOOKUP keyValues=userId={uuid}</Item>
            <Item>[SVC=account-service][UC=UC-ACCOUNT-MANAGE-PROFILE][BLOCK=BA-ACCT-PROF-02][STATE=VALIDATING]
                eventType=PROFILE_UPDATE decision=VALIDATE keyValues=userId={uuid},fields={list}</Item>
            <Item>[SVC=account-service][UC=UC-ACCOUNT-MANAGE-PROFILE][BLOCK=BA-ACCT-PROF-02][STATE=UPDATED]
                eventType=PROFILE_UPDATED decision=COMMIT keyValues=userId={uuid},fields={list}</Item>
        </LOGGING>

        <TESTS>
            <Case id="TC-FUNC-UPD-001">Update first name and last name succeeds</Case>
            <Case id="TC-FUNC-UPD-002">Update phone number with valid format succeeds</Case>
            <Case id="TC-FUNC-UPD-003">Update phone number with invalid format returns
                ERR-ACCT-INVALID-PHONE</Case>
            <Case id="TC-FUNC-UPD-004">Update with no fields provided returns validation error</Case>
            <Case id="TC-FUNC-UPD-005">Concurrent updates with version conflict are handled</Case>
        </TESTS>

        <gRPC_MAPPING>
            <Method>AccountService.UpdateProfile</Method>
            <ProtoRequest>UpdateProfileRequest</ProtoRequest>
            <ProtoResponse>UpdateProfileResponse</ProtoResponse>
        </gRPC_MAPPING>
    </FUNCTION_CONTRACT>

    <!-- ═══════════════════════════════════════════════════════════════════════ -->
    <!-- FC-account-saveConfiguration                                            -->
    <!-- ═══════════════════════════════════════════════════════════════════════ -->
    <FUNCTION_CONTRACT id="FC-account-saveConfiguration"
        LAYER="application.service"
        INTENT="Save a product configuration as draft for later retrieval and checkout"
        INPUT="SaveConfigurationCommand(userId: UUID, name: String, productTemplateId: UUID, configurationSnapshot: JSON, quoteSnapshot?: JSON)"
        OUTPUT="SavedConfigurationDTO(configurationId: UUID)"
        SIDE_EFFECTS="Persists configuration, emits ConfigurationSavedEvent"
        LINKS="RequirementsAnalysis.xml#UC-B2C-CPQ-01;DevelopmentPlan.xml#DP-SVC-account-service;DevelopmentPlan.xml#Flow-B2C-CPQ">

        <PRECONDITIONS>
            <Item>userId is a valid UUID of authenticated user</Item>
            <Item>name is non-blank string (max 255 chars)</Item>
            <Item>productTemplateId is non-null UUID</Item>
            <Item>configurationSnapshot is valid JSON matching expected schema</Item>
            <Item>User is authenticated (cannot save anonymous configurations to account)</Item>
        </PRECONDITIONS>

        <POSTCONDITIONS>
            <Item>SavedConfiguration entity is persisted with generated configurationId</Item>
            <Item>createdAt and updatedAt timestamps are set</Item>
            <Item>ConfigurationSavedEvent is published</Item>
            <Item>Returns SavedConfigurationDTO with configurationId</Item>
        </POSTCONDITIONS>

        <INVARIANTS>
            <Item>configurationId is globally unique UUID</Item>
            <Item>User can have unlimited saved configurations (no limit in MVP)</Item>
            <Item>Saving same configuration twice creates separate entries (no dedup)</Item>
        </INVARIANTS>

        <ERROR_HANDLING>
            <Item type="BUSINESS" code="ERR-ACCT-INVALID-CONFIG-NAME">Name is blank or exceeds max
                length</Item>
            <Item type="BUSINESS" code="ERR-ACCT-INVALID-CONFIG-SNAPSHOT">Configuration snapshot
                fails schema validation</Item>
            <Item type="BUSINESS" code="ERR-ACCT-UNAUTHORIZED">User not authenticated</Item>
        </ERROR_HANDLING>

        <CONFIGURATION_SNAPSHOT_SCHEMA>
            <Description>Expected structure of configurationSnapshot JSONB field</Description>
            <Schema>
                {
                "productTemplateId": "UUID",
                "dimensions": {
                "width": "number (mm)",
                "height": "number (mm)",
                "unit": "mm"
                },
                "selectedOptions": [
                {
                "optionGroupId": "UUID",
                "optionId": "UUID",
                "value": "any (depends on option type)"
                }
                ],
                "accessories": [
                {
                "accessoryId": "UUID",
                "quantity": "integer >= 1"
                }
                ],
                "notes": "optional string"
                }
            </Schema>
        </CONFIGURATION_SNAPSHOT_SCHEMA>

        <BLOCK_ANCHORS>
            <Item id="BA-ACCT-CFG-01">Validate configuration snapshot structure</Item>
            <Item id="BA-ACCT-CFG-02">Persist saved configuration</Item>
            <Item id="BA-ACCT-CFG-03">Emit ConfigurationSavedEvent</Item>
        </BLOCK_ANCHORS>

        <LOGGING>
            <Item>[SVC=account-service][UC=UC-B2C-CPQ-01][BLOCK=BA-ACCT-CFG-01][STATE=VALIDATING]
                eventType=CONFIG_SAVE_START decision=VALIDATE
                keyValues=userId={uuid},productTemplateId={uuid},name={name}</Item>
            <Item>[SVC=account-service][UC=UC-B2C-CPQ-01][BLOCK=BA-ACCT-CFG-01][STATE=INVALID]
                eventType=CONFIG_SAVE decision=REJECT reason=SCHEMA_VALIDATION_FAILED
                keyValues=userId={uuid},errors={list}</Item>
            <Item>[SVC=account-service][UC=UC-B2C-CPQ-01][BLOCK=BA-ACCT-CFG-02][STATE=PERSISTING]
                eventType=CONFIG_SAVE decision=PERSIST keyValues=userId={uuid},configId={uuid}</Item>
            <Item>[SVC=account-service][UC=UC-B2C-CPQ-01][BLOCK=BA-ACCT-CFG-03][STATE=COMPLETE]
                eventType=CONFIG_SAVED decision=SUCCESS
                keyValues=userId={uuid},configId={uuid},productTemplateId={uuid}</Item>
        </LOGGING>

        <TESTS>
            <Case id="TC-FUNC-CFG-001">Save valid configuration returns configurationId</Case>
            <Case id="TC-FUNC-CFG-002">Save configuration with invalid JSON returns
                ERR-ACCT-INVALID-CONFIG-SNAPSHOT</Case>
            <Case id="TC-FUNC-CFG-003">Save configuration emits ConfigurationSavedEvent</Case>
            <Case id="TC-FUNC-CFG-004">Save configuration with quote snapshot persists both</Case>
            <Case id="TC-FUNC-CFG-005">Unauthenticated save attempt returns UNAUTHORIZED</Case>
        </TESTS>
    </FUNCTION_CONTRACT>

    <!-- ═══════════════════════════════════════════════════════════════════════ -->
    <!-- FC-account-manageAddresses                                              -->
    <!-- ═══════════════════════════════════════════════════════════════════════ -->
    <FUNCTION_CONTRACT id="FC-account-manageAddresses"
        LAYER="application.service"
        INTENT="CRUD operations for user delivery/installation addresses"
        INPUT="AddressCommand variants (Add, Update, Delete, List)"
        OUTPUT="SavedAddressDTO or List&lt;SavedAddressDTO&gt;"
        SIDE_EFFECTS="Persists address changes, emits Address*Event"
        LINKS="RequirementsAnalysis.xml#UC-ACCOUNT-MANAGE-PROFILE;DevelopmentPlan.xml#DP-SVC-account-service">

        <OPERATIONS>
            <Operation name="AddAddress">
                <Input>AddAddressCommand(userId, address: Address, label: String, setAsDefault:
                    boolean)</Input>
                <Output>SavedAddressDTO</Output>
            </Operation>
            <Operation name="UpdateAddress">
                <Input>UpdateAddressCommand(userId, addressId, address?: Address, label?: String,
                    setAsDefault?: boolean)</Input>
                <Output>SavedAddressDTO</Output>
            </Operation>
            <Operation name="DeleteAddress">
                <Input>DeleteAddressCommand(userId, addressId)</Input>
                <Output>void</Output>
            </Operation>
            <Operation name="ListAddresses">
                <Input>ListAddressesQuery(userId)</Input>
                <Output>List&lt;SavedAddressDTO&gt;</Output>
            </Operation>
        </OPERATIONS>

        <PRECONDITIONS>
            <Item>userId is valid UUID of authenticated caller</Item>
            <Item>For Update/Delete: addressId exists and belongs to userId</Item>
            <Item>Address contains required fields: street, city, postalCode, country</Item>
            <Item>Label is non-blank (max 50 chars, e.g., "Home", "Work", "Site A")</Item>
        </PRECONDITIONS>

        <POSTCONDITIONS>
            <Item>Add: New address is persisted with generated addressId</Item>
            <Item>Add with setAsDefault: Previous default is cleared</Item>
            <Item>Update: Specified fields are updated</Item>
            <Item>Delete: Address is removed from user's list</Item>
            <Item>Appropriate Event (Added, Updated, Deleted) is emitted</Item>
        </POSTCONDITIONS>

        <INVARIANTS>
            <Item>User can have at most one default address</Item>
            <Item>Setting new default clears old default</Item>
            <Item>Deleting default address does NOT auto-promote another (user must set new default)</Item>
            <Item>Duplicate addresses (same street, city, postalCode) for same user are rejected</Item>
        </INVARIANTS>

        <ERROR_HANDLING>
            <Item type="BUSINESS" code="ERR-ACCT-ADDRESS-NOT-FOUND">Address does not exist or does
                not belong to user</Item>
            <Item type="BUSINESS" code="ERR-ACCT-ADDRESS-DUPLICATE">Address with same details
                already exists</Item>
            <Item type="BUSINESS" code="ERR-ACCT-INVALID-ADDRESS">Address missing required fields or
                invalid format</Item>
            <Item type="BUSINESS" code="ERR-ACCT-LABEL-TOO-LONG">Label exceeds 50 characters</Item>
        </ERROR_HANDLING>

        <BLOCK_ANCHORS>
            <Item id="BA-ACCT-ADDR-01">Validate address input</Item>
            <Item id="BA-ACCT-ADDR-02">Check for duplicate address</Item>
            <Item id="BA-ACCT-ADDR-03">Update default address flag</Item>
        </BLOCK_ANCHORS>

        <LOGGING>
            <Item>[SVC=account-service][UC=UC-ACCOUNT-MANAGE-PROFILE][BLOCK=BA-ACCT-ADDR-01][STATE=VALIDATING]
                eventType=ADDRESS_ADD decision=VALIDATE keyValues=userId={uuid},label={label}</Item>
            <Item>[SVC=account-service][UC=UC-ACCOUNT-MANAGE-PROFILE][BLOCK=BA-ACCT-ADDR-02][STATE=CHECKING]
                eventType=ADDRESS_DUPLICATE_CHECK decision=EVALUATE
                keyValues=userId={uuid},city={city}</Item>
            <Item>[SVC=account-service][UC=UC-ACCOUNT-MANAGE-PROFILE][BLOCK=BA-ACCT-ADDR-03][STATE=UPDATING_DEFAULT]
                eventType=ADDRESS_DEFAULT decision=CLEAR_OLD
                keyValues=userId={uuid},oldDefaultId={uuid}</Item>
            <Item>[SVC=account-service][UC=UC-ACCOUNT-MANAGE-PROFILE][BLOCK=BA-ACCT-ADDR-01][STATE=COMPLETE]
                eventType=ADDRESS_ADDED decision=SUCCESS
                keyValues=userId={uuid},addressId={uuid},label={label}</Item>
        </LOGGING>

        <TESTS>
            <Case id="TC-FUNC-ADDR-001">Add address with valid input succeeds</Case>
            <Case id="TC-FUNC-ADDR-002">Add duplicate address returns ERR-ACCT-ADDRESS-DUPLICATE</Case>
            <Case id="TC-FUNC-ADDR-003">Add address with setAsDefault clears previous default</Case>
            <Case id="TC-FUNC-ADDR-004">Update address label succeeds</Case>
            <Case id="TC-FUNC-ADDR-005">Update non-existent address returns
                ERR-ACCT-ADDRESS-NOT-FOUND</Case>
            <Case id="TC-FUNC-ADDR-006">Delete address removes from list</Case>
            <Case id="TC-FUNC-ADDR-007">List addresses returns all user's addresses sorted by label</Case>
        </TESTS>

        <gRPC_MAPPING>
            <Method>AccountService.AddAddress</Method>
            <Method>AccountService.UpdateAddress</Method>
            <Method>AccountService.DeleteAddress</Method>
            <Method>AccountService.ListAddresses</Method>
        </gRPC_MAPPING>
    </FUNCTION_CONTRACT>

</FUNCTION_CONTRACTS>