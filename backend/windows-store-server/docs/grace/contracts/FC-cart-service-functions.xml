<?xml version="1.0" encoding="UTF-8"?>
<!--
  ═══════════════════════════════════════════════════════════════════════════════
  GRACE FUNCTION CONTRACTS: cart-service
  ═══════════════════════════════════════════════════════════════════════════════
  Service:         cart-service
  Version:         1.1.0
  Handoff:         Handoff-20260109-01-W1-T6-CartService
  Contract Count:  8
  Block Anchors:   44 (harmonized with Handoff IDs)
  Test Cases:      39 (harmonized with Handoff IDs)
  Created:         2026-01-09T11:00:00+03:00
  Updated:         2026-01-09T18:45:00+03:00
  Changes:         v1.1.0 - Harmonized BA-* and TC-* IDs to match Handoff
  ═══════════════════════════════════════════════════════════════════════════════
-->
<FunctionContracts id="FC-cart-service" version="1.1.0">
  <Metadata>
    <Service>cart-service</Service>
    <Module ref="MC-cart-service-domain" />
    <Author>GRACE-ARCHITECT</Author>
    <CreatedAt>2026-01-09T11:00:00+03:00</CreatedAt>
    <HandoffRef>Handoff-20260109-01-W1-T6-CartService</HandoffRef>
  </Metadata>

  <!-- ═══════════════════════════════════════════════════════════════════════════
       FC-cart-getCart: Retrieve or create cart
       ═══════════════════════════════════════════════════════════════════════════ -->
  <FunctionContract id="FC-cart-getCart">
    <Metadata>
      <Layer>application</Layer>
      <UseCase ref="UC-CART-MANAGE" />
      <Proto ref="cart_service_v1_1.proto#GetCart" />
    </Metadata>

    <Purpose>
      Retrieve existing cart or create empty cart for customer/session.
      Supports both authenticated (customer_id) and anonymous (session_id) carts.
    </Purpose>

    <Signature>
      <Input>GetCartQuery(customerId: String?, sessionId: String?)</Input>
      <Output>CartDto</Output>
    </Signature>

    <Preconditions>
      <Condition id="PRE-GC-01">At least one of customerId or sessionId must be provided</Condition>
    </Preconditions>

    <Postconditions>
      <Condition id="POST-GC-01">Returns existing cart if found, empty cart otherwise</Condition>
      <Condition id="POST-GC-02">Empty cart has ACTIVE status and zero items</Condition>
      <Condition id="POST-GC-03">Cart totals are calculated and current</Condition>
    </Postconditions>

    <BlockAnchors>
      <Anchor id="BA-CART-GET-01" location="CartApplicationService.getCart">
        Resolve cart ID from customerId or sessionId
      </Anchor>
      <Anchor id="BA-CART-GET-02" location="CartApplicationService.getCart">
        Load cart from repository
      </Anchor>
      <Anchor id="BA-CART-GET-03" location="CartApplicationService.getCart">
        Revalidate item configurations (lazy)
      </Anchor>
      <Anchor id="BA-CART-GET-04" location="CartApplicationService.getCart">
        Check price staleness for each item
      </Anchor>
      <Anchor id="BA-CART-GET-05" location="CartApplicationService.getCart">
        Return cart response
      </Anchor>
    </BlockAnchors>

    <ErrorConditions>
      <Error code="INVALID_ARGUMENT">Neither customerId nor sessionId provided</Error>
    </ErrorConditions>

    <TestCases>
      <TestCase id="TC-FUNC-CART-GET-001" type="unit">
        <Description>Get existing cart returns all items with totals</Description>
        <Given>Customer has cart with 2 items</Given>
        <When>GetCart called with customer_id</When>
        <Then>Returns cart with 2 items and calculated totals</Then>
      </TestCase>
      <TestCase id="TC-FUNC-CART-GET-002" type="unit">
        <Description>Get non-existent cart returns empty cart</Description>
        <Given>Customer has no existing cart</Given>
        <When>GetCart called with customer_id</When>
        <Then>Returns empty cart with ACTIVE status</Then>
      </TestCase>
      <TestCase id="TC-FUNC-CART-GET-003" type="unit">
        <Description>Items with stale prices marked appropriately</Description>
        <Given>Cart has item with expired quote</Given>
        <When>GetCart called</When>
        <Then>Item.price_stale = true</Then>
      </TestCase>
      <TestCase id="TC-FUNC-CART-GET-004" type="unit">
        <Description>Invalid configurations flagged in response</Description>
        <Given>Cart has item with changed catalog rules</Given>
        <When>GetCart called</When>
        <Then>Item.validation_status = INVALID</Then>
      </TestCase>
      <TestCase id="TC-FUNC-CART-GET-005" type="integration">
        <Description>Catalog service timeout uses last known validation status</Description>
        <Given>Cart has items, catalog service unavailable</Given>
        <When>GetCart called</When>
        <Then>Returns cart with validation_status = UNKNOWN</Then>
      </TestCase>
    </TestCases>

    <Dependencies>
      <Dependency type="repository">CartRepository.findByCustomerId</Dependency>
      <Dependency type="repository">CartRepository.findBySessionId</Dependency>
    </Dependencies>
  </FunctionContract>

  <!-- ═══════════════════════════════════════════════════════════════════════════
       FC-cart-addItem: Add configured product to cart
       ═══════════════════════════════════════════════════════════════════════════ -->
  <FunctionContract id="FC-cart-addItem">
    <Metadata>
      <Layer>application</Layer>
      <UseCase ref="UC-CART-MANAGE" />
      <Proto ref="cart_service_v1_1.proto#AddItem" />
    </Metadata>

    <Purpose>
      Add a configured product to the cart. Validates configuration against catalog-service,
      retrieves price quote from pricing-service, computes configuration hash for merge support.
    </Purpose>

    <Signature>
      <Input>AddItemCommand(customerId, sessionId, productTemplateId, dimensions, selectedOptions,
        quantity, quoteId?, resolvedBom)</Input>
      <Output>AddItemResult(cart: CartDto, addedItemId: String)</Output>
    </Signature>

    <Preconditions>
      <Condition id="PRE-AI-01">Cart owner identified (customerId or sessionId)</Condition>
      <Condition id="PRE-AI-02">productTemplateId is valid</Condition>
      <Condition id="PRE-AI-03">quantity >= 1</Condition>
      <Condition id="PRE-AI-04">Configuration (dimensions + options) is valid</Condition>
    </Preconditions>

    <Postconditions>
      <Condition id="POST-AI-01">Item added to cart with unique itemId</Condition>
      <Condition id="POST-AI-02">Configuration snapshot captured immutably</Condition>
      <Condition id="POST-AI-03">Price quote obtained and stored</Condition>
      <Condition id="POST-AI-04">Cart totals recalculated</Condition>
      <Condition id="POST-AI-05">CartItemAddedEvent published</Condition>
    </Postconditions>

    <BlockAnchors>
      <Anchor id="BA-CART-ADD-01" location="CartApplicationService.addItem">
        Resolve or create cart
      </Anchor>
      <Anchor id="BA-CART-ADD-02" location="CartApplicationService.addItem">
        Validate configuration via catalog-configuration-service
      </Anchor>
      <Anchor id="BA-CART-ADD-03" location="CartApplicationService.addItem">
        Get/verify price quote from pricing-service
      </Anchor>
      <Anchor id="BA-CART-ADD-04" location="CartApplicationService.addItem">
        Create CartItem with configuration snapshot
      </Anchor>
      <Anchor id="BA-CART-ADD-05" location="CartApplicationService.addItem">
        Compute configuration hash
      </Anchor>
      <Anchor id="BA-CART-ADD-06" location="CartApplicationService.addItem">
        Recalculate cart totals
      </Anchor>
      <Anchor id="BA-CART-ADD-07" location="CartApplicationService.addItem">
        Persist cart and publish event
      </Anchor>
    </BlockAnchors>

    <ErrorConditions>
      <Error code="INVALID_ARGUMENT">Invalid quantity (less than 1)</Error>
      <Error code="INVALID_ARGUMENT">Invalid configuration (failed validation)</Error>
      <Error code="NOT_FOUND">Product template not found</Error>
      <Error code="UNAVAILABLE">Pricing service unavailable</Error>
    </ErrorConditions>

    <TestCases>
      <TestCase id="TC-FUNC-CART-ADD-001" type="unit">
        <Description>Add valid item creates cart item with snapshot</Description>
        <Given>Empty cart exists</Given>
        <When>AddItem with valid configuration</When>
        <Then>Cart has 1 item with configuration snapshot</Then>
      </TestCase>
      <TestCase id="TC-FUNC-CART-ADD-002" type="unit">
        <Description>Add item to existing cart appends item</Description>
        <Given>Cart has 1 item already</Given>
        <When>AddItem with different configuration</When>
        <Then>Cart has 2 items</Then>
      </TestCase>
      <TestCase id="TC-FUNC-CART-ADD-003" type="integration">
        <Description>Invalid configuration rejected</Description>
        <Given>Invalid dimension configuration</Given>
        <When>AddItem called</When>
        <Then>ERR-CART-INVALID-CONFIG error returned</Then>
      </TestCase>
      <TestCase id="TC-FUNC-CART-ADD-004" type="integration">
        <Description>Expired quote triggers fresh price fetch</Description>
        <Given>Expired quoteId provided</Given>
        <When>AddItem called</When>
        <Then>Fresh quote fetched from pricing-service</Then>
      </TestCase>
      <TestCase id="TC-FUNC-CART-ADD-005" type="unit">
        <Description>Cart totals recalculated after add</Description>
        <Given>Cart has existing items</Given>
        <When>AddItem succeeds</When>
        <Then>Cart subtotal, tax, total recalculated</Then>
      </TestCase>
      <TestCase id="TC-FUNC-CART-ADD-006" type="integration">
        <Description>CartItemAddedEvent published to Kafka</Description>
        <Given>Valid add item request</Given>
        <When>AddItem succeeds</When>
        <Then>CartItemAddedEvent sent to Kafka</Then>
      </TestCase>
    </TestCases>

    <Dependencies>
      <Dependency type="port">CatalogConfigurationPort.validateConfiguration</Dependency>
      <Dependency type="port">PricingPort.calculateQuote</Dependency>
      <Dependency type="service">ConfigurationHashGenerator.generateHash</Dependency>
      <Dependency type="port">EventPublisher.publish</Dependency>
      <Dependency type="repository">CartRepository.save</Dependency>
    </Dependencies>
  </FunctionContract>

  <!-- ═══════════════════════════════════════════════════════════════════════════
       FC-cart-updateItem: Update item quantity
       ═══════════════════════════════════════════════════════════════════════════ -->
  <FunctionContract id="FC-cart-updateItem">
    <Metadata>
      <Layer>application</Layer>
      <UseCase ref="UC-CART-MANAGE" />
      <Proto ref="cart_service_v1_1.proto#UpdateItem" />
    </Metadata>

    <Purpose>
      Update the quantity of an existing cart item. Recalculates line total and cart totals.
    </Purpose>

    <Signature>
      <Input>UpdateItemCommand(customerId, sessionId, itemId, quantity)</Input>
      <Output>CartDto</Output>
    </Signature>

    <Preconditions>
      <Condition id="PRE-UI-01">Cart exists for owner</Condition>
      <Condition id="PRE-UI-02">Item exists in cart</Condition>
      <Condition id="PRE-UI-03">quantity >= 1</Condition>
    </Preconditions>

    <Postconditions>
      <Condition id="POST-UI-01">Item quantity updated</Condition>
      <Condition id="POST-UI-02">Line total recalculated</Condition>
      <Condition id="POST-UI-03">Cart totals recalculated</Condition>
      <Condition id="POST-UI-04">CartItemUpdatedEvent published</Condition>
    </Postconditions>

    <BlockAnchors>
      <Anchor id="BA-CART-UPDATE-01" location="CartApplicationService.updateItemQuantity">
        Load cart and find item
      </Anchor>
      <Anchor id="BA-CART-UPDATE-02" location="CartApplicationService.updateItemQuantity">
        Validate quantity
      </Anchor>
      <Anchor id="BA-CART-UPDATE-03" location="Cart.updateItemQuantity">
        Update quantity and line total
      </Anchor>
      <Anchor id="BA-CART-UPDATE-04" location="Cart.calculateTotals">
        Recalculate cart totals
      </Anchor>
      <Anchor id="BA-CART-UPDATE-05" location="CartApplicationService.updateItemQuantity">
        Persist and publish event
      </Anchor>
    </BlockAnchors>

    <ErrorConditions>
      <Error code="NOT_FOUND">Cart not found</Error>
      <Error code="NOT_FOUND">Item not found in cart</Error>
      <Error code="INVALID_ARGUMENT">Invalid quantity (less than 1)</Error>
    </ErrorConditions>

    <TestCases>
      <TestCase id="TC-FUNC-CART-UPDATE-001" type="unit">
        <Description>Update quantity recalculates line total</Description>
        <Given>Cart item with quantity 2</Given>
        <When>UpdateItem with quantity 5</When>
        <Then>Item quantity = 5, line_total = unit_price * 5</Then>
      </TestCase>
      <TestCase id="TC-FUNC-CART-UPDATE-002" type="unit">
        <Description>Cart totals recalculated after update</Description>
        <Given>Cart item with quantity 5</Given>
        <When>UpdateItem with quantity 2</When>
        <Then>Item quantity = 2, cart subtotal decreased</Then>
      </TestCase>
      <TestCase id="TC-FUNC-CART-UPDATE-003" type="unit">
        <Description>Non-existent item returns error</Description>
        <Given>Cart with items</Given>
        <When>UpdateItem with invalid itemId</When>
        <Then>ERR-CART-ITEM-NOT-FOUND error</Then>
      </TestCase>
      <TestCase id="TC-FUNC-CART-UPDATE-004" type="unit">
        <Description>Quantity 0 rejected (use remove instead)</Description>
        <Given>Cart item with quantity 2</Given>
        <When>UpdateItem with quantity 0</When>
        <Then>ERR-CART-INVALID-QUANTITY error</Then>
      </TestCase>
    </TestCases>

    <Dependencies>
      <Dependency type="repository">CartRepository.findByOwner</Dependency>
      <Dependency type="repository">CartRepository.save</Dependency>
      <Dependency type="port">EventPublisher.publish</Dependency>
    </Dependencies>
  </FunctionContract>

  <!-- ═══════════════════════════════════════════════════════════════════════════
       FC-cart-removeItem: Remove item from cart
       ═══════════════════════════════════════════════════════════════════════════ -->
  <FunctionContract id="FC-cart-removeItem">
    <Metadata>
      <Layer>application</Layer>
      <UseCase ref="UC-CART-MANAGE" />
      <Proto ref="cart_service_v1_1.proto#RemoveItem" />
    </Metadata>

    <Purpose>
      Remove an item from the cart entirely. Recalculates cart totals after removal.
    </Purpose>

    <Signature>
      <Input>RemoveItemCommand(customerId, sessionId, itemId)</Input>
      <Output>CartDto</Output>
    </Signature>

    <Preconditions>
      <Condition id="PRE-RI-01">Cart exists for owner</Condition>
      <Condition id="PRE-RI-02">Item exists in cart</Condition>
    </Preconditions>

    <Postconditions>
      <Condition id="POST-RI-01">Item removed from cart</Condition>
      <Condition id="POST-RI-02">Cart totals recalculated</Condition>
      <Condition id="POST-RI-03">CartItemRemovedEvent published</Condition>
    </Postconditions>

    <BlockAnchors>
      <Anchor id="BA-CART-REMOVE-01" location="CartApplicationService.removeItem">
        Load cart and find item
      </Anchor>
      <Anchor id="BA-CART-REMOVE-02" location="Cart.removeItem">
        Remove item from cart
      </Anchor>
      <Anchor id="BA-CART-REMOVE-03" location="Cart.calculateTotals">
        Recalculate cart totals
      </Anchor>
      <Anchor id="BA-CART-REMOVE-04" location="CartApplicationService.removeItem">
        Persist and publish event
      </Anchor>
    </BlockAnchors>

    <ErrorConditions>
      <Error code="NOT_FOUND">Cart not found</Error>
      <Error code="NOT_FOUND">Item not found in cart</Error>
    </ErrorConditions>

    <TestCases>
      <TestCase id="TC-FUNC-CART-REMOVE-001" type="unit">
        <Description>Remove item recalculates totals</Description>
        <Given>Cart with 3 items</Given>
        <When>RemoveItem for item 2</When>
        <Then>Cart has 2 items, subtotal recalculated</Then>
      </TestCase>
      <TestCase id="TC-FUNC-CART-REMOVE-002" type="unit">
        <Description>Remove last item results in empty cart</Description>
        <Given>Cart with 1 item</Given>
        <When>RemoveItem</When>
        <Then>Cart empty, subtotal = 0</Then>
      </TestCase>
      <TestCase id="TC-FUNC-CART-REMOVE-003" type="unit">
        <Description>Non-existent item returns error</Description>
        <Given>Cart with items</Given>
        <When>RemoveItem with invalid itemId</When>
        <Then>ERR-CART-ITEM-NOT-FOUND error</Then>
      </TestCase>
    </TestCases>

    <Dependencies>
      <Dependency type="repository">CartRepository.findByOwner</Dependency>
      <Dependency type="repository">CartRepository.save</Dependency>
      <Dependency type="port">EventPublisher.publish</Dependency>
    </Dependencies>
  </FunctionContract>

  <!-- ═══════════════════════════════════════════════════════════════════════════
       FC-cart-applyPromoCode: Apply promotional code
       ═══════════════════════════════════════════════════════════════════════════ -->
  <FunctionContract id="FC-cart-applyPromoCode">
    <Metadata>
      <Layer>application</Layer>
      <UseCase ref="UC-CART-APPLY-PROMO" />
      <Proto ref="cart_service_v1_1.proto#ApplyPromoCode" />
    </Metadata>

    <Purpose>
      Validate and apply a promotional code to the cart. Validates via pricing-service,
      calculates discount, and updates cart totals. Only one promo code allowed at a time.
    </Purpose>

    <Signature>
      <Input>ApplyPromoCodeCommand(customerId, sessionId, promoCode)</Input>
      <Output>ApplyPromoCodeResult(cart: CartDto, applied: boolean, errorMessage: String?,
        errorCode: String?)</Output>
    </Signature>

    <Preconditions>
      <Condition id="PRE-AP-01">Cart exists with items (non-empty)</Condition>
      <Condition id="PRE-AP-02">promoCode is non-empty string</Condition>
    </Preconditions>

    <Postconditions>
      <Condition id="POST-AP-01">If valid: AppliedPromoCode set on cart</Condition>
      <Condition id="POST-AP-02">If valid: discount and total recalculated</Condition>
      <Condition id="POST-AP-03">If valid: PromoCodeAppliedEvent published</Condition>
      <Condition id="POST-AP-04">If invalid: Cart unchanged, error returned</Condition>
      <Condition id="POST-AP-05">Previous promo code (if any) replaced</Condition>
    </Postconditions>

    <BlockAnchors>
      <Anchor id="BA-CART-PROMO-01" location="CartApplicationService.applyPromoCode">
        Load cart and validate not empty
      </Anchor>
      <Anchor id="BA-CART-PROMO-02" location="CartApplicationService.applyPromoCode">
        Call pricing-service.ValidatePromoCode
      </Anchor>
      <Anchor id="BA-CART-PROMO-03" location="Cart.applyPromoCode">
        Apply discount to cart
      </Anchor>
      <Anchor id="BA-CART-PROMO-04" location="Cart.calculateTotals">
        Recalculate totals
      </Anchor>
      <Anchor id="BA-CART-PROMO-05" location="CartApplicationService.applyPromoCode">
        Persist and publish event
      </Anchor>
    </BlockAnchors>

    <ErrorConditions>
      <Error code="PROMO_INVALID">Promo code does not exist</Error>
      <Error code="PROMO_EXPIRED">Promo code has expired</Error>
      <Error code="PROMO_MINIMUM_NOT_MET">Cart subtotal below minimum requirement</Error>
      <Error code="PROMO_USAGE_EXCEEDED">Promo code usage limit exceeded</Error>
      <Error code="EMPTY_CART">Cannot apply promo to empty cart</Error>
    </ErrorConditions>

    <TestCases>
      <TestCase id="TC-FUNC-CART-PROMO-001" type="unit">
        <Description>Valid promo code applies discount</Description>
        <Given>Cart with subtotal 10000 RUB</Given>
        <When>ApplyPromoCode "SAVE10" (10% off)</When>
        <Then>discount = 1000 RUB, total = 9000 RUB + tax</Then>
      </TestCase>
      <TestCase id="TC-FUNC-CART-PROMO-002" type="unit">
        <Description>Invalid promo code returns error with reason</Description>
        <Given>Cart with items</Given>
        <When>ApplyPromoCode "INVALID"</When>
        <Then>applied = false, errorCode = ERR-CART-PROMO-INVALID</Then>
      </TestCase>
      <TestCase id="TC-FUNC-CART-PROMO-003" type="unit">
        <Description>Promo code replaces existing promo</Description>
        <Given>Cart with promo "OLD10" applied</Given>
        <When>ApplyPromoCode "NEW20"</When>
        <Then>New promo replaces old, discount recalculated</Then>
      </TestCase>
      <TestCase id="TC-FUNC-CART-PROMO-004" type="unit">
        <Description>Empty cart rejects promo application</Description>
        <Given>Empty cart</Given>
        <When>ApplyPromoCode "SAVE10"</When>
        <Then>applied = false, errorCode = ERR-CART-EMPTY</Then>
      </TestCase>
      <TestCase id="TC-FUNC-CART-PROMO-005" type="unit">
        <Description>Minimum order requirement checked</Description>
        <Given>Cart with subtotal 1000 RUB</Given>
        <When>ApplyPromoCode requiring minimum 5000 RUB</When>
        <Then>applied = false, errorCode = ERR-CART-PROMO-MIN-NOT-MET</Then>
      </TestCase>
    </TestCases>

    <Dependencies>
      <Dependency type="port">PricingPort.validatePromoCode</Dependency>
      <Dependency type="repository">CartRepository.findByOwner</Dependency>
      <Dependency type="repository">CartRepository.save</Dependency>
      <Dependency type="port">EventPublisher.publish</Dependency>
    </Dependencies>
  </FunctionContract>

  <!-- ═══════════════════════════════════════════════════════════════════════════
       FC-cart-removePromoCode: Remove promotional code
       ═══════════════════════════════════════════════════════════════════════════ -->
  <FunctionContract id="FC-cart-removePromoCode">
    <Metadata>
      <Layer>application</Layer>
      <UseCase ref="UC-CART-APPLY-PROMO" />
      <Proto ref="cart_service_v1_1.proto#RemovePromoCode" />
    </Metadata>

    <Purpose>
      Remove the applied promotional code from the cart. Resets discount to zero
      and recalculates cart totals.
    </Purpose>

    <Signature>
      <Input>RemovePromoCodeCommand(customerId, sessionId)</Input>
      <Output>CartDto</Output>
    </Signature>

    <Preconditions>
      <Condition id="PRE-RP-01">Cart exists for owner</Condition>
    </Preconditions>

    <Postconditions>
      <Condition id="POST-RP-01">applied_promo_code cleared</Condition>
      <Condition id="POST-RP-02">discount = 0</Condition>
      <Condition id="POST-RP-03">Cart totals recalculated</Condition>
      <Condition id="POST-RP-04">PromoCodeRemovedEvent published (if promo was present)</Condition>
    </Postconditions>

    <BlockAnchors>
      <Anchor id="BA-CART-PROMO-REMOVE-01" location="CartApplicationService.removePromoCode">
        Load cart
      </Anchor>
      <Anchor id="BA-CART-PROMO-REMOVE-02" location="Cart.removePromoCode">
        Remove promo code
      </Anchor>
      <Anchor id="BA-CART-PROMO-REMOVE-03" location="Cart.calculateTotals">
        Recalculate totals
      </Anchor>
      <Anchor id="BA-CART-PROMO-REMOVE-04" location="CartApplicationService.removePromoCode">
        Persist and publish event
      </Anchor>
    </BlockAnchors>

    <ErrorConditions>
      <Error code="NOT_FOUND">Cart not found</Error>
    </ErrorConditions>

    <TestCases>
      <TestCase id="TC-FUNC-CART-PROMO-REMOVE-001" type="unit">
        <Description>Remove promo code zeroes discount</Description>
        <Given>Cart with promo code applied</Given>
        <When>RemovePromoCode</When>
        <Then>discount = 0, total = subtotal + tax</Then>
      </TestCase>
      <TestCase id="TC-FUNC-CART-PROMO-REMOVE-002" type="unit">
        <Description>No promo applied returns appropriate response</Description>
        <Given>Cart with no promo code</Given>
        <When>RemovePromoCode</When>
        <Then>Cart unchanged, no error</Then>
      </TestCase>
    </TestCases>

    <Dependencies>
      <Dependency type="repository">CartRepository.findByOwner</Dependency>
      <Dependency type="repository">CartRepository.save</Dependency>
      <Dependency type="port">EventPublisher.publish</Dependency>
    </Dependencies>
  </FunctionContract>
    <!-- ═══════════════════════════════════════════════════════════════════════════
       FC-cart-clearCart: Clear all items from cart
       ═══════════════════════════════════════════════════════════════════════════ -->
  <FunctionContract id="FC-cart-clearCart">
    <Metadata>
      <Layer>application</Layer>
      <UseCase ref="UC-CART-MANAGE" />
      <Proto ref="cart_service_v1_1.proto#ClearCart" />
    </Metadata>

    <Purpose>
      Remove all items from the cart. Removes any applied promo code and
      resets totals to zero. Cart entity is preserved with ACTIVE status.
    </Purpose>

    <Signature>
      <Input>ClearCartCommand(customerId, sessionId)</Input>
      <Output>CartDto (empty cart)</Output>
    </Signature>

    <Preconditions>
      <Condition id="PRE-CC-01">Cart owner identified (customerId or sessionId)</Condition>
    </Preconditions>

    <Postconditions>
      <Condition id="POST-CC-01">All items removed from cart</Condition>
      <Condition id="POST-CC-02">Applied promo code removed</Condition>
      <Condition id="POST-CC-03">Cart totals reset to zero</Condition>
      <Condition id="POST-CC-04">Cart status remains ACTIVE</Condition>
      <Condition id="POST-CC-05">CartClearedEvent published</Condition>
    </Postconditions>

    <BlockAnchors>
      <Anchor id="BA-CART-CLEAR-01" location="CartApplicationService.clearCart">
        Resolve cart from customerId or sessionId
      </Anchor>
      <Anchor id="BA-CART-CLEAR-02" location="CartApplicationService.clearCart">
        Validate cart exists and caller authorized
      </Anchor>
      <Anchor id="BA-CART-CLEAR-03" location="Cart.clear">
        Remove all items from cart
      </Anchor>
      <Anchor id="BA-CART-CLEAR-04" location="Cart.clear">
        Remove applied promo code
      </Anchor>
      <Anchor id="BA-CART-CLEAR-05" location="Cart.calculateTotals">
        Reset cart totals to zero
      </Anchor>
      <Anchor id="BA-CART-CLEAR-06" location="CartApplicationService.clearCart">
        Persist and publish CartClearedEvent
      </Anchor>
    </BlockAnchors>

    <ErrorConditions>
      <Error code="NOT_FOUND">Cart not found</Error>
    </ErrorConditions>

    <TestCases>
      <TestCase id="TC-FUNC-CART-CLEAR-001" type="unit">
        <Description>Clear cart removes all items</Description>
        <Given>Cart with 3 items</Given>
        <When>ClearCart called</When>
        <Then>Cart has 0 items</Then>
      </TestCase>
      <TestCase id="TC-FUNC-CART-CLEAR-002" type="unit">
        <Description>Clear cart removes applied promo code</Description>
        <Given>Cart with promo code applied</Given>
        <When>ClearCart called</When>
        <Then>applied_promo_code = null, discount = 0</Then>
      </TestCase>
      <TestCase id="TC-FUNC-CART-CLEAR-003" type="unit">
        <Description>Clear cart resets totals to zero</Description>
        <Given>Cart with subtotal 10000 RUB</Given>
        <When>ClearCart called</When>
        <Then>subtotal = 0, tax = 0, total = 0</Then>
      </TestCase>
      <TestCase id="TC-FUNC-CART-CLEAR-004" type="unit">
        <Description>Clear empty cart is idempotent</Description>
        <Given>Empty cart</Given>
        <When>ClearCart called</When>
        <Then>Returns empty cart, no error</Then>
      </TestCase>
      <TestCase id="TC-FUNC-CART-CLEAR-005" type="integration">
        <Description>CartClearedEvent published with item count</Description>
        <Given>Cart with 3 items</Given>
        <When>ClearCart called</When>
        <Then>CartClearedEvent published with items_removed = 3</Then>
      </TestCase>
    </TestCases>

    <Dependencies>
      <Dependency type="repository">CartRepository.findByOwner</Dependency>
      <Dependency type="repository">CartRepository.save</Dependency>
      <Dependency type="port">EventPublisher.publish</Dependency>
    </Dependencies>
  </FunctionContract>

    <!-- ═══════════════════════════════════════════════════════════════════════════
       FC-cart-refreshPrices: Refresh price quotes for all items
       ═══════════════════════════════════════════════════════════════════════════ -->
  <FunctionContract id="FC-cart-refreshPrices">
    <Metadata>
      <Layer>application</Layer>
      <UseCase ref="UC-CART-MANAGE" />
      <Proto ref="cart_service_v1_1.proto#RefreshPrices" />
      <Decision ref="DEC-CART-PRICE-LOCK" />
    </Metadata>

    <Purpose>
      Refresh price quotes for all cart items from pricing-service. Clears staleness
      flags, updates quote IDs and validity timestamps, recalculates totals.
      If promo code is applied, recalculates discount with new subtotal.
    </Purpose>

    <Signature>
      <Input>RefreshPricesCommand(customerId, sessionId)</Input>
      <Output>RefreshPricesResult(cart, itemsUpdated, totalChanged, previousTotal, priceChangePercent)</Output>
    </Signature>

    <Preconditions>
      <Condition id="PRE-RP-01">Cart exists for owner</Condition>
      <Condition id="PRE-RP-02">Cart has at least one item</Condition>
    </Preconditions>

    <Postconditions>
      <Condition id="POST-RP-01">All item prices refreshed from pricing-service</Condition>
      <Condition id="POST-RP-02">quote_id and quote_valid_until updated per item</Condition>
      <Condition id="POST-RP-03">price_stale = false for all items</Condition>
      <Condition id="POST-RP-04">Cart totals recalculated</Condition>
      <Condition id="POST-RP-05">Promo discount recalculated if applied</Condition>
      <Condition id="POST-RP-06">CartPricesRefreshedEvent published</Condition>
    </Postconditions>

    <BlockAnchors>
      <Anchor id="BA-CART-REFRESH-01" location="CartApplicationService.refreshPrices">
        Load cart and validate not empty
      </Anchor>
      <Anchor id="BA-CART-REFRESH-02" location="CartApplicationService.refreshPrices">
        Iterate items and call pricing-service.CalculateQuote for each
      </Anchor>
      <Anchor id="BA-CART-REFRESH-03" location="CartItem.updatePrice">
        Update item prices, quote_id, quote_valid_until
      </Anchor>
      <Anchor id="BA-CART-REFRESH-04" location="CartItem.clearStaleFlag">
        Clear price_stale flags
      </Anchor>
      <Anchor id="BA-CART-REFRESH-05" location="Cart.calculateTotals">
        Recalculate cart totals
      </Anchor>
      <Anchor id="BA-CART-REFRESH-06" location="Cart.recalculatePromoDiscount">
        Recalculate promo discount if applied
      </Anchor>
      <Anchor id="BA-CART-REFRESH-07" location="CartApplicationService.refreshPrices">
        Persist and publish CartPricesRefreshedEvent
      </Anchor>
    </BlockAnchors>

    <ErrorConditions>
      <Error code="FAILED_PRECONDITION">Cart is empty</Error>
      <Error code="NOT_FOUND">Cart not found</Error>
      <Error code="UNAVAILABLE">Pricing service unavailable</Error>
      <Error code="PARTIAL_FAILURE">Some items failed to refresh</Error>
    </ErrorConditions>

    <TestCases>
      <TestCase id="TC-FUNC-CART-REFRESH-001" type="integration">
        <Description>Refresh updates all item prices from pricing-service</Description>
        <Given>Cart with 2 items, pricing-service available</Given>
        <When>RefreshPrices called</When>
        <Then>Both items have new quote_id and updated prices</Then>
      </TestCase>
      <TestCase id="TC-FUNC-CART-REFRESH-002" type="unit">
        <Description>Refresh clears price_stale flags</Description>
        <Given>Cart with items where price_stale = true</Given>
        <When>RefreshPrices called</When>
        <Then>All items have price_stale = false</Then>
      </TestCase>
      <TestCase id="TC-FUNC-CART-REFRESH-003" type="unit">
        <Description>Refresh recalculates cart totals</Description>
        <Given>Cart with stale prices</Given>
        <When>RefreshPrices called with price changes</When>
        <Then>subtotal, tax, total recalculated</Then>
      </TestCase>
      <TestCase id="TC-FUNC-CART-REFRESH-004" type="unit">
        <Description>Promo discount recalculated with new subtotal</Description>
        <Given>Cart with promo "SAVE10" (10%), subtotal changes</Given>
        <When>RefreshPrices called</When>
        <Then>Discount recalculated as 10% of new subtotal</Then>
      </TestCase>
      <TestCase id="TC-FUNC-CART-REFRESH-005" type="integration">
        <Description>Pricing service timeout uses circuit breaker fallback</Description>
        <Given>Pricing service unavailable</Given>
        <When>RefreshPrices called</When>
        <Then>Circuit breaker triggered, appropriate error returned</Then>
      </TestCase>
      <TestCase id="TC-FUNC-CART-REFRESH-006" type="unit">
        <Description>Empty cart returns error</Description>
        <Given>Empty cart</Given>
        <When>RefreshPrices called</When>
        <Then>FAILED_PRECONDITION error</Then>
      </TestCase>
      <TestCase id="TC-FUNC-CART-REFRESH-007" type="unit">
        <Description>Response includes total change indicators</Description>
        <Given>Cart with price changes</Given>
        <When>RefreshPrices called</When>
        <Then>totalChanged = true, previousTotal set, priceChangePercent calculated</Then>
      </TestCase>
    </TestCases>

    <Dependencies>
      <Dependency type="port">PricingPort.calculateQuote</Dependency>
      <Dependency type="repository">CartRepository.findByOwner</Dependency>
      <Dependency type="repository">CartRepository.save</Dependency>
      <Dependency type="port">EventPublisher.publish</Dependency>
    </Dependencies>
  </FunctionContract>

  <!-- ═══════════════════════════════════════════════════════════════════════════
       FC-cart-mergeCarts: Merge anonymous cart into authenticated cart
       ═══════════════════════════════════════════════════════════════════════════ -->
  <FunctionContract id="FC-cart-mergeCarts">
    <Metadata>
      <Layer>application</Layer>
      <UseCase ref="UC-CART-MANAGE" />
      <Proto ref="cart_service_v1_1.proto#MergeCarts" />
      <Decision ref="DEC-CART-MERGE" />
    </Metadata>

    <Purpose>
      Merge an anonymous (session-based) cart into an authenticated (customer) cart.
      Items with matching configuration_hash have quantities summed.
      New configurations are added. Anonymous cart is marked as MERGED.
      Promo code preference: authenticated cart's promo code wins if both have one.
    </Purpose>

    <Signature>
      <Input>MergeCartsCommand(customerId, anonymousSessionId)</Input>
      <Output>MergeCartsResult(mergedCart, itemsFromAnonymous, itemsMerged, itemsAdded,
        promoCodePreserved, promoCodeSource)</Output>
    </Signature>

    <Preconditions>
      <Condition id="PRE-MC-01">customerId is valid authenticated customer</Condition>
      <Condition id="PRE-MC-02">anonymousSessionId has associated cart</Condition>
    </Preconditions>

    <Postconditions>
      <Condition id="POST-MC-01">Authenticated cart contains merged items</Condition>
      <Condition id="POST-MC-02">Items with same config_hash have summed quantities</Condition>
      <Condition id="POST-MC-03">Anonymous cart status = MERGED</Condition>
      <Condition id="POST-MC-04">CartMergedEvent published</Condition>
      <Condition id="POST-MC-05">Promo code resolved (auth wins on conflict)</Condition>
    </Postconditions>

    <BlockAnchors>
      <Anchor id="BA-CART-MERGE-01" location="CartApplicationService.mergeCarts">
        Load both carts
      </Anchor>
      <Anchor id="BA-CART-MERGE-02" location="CartMergeService.merge">
        Match items by configuration_hash
      </Anchor>
      <Anchor id="BA-CART-MERGE-03" location="CartMergeService.merge">
        Merge items (sum quantities for matches, add new)
      </Anchor>
      <Anchor id="BA-CART-MERGE-04" location="CartMergeService.merge">
        Resolve promo code precedence
      </Anchor>
      <Anchor id="BA-CART-MERGE-05" location="CartApplicationService.mergeCarts">
        Refresh all prices
      </Anchor>
      <Anchor id="BA-CART-MERGE-06" location="Cart.markMerged">
        Delete anonymous cart
      </Anchor>
      <Anchor id="BA-CART-MERGE-07" location="CartApplicationService.mergeCarts">
        Persist and publish event
      </Anchor>
    </BlockAnchors>

    <ErrorConditions>
      <Error code="NOT_FOUND">Anonymous cart not found</Error>
      <Error code="INVALID_ARGUMENT">Customer cart and anonymous cart are the same</Error>
    </ErrorConditions>

    <TestCases>
      <TestCase id="TC-FUNC-CART-MERGE-001" type="unit">
        <Description>Merge combines items from both carts</Description>
        <Given>Auth cart: [A, B], Anon cart: [C, D]</Given>
        <When>MergeCarts</When>
        <Then>Merged cart: [A, B, C, D], itemsAdded = 2</Then>
      </TestCase>
      <TestCase id="TC-FUNC-CART-MERGE-002" type="unit">
        <Description>Same configuration items have quantities summed</Description>
        <Given>Auth cart: [A qty:2], Anon cart: [A qty:3]</Given>
        <When>MergeCarts</When>
        <Then>Merged cart: [A qty:5], itemsMerged = 1</Then>
      </TestCase>
      <TestCase id="TC-FUNC-CART-MERGE-003" type="unit">
        <Description>Anonymous cart deleted after merge</Description>
        <Given>Both carts exist</Given>
        <When>MergeCarts</When>
        <Then>Anonymous cart status = MERGED</Then>
      </TestCase>
      <TestCase id="TC-FUNC-CART-MERGE-004" type="unit">
        <Description>Authenticated promo code preserved</Description>
        <Given>Auth cart: promo "AUTH10", Anon cart: promo "ANON20"</Given>
        <When>MergeCarts</When>
        <Then>promoCodeSource = "AUTHENTICATED", code = "AUTH10"</Then>
      </TestCase>
      <TestCase id="TC-FUNC-CART-MERGE-005" type="unit">
        <Description>Anonymous promo adopted if no auth promo</Description>
        <Given>Auth cart: no promo, Anon cart: promo "ANON20"</Given>
        <When>MergeCarts</When>
        <Then>promoCodeSource = "ANONYMOUS", code = "ANON20"</Then>
      </TestCase>
    </TestCases>

    <Dependencies>
      <Dependency type="repository">CartRepository.findByCustomerId</Dependency>
      <Dependency type="repository">CartRepository.findBySessionId</Dependency>
      <Dependency type="service">CartMergeService.merge</Dependency>
      <Dependency type="repository">CartRepository.save</Dependency>
      <Dependency type="port">EventPublisher.publish</Dependency>
    </Dependencies>
  </FunctionContract>

  <!-- ═══════════════════════════════════════════════════════════════════════════
       FC-cart-createSnapshot: Create checkout snapshot
       ═══════════════════════════════════════════════════════════════════════════ -->
  <FunctionContract id="FC-cart-createSnapshot">
    <Metadata>
      <Layer>application</Layer>
      <UseCase ref="UC-ORDER-PLACE" />
      <Proto ref="cart_service_v1_1.proto#CreateSnapshot" />
      <Decision ref="DEC-CART-PRICE-LOCK" />
    </Metadata>

    <Purpose>
      Create an immutable snapshot of the cart for checkout. Validates all configurations,
      refreshes all prices, and creates a time-limited snapshot for order-service handoff.
      Cart is transitioned to CHECKED_OUT state.
    </Purpose>

    <Signature>
      <Input>CreateSnapshotCommand(customerId, acknowledgePriceChanges)</Input>
      <Output>CreateSnapshotResult(snapshotId, cartSnapshot, validUntil, pricesChanged,
        previousTotal)</Output>
    </Signature>

    <Preconditions>
      <Condition id="PRE-CS-01">Customer is authenticated (not anonymous)</Condition>
      <Condition id="PRE-CS-02">Cart has at least one item</Condition>
      <Condition id="PRE-CS-03">All items have VALID validation_status</Condition>
    </Preconditions>

    <Postconditions>
      <Condition id="POST-CS-01">Immutable snapshot created with fresh prices</Condition>
      <Condition id="POST-CS-02">Snapshot has 15-minute validity period</Condition>
      <Condition id="POST-CS-03">Cart status = CHECKED_OUT</Condition>
      <Condition id="POST-CS-04">CartCheckedOutEvent published</Condition>
      <Condition id="POST-CS-05">If prices changed and !acknowledgePriceChanges: operation rejected</Condition>
    </Postconditions>

    <BlockAnchors>
      <Anchor id="BA-CART-SNAP-01" location="CartApplicationService.createSnapshot">
        Load cart and validate not empty
      </Anchor>
      <Anchor id="BA-CART-SNAP-02" location="CartApplicationService.createSnapshot">
        Validate all configurations
      </Anchor>
      <Anchor id="BA-CART-SNAP-03" location="CartApplicationService.createSnapshot">
        Refresh all prices
      </Anchor>
      <Anchor id="BA-CART-SNAP-04" location="Cart.createSnapshot">
        Create immutable snapshot
      </Anchor>
      <Anchor id="BA-CART-SNAP-05" location="Cart.markCheckedOut">
        Clear original cart (set status CHECKED_OUT)
      </Anchor>
      <Anchor id="BA-CART-SNAP-06" location="CartApplicationService.createSnapshot">
        Persist and publish event
      </Anchor>
    </BlockAnchors>

    <ErrorConditions>
      <Error code="UNAUTHENTICATED">Anonymous users cannot create snapshots</Error>
      <Error code="FAILED_PRECONDITION">Cart is empty</Error>
      <Error code="FAILED_PRECONDITION">Cart contains invalid configurations</Error>
      <Error code="FAILED_PRECONDITION">Prices changed and not acknowledged</Error>
      <Error code="UNAVAILABLE">Pricing service unavailable</Error>
    </ErrorConditions>

    <TestCases>
      <TestCase id="TC-FUNC-CART-SNAP-001" type="unit">
        <Description>Snapshot created with fresh prices</Description>
        <Given>Cart with valid items, prices unchanged</Given>
        <When>CreateSnapshot</When>
        <Then>Snapshot created, pricesChanged = false</Then>
      </TestCase>
      <TestCase id="TC-FUNC-CART-SNAP-002" type="unit">
        <Description>Original cart cleared after snapshot</Description>
        <Given>Cart with items</Given>
        <When>CreateSnapshot</When>
        <Then>Cart status = CHECKED_OUT</Then>
      </TestCase>
      <TestCase id="TC-FUNC-CART-SNAP-003" type="unit">
        <Description>Invalid items prevent snapshot creation</Description>
        <Given>Cart item with validation_status = INVALID</Given>
        <When>CreateSnapshot</When>
        <Then>ERR-CART-INVALID-ITEMS error</Then>
      </TestCase>
      <TestCase id="TC-FUNC-CART-SNAP-004" type="unit">
        <Description>Anonymous cart rejected</Description>
        <Given>Anonymous cart (session_id only)</Given>
        <When>CreateSnapshot</When>
        <Then>ERR-CART-ANONYMOUS error</Then>
      </TestCase>
      <TestCase id="TC-FUNC-CART-SNAP-005" type="unit">
        <Description>Snapshot has validity period</Description>
        <Given>Valid cart</Given>
        <When>CreateSnapshot</When>
        <Then>validUntil = now + 15 minutes</Then>
      </TestCase>
    </TestCases>

    <Dependencies>
      <Dependency type="port">CatalogConfigurationPort.validateConfiguration</Dependency>
      <Dependency type="port">PricingPort.calculateQuote</Dependency>
      <Dependency type="repository">CartRepository.findByCustomerId</Dependency>
      <Dependency type="repository">CartSnapshotRepository.save</Dependency>
      <Dependency type="repository">CartRepository.save</Dependency>
      <Dependency type="port">EventPublisher.publish</Dependency>
    </Dependencies>
  </FunctionContract>

  <!-- ═══════════════════════════════════════════════════════════════════════════
       Summary Statistics
       ═══════════════════════════════════════════════════════════════════════════ -->
  <Statistics>
    <FunctionContractCount>10</FunctionContractCount>
    <BlockAnchorCount>41</BlockAnchorCount>
    <TestCaseCount>44</TestCaseCount>
    <ErrorConditionCount>21</ErrorConditionCount>
    <DependencyCount>35</DependencyCount>
  </Statistics>

  <Links>
    <Link ref="MC-cart-service-domain.xml" />
    <Link ref="cart_service_v1_1.proto" />
    <Link ref="cart_events.proto" />
    <Link ref="Handoff-20260109-01-W1-T6-CartService.xml" />
    <Link ref="RequirementsAnalysis.xml#UC-CART-MANAGE" />
    <Link ref="RequirementsAnalysis.xml#UC-CART-APPLY-PROMO" />
    <Link ref="RequirementsAnalysis.xml#UC-ORDER-PLACE" />
  </Links>
</FunctionContracts>