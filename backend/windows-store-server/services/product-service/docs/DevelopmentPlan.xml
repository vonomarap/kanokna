<DevelopmentPlan version="1.0">
  <Service id="Service-product-service">
    <Description>Product master data and marketing content for windows/doors; feeds browse/search/configuration.</Description>
    <BoundedContext>product-catalog</BoundedContext>
    <Responsibilities>
      <Item>Maintain product cards (door/window) with specs and variants</Item>
      <Item>Validate price/discount and dimension invariants at domain level</Item>
      <Item>Publish product versions/events for search and downstream consumers</Item>
      <Item>Expose read APIs for list/detail</Item>
    </Responsibilities>
    <Dependencies>
      <ServiceRef ref="shared-kernel"/>
      <ServiceRef ref="media-service" type="sync">Validate media references</ServiceRef>
      <ServiceRef ref="search-service" type="async">Index products on publish</ServiceRef>
    </Dependencies>
    <Links>
      <Link ref="RequirementsAnalysis.xml#UC-PROD-CREATE-CARD"/>
      <Link ref="RequirementsAnalysis.xml#UC-PROD-LIST"/>
      <Link ref="Technology.xml#Interfaces"/>
    </Links>
  </Service>

  <Architecture>
    <Layers>
      <Domain>com.kanokna.product_service.domain.model/../domain.service (pure Java)</Domain>
      <Application>com.kanokna.product_service.application (use cases, ports, DTOs)</Application>
      <AdaptersIn>com.kanokna.product_service.adapters.in (web/grpc)</AdaptersIn>
      <AdaptersOut>com.kanokna.product_service.adapters.out (persistence, messaging, media/search clients)</AdaptersOut>
    </Layers>
    <Enforcement>ArchUnit to ensure domain free from Spring/JPA; application depends only on domain and ports; adapters depend on application ports.</Enforcement>
  </Architecture>

  <Ports>
    <Inbound>
      <Port name="ProductCommandPort" layer="application.port.in">
        <Operation>createOrUpdateProduct</Operation>
        <Operation>publishProduct</Operation>
        <Operation>deprecateProduct</Operation>
      </Port>
      <Port name="ProductQueryPort" layer="application.port.in">
        <Operation>listProducts</Operation>
        <Operation>getProduct</Operation>
      </Port>
    </Inbound>
    <Outbound>
      <Port name="ProductRepository" layer="application.port.out"/>
      <Port name="MediaValidator" layer="application.port.out"/>
      <Port name="SearchIndexPort" layer="application.port.out"/>
      <Port name="OutboxPublisher" layer="application.port.out"/>
    </Outbound>
  </Ports>

  <DomainModel>
    <Aggregate name="ProductCard">
      <Identifier>ProductId</Identifier>
      <State>code, name, type (window/door), price, discountPrice, dimensions, mediaRefs, status, version</State>
      <Invariants>
        <Invariant>discountPrice is null or <= price</Invariant>
        <Invariant>dimensions within allowed range (width/height 50-500 cm)</Invariant>
        <Invariant>status transitions: DRAFT -> ACTIVE -> DEPRECATED</Invariant>
      </Invariants>
      <Events>
        <Event>ProductCreated</Event>
        <Event>ProductUpdated</Event>
        <Event>ProductPublished</Event>
        <Event>ProductDeprecated</Event>
      </Events>
    </Aggregate>
    <Entity name="Variant">
      <Fields>sku, attributes (glass, lamination, profile), mediaRefs</Fields>
    </Entity>
    <ValueObject name="Money">amount, currency</ValueObject>
    <ValueObject name="DimensionsCm">widthCm, heightCm</ValueObject>
  </DomainModel>

  <Contracts>
    <ModuleContract id="mod.product.domain" layer="domain">
      <Purpose>Product aggregates and invariants for price/dimensions/status.</Purpose>
      <Links>
        <Link ref="RequirementsAnalysis.xml#UC-PROD-CREATE-CARD"/>
      </Links>
      <FunctionContracts>
        <FunctionContract id="validatePricing" layer="domain.service" intent="Enforce price and discount invariants">
          <Input>ProductCard draft/update</Input>
          <Output>Validated ProductCard</Output>
          <Preconditions>price and currency provided</Preconditions>
          <Postconditions>discountPrice null or <= price; Money normalized</Postconditions>
          <BlockAnchors>
            <Block id="PROD-PRICE-BASE" purpose="Check base price presence and currency"/>
            <Block id="PROD-PRICE-DISCOUNT" purpose="Check discount <= base"/>
          </BlockAnchors>
          <LoggingPattern>[PROD][validatePricing][block={id}][state={state}]</LoggingPattern>
        </FunctionContract>
        <FunctionContract id="validateDimensions" layer="domain.service" intent="Ensure dimensions within allowed range">
          <Input>DimensionsCm</Input>
          <Output>Validated DimensionsCm</Output>
          <Preconditions>width/height provided in cm</Preconditions>
          <Postconditions>Accepted ranges enforced; errors otherwise</Postconditions>
          <BlockAnchors>
            <Block id="PROD-DIM-RANGE" purpose="Check width/height min/max"/>
          </BlockAnchors>
          <LoggingPattern>[PROD][validateDimensions][block={id}][state={state}]</LoggingPattern>
        </FunctionContract>
      </FunctionContracts>
    </ModuleContract>

    <ModuleContract id="mod.product.application" layer="application">
      <Purpose>Use cases for create/update/publish and list/get products.</Purpose>
      <Links>
        <Link ref="RequirementsAnalysis.xml#UC-PROD-PUBLISH"/>
        <Link ref="RequirementsAnalysis.xml#UC-PROD-LIST"/>
      </Links>
      <FunctionContracts>
        <FunctionContract id="publishProduct" layer="application.service" intent="Validate and publish product version">
          <Input>PublishProductCommand</Input>
          <Output>PublishResult</Output>
          <BlockAnchors>
            <Block id="PROD-PUB-VALIDATE" purpose="Run domain validations"/>
            <Block id="PROD-PUB-PERSIST" purpose="Persist status/version change"/>
            <Block id="PROD-PUB-EVENT" purpose="Write outbox event for search indexing"/>
          </BlockAnchors>
          <LoggingPattern>[PROD][publishProduct][block={id}][state={state}]</LoggingPattern>
        </FunctionContract>
      </FunctionContracts>
    </ModuleContract>
  </Contracts>

  <Flows>
    <Flow id="Flow-Read">
      <Description>Read product list/detail.</Description>
      <Sequence>
        <Step order="1" from="Adapter (REST/GraphQL)" to="Application Service">Map request to query</Step>
        <Step order="2" from="Application Service" to="ProductRepository">Fetch data (with cache if enabled)</Step>
        <Step order="3" from="Application Service" to="Adapter">Return DTO response</Step>
      </Sequence>
    </Flow>
    <Flow id="Flow-Publish">
      <Description>Publish product and notify search.</Description>
      <Sequence>
        <Step order="1" from="Adapter (REST)" to="Application Service">publishProduct command</Step>
        <Step order="2" from="Application Service" to="Domain">Validate invariants</Step>
        <Step order="3" from="Application Service" to="Persistence">Persist ACTIVE version</Step>
        <Step order="4" from="Application Service" to="OutboxPublisher">Write product.published event</Step>
        <Step order="5" from="OutboxPublisher" to="Kafka">Publish for search-service indexing</Step>
      </Sequence>
    </Flow>
  </Flows>

  <PersistencePlan>
    <Table name="product">
      <Column name="id" type="UUID" role="PK"/>
      <Column name="tenant_id" type="UUID"/>
      <Column name="code" type="VARCHAR(100)"/>
      <Column name="name" type="VARCHAR(255)"/>
      <Column name="type" type="VARCHAR(20)"/>
      <Column name="status" type="VARCHAR(20)"/>
      <Column name="price_amount" type="DECIMAL(19,2)"/>
      <Column name="price_currency" type="CHAR(3)"/>
      <Column name="discount_amount" type="DECIMAL(19,2)" nullable="true"/>
      <Column name="discount_currency" type="CHAR(3)" nullable="true"/>
      <Column name="width_cm" type="INT"/>
      <Column name="height_cm" type="INT"/>
      <Column name="version" type="BIGINT" role="OPTIMISTIC_LOCK"/>
      <Index name="ux_product_tenant_code" unique="true">
        <ColumnRef>tenant_id</ColumnRef>
        <ColumnRef>code</ColumnRef>
      </Index>
    </Table>
    <Table name="product_variant">
      <Column name="id" type="UUID" role="PK"/>
      <Column name="product_id" type="UUID" role="FK"/>
      <Column name="sku" type="VARCHAR(100)"/>
      <Column name="attributes_json" type="JSONB"/>
      <Column name="media_refs_json" type="JSONB"/>
    </Table>
    <Table name="product_media_ref">
      <Column name="id" type="UUID" role="PK"/>
      <Column name="product_id" type="UUID" role="FK"/>
      <Column name="media_id" type="UUID"/>
      <Column name="purpose" type="VARCHAR(50)"/>
    </Table>
  </PersistencePlan>

  <TestingStrategy>
    <Unit>Product domain invariants (pricing, dimensions, status transitions)</Unit>
    <Slice>@DataJpaTest for repositories; @WebMvcTest for REST</Slice>
    <Integration>Testcontainers for PostgreSQL/Redis/Kafka; outbox publisher integration</Integration>
    <ContractTests>OpenAPI for REST; AsyncAPI/Avro for product events</ContractTests>
    <Architecture>ArchUnit enforcing hexagonal boundaries and shared-kernel purity</Architecture>
  </TestingStrategy>

  <Observability>
    <Metrics>Publish success/failure count; list/detail latency; cache hit ratio; outbox lag</Metrics>
    <Tracing>TraceId/spanId propagation; include productId/version attributes</Tracing>
    <Logging>Structured JSON with block anchors (PROD-PRICE-*, PROD-PUB-*) describing decisions</Logging>
  </Observability>

  <Deployment>
    <Packaging>Jib/Buildpacks OCI image</Packaging>
    <Config>Config-server profiles dev/stage/prod</Config>
    <Rollout>Rolling/blue-green; Flyway migrations expand-migrate-contract</Rollout>
    <Secrets>Vault/K8s Secrets; no secrets in code</Secrets>
  </Deployment>
</DevelopmentPlan>
