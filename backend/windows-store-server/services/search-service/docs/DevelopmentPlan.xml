<DevelopmentPlan version="1.0">
  <Service id="Service-search-service">
    <Description>Provides search and autocomplete over products/templates using Elasticsearch/OpenSearch.</Description>
    <BoundedContext>search</BoundedContext>
    <Responsibilities>
      <Item>Ingest catalog events to update search index</Item>
      <Item>Serve faceted search and autocomplete APIs</Item>
      <Item>Provide admin reindex controls</Item>
    </Responsibilities>
    <Dependencies>
      <ServiceRef ref="shared-kernel"/>
      <ServiceRef ref="catalog-configuration-service" type="async-events">Index updates</ServiceRef>
    </Dependencies>
    <Links>
      <Link ref="RequirementsAnalysis.xml#UC-SEARCH-BROWSE"/>
      <Link ref="RequirementsAnalysis.xml#UC-SEARCH-AUTOCOMPLETE"/>
      <Link ref="Technology.xml#Interfaces"/>
    </Links>
  </Service>

  <Architecture>
    <Layers>
      <Domain>com.kanokna.search_service.domain.* (pure Java)</Domain>
      <Application>com.kanokna.search_service.application.* (use cases, ports, DTOs)</Application>
      <AdaptersIn>com.kanokna.search_service.adapters.in.* (web)</AdaptersIn>
      <AdaptersOut>com.kanokna.search_service.adapters.out.* (search engine, messaging, cache)</AdaptersOut>
    </Layers>
    <Enforcement>ArchUnit: domain free of Spring; application depends on domain and ports only.</Enforcement>
  </Architecture>

  <Ports>
    <Inbound>
      <Port name="SearchPort" layer="application.port.in">
        <Operation>searchProducts</Operation>
        <Operation>autocomplete</Operation>
      </Port>
      <Port name="AdminPort" layer="application.port.in">
        <Operation>reindex</Operation>
      </Port>
    </Inbound>
    <Outbound>
      <Port name="IndexPort" layer="application.port.out"/>
      <Port name="CachePort" layer="application.port.out"/>
    </Outbound>
  </Ports>

  <DomainModel>
    <ValueObject name="SearchQuery">text, filters, pagination, sort</ValueObject>
    <ValueObject name="SearchResult">hits, facets, page info</ValueObject>
  </DomainModel>

  <Contracts>
    <ModuleContract id="mod.search.application" layer="application.service">
      <Purpose>Handle search and autocomplete with cache and index interactions.</Purpose>
      <Links>
        <Link ref="RequirementsAnalysis.xml#UC-SEARCH-BROWSE"/>
      </Links>
      <FunctionContracts>
        <FunctionContract id="searchProducts" layer="application.service" intent="Perform faceted search">
          <Input>SearchQuery</Input>
          <Output>SearchResult</Output>
          <Preconditions>Query validated</Preconditions>
          <Postconditions>Results returned with facets</Postconditions>
          <BlockAnchors>
            <Block id="SEARCH-QUERY-CACHE" purpose="Check cache for hot queries"/>
            <Block id="SEARCH-QUERY-INDEX" purpose="Execute search in index"/>
          </BlockAnchors>
          <LoggingPattern>[SEARCH][searchProducts][block={id}][state={state}]</LoggingPattern>
        </FunctionContract>
        <FunctionContract id="autocomplete" layer="application.service" intent="Return autocomplete suggestions">
          <Input>AutocompleteQuery</Input>
          <Output>Suggestions</Output>
          <BlockAnchors>
            <Block id="SEARCH-AUTO-CACHE" purpose="Check suggestion cache"/>
            <Block id="SEARCH-AUTO-INDEX" purpose="Query suggest index"/>
          </BlockAnchors>
          <LoggingPattern>[SEARCH][autocomplete][block={id}][state={state}]</LoggingPattern>
        </FunctionContract>
      </FunctionContracts>
    </ModuleContract>
  </Contracts>

  <Flows>
    <Flow id="Flow-Search">
      <Description>Serve search queries.</Description>
      <Sequence>
        <Step order="1" from="Adapter (REST)" to="Application Service">searchProducts/autocomplete</Step>
        <Step order="2" from="Application Service" to="CachePort">Check cache</Step>
        <Step order="3" from="Application Service" to="IndexPort">Execute search/suggest</Step>
        <Step order="4" from="Application Service" to="Adapter">Return response</Step>
      </Sequence>
    </Flow>
    <Flow id="Flow-Ingest">
      <Description>Ingest catalog events into search index.</Description>
      <Sequence>
        <Step order="1" from="Kafka" to="Adapter (listener)">Receive event</Step>
        <Step order="2" from="Adapter" to="IndexPort">Transform and upsert document</Step>
      </Sequence>
    </Flow>
  </Flows>

  <PersistencePlan>
    <Index name="products">
      <Field name="id" type="keyword"/>
      <Field name="name" type="text"/>
      <Field name="type" type="keyword"/>
      <Field name="attributes" type="nested"/>
      <Field name="facets" type="object"/>
      <Field name="status" type="keyword"/>
    </Index>
    <Index name="suggestions">
      <Field name="suggest" type="completion"/>
    </Index>
  </PersistencePlan>

  <TestingStrategy>
    <Unit>Query builder and transformation logic</Unit>
    <Slice>@WebMvcTest for controllers</Slice>
    <Integration>Testcontainers for OpenSearch/Elasticsearch + Kafka + Redis</Integration>
    <ContractTests>OpenAPI for REST</ContractTests>
    <Architecture>ArchUnit enforcing hexagonal boundaries and shared-kernel purity</Architecture>
  </TestingStrategy>

  <Observability>
    <Metrics>Search latency, autocomplete latency, ingestion lag, cache hit ratio</Metrics>
    <Tracing>Include queryId and index name in spans</Tracing>
    <Logging>Structured JSON with block anchors (SEARCH-QUERY-*, SEARCH-INDEX-*)</Logging>
  </Observability>

  <Deployment>
    <Packaging>Jib/Buildpacks OCI image</Packaging>
    <Config>Config-server profiles dev/stage/prod</Config>
    <Rollout>Rolling/blue-green</Rollout>
    <Secrets>Vault/K8s Secrets; no secrets in code</Secrets>
  </Deployment>
</DevelopmentPlan>
