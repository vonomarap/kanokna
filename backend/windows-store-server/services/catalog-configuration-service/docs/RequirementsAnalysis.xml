<RequirementsAnalysis version="1.0">
  <Domain id="catalog-configuration">
    <Description>
      Defines and validates configurable windows and doors, including templates, attribute groups,
      compatibility rules, catalog versions, and bill of materials resolution for downstream services.
    </Description>
  </Domain>

  <Actors>
    <Actor id="CATALOG_ADMIN">
      <Name>CatalogAdmin</Name>
      <Goals>
        <Goal id="G-CATALOG-TEMPLATE">Create and update product templates with attributes and options</Goal>
        <Goal id="G-CATALOG-RULES">Define and maintain compatibility/validation rules</Goal>
        <Goal id="G-CATALOG-PUBLISH">Publish catalog versions for use by other services</Goal>
      </Goals>
    </Actor>
    <Actor id="SYSTEM_CLIENT">
      <Name>InternalServiceConsumer</Name>
      <Goals>
        <Goal id="G-CONSUME-OPTIONS">Query valid options for UI/configurator</Goal>
        <Goal id="G-CONSUME-VALIDATION">Validate a configuration before pricing/cart</Goal>
        <Goal id="G-CONSUME-BOM">Resolve bill of materials for fulfillment</Goal>
      </Goals>
    </Actor>
    <Actor id="MEDIA_SERVICE">
      <Name>MediaService</Name>
      <Goals>
        <Goal id="G-MEDIA-LINK">Provide media references for templates/options</Goal>
      </Goals>
    </Actor>
    <Actor id="PRICING_SERVICE">
      <Name>PricingService</Name>
      <Goals>
        <Goal id="G-PRICING-DATA">Receive published catalog attributes and rules for pricing calculations</Goal>
      </Goals>
    </Actor>
    <Actor id="SEARCH_SERVICE">
      <Name>SearchService</Name>
      <Goals>
        <Goal id="G-SEARCH-INDEX">Index templates/options for faceted search and autocomplete</Goal>
      </Goals>
    </Actor>
  </Actors>

  <UseCases>
    <UseCase id="UC-DEFINE-TEMPLATE">
      <ActorRef ref="CATALOG_ADMIN"/>
      <Action>Creates or updates a product template</Action>
      <Goal>Make a configurable window/door definition available as a draft</Goal>
      <Preconditions>Admin is authenticated with CATALOG_ADMIN role.</Preconditions>
      <Postconditions>Template draft persisted with basic attributes and unique name per tenant.</Postconditions>
      <MainFlow>Admin provides template metadata and base attributes -> template stored as DRAFT.</MainFlow>
      <AlternateFlows>Name conflict -> validation error.</AlternateFlows>
      <Links>
        <Link ref="Technology.xml#SVC-runtime"/>
        <Link ref="DevelopmentPlan.xml#Service-catalog-configuration-service"/>
      </Links>
    </UseCase>

    <UseCase id="UC-MANAGE-OPTIONS">
      <ActorRef ref="CATALOG_ADMIN"/>
      <Action>Manages attribute groups and options</Action>
      <Goal>Control selectable values per product template</Goal>
      <Preconditions>Target template exists in DRAFT.</Preconditions>
      <Postconditions>Groups/options updated; references consistent.</Postconditions>
      <MainFlow>Admin adds/updates/removes groups and options -> draft saved.</MainFlow>
      <AlternateFlows>Option in use by ACTIVE version cannot be removed without deprecation.</AlternateFlows>
      <Links>
        <Link ref="DevelopmentPlan.xml#Ports-Inbound"/>
      </Links>
    </UseCase>

    <UseCase id="UC-MANAGE-RULES">
      <ActorRef ref="CATALOG_ADMIN"/>
      <Action>Defines configuration compatibility rules</Action>
      <Goal>Ensure only valid combinations are selectable</Goal>
      <Preconditions>Template and options exist.</Preconditions>
      <Postconditions>Rule sets persisted and linked to template.</Postconditions>
      <MainFlow>Admin defines rule expressions (allow/deny/warn) -> system validates references -> persists.</MainFlow>
      <AlternateFlows>Conflicting or invalid references -> rule validation errors.</AlternateFlows>
      <Links>
        <Link ref="DevelopmentPlan.xml#Contracts-domain-validation"/>
      </Links>
    </UseCase>

    <UseCase id="UC-PUBLISH-CATALOG">
      <ActorRef ref="CATALOG_ADMIN"/>
      <Action>Publishes a catalog version</Action>
      <Goal>Expose a consistent set of templates/rules to downstream services</Goal>
      <Preconditions>All required fields/rules validated; draft exists.</Preconditions>
      <Postconditions>Catalog version marked ACTIVE; events emitted for pricing/search.</Postconditions>
      <MainFlow>Admin selects draft -> runs validation -> publishes -> outbox events written.</MainFlow>
      <AlternateFlows>Validation fails -> version stays DRAFT with errors.</AlternateFlows>
      <Links>
        <Link ref="Technology.xml#Messaging"/>
        <Link ref="DevelopmentPlan.xml#Flow-Publish"/>
      </Links>
    </UseCase>

    <UseCase id="UC-QUERY-OPTIONS">
      <ActorRef ref="SYSTEM_CLIENT"/>
      <Action>Queries valid configuration options for context</Action>
      <Goal>Return allowed groups/options based on partial selection</Goal>
      <Preconditions>ACTIVE catalog version exists.</Preconditions>
      <Postconditions>Allowed options returned; localized labels resolved.</Postconditions>
      <MainFlow>Client sends templateId and partial selection -> service filters options -> responds.</MainFlow>
      <AlternateFlows>Template not found or inactive -> not found error.</AlternateFlows>
      <Links>
        <Link ref="Technology.xml#Interfaces"/>
        <Link ref="DevelopmentPlan.xml#Flow-Validation"/>
      </Links>
    </UseCase>

    <UseCase id="UC-VALIDATE-CONFIGURATION">
      <ActorRef ref="SYSTEM_CLIENT"/>
      <Action>Validates a configuration</Action>
      <Goal>Ensure configuration is feasible before pricing/cart</Goal>
      <Preconditions>Configuration includes required attributes and version info.</Preconditions>
      <Postconditions>ValidationResult with errors/warnings; ConfigurationValidated event on success.</Postconditions>
      <MainFlow>Client posts configuration -> rules evaluated (dimensions, compatibility, status) -> result returned.</MainFlow>
      <AlternateFlows>Rule violation -> errors; missing required fields -> errors.</AlternateFlows>
      <Links>
        <Link ref="DevelopmentPlan.xml#Contracts-domain-validation"/>
      </Links>
    </UseCase>

    <UseCase id="UC-RESOLVE-BOM">
      <ActorRef ref="SYSTEM_CLIENT"/>
      <Action>Resolves BOM for a validated configuration</Action>
      <Goal>Provide manufacturing/installation BOM references</Goal>
      <Preconditions>Configuration validated; template/variant has BOM mapping.</Preconditions>
      <Postconditions>BomResolved event emitted; BOM components returned.</Postconditions>
      <MainFlow>Client requests BOM -> resolver maps configuration to BOM template -> returns items.</MainFlow>
      <AlternateFlows>No matching BOM template -> error; invalid configuration -> validation required.</AlternateFlows>
      <Links>
        <Link ref="DevelopmentPlan.xml#Contracts-domain-bom"/>
      </Links>
    </UseCase>
  </UseCases>

  <NonFunctionalRequirements>
    <Requirement id="NFR-PERF-VALIDATION">P95 validation latency <=150ms; option query <=120ms.</Requirement>
    <Requirement id="NFR-AVAILABILITY">99.9% availability for read/validation endpoints.</Requirement>
    <Requirement id="NFR-VERSIONING">Published catalog versions are immutable; changes require new versions.</Requirement>
    <Requirement id="NFR-AUDIT">All admin changes audited (who/when/what).</Requirement>
    <Requirement id="NFR-SECURITY">OAuth2/OIDC JWT; role-based authorization; input validation.</Requirement>
  </NonFunctionalRequirements>

  <Links>
    <Link ref="Technology.xml"/>
    <Link ref="DevelopmentPlan.xml"/>
  </Links>
</RequirementsAnalysis>
