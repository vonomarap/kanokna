<Technology version="1.0">
  <Runtime id="SVC-runtime">
    <Language>Java 25</Language>
    <Framework>Spring Boot 4.0.x (Web, Validation)</Framework>
    <Architecture>DDD + Hexagonal with ports/adapters; no Spring/JPA in domain/application ports.</Architecture>
  </Runtime>

  <Frameworks>
    <SpringDataJpa>3.3.x with Hibernate 6.x; ddl-auto=validate</SpringDataJpa>
    <SpringSecurity>OAuth2 Resource Server with JWT</SpringSecurity>
    <Resilience4j>Timeouts, retries (expo+jitter), circuit breakers, bulkheads</Resilience4j>
    <MapStruct>1.5+ for DTO mappers</MapStruct>
    <OpenAPI>springdoc-openapi 2.x for REST contracts</OpenAPI>
    <GraphQL optional="true">Spring for GraphQL 2.x for configurator queries</GraphQL>
  </Frameworks>

  <Infrastructure>
    <Database>
      <Engine>PostgreSQL 16</Engine>
      <Migrations>Flyway</Migrations>
      <Constraints>Disable Open-Session-in-View; optimistic locking with @Version; equals/hashCode by business key.</Constraints>
    </Database>
    <Cache>
      <Engine>Redis 7.x</Engine>
      <Usage>Cache ACTIVE catalog versions and option sets with TTL; invalidate on publish.</Usage>
    </Cache>
    <Search>
      <Engine>Elasticsearch 8.x</Engine>
      <Usage>Index templates/options on publish for search-service.</Usage>
    </Search>
    <Messaging>
      <Broker>Kafka 3.x</Broker>
      <OutboundTopics>
        <Topic name="catalog.product-template-changed" key="productTemplateId"/>
        <Topic name="catalog.version-published" key="catalogVersionId"/>
        <Topic name="catalog.configuration-validated" key="configurationId"/>
        <Topic name="catalog.bom-resolved" key="configurationId"/>
      </OutboundTopics>
      <Pattern>Transactional outbox + Debezium/connector or polling publisher; idempotent consumers.</Pattern>
    </Messaging>
    <Storage>
      <Service>Media-service for asset metadata; references stored as IDs/URLs</Service>
    </Storage>
  </Infrastructure>

  <Interfaces id="Interfaces">
    <REST base="/api/v1/catalog">
      <Endpoint>GET /templates (list)</Endpoint>
      <Endpoint>GET /templates/{id}</Endpoint>
      <Endpoint>POST /templates (create/update drafts)</Endpoint>
      <Endpoint>POST /templates/{id}/publish</Endpoint>
      <Endpoint>POST /configurations/validate</Endpoint>
      <Endpoint>POST /configurations/resolve-bom</Endpoint>
    </REST>
    <GraphQL enabled="optional" endpoint="/graphql/catalog">
      <Query>productOptions(templateId, locale, selection)</Query>
      <Query>validateConfiguration(input)</Query>
    </GraphQL>
    <gRPC enabled="future" note="for low-latency internal validation/option lookup"/>
  </Interfaces>

  <CrossCutting>
    <Security>
      <Auth>OAuth2/OIDC JWT; roles CATALOG_ADMIN for admin endpoints, SERVICE for system clients.</Auth>
      <InputValidation>Bean Validation on DTOs; domain invariants enforced in domain layer.</InputValidation>
    </Security>
    <Observability>
      <Metrics>Micrometer + Prometheus; business metrics: validation failures, publish duration, BOM resolve latency.</Metrics>
      <Tracing>OpenTelemetry; propagate traceId/spanId and correlationId.</Tracing>
      <Logging>Structured JSON with block anchors (CFG-VAL-*, BOM-RES-*) for belief-state tracing.</Logging>
    </Observability>
    <Resilience>
      <Timeouts>External calls (media, search) bounded with timeouts.</Timeouts>
      <Retries>Circuit breakers and retries for transient DB/cache issues; idempotent handlers.</Retries>
    </Resilience>
    <Testing>
      <Unit>Domain rules and services</Unit>
      <Slice>@DataJpaTest for persistence adapters; @WebMvcTest for controllers</Slice>
      <Integration>Testcontainers for PostgreSQL/Redis/Kafka</Integration>
      <Contract>OpenAPI/AsyncAPI contract tests for REST/events</Contract>
      <Architecture>ArchUnit enforcing hexagonal boundaries and shared-kernel purity</Architecture>
    </Testing>
  </CrossCutting>

  <Links>
    <Link ref="RequirementsAnalysis.xml"/>
    <Link ref="DevelopmentPlan.xml"/>
  </Links>
</Technology>
