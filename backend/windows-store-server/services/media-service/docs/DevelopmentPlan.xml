<DevelopmentPlan version="1.0">
  <Service id="Service-media-service">
    <Description>Stores and serves media assets (images/renders/manuals) with variants and signed URLs.</Description>
    <BoundedContext>media</BoundedContext>
    <Responsibilities>
      <Item>Upload and validate assets</Item>
      <Item>Generate/manage variants (thumbnail, web-optimized)</Item>
      <Item>Link assets to catalog/product entities</Item>
      <Item>Provide signed URLs for access</Item>
    </Responsibilities>
    <Dependencies>
      <ServiceRef ref="shared-kernel"/>
      <ServiceRef ref="object-storage" type="storage"/>
    </Dependencies>
    <Links>
      <Link ref="RequirementsAnalysis.xml#UC-MEDIA-UPLOAD"/>
      <Link ref="RequirementsAnalysis.xml#UC-MEDIA-RESOLVE"/>
      <Link ref="Technology.xml#Interfaces"/>
    </Links>
  </Service>

  <Architecture>
    <Layers>
      <Domain>com.kanokna.media_service.domain.* (pure Java)</Domain>
      <Application>com.kanokna.media_service.application.* (use cases, ports, DTOs)</Application>
      <AdaptersIn>com.kanokna.media_service.adapters.in.* (web)</AdaptersIn>
      <AdaptersOut>com.kanokna.media_service.adapters.out.* (persistence, object storage, messaging)</AdaptersOut>
    </Layers>
    <Enforcement>ArchUnit: domain free of Spring/JPA; application depends on domain and ports only.</Enforcement>
  </Architecture>

  <Ports>
    <Inbound>
      <Port name="MediaAdminPort" layer="application.port.in">
        <Operation>uploadAsset</Operation>
        <Operation>linkAsset</Operation>
      </Port>
      <Port name="MediaQueryPort" layer="application.port.in">
        <Operation>getMetadata</Operation>
        <Operation>resolveUrls</Operation>
      </Port>
    </Inbound>
    <Outbound>
      <Port name="MediaRepository" layer="application.port.out"/>
      <Port name="ObjectStoragePort" layer="application.port.out"/>
      <Port name="VariantGeneratorPort" layer="application.port.out" optional="true"/>
      <Port name="OutboxPublisher" layer="application.port.out"/>
    </Outbound>
  </Ports>

  <DomainModel>
    <Aggregate name="MediaAsset">
      <Identifier>MediaId</Identifier>
      <State>filename, contentType, size, variants, links, status, metadata</State>
      <Invariants>
        <Invariant>Content type allowed</Invariant>
        <Invariant>Size within configured limits</Invariant>
      </Invariants>
      <Events>
        <Event>MediaUploaded</Event>
        <Event>MediaLinked</Event>
      </Events>
    </Aggregate>
    <ValueObject name="MediaVariant">variantType, url, size, width, height</ValueObject>
  </DomainModel>

  <Contracts>
    <ModuleContract id="mod.media.domain" layer="domain.service">
      <Purpose>Validate uploads and manage media metadata/links.</Purpose>
      <Links>
        <Link ref="RequirementsAnalysis.xml#UC-MEDIA-UPLOAD"/>
      </Links>
      <FunctionContracts>
        <FunctionContract id="uploadAsset" layer="domain.service" intent="Validate and register a media asset">
          <Input>UploadAssetCommand</Input>
          <Output>MediaAsset</Output>
          <Preconditions>Content type/size allowed</Preconditions>
          <Postconditions>MediaAsset created with variants metadata; MediaUploaded event</Postconditions>
          <BlockAnchors>
            <Block id="MEDIA-UPLOAD-VALIDATE" purpose="Check content type/size"/>
            <Block id="MEDIA-UPLOAD-REGISTER" purpose="Register metadata and variants"/>
          </BlockAnchors>
          <LoggingPattern>[MEDIA][uploadAsset][block={id}][state={state}]</LoggingPattern>
        </FunctionContract>
        <FunctionContract id="resolveUrls" layer="domain.service" intent="Resolve signed/public URLs for assets">
          <Input>ResolveUrlsCommand</Input>
          <Output>ResolvedUrlsResult</Output>
          <Preconditions>Media exists; caller authorized</Preconditions>
          <Postconditions>URLs returned with TTL</Postconditions>
          <BlockAnchors>
            <Block id="MEDIA-RESOLVE-FETCH" purpose="Fetch asset metadata"/>
            <Block id="MEDIA-RESOLVE-SIGN" purpose="Generate signed URLs"/>
          </BlockAnchors>
          <LoggingPattern>[MEDIA][resolveUrls][block={id}][state={state}]</LoggingPattern>
        </FunctionContract>
      </FunctionContracts>
    </ModuleContract>
  </Contracts>

  <Flows>
    <Flow id="Flow-Upload">
      <Description>Handle media upload.</Description>
      <Sequence>
        <Step order="1" from="Adapter (REST)" to="Application Service">Receive multipart upload</Step>
        <Step order="2" from="Application Service" to="Domain Service">uploadAsset</Step>
        <Step order="3" from="Application Service" to="ObjectStoragePort">Store file</Step>
        <Step order="4" from="Application Service" to="MediaRepository">Persist metadata</Step>
        <Step order="5" from="Application Service" to="OutboxPublisher">Emit media.updated event</Step>
      </Sequence>
    </Flow>
    <Flow id="Flow-Resolve">
      <Description>Resolve signed URLs for assets.</Description>
      <Sequence>
        <Step order="1" from="Adapter (REST)" to="Application Service">resolveUrls request</Step>
        <Step order="2" from="Application Service" to="Domain Service">resolveUrls</Step>
        <Step order="3" from="Application Service" to="ObjectStoragePort">Generate signed URLs</Step>
        <Step order="4" from="Application Service" to="Adapter">Return URLs</Step>
      </Sequence>
    </Flow>
  </Flows>

  <PersistencePlan>
    <Table name="media_asset">
      <Column name="id" type="UUID" role="PK"/>
      <Column name="filename" type="VARCHAR(255)"/>
      <Column name="content_type" type="VARCHAR(100)"/>
      <Column name="size_bytes" type="BIGINT"/>
      <Column name="variants_json" type="JSONB"/>
      <Column name="metadata_json" type="JSONB"/>
      <Column name="status" type="VARCHAR(20)"/>
      <Column name="version" type="BIGINT" role="OPTIMISTIC_LOCK"/>
    </Table>
    <Table name="media_link">
      <Column name="id" type="UUID" role="PK"/>
      <Column name="media_id" type="UUID" role="FK"/>
      <Column name="entity_type" type="VARCHAR(50)"/>
      <Column name="entity_id" type="UUID"/>
      <Column name="purpose" type="VARCHAR(50)"/>
    </Table>
  </PersistencePlan>

  <TestingStrategy>
    <Unit>Content type/size validation; URL signing logic</Unit>
    <Slice>@DataJpaTest for repositories; @WebMvcTest for controllers</Slice>
    <Integration>Testcontainers for PostgreSQL + MinIO + Kafka</Integration>
    <ContractTests>OpenAPI for REST; AsyncAPI/Avro for media.updated</ContractTests>
    <Architecture>ArchUnit enforcing hexagonal boundaries and shared-kernel purity</Architecture>
  </TestingStrategy>

  <Observability>
    <Metrics>Upload latency, resolve latency, storage failures, variant generation time</Metrics>
    <Tracing>Include mediaId in spans</Tracing>
    <Logging>Structured JSON with block anchors (MEDIA-UPLOAD-*, MEDIA-RESOLVE-*) describing decisions</Logging>
  </Observability>

  <Deployment>
    <Packaging>Jib/Buildpacks OCI image</Packaging>
    <Config>Config-server profiles dev/stage/prod</Config>
    <Rollout>Rolling/blue-green; Flyway migrations expand-migrate-contract</Rollout>
    <Secrets>Vault/K8s Secrets; no secrets in code</Secrets>
  </Deployment>
</DevelopmentPlan>
