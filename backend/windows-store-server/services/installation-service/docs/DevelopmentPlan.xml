<DevelopmentPlan version="1.0">
  <Service id="Service-installation-service">
    <Description>Handles installation slot search/booking and status updates for orders.</Description>
    <BoundedContext>installation</BoundedContext>
    <Responsibilities>
      <Item>Provide available slots</Item>
      <Item>Book slots atomically and idempotently</Item>
      <Item>Update installation status and notify downstream systems</Item>
    </Responsibilities>
    <Dependencies>
      <ServiceRef ref="shared-kernel"/>
      <ServiceRef ref="order-service" type="async-events">Consume order.confirmed; emit installation events</ServiceRef>
    </Dependencies>
    <Links>
      <Link ref="RequirementsAnalysis.xml#UC-INSTALL-SLOT-SEARCH"/>
      <Link ref="RequirementsAnalysis.xml#UC-INSTALL-BOOK"/>
      <Link ref="Technology.xml#Interfaces"/>
    </Links>
  </Service>

  <Architecture>
    <Layers>
      <Domain>com.kanokna.installation_service.domain.* (pure Java)</Domain>
      <Application>com.kanokna.installation_service.application.* (use cases, ports, DTOs)</Application>
      <AdaptersIn>com.kanokna.installation_service.adapters.in.* (web)</AdaptersIn>
      <AdaptersOut>com.kanokna.installation_service.adapters.out.* (persistence, messaging)</AdaptersOut>
    </Layers>
    <Enforcement>ArchUnit: domain free of Spring/JPA; application depends on domain and ports only.</Enforcement>
  </Architecture>

  <Ports>
    <Inbound>
      <Port name="SlotQueryPort" layer="application.port.in">
        <Operation>searchSlots</Operation>
      </Port>
      <Port name="BookingPort" layer="application.port.in">
        <Operation>bookSlot</Operation>
      </Port>
      <Port name="StatusPort" layer="application.port.in">
        <Operation>updateStatus</Operation>
      </Port>
    </Inbound>
    <Outbound>
      <Port name="SlotRepository" layer="application.port.out"/>
      <Port name="BookingRepository" layer="application.port.out"/>
      <Port name="OutboxPublisher" layer="application.port.out"/>
    </Outbound>
  </Ports>

  <DomainModel>
    <Aggregate name="InstallationBooking">
      <Identifier>BookingId</Identifier>
      <State>orderId, slotId, installerId, status, version</State>
      <Invariants>
        <Invariant>Order/slot combination booked idempotently</Invariant>
        <Invariant>Status transitions valid (REQUESTED -> CONFIRMED -> IN_PROGRESS -> COMPLETED/CANCELLED)</Invariant>
      </Invariants>
      <Events>
        <Event>InstallationScheduled</Event>
        <Event>InstallationUpdated</Event>
      </Events>
    </Aggregate>
    <ValueObject name="Slot">slotId, startTime, endTime, installerId</ValueObject>
  </DomainModel>

  <Contracts>
    <ModuleContract id="mod.installation.domain" layer="domain.service">
      <Purpose>Slot booking and status updates with idempotency.</Purpose>
      <Links>
        <Link ref="RequirementsAnalysis.xml#UC-INSTALL-BOOK"/>
      </Links>
      <FunctionContracts>
        <FunctionContract id="bookSlot" layer="domain.service" intent="Book a slot idempotently for an order">
          <Input>BookSlotCommand</Input>
          <Output>BookingResult</Output>
          <Preconditions>Slot available; order eligible</Preconditions>
          <Postconditions>Booking persisted; InstallationScheduled event</Postconditions>
          <BlockAnchors>
            <Block id="INSTALL-BOOK-IDEMP" purpose="Check existing booking or duplicate request"/>
            <Block id="INSTALL-BOOK-CONFLICT" purpose="Detect slot conflicts"/>
            <Block id="INSTALL-BOOK-PERSIST" purpose="Persist booking and emit event"/>
          </BlockAnchors>
          <LoggingPattern>[INSTALL][bookSlot][block={id}][state={state}]</LoggingPattern>
        </FunctionContract>
        <FunctionContract id="updateStatus" layer="domain.service" intent="Transition installation booking status">
          <Input>UpdateStatusCommand</Input>
          <Output>StatusUpdateResult</Output>
          <Preconditions>Booking exists; transition allowed</Preconditions>
          <Postconditions>Status updated; InstallationUpdated event</Postconditions>
          <BlockAnchors>
            <Block id="INSTALL-STATUS-VALIDATE" purpose="Validate transition"/>
            <Block id="INSTALL-STATUS-PERSIST" purpose="Persist state change and emit event"/>
          </BlockAnchors>
          <LoggingPattern>[INSTALL][updateStatus][block={id}][state={state}]</LoggingPattern>
        </FunctionContract>
      </FunctionContracts>
    </ModuleContract>
  </Contracts>

  <Flows>
    <Flow id="Flow-Schedule">
      <Description>Search and book installation slots.</Description>
      <Sequence>
        <Step order="1" from="Adapter (REST)" to="Application Service">searchSlots/bookSlot</Step>
        <Step order="2" from="Application Service" to="SlotRepository">Query/lock slot</Step>
        <Step order="3" from="Application Service" to="Domain Service">bookSlot</Step>
        <Step order="4" from="Application Service" to="OutboxPublisher">Emit installation.scheduled</Step>
      </Sequence>
    </Flow>
    <Flow id="Flow-Status">
      <Description>Update installation status.</Description>
      <Sequence>
        <Step order="1" from="Adapter (REST)" to="Application Service">updateStatus</Step>
        <Step order="2" from="Application Service" to="Domain Service">updateStatus</Step>
        <Step order="3" from="Application Service" to="OutboxPublisher">Emit installation.updated</Step>
      </Sequence>
    </Flow>
  </Flows>

  <PersistencePlan>
    <Table name="installation_booking">
      <Column name="id" type="UUID" role="PK"/>
      <Column name="order_id" type="UUID"/>
      <Column name="slot_id" type="UUID"/>
      <Column name="installer_id" type="UUID" nullable="true"/>
      <Column name="status" type="VARCHAR(20)"/>
      <Column name="version" type="BIGINT" role="OPTIMISTIC_LOCK"/>
      <Index name="ux_booking_order_slot" unique="true">
        <ColumnRef>order_id</ColumnRef>
        <ColumnRef>slot_id</ColumnRef>
      </Index>
    </Table>
    <Table name="installation_slot">
      <Column name="id" type="UUID" role="PK"/>
      <Column name="installer_id" type="UUID" nullable="true"/>
      <Column name="start_time" type="TIMESTAMP WITH TIME ZONE"/>
      <Column name="end_time" type="TIMESTAMP WITH TIME ZONE"/>
      <Column name="status" type="VARCHAR(20)"/>
    </Table>
  </PersistencePlan>

  <TestingStrategy>
    <Unit>Slot conflict detection, idempotent booking, status transitions</Unit>
    <Slice>@DataJpaTest for repositories; @WebMvcTest for controllers</Slice>
    <Integration>Testcontainers for PostgreSQL/Redis/Kafka</Integration>
    <ContractTests>OpenAPI for REST; AsyncAPI/Avro for installation events</ContractTests>
    <Architecture>ArchUnit enforcing hexagonal boundaries and shared-kernel purity</Architecture>
  </TestingStrategy>

  <Observability>
    <Metrics>Slot search latency, booking success/conflict rate, status update latency</Metrics>
    <Tracing>Include orderId and slotId in spans</Tracing>
    <Logging>Structured JSON with block anchors (INSTALL-BOOK-*, INSTALL-STATUS-*)</Logging>
  </Observability>

  <Deployment>
    <Packaging>Jib/Buildpacks OCI image</Packaging>
    <Config>Config-server profiles dev/stage/prod</Config>
    <Rollout>Rolling/blue-green; Flyway migrations expand-migrate-contract</Rollout>
    <Secrets>Vault/K8s Secrets; no secrets in code</Secrets>
  </Deployment>
</DevelopmentPlan>
