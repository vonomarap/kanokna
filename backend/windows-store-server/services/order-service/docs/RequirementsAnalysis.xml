<RequirementsAnalysis version="1.0">
  <Domain id="order">
    <Description>
      Handles checkout, order creation, payment coordination (deposit/full), order lifecycle (production,
      delivery, installation), and downstream notifications for configurable windows/doors.
    </Description>
  </Domain>

  <Actors>
    <Actor id="CUSTOMER">
      <Name>Customer</Name>
      <Goals>
        <Goal id="G-ORDER-CREATE">Place an order from a cart</Goal>
        <Goal id="G-ORDER-PAY">Pay deposit or full amount</Goal>
        <Goal id="G-ORDER-TRACK">Track production, delivery, installation</Goal>
      </Goals>
    </Actor>
    <Actor id="ADMIN">
      <Name>OrderOps</Name>
      <Goals>
        <Goal id="G-ORDER-ASSIST">Assist/override orders and payments when allowed</Goal>
        <Goal id="G-ORDER-MANAGE">Manage status transitions and scheduling</Goal>
      </Goals>
    </Actor>
    <Actor id="PAYMENT_GATEWAY">
      <Name>PaymentGateway</Name>
      <Goals>
        <Goal id="G-PAYMENT">Authorize/capture payments and send callbacks</Goal>
      </Goals>
    </Actor>
    <Actor id="INSTALLER">
      <Name>Installer</Name>
      <Goals>
        <Goal id="G-INSTALL-SCHEDULE">Schedule and update installation appointments</Goal>
      </Goals>
    </Actor>
    <Actor id="SYSTEM">
      <Name>InternalServiceConsumer</Name>
      <Goals>
        <Goal id="G-ORDER-EVENTS">Consume order lifecycle events</Goal>
      </Goals>
    </Actor>
  </Actors>

  <UseCases>
    <UseCase id="UC-CHECKOUT-ORDER">
      <ActorRef ref="CUSTOMER"/>
      <Action>Submits an order from a validated cart</Action>
      <Goal>Create order with totals, addresses, and preferences</Goal>
      <Preconditions>Cart exists and totals validated with pricing; customer authenticated or cart token present.</Preconditions>
      <Postconditions>Order created in PENDING_PAYMENT/CONFIRMED depending on payment flow; order.created event emitted.</Postconditions>
      <MainFlow>Client submits checkout payload -> service validates cart totals -> creates order -> returns order id/status.</MainFlow>
      <AlternateFlows>Totals mismatch -> error; invalid address -> validation error.</AlternateFlows>
      <Links>
        <Link ref="DevelopmentPlan.xml#Flow-Checkout"/>
      </Links>
    </UseCase>

    <UseCase id="UC-PAYMENT">
      <ActorRef ref="CUSTOMER"/>
      <Action>Pays deposit or full amount</Action>
      <Goal>Authorize and capture funds for the order</Goal>
      <Preconditions>Order exists and payable amount > 0; payment method supported.</Preconditions>
      <Postconditions>Payment status updated; order advanced; receipts sent.</Postconditions>
      <MainFlow>Service initiates payment session -> gateway collects -> callback updates order/payment state.</MainFlow>
      <AlternateFlows>Authorization declined -> order remains pending/cancel policy; duplicate callback -> idempotent ignore.</AlternateFlows>
      <Links>
        <Link ref="DevelopmentPlan.xml#Flow-Payment"/>
      </Links>
    </UseCase>

    <UseCase id="UC-ORDER-LIFECYCLE">
      <ActorRef ref="CUSTOMER"/>
      <ActorRef ref="INSTALLER"/>
      <Action>Tracks and updates order status through production/delivery/installation</Action>
      <Goal>Keep stakeholders informed and schedule installation</Goal>
      <Preconditions>Order confirmed; production or logistics steps configured.</Preconditions>
      <Postconditions>Status transitions recorded; installation slot stored; notifications emitted.</Postconditions>
      <MainFlow>Service advances state machine -> emits events -> installer schedules slots -> updates stored.</MainFlow>
      <AlternateFlows>Invalid transition -> error; slot conflict -> validation error.</AlternateFlows>
      <Links>
        <Link ref="DevelopmentPlan.xml#Flow-Lifecycle"/>
      </Links>
    </UseCase>

    <UseCase id="UC-ORDER-QUERY">
      <ActorRef ref="CUSTOMER"/>
      <Action>Retrieves order details and status</Action>
      <Goal>View current state, payments, and installation info</Goal>
      <Preconditions>Order belongs to requester or authorized role.</Preconditions>
      <Postconditions>Order details returned.</Postconditions>
      <MainFlow>Client requests order id -> service returns DTO with status/history.</MainFlow>
      <AlternateFlows>Unauthorized -> 403; not found -> 404.</AlternateFlows>
    </UseCase>
  </UseCases>

  <NonFunctionalRequirements>
    <Requirement id="NFR-PERF">P95 checkout POST <=350ms with cached pricing; payment callback handling <=150ms.</Requirement>
    <Requirement id="NFR-AVAILABILITY">99.9% availability for checkout and payment callbacks.</Requirement>
    <Requirement id="NFR-IDEMPOTENCY">Checkout and payment callbacks must be idempotent using keys/message ids.</Requirement>
    <Requirement id="NFR-AUDIT">All status changes and payments audited.</Requirement>
    <Requirement id="NFR-SECURITY">OAuth2/OIDC JWT; role-based access; PII minimized; input validation.</Requirement>
  </NonFunctionalRequirements>

  <Links>
    <Link ref="Technology.xml"/>
    <Link ref="DevelopmentPlan.xml"/>
  </Links>
</RequirementsAnalysis>
