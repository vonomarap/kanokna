<DevelopmentPlan version="1.0">
  <Service id="Service-notification-service">
    <Description>Dispatches email/SMS/push notifications from domain events with templating and localization.</Description>
    <BoundedContext>notification</BoundedContext>
    <Responsibilities>
      <Item>Manage templates and localization</Item>
      <Item>Apply user preferences and routing</Item>
      <Item>Send messages reliably via providers</Item>
      <Item>Track delivery status</Item>
    </Responsibilities>
    <Dependencies>
      <ServiceRef ref="shared-kernel"/>
      <ServiceRef ref="order-service" type="async-events"/>
      <ServiceRef ref="cart-service" type="async-events"/>
    </Dependencies>
    <Links>
      <Link ref="RequirementsAnalysis.xml#UC-NOTIFY-EVENT"/>
      <Link ref="Technology.xml#Interfaces"/>
    </Links>
  </Service>

  <Architecture>
    <Layers>
      <Domain>com.kanokna.notification_service.domain.* (pure Java)</Domain>
      <Application>com.kanokna.notification_service.application.* (use cases, ports, DTOs)</Application>
      <AdaptersIn>com.kanokna.notification_service.adapters.in.* (web, kafka listeners)</AdaptersIn>
      <AdaptersOut>com.kanokna.notification_service.adapters.out.* (persistence, channels, messaging)</AdaptersOut>
    </Layers>
    <Enforcement>ArchUnit: domain free of Spring/JPA; application depends on domain and ports only.</Enforcement>
  </Architecture>

  <Ports>
    <Inbound>
      <Port name="TemplatePort" layer="application.port.in">
        <Operation>createOrUpdateTemplate</Operation>
        <Operation>listTemplates</Operation>
      </Port>
      <Port name="PreferencePort" layer="application.port.in">
        <Operation>setPreferences</Operation>
        <Operation>getPreferences</Operation>
      </Port>
      <Port name="SendPort" layer="application.port.in">
        <Operation>sendNotification</Operation>
        <Operation>processEvent</Operation>
      </Port>
    </Inbound>
    <Outbound>
      <Port name="TemplateRepository" layer="application.port.out"/>
      <Port name="PreferenceRepository" layer="application.port.out"/>
      <Port name="ChannelPort" layer="application.port.out"/>
      <Port name="OutboxPublisher" layer="application.port.out"/>
    </Outbound>
  </Ports>

  <DomainModel>
    <Aggregate name="NotificationTemplate">
      <Identifier>TemplateId</Identifier>
      <State>name, locale, subject, body, placeholders, channel, status</State>
      <Invariants>
        <Invariant>Placeholders must resolve from event payload</Invariant>
      </Invariants>
      <Events>
        <Event>TemplateUpdated</Event>
      </Events>
    </Aggregate>
    <Aggregate name="NotificationPreference">
      <Identifier>PreferenceId</Identifier>
      <State>accountId, channel preferences, locale</State>
    </Aggregate>
    <ValueObject name="NotificationMessage">recipient, channel, templateId, payload</ValueObject>
  </DomainModel>

  <Contracts>
    <ModuleContract id="mod.notification.domain" layer="domain.service">
      <Purpose>Render and send notifications with preferences and idempotency.</Purpose>
      <Links>
        <Link ref="RequirementsAnalysis.xml#UC-NOTIFY-EVENT"/>
      </Links>
      <FunctionContracts>
        <FunctionContract id="renderAndSend" layer="domain.service" intent="Render template and send via channel">
          <Input>NotificationMessage</Input>
          <Output>SendResult</Output>
          <Preconditions>Template exists; recipient/channel valid</Preconditions>
          <Postconditions>Message sent or queued; delivery status recorded</Postconditions>
          <BlockAnchors>
            <Block id="NOTIFY-RENDER" purpose="Render template with payload"/>
            <Block id="NOTIFY-SEND" purpose="Send via channel with retries"/>
          </BlockAnchors>
          <LoggingPattern>[NOTIFY][renderAndSend][block={id}][state={state}]</LoggingPattern>
        </FunctionContract>
      </FunctionContracts>
    </ModuleContract>
  </Contracts>

  <Flows>
    <Flow id="Flow-Event-Driven">
      <Description>Process domain events into notifications.</Description>
      <Sequence>
        <Step order="1" from="Kafka" to="Adapter (listener)">Receive event</Step>
        <Step order="2" from="Adapter" to="Application Service">processEvent</Step>
        <Step order="3" from="Application Service" to="Domain Service">renderAndSend</Step>
        <Step order="4" from="Application Service" to="OutboxPublisher">Emit notification.sent</Step>
      </Sequence>
    </Flow>
  </Flows>

  <PersistencePlan>
    <Table name="notification_template">
      <Column name="id" type="UUID" role="PK"/>
      <Column name="name" type="VARCHAR(255)"/>
      <Column name="locale" type="VARCHAR(10)"/>
      <Column name="channel" type="VARCHAR(20)"/>
      <Column name="subject" type="TEXT"/>
      <Column name="body" type="TEXT"/>
      <Column name="placeholders_json" type="JSONB"/>
      <Column name="status" type="VARCHAR(20)"/>
    </Table>
    <Table name="notification_preference">
      <Column name="id" type="UUID" role="PK"/>
      <Column name="account_id" type="UUID"/>
      <Column name="channels_json" type="JSONB"/>
      <Column name="locale" type="VARCHAR(10)"/>
    </Table>
  </PersistencePlan>

  <TestingStrategy>
    <Unit>Template rendering, preference routing, idempotent send</Unit>
    <Slice>@DataJpaTest for repositories; @WebMvcTest for controllers</Slice>
    <Integration>Testcontainers for PostgreSQL/Redis/Kafka; channel mock tests</Integration>
    <ContractTests>OpenAPI for REST; AsyncAPI/Avro for notification.sent</ContractTests>
    <Architecture>ArchUnit enforcing hexagonal boundaries and shared-kernel purity</Architecture>
  </TestingStrategy>

  <Observability>
    <Metrics>Send success/failure rate per channel; retry counts; render latency</Metrics>
    <Tracing>Include messageId, channel in spans</Tracing>
    <Logging>Structured JSON with block anchors (NOTIFY-RENDER, NOTIFY-SEND) describing decisions</Logging>
  </Observability>

  <Deployment>
    <Packaging>Jib/Buildpacks OCI image</Packaging>
    <Config>Config-server profiles dev/stage/prod</Config>
    <Rollout>Rolling/blue-green; Flyway migrations expand-migrate-contract</Rollout>
    <Secrets>Vault/K8s Secrets; no secrets in code</Secrets>
  </Deployment>
</DevelopmentPlan>
