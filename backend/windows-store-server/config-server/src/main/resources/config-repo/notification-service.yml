# ============================================================================
# Notification Service Configuration
# ============================================================================
# Sends transactional notifications (email, SMS, push) based on domain events.
# Manages templates, localization, and delivery tracking.
#
# Links:
#   - DevelopmentPlan.xml#DP-SVC-notification-service
#   - RequirementsAnalysis.xml#UC-NOTIFY-TRANSACTIONAL
#   - RequirementsAnalysis.xml#ACT-NOTIFICATION-PROVIDER
# ============================================================================

server:
  port: 8088

spring:
  datasource:
    url: jdbc:postgresql://${DB_HOST:localhost}:${DB_PORT:5432}/${DB_NAME:notifications}
    username: ${DB_USERNAME:postgres}
    password: ${DB_PASSWORD:postgres}
    hikari:
      maximum-pool-size: 10
      minimum-idle: 5
      connection-timeout: 30000

  flyway:
    enabled: true
    locations: classpath:db/migration
    baseline-on-migrate: true
    schemas: notifications

# -----------------------------------------------------------------------------
# Email Provider (SendGrid)
# -----------------------------------------------------------------------------
email:
  provider: sendgrid
  sendgrid:
    api-key: ${SENDGRID_API_KEY:}
    from-email: ${EMAIL_FROM:noreply@kanokna.com}
    from-name: ${EMAIL_FROM_NAME:Kanokna}
    sandbox-mode: ${SENDGRID_SANDBOX:false}
  # Retry settings
  retry:
    max-attempts: 3
    backoff-ms: 1000

# -----------------------------------------------------------------------------
# SMS Provider (Twilio - Optional)
# -----------------------------------------------------------------------------
sms:
  enabled: ${SMS_ENABLED:false}
  provider: twilio
  twilio:
    account-sid: ${TWILIO_ACCOUNT_SID:}
    auth-token: ${TWILIO_AUTH_TOKEN:}
    from-number: ${TWILIO_FROM_NUMBER:}

# -----------------------------------------------------------------------------
# Notification Domain Configuration
# -----------------------------------------------------------------------------
notification:
  # Template settings
  templates:
    default-locale: ru
    cache-enabled: true
    cache-ttl-minutes: 30

  # Event to notification type mapping
  event-mapping:
    OrderCreatedEvent:
      - EMAIL_ORDER_CONFIRMATION
      - SMS_ORDER_CONFIRMATION
    OrderShippedEvent:
      - EMAIL_SHIPPING_NOTIFICATION
    OrderDeliveredEvent:
      - EMAIL_DELIVERY_NOTIFICATION
    InstallationScheduledEvent:
      - EMAIL_INSTALLATION_SCHEDULED
      - SMS_INSTALLATION_REMINDER

  # Rate limiting
  rate-limits:
    email-per-user-per-hour: 20
    sms-per-user-per-day: 5

  # Abandoned cart reminders
  abandoned-cart:
    enabled: true
    delay-hours: 24
    max-reminders: 2
    cron: "0 0 10 * * *"  # 10 AM daily

# -----------------------------------------------------------------------------
# Kafka Consumer Configuration
# -----------------------------------------------------------------------------
kafka:
  consumer:
    group-id: notification-service
  topics:
    order-created: order.created
    order-shipped: order.shipped
    order-delivered: order.delivered
    installation-scheduled: installation.scheduled

# -----------------------------------------------------------------------------
# Resilience4j
# -----------------------------------------------------------------------------
resilience4j:
  circuitbreaker:
    instances:
      emailProvider:
        sliding-window-size: 10
        failure-rate-threshold: 50
        wait-duration-in-open-state: 30s
      smsProvider:
        sliding-window-size: 10
        failure-rate-threshold: 50
        wait-duration-in-open-state: 60s
  retry:
    instances:
      emailProvider:
        max-attempts: 3
        wait-duration: 1000ms
      smsProvider:
        max-attempts: 2
        wait-duration: 2000ms

# -----------------------------------------------------------------------------
# Logging
# -----------------------------------------------------------------------------
logging:
  level:
    com.kanokna.notification_service.domain: DEBUG
    com.kanokna.notification_service.application: DEBUG
