# ============================================================================
# Config Server - Main Configuration
# ============================================================================
# This is the Spring Cloud Config Server that provides centralized configuration
# management for all microservices in the Kanokna Windows & Doors platform.
#
# Configuration Source Strategy:
# - dev/stage: Native file system (configs in classpath:config-repo/)
# - prod: Git repository (external, encrypted)
# ============================================================================

server:
  port: 8888
  shutdown: graceful

spring:
  application:
    name: config-server

  profiles:
    active: native  # Use native filesystem by default

  cloud:
    config:
      server:
        # Native filesystem configuration (for dev/stage)
        native:
          search-locations:
            - classpath:/config-repo
            - classpath:/config-repo/{application}

        # Git configuration (for prod - activated via profile)
        git:
          uri: ${CONFIG_GIT_URI:https://github.com/kanokna/config-repo}
          default-label: main
          search-paths:
            - '{application}'
          clone-on-start: true
          force-pull: true
          # Credentials (set via environment variables in prod)
          username: ${CONFIG_GIT_USERNAME:}
          password: ${CONFIG_GIT_PASSWORD:}

        # Encryption configuration
        encrypt:
          enabled: true

  # Security configuration
  security:
    user:
      name: ${CONFIG_SERVER_USER:configadmin}
      password: ${CONFIG_SERVER_PASSWORD:configsecret}

# Encryption key for sensitive properties
encrypt:
  key: ${ENCRYPT_KEY:kanokna-dev-encrypt-key-change-in-prod}

# Actuator endpoints
management:
  server:
    port: 8889
  endpoints:
    web:
      exposure:
        include: health,info,refresh,env,metrics,prometheus
      base-path: /actuator
  endpoint:
    health:
      show-details: when_authorized
      probes:
        enabled: true
  health:
    livenessState:
      enabled: true
    readinessState:
      enabled: true
  metrics:
    tags:
      application: ${spring.application.name}
  prometheus:
    metrics:
      export:
        enabled: true

# Logging
logging:
  level:
    root: INFO
    org.springframework.cloud.config: INFO
    com.kanokna: DEBUG
  pattern:
    console: "%d{ISO8601} [%thread] %-5level [%X{correlationId:-}] %logger{36} - %msg%n"

---
# ============================================================================
# Development Profile
# ============================================================================
spring:
  config:
    activate:
      on-profile: dev

  cloud:
    config:
      server:
        native:
          search-locations:
            - classpath:/config-repo
            - classpath:/config-repo/{application}
            - file:./config-repo
            - file:./config-repo/{application}

  security:
    user:
      name: admin
      password: admin

logging:
  level:
    org.springframework.cloud.config: DEBUG
    org.springframework.security: DEBUG

---
# ============================================================================
# Stage Profile
# ============================================================================
spring:
  config:
    activate:
      on-profile: stage

  cloud:
    config:
      server:
        native:
          search-locations:
            - classpath:/config-repo
            - classpath:/config-repo/{application}

---
# ============================================================================
# Production Profile
# ============================================================================
spring:
  config:
    activate:
      on-profile: prod

  profiles:
    include: git  # Use Git backend in production

  cloud:
    config:
      server:
        git:
          uri: ${CONFIG_GIT_URI}
          default-label: ${CONFIG_GIT_BRANCH:main}
          clone-on-start: true
          force-pull: true
          timeout: 10
          refresh-rate: 30

  security:
    user:
      name: ${CONFIG_SERVER_USER}
      password: ${CONFIG_SERVER_PASSWORD}

logging:
  level:
    root: WARN
    org.springframework.cloud.config: INFO
    com.kanokna: INFO
