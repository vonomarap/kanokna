# ============================================================================
# Config Server - Main Configuration
# ============================================================================
# This is the Spring Cloud Config Server that provides centralized configuration
# management for all microservices in the Kanokna Windows & Doors platform.
#
# Configuration Source Strategy:
# - dev: Native file system (configs in kanokna-config)
# - stage/prod: Git repository (external, encrypted)
# ============================================================================

server:
  port: 8888
  shutdown: graceful

spring:
  application:
    name: config-server

  profiles:
    active: native  # Use native filesystem by default
    # Profile groups: test profile includes native for config server
    group:
      test:
        - native

  cloud:
    config:
      server:
        # Native filesystem configuration (default for dev)
        native:
          search-locations:
            - file:${CONFIG_REPO_PATH:C:/windows-store-project/kanokna-copy/backend/windows-store-server/kanokna-config}
            - file:${CONFIG_REPO_PATH:C:/windows-store-project/kanokna-copy/backend/windows-store-server/kanokna-config}/{application}

        # Encryption configuration
        encrypt:
          enabled: true

  # Security configuration
  security:
    user:
      name: ${CONFIG_SERVER_USER:configadmin}
      password: ${CONFIG_SERVER_PASSWORD:configsecret}

# Encryption key for sensitive properties
encrypt:
  key: ${ENCRYPT_KEY:kanokna-dev-encrypt-key-change-in-prod}

# Actuator endpoints
management:
  server:
    port: 8889
  endpoints:
    web:
      exposure:
        include: health,info,refresh,env,metrics,prometheus
      base-path: /actuator
  endpoint:
    health:
      show-details: when_authorized
      probes:
        enabled: true
  health:
    livenessState:
      enabled: true
    readinessState:
      enabled: true
  metrics:
    tags:
      application: ${spring.application.name}
  prometheus:
    metrics:
      export:
        enabled: true

# Logging
logging:
  level:
    root: INFO
    org.springframework.cloud.config: INFO
    com.kanokna: DEBUG
  pattern:
    console: "%d{ISO8601} [%thread] %-5level [%X{correlationId:-}] %logger{36} - %msg%n"

---
# ============================================================================
# Development Profile
# ============================================================================
spring:
  config:
    activate:
      on-profile: dev

  cloud:
    config:
      server:
        native:
          search-locations:
            - file:${CONFIG_REPO_PATH:C:/windows-store-project/kanokna-copy/backend/windows-store-server/kanokna-config}
            - file:${CONFIG_REPO_PATH:C:/windows-store-project/kanokna-copy/backend/windows-store-server/kanokna-config}/{application}

  security:
    user:
      name: admin
      password: admin

logging:
  level:
    org.springframework.cloud.config: DEBUG
    org.springframework.security: DEBUG

---
# ============================================================================
# Stage Profile
# ============================================================================
spring:
  config:
    activate:
      on-profile: stage

  cloud:
    config:
      server:
        native:
          search-locations: []
        git:
          uri: ${CONFIG_GIT_URI:https://github.com/vonomarap/kanokna-config.git}
          default-label: ${CONFIG_GIT_BRANCH:main}
          search-paths:
            - '.'
          clone-on-start: true
          force-pull: true
          timeout: 10
          refresh-rate: 30
          username: ${CONFIG_GIT_USERNAME:}
          password: ${CONFIG_GIT_PASSWORD:}

---
# ============================================================================
# Production Profile
# ============================================================================
# Note: In production, we use git backend for externalized configuration.
spring:
  config:
    activate:
      on-profile: prod

  cloud:
    config:
      server:
        # Disable native backend in prod
        native:
          search-locations: []
        # Git configuration for production
        git:
          uri: ${CONFIG_GIT_URI:https://github.com/vonomarap/kanokna-config.git}
          default-label: ${CONFIG_GIT_BRANCH:main}
          search-paths:
            - '.'
          clone-on-start: true
          force-pull: true
          timeout: 10
          refresh-rate: 30
          username: ${CONFIG_GIT_USERNAME:}
          password: ${CONFIG_GIT_PASSWORD:}

  security:
    user:
      name: ${CONFIG_SERVER_USER}
      password: ${CONFIG_SERVER_PASSWORD}

logging:
  level:
    root: WARN
    org.springframework.cloud.config: INFO
    com.kanokna: INFO
